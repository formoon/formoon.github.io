I"Ë|<p><img src="/attachments/201904/tensorFlow2/tf-logo-card-2.png" alt="" /><br />
<a href="http://blog.17study.com.cn/2018/01/11/tensorFlow-series-6/">ã€Šä»é”…ç‚‰å·¥åˆ°AIä¸“å®¶(6)ã€‹</a>ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬æŠŠç¥ç»ç½‘ç»œæ¨¡å‹é™ç»´ï¼Œç®€å•çš„åœ¨äºŒç»´ç©ºé—´ä¸­ä»‹ç»äº†è¿‡æ‹Ÿåˆå’Œæ¬ æ‹Ÿåˆçš„ç°è±¡å’Œè§£å†³æ–¹æ³•ã€‚ä½†æ˜¯å› ä¸ºæ¡ä»¶æ‰€é™ï¼Œåœ¨è¯¥æ–‡ä¸­æˆ‘ä»¬åªä»‹ç»äº†ç†è®ºï¼Œå¹¶æ²¡æœ‰å®é™…è§‚å¯Ÿç°è±¡å’Œåº”å¯¹ã€‚<br />
ç°åœ¨æœ‰äº†TensorFLow 2.0 / Kerasçš„æ”¯æŒï¼Œå¯ä»¥éå¸¸å®¹æ˜“çš„æ„å»ºæ¨¡å‹ã€‚æˆ‘ä»¬å¯ä»¥æ–¹ä¾¿çš„äººå·¥æ¨¡æ‹Ÿè¿‡æ‹Ÿåˆçš„æƒ…å½¢ï¼Œå®é™…æ¥æ“ä½œç›‘æ§ã€è°ƒæ•´æ¨¡å‹ï¼Œä»è€Œæ˜¾è‘—æ”¹å–„æ¨¡å‹æŒ‡æ ‡ã€‚</p>

<h4 id="ä»å›¾ä¸­è¯†åˆ«è¿‡æ‹Ÿåˆå’Œæ¬ æ‹Ÿåˆ">ä»å›¾ä¸­è¯†åˆ«è¿‡æ‹Ÿåˆå’Œæ¬ æ‹Ÿåˆ</h4>
<p>å…ˆå€Ÿç”¨ä¸Šä¸€ç¯‡çš„ä¸¤ç»„å›¾ï¼š<br />
<img src="/attachments/201904/tensorFlow2/regression_mae_mse.png" alt="" />
<img src="/attachments/201904/tensorFlow2/regression_mae_mse2.png" alt="" />
å…ˆçœ‹ä¸Šè¾¹çš„ä¸€ç»„å›¾ï¼Œéšç€è®­ç»ƒè¿­ä»£æ¬¡æ•°çš„å¢åŠ ï¼Œé¢„æµ‹çš„é”™è¯¯ç‡è¿…é€Ÿä¸‹é™ã€‚<br />
æˆ‘ä»¬ä¸Šä¸€ç¯‡ä¸­è®²ï¼Œè¾¾åˆ°ä¸€å®šè¿­ä»£æ¬¡æ•°ä¹‹åï¼ŒéªŒè¯çš„é”™è¯¯ç‡å°±ç¨³å®šä¸å˜äº†ã€‚å®é™…ä¸Šä½ ä»”ç»†è§‚å¯Ÿï¼Œè®­ç»ƒé›†çš„é”™è¯¯ç‡åœ¨ç¨³å®šä¸‹é™ï¼Œä½†éªŒè¯é›†çš„é”™è¯¯ç‡è¿˜ä¼šç•¥æœ‰ä¸Šå‡ã€‚ä¸¤è€…ä¹‹é—´çš„å·®å¼‚è¶Šæ¥è¶Šå¤§ï¼Œå›¾ä¸­çš„ä¸¤æ¡æ›²çº¿ï¼Œæ˜¾è‘—åˆ†ç¦»äº†ï¼Œå¹¶ä¸”åˆ†ç¦»çš„è¶‹åŠ¿è¿˜åœ¨å¢åŠ ã€‚è¿™å°±æ˜¯è¿‡æ‹Ÿåˆçš„å…¸å‹ç‰¹å¾ã€‚<br />
è¿™è¡¨ç¤ºï¼Œæ¨¡å‹è¿‡åˆ†é€‚åº”äº†å½“å‰çš„è®­ç»ƒé›†æ•°æ®ï¼Œå¯¹äºè®­ç»ƒé›†æ•°æ®æœ‰äº†è¾ƒå¥½è¡¨ç°ã€‚å¯¹äºä¹‹å¤–çš„æ•°æ®ï¼Œåè€Œä¸é€‚åº”ï¼Œä»è€Œæ•ˆæœå¾ˆå·®ã€‚<br />
è¿™é€šå¸¸éƒ½æ˜¯ç”±äºè¾ƒå°çš„æ•°æ®æ ·æœ¬é€ æˆçš„ã€‚å¦‚æœæ•°æ®é›†è¶³å¤Ÿå¤§ï¼Œè¾ƒå¤šçš„è®­ç»ƒé€šå¸¸éƒ½èƒ½è®©æ¨¡å‹è¡¨ç°çš„æ›´å¥½ã€‚è¿‡æ‹Ÿåˆå¯¹äºç”Ÿäº§ç¯å¢ƒä¼¤å®³æ˜¯æ¯”è¾ƒå¤§çš„ï¼Œå› ä¸ºç”Ÿäº§ä¸­å¤§å¤šæ¥æ”¶åˆ°çš„éƒ½æ˜¯æ–°æ•°æ®ï¼Œè€Œè¿‡æ‹Ÿåˆæ— æ³•å¯¹è¿™äº›æ–°æ•°æ®è¾¾æˆè¾ƒå¥½è¡¨ç°ã€‚<br />
æ‰€ä»¥å¦‚æœæ•°æ®é›†ä¸å¤Ÿçš„æƒ…å†µä¸‹ï¼Œé‡‡ç”¨é€‚å½“çš„è¿­ä»£æ¬¡æ•°å¯èƒ½æ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚è¿™ä¹Ÿæ˜¯ä¸Šä¸€èŠ‚æˆ‘ä»¬é‡‡ç”¨EarlyStoppingæœºåˆ¶çš„åŸå› ä¹‹ä¸€ã€‚æœ€ç»ˆçš„è¡¨ç°æ˜¯ä¸Šè¾¹ä¸‹é¢ä¸€ç»„å›¾çš„æ ·å­ã€‚<br />
æ¬ æ‹Ÿåˆä¸æ­¤ç›¸åï¼Œè¡¨ç¤ºæ¨¡å‹è¿˜æœ‰è¾ƒå¤§æ”¹å–„ç©ºé—´ã€‚ä¸Šé¢ä¸¤ç»„å›¾ä¸­ï¼Œå·¦ä¾§ä¸‹é™æ²¿çš„æ›²çº¿éƒ½å¯ä»¥è®¤ä¸ºæ˜¯æ¬ æ‹Ÿåˆã€‚è¡¨ç°ç‰¹å¾æ˜¯æ— è®ºæµ‹è¯•é›†è¿˜æ˜¯éªŒè¯é›†ï¼Œéƒ½æ²¡æœ‰è¶³å¤Ÿçš„æ­£ç¡®ç‡ã€‚å½“ç„¶ä¹Ÿå› æ­¤ï¼Œæµ‹è¯•é›†å’ŒéªŒè¯é›†è¡¨ç°ç±»ä¼¼ï¼Œæ‹Ÿåˆéå¸¸ç´§å¯†ã€‚<br />
æ¬ æ‹Ÿåˆçš„æƒ…å†µï¼Œé™¤äº†è®­ç»ƒä¸è¶³ä¹‹å¤–ï¼Œæ¨¡å‹ä¸å¤Ÿå¼ºå¤§æˆ–è€…æˆ–è€…æ¨¡å‹ä¸é€‚åˆä¸šåŠ¡æƒ…å†µéƒ½æ˜¯å¯èƒ½çš„åŸå› ã€‚</p>

<h4 id="å®éªŒæ¨¡æ‹Ÿè¿‡æ‹Ÿåˆ">å®éªŒæ¨¡æ‹Ÿè¿‡æ‹Ÿåˆ</h4>
<p>æˆ‘ä»¬ä½¿ç”¨IMDBå½±è¯„æ ·æœ¬åº“æ¥åšè¿™ä¸ªå®éªŒã€‚å®éªŒç¨‹åºä¸»è¦éƒ¨åˆ†æ¥è‡ªäº<a href="http://blog.17study.com.cn/2019/04/08/tensorflow-from-1-to-2-5/">æœ¬ç³»åˆ—ç¬¬äº”ç¯‡</a>ä¸­ç¬¬äºŒä¸ªä¾‹å­ï¼Œå½“ç„¶æœ‰è¾ƒå¤§çš„ä¿®æ”¹ã€‚<br />
ç¨‹åºä¸»è¦åˆ†ä¸ºå‡ ä¸ªéƒ¨åˆ†ï¼š</p>
<ul>
  <li>ä¸‹è½½IMDBå½±è¯„åº“ï¼ˆä»…ç¬¬ä¸€æ¬¡ï¼‰ï¼Œè½½å…¥å†…å­˜ï¼Œå¹¶åšå•è¯å‘é‡åŒ–ã€‚</li>
  <li>å•è¯å‘é‡åŒ–ç¼–ç ä½¿ç”¨äº†multi-hot-sequencesï¼Œè¿™ç§ç¼–ç è·Ÿone-hotç±»ä¼¼ï¼Œä½†ä¸€å¥è¯ä¸­æœ‰å¤šä¸ªå•è¯ï¼Œå› æ­¤ä¼šæœ‰å¤šä¸ªâ€™1â€™ã€‚ä¸€ä¸ªå½±è¯„å°±æ˜¯ä¸€ä¸ª0ã€1åºåˆ—ã€‚è¿™ç§ç¼–ç æ¨¡å‹éå¸¸æœ‰ç”¨ï¼Œä½†åœ¨æœ¬ä¾‹ä¸­ï¼Œæ•°æ®æ­§ä¹‰ä¼šæ›´å¤šï¼Œæ›´å®¹æ˜“å‡ºç°è¿‡æ‹Ÿåˆã€‚</li>
  <li>å®šä¹‰baseline/small/bigä¸‰ä¸ªä¸åŒè§„æ¨¡çš„ç¥ç»ç½‘ç»œæ¨¡å‹ï¼Œå¹¶åˆ†åˆ«ç¼–è¯‘è®­ç»ƒï¼Œè®­ç»ƒæ—¶ä¿å­˜è¿‡ç¨‹æ•°æ®ã€‚</li>
  <li>ä½¿ç”¨ä¸‰ç»„è¿‡ç¨‹æ•°æ®ç»˜åˆ¶æ›²çº¿å›¾ï¼ŒæŒ‡æ ‡æ˜¯binary_crossentropyï¼Œè¿™æ˜¯æˆ‘ä»¬ç»å¸¸å½“åšæŸå¤±å‡½æ•°ä½¿ç”¨çš„æŒ‡å¾ï¼Œè¿™ä¸ªå€¼åœ¨æ­£å¸¸è®­ç»ƒçš„æ—¶å€™æ”¶æ•›åˆ°è¶Šå°è¶Šå¥½ã€‚</li>
</ul>

<p>ç¨‹åºä¸­ï¼Œæ–‡æœ¬çš„ç¼–ç æ–¹å¼ã€æ¨¡å‹éƒ½å¹¶ä¸æ˜¯å¾ˆåˆç†ï¼Œå› ä¸ºæˆ‘ä»¬ä¸æ˜¯æƒ³å¾—åˆ°ä¸€ä¸ªæœ€ä¼˜çš„æ¨¡å‹ï¼Œè€Œæ˜¯æƒ³æ¼”ç¤ºè¿‡æ‹Ÿåˆçš„åœºæ™¯ã€‚</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">unicode_literals</span>

<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="n">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="n">NUM_WORDS</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="c1"># è½½å…¥IMDBæ ·æœ¬æ•°æ®
</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">train_labels</span><span class="p">),</span> <span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">test_labels</span><span class="p">)</span> <span class="o">=</span> <span class="n">keras</span><span class="p">.</span><span class="n">datasets</span><span class="p">.</span><span class="n">imdb</span><span class="p">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">num_words</span><span class="o">=</span><span class="n">NUM_WORDS</span><span class="p">)</span>

<span class="c1"># å°†å•è¯æ•°å­—åŒ–ï¼Œè½¬åŒ–ä¸ºmulti-hotåºåˆ—ç¼–ç æ–¹å¼
</span><span class="k">def</span> <span class="nf">multi_hot_sequences</span><span class="p">(</span><span class="n">sequences</span><span class="p">,</span> <span class="n">dimension</span><span class="p">):</span>
    <span class="c1"># å»ºç«‹ä¸€ä¸ªç©ºçŸ©é˜µä¿å­˜ç»“æœ
</span>    <span class="n">results</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">sequences</span><span class="p">),</span> <span class="n">dimension</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">word_indices</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sequences</span><span class="p">):</span>
        <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">word_indices</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># å‡ºç°è¿‡çš„è¯è®¾ç½®ä¸º1.0
</span>    <span class="k">return</span> <span class="n">results</span>

<span class="n">train_data</span> <span class="o">=</span> <span class="n">multi_hot_sequences</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">dimension</span><span class="o">=</span><span class="n">NUM_WORDS</span><span class="p">)</span>
<span class="n">test_data</span> <span class="o">=</span> <span class="n">multi_hot_sequences</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">dimension</span><span class="o">=</span><span class="n">NUM_WORDS</span><span class="p">)</span>

<span class="c1"># å»ºç«‹baselineæ¨¡å‹ï¼Œå¹¶ç¼–è¯‘è®­ç»ƒ
</span><span class="n">baseline_model</span> <span class="o">=</span> <span class="n">keras</span><span class="p">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="c1"># æŒ‡å®š`input_shape`ä»¥ä¿è¯ä¸‹é¢çš„.summary()å¯ä»¥æ‰§è¡Œï¼Œ
</span>    <span class="c1"># å¦åˆ™åœ¨æ¨¡å‹ç»“æ„æ— æ³•ç¡®å®š
</span>    <span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">NUM_WORDS</span><span class="p">,)),</span>
    <span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">),</span>
    <span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'sigmoid'</span><span class="p">)</span>
<span class="p">])</span>
<span class="n">baseline_model</span><span class="p">.</span><span class="nb">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="s">'adam'</span><span class="p">,</span>
                       <span class="n">loss</span><span class="o">=</span><span class="s">'binary_crossentropy'</span><span class="p">,</span>
                       <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s">'accuracy'</span><span class="p">,</span> <span class="s">'binary_crossentropy'</span><span class="p">])</span>
<span class="n">baseline_model</span><span class="p">.</span><span class="n">summary</span><span class="p">()</span>
<span class="n">baseline_history</span> <span class="o">=</span> <span class="n">baseline_model</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span>
                                      <span class="n">train_labels</span><span class="p">,</span>
                                      <span class="n">epochs</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                                      <span class="n">batch_size</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span>
                                      <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">test_labels</span><span class="p">),</span>
                                      <span class="n">verbose</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="c1"># å°æ¨¡å‹å®šä¹‰ã€ç¼–è¯‘ã€è®­ç»ƒ
</span><span class="n">smaller_model</span> <span class="o">=</span> <span class="n">keras</span><span class="p">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">NUM_WORDS</span><span class="p">,)),</span>
    <span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">),</span>
    <span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'sigmoid'</span><span class="p">)</span>
<span class="p">])</span>
<span class="n">smaller_model</span><span class="p">.</span><span class="nb">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="s">'adam'</span><span class="p">,</span>
                      <span class="n">loss</span><span class="o">=</span><span class="s">'binary_crossentropy'</span><span class="p">,</span>
                      <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s">'accuracy'</span><span class="p">,</span> <span class="s">'binary_crossentropy'</span><span class="p">])</span>
<span class="n">smaller_model</span><span class="p">.</span><span class="n">summary</span><span class="p">()</span>
<span class="n">smaller_history</span> <span class="o">=</span> <span class="n">smaller_model</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span>
                                    <span class="n">train_labels</span><span class="p">,</span>
                                    <span class="n">epochs</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                                    <span class="n">batch_size</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span>
                                    <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">test_labels</span><span class="p">),</span>
                                    <span class="n">verbose</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="c1"># å¤§æ¨¡å‹å®šä¹‰ã€ç¼–è¯‘ã€è®­ç»ƒ
</span><span class="n">bigger_model</span> <span class="o">=</span> <span class="n">keras</span><span class="p">.</span><span class="n">models</span><span class="p">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">NUM_WORDS</span><span class="p">,)),</span>
    <span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">),</span>
    <span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'sigmoid'</span><span class="p">)</span>
<span class="p">])</span>

<span class="n">bigger_model</span><span class="p">.</span><span class="nb">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="s">'adam'</span><span class="p">,</span>
                     <span class="n">loss</span><span class="o">=</span><span class="s">'binary_crossentropy'</span><span class="p">,</span>
                     <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s">'accuracy'</span><span class="p">,</span><span class="s">'binary_crossentropy'</span><span class="p">])</span>

<span class="n">bigger_model</span><span class="p">.</span><span class="n">summary</span><span class="p">()</span>
<span class="n">bigger_history</span> <span class="o">=</span> <span class="n">bigger_model</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">train_labels</span><span class="p">,</span>
                                  <span class="n">epochs</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                                  <span class="n">batch_size</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span>
                                  <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">test_labels</span><span class="p">),</span>
                                  <span class="n">verbose</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># ç»˜å›¾å‡½æ•°
</span><span class="k">def</span> <span class="nf">plot_history</span><span class="p">(</span><span class="n">histories</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s">'binary_crossentropy'</span><span class="p">):</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">history</span> <span class="ow">in</span> <span class="n">histories</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">history</span><span class="p">.</span><span class="n">epoch</span><span class="p">,</span> <span class="n">history</span><span class="p">.</span><span class="n">history</span><span class="p">[</span><span class="s">'val_'</span><span class="o">+</span><span class="n">key</span><span class="p">],</span>
            <span class="s">'--'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">name</span><span class="p">.</span><span class="n">title</span><span class="p">()</span><span class="o">+</span><span class="s">' Val'</span><span class="p">)</span>
        <span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">history</span><span class="p">.</span><span class="n">epoch</span><span class="p">,</span> <span class="n">history</span><span class="p">.</span><span class="n">history</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">get_color</span><span class="p">(),</span>
            <span class="n">label</span><span class="o">=</span><span class="n">name</span><span class="p">.</span><span class="n">title</span><span class="p">()</span><span class="o">+</span><span class="s">' Train'</span><span class="p">)</span>

    <span class="n">plt</span><span class="p">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'Epochs'</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">'_'</span><span class="p">,</span><span class="s">' '</span><span class="p">).</span><span class="n">title</span><span class="p">())</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="n">plt</span><span class="p">.</span><span class="n">xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="nb">max</span><span class="p">(</span><span class="n">history</span><span class="p">.</span><span class="n">epoch</span><span class="p">)])</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>


<span class="c1"># ç»˜åˆ¶ä¸‰ä¸ªæ¨¡å‹çš„ä¸‰ç»„æ›²çº¿
</span><span class="n">plot_history</span><span class="p">([(</span><span class="s">'baseline'</span><span class="p">,</span> <span class="n">baseline_history</span><span class="p">),</span>
              <span class="p">(</span><span class="s">'smaller'</span><span class="p">,</span> <span class="n">smaller_history</span><span class="p">),</span>
              <span class="p">(</span><span class="s">'bigger'</span><span class="p">,</span> <span class="n">bigger_history</span><span class="p">)])</span>

</code></pre></div></div>
<p>ç¨‹åºåœ¨å‘½ä»¤è¡Œçš„è¾“å‡ºå°±ä¸è´´å‡ºæ¥äº†ï¼Œé™¤äº†è¾“å‡ºçš„è®­ç»ƒè¿­ä»£è¿‡ç¨‹ï¼Œåœ¨ä¹‹å‰è¿˜è¾“å‡ºäº†æ¯ä¸ªæ¨¡å‹çš„summary()ã€‚è¿™é‡Œä¸»è¦çœ‹æœ€åçš„binary_crossentropyæ›²çº¿å›¾ã€‚<br />
<img src="/attachments/201904/tensorFlow2/imdb-overfitting.png" alt="" /><br />
å›¾ä¸­çš„è™šçº¿éƒ½æ˜¯éªŒè¯é›†æ•°æ®çš„è¡¨ç°ï¼Œå®çº¿æ˜¯è®­ç»ƒé›†æ•°æ®çš„è¡¨ç°ã€‚ä¸‰ä¸ªæ¨¡å‹çš„è®­ç»ƒæ•°æ®å’Œæµ‹è¯•æ•°æ®äº¤å‰ç†µæ›²çº¿éƒ½å‡ºç°äº†è¾ƒå¤§çš„åˆ†ç¦»ï¼Œä»£è¡¨å‡ºç°äº†è¿‡æ‹Ÿåˆã€‚å°¤å…¶æ˜¯biggeræ¨¡å‹çš„ä¸¤æ¡ç»¿çº¿ï¼Œå‡ ä¹æ˜¯ä¸€å¼€å§‹å°±å‡ºç°äº†è¾ƒå¤§çš„èƒŒç¦»ã€‚</p>

<h4 id="ä¼˜åŒ–è¿‡æ‹Ÿåˆ">ä¼˜åŒ–è¿‡æ‹Ÿåˆ</h4>
<p>ä¼˜åŒ–è¿‡æ‹Ÿåˆé¦–å…ˆè¦çŸ¥é“è¿‡æ‹Ÿåˆäº§ç”Ÿçš„åŸå› ï¼Œæˆ‘ä»¬å€Ÿç”¨ä¸€å¼ å‰ä¸€ç³»åˆ—è®²è§£è¿‡æ‹Ÿåˆæ—¶å€™ç”¨è¿‡çš„å›¾ï¼Œæ˜¯å´æ©è¾¾è€å¸ˆè¯¾ç¨‹çš„ç¬”è®°ï¼š<br />
<img src="/attachments/201801/ml-nn/overfitting1.png" alt="" />
å¦‚æœä¸€ä¸ªæ¨¡å‹äº§ç”Ÿè¿‡æ‹Ÿåˆï¼Œé‚£è¿™ä¸ªæ¨¡å‹çš„æ€»ä½“æ•ˆæœå°±å¯èƒ½æ˜¯ä¸€ä¸ªéå¸¸å¤æ‚çš„éçº¿æ€§æ–¹ç¨‹ã€‚æ–¹ç¨‹éå¸¸åŠªåŠ›çš„å­¦ä¹ æ‰€æœ‰â€œå¯è§â€æ•°æ®ï¼Œå¯¼è‡´äº†å¤æ‚çš„æƒé‡å€¼ï¼Œä½¿å¾—æ›²çº¿å¼¯æ¥å¼¯å»ï¼Œå˜å¾—æä¸ºå¤æ‚ã€‚å¤šå±‚ç½‘ç»œæ›´åŠ å‰§äº†è¿™ç§å¤æ‚åº¦ï¼Œæœ€ç»ˆçš„å¤æ‚æ›²çº¿ç»•å¼€äº†å¯è¡Œçš„åŒºåŸŸï¼Œåªå¯¹å±€éƒ¨çš„å¯è§æ•°æ®æœ‰æ•ˆï¼Œå¯¹äºå®é™…æ•°æ®å‘½ä¸­ç‡ä½ã€‚æ‰€ä»¥ä»æˆ‘ä»¬ç¨‹åºè·‘çš„ç»“æœå›¾æ¥çœ‹ï¼Œä¹Ÿæ˜¯è¶Šå¤æ‚çš„ç½‘ç»œæ¨¡å‹ï¼Œè¿‡æ‹Ÿåˆç°è±¡åè€Œè¶Šä¸¥é‡ã€‚<br />
è¿™ä¹ˆè¯´ç®€å•çš„æ¨¡å‹å°±å¥½å–½ï¼Ÿå¹¶éå¦‚æ­¤ï¼Œå¤ªç®€å•çš„æ¨¡å‹å¾€å¾€æ— æ³•è¡¨è¾¾å¤æ‚çš„é€»è¾‘ï¼Œä»è€Œäº§ç”Ÿæ¬ æ‹Ÿåˆã€‚å…¶å®çœ‹çœ‹æˆç†Ÿçš„é‚£äº›æ¨¡å‹æ¯”å¦‚ResNet50ï¼Œéƒ½æ˜¯éå¸¸å¤æ‚çš„ç»“æ„ã€‚<br />
è¿‡æ‹Ÿåˆæ—¢ç„¶äº§ç”Ÿçš„ä¸»è¦åŸå› æ˜¯åœ¨æƒé‡å€¼ä¸Šï¼Œæˆ‘ä»¬åœ¨è¿™æ–¹é¢åšå·¥ä½œå³å¯ã€‚</p>

<h4 id="å¢åŠ æƒé‡çš„è§„èŒƒåŒ–">å¢åŠ æƒé‡çš„è§„èŒƒåŒ–</h4>
<p>é€šå¸¸æœ‰ä¸¤ç§æ–¹æ³•ï¼Œç§°ä¸ºL1è§„èŒƒåŒ–å’ŒL2è§„èŒƒåŒ–ã€‚å‰è€…ä¸ºä»£ä»·å€¼å¢åŠ ä¸€å®šæ¯”ä¾‹çš„æƒé‡å€¼çš„ç»å¯¹å€¼ã€‚åè€…å¢åŠ ä¸€å®šæ¯”ä¾‹æƒé‡å€¼çš„å¹³æ–¹å€¼ã€‚å…·ä½“çš„å®ç°æ¥æºäºå…¬å¼ï¼Œæœ‰å…´è¶£çš„å¯ä»¥å‚è€ƒä¸€ä¸‹è¿™ç¯‡æ–‡ç« <a href="https://medium.com/datadriveninvestor/l1-l2-regularization-7f1b4fe948f2">ã€ŠL1 and L2 Regularizationã€‹</a>ã€‚<br />
æˆ‘ä»¬åˆ é™¤æ‰ä¸Šé¢æºç ä¸­çš„biggeræ¨¡å‹å’Œsmallæ¨¡å‹çš„éƒ¨åˆ†ï¼ŒåŒ…æ‹¬æ¨¡å‹çš„æ„å»ºã€ç¼–è¯‘å’Œè®­ç»ƒï¼Œæ·»åŠ ä¸‹é¢çš„ä»£ç ï¼š</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># æ„å»ºä¸€ä¸ªL2è§„èŒƒåŒ–çš„æ¨¡å‹
</span><span class="n">l2_model</span> <span class="o">=</span> <span class="n">keras</span><span class="p">.</span><span class="n">models</span><span class="p">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">kernel_regularizer</span><span class="o">=</span><span class="n">keras</span><span class="p">.</span><span class="n">regularizers</span><span class="p">.</span><span class="n">l2</span><span class="p">(</span><span class="mf">0.001</span><span class="p">),</span>
                       <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">NUM_WORDS</span><span class="p">,)),</span>
    <span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">kernel_regularizer</span><span class="o">=</span><span class="n">keras</span><span class="p">.</span><span class="n">regularizers</span><span class="p">.</span><span class="n">l2</span><span class="p">(</span><span class="mf">0.001</span><span class="p">),</span>
                       <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">),</span>
    <span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'sigmoid'</span><span class="p">)</span>
<span class="p">])</span>

<span class="n">l2_model</span><span class="p">.</span><span class="nb">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="s">'adam'</span><span class="p">,</span>
                 <span class="n">loss</span><span class="o">=</span><span class="s">'binary_crossentropy'</span><span class="p">,</span>
                 <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s">'accuracy'</span><span class="p">,</span> <span class="s">'binary_crossentropy'</span><span class="p">])</span>

<span class="n">l2_model_history</span> <span class="o">=</span> <span class="n">l2_model</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">train_labels</span><span class="p">,</span>
                                <span class="n">epochs</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                                <span class="n">batch_size</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span>
                                <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">test_labels</span><span class="p">),</span>
                                <span class="n">verbose</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div></div>
<p>è¿™ä¸ªæ¨¡å‹çš„é€»è¾‘ç»“æ„åŒbaselineçš„æ¨¡å‹å®Œå…¨ä¸€è‡´ï¼Œåªæ˜¯åœ¨å‰ä¸¤å±‚ä¸­å¢åŠ äº†L2è§„èŒƒåŒ–çš„è®¾ç½®å‚æ•°ã€‚<br />
å…ˆä¸ç€æ€¥è¿è¡Œï¼Œæˆ‘ä»¬ç»§ç»­å¦å¤–ä¸€ç§æ–¹æ³•ã€‚</p>

<h4 id="æ·»åŠ dropout">æ·»åŠ DropOut</h4>
<p>DropOutæ˜¯æˆ‘ä»¬åœ¨ä¸Šä¸ªç³»åˆ—ä¸­å·²ç»è®²è¿‡çš„æ–¹æ³•ï¼Œåº”ç”¨çš„å¾ˆå¹¿æ³›ä¹Ÿéå¸¸æœ‰æ•ˆã€‚<br />
å…¶æœºç†éå¸¸ç®€å•ï¼Œå°±æ˜¯åœ¨ä¸€å±‚ç½‘ç»œä¸­ï¼Œâ€œä¸¢å¼ƒâ€ä¸€å®šæ¯”ä¾‹çš„è¾“å‡ºï¼ˆè®¾ç½®ä¸ºæ•°å€¼0ï¼‰ç»™ä¸‹ä¸€å±‚ã€‚ä¸¢å¼ƒçš„æ¯”ä¾‹é€šå¸¸è®¾ç½®ä¸º0.2è‡³0.5ã€‚è¿™ä¸ªè¿‡ç¨‹åªåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­æœ‰æ•ˆï¼Œä¸€èˆ¬ä¼šåœ¨é¢„æµ‹è¿‡ç¨‹ä¸­å…³é—­è¿™ä¸ªæœºåˆ¶ã€‚<br />
æˆ‘ä»¬ç»§ç»­åœ¨ä¸Šé¢ä»£ç ä¸­ï¼Œæ·»åŠ ä¸€ç»„é‡‡ç”¨DropOutæœºåˆ¶çš„æ¨¡å‹ï¼Œæ¨¡å‹çš„åŸºæœ¬ç»“æ„ä¾ç„¶åŒbaselineç›¸åŒï¼š</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="n">dpt_model</span> <span class="o">=</span> <span class="n">keras</span><span class="p">.</span><span class="n">models</span><span class="p">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">NUM_WORDS</span><span class="p">,)),</span>
    <span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span>
    <span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">),</span>
    <span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span>
    <span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'sigmoid'</span><span class="p">)</span>
<span class="p">])</span>

<span class="n">dpt_model</span><span class="p">.</span><span class="nb">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="s">'adam'</span><span class="p">,</span>
                  <span class="n">loss</span><span class="o">=</span><span class="s">'binary_crossentropy'</span><span class="p">,</span>
                  <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s">'accuracy'</span><span class="p">,</span><span class="s">'binary_crossentropy'</span><span class="p">])</span>

<span class="n">dpt_model_history</span> <span class="o">=</span> <span class="n">dpt_model</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_data</span><span class="p">,</span> <span class="n">train_labels</span><span class="p">,</span>
                                  <span class="n">epochs</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                                  <span class="n">batch_size</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span>
                                  <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">test_data</span><span class="p">,</span> <span class="n">test_labels</span><span class="p">),</span>
                                  <span class="n">verbose</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
		<span class="p">....</span>
<span class="c1"># æœ€åçš„ç»˜å›¾å‡½æ•°ä¸å˜ï¼Œç»˜å›¾è¯­å¥ä¿®æ”¹å¦‚ä¸‹ï¼š
</span><span class="n">plot_history</span><span class="p">([</span>
            <span class="p">(</span><span class="s">'baseline'</span><span class="p">,</span> <span class="n">baseline_history</span><span class="p">),</span>
            <span class="p">(</span><span class="s">'l2'</span><span class="p">,</span> <span class="n">l2_model_history</span><span class="p">),</span>
            <span class="p">(</span><span class="s">'dropout'</span><span class="p">,</span> <span class="n">dpt_model_history</span><span class="p">)])</span>
</code></pre></div></div>
<p>ç°åœ¨å¯ä»¥æ‰§è¡Œç¨‹åºäº†ã€‚<br />
ç¨‹åºè·å¾—çš„æ›²çº¿å›¾å¦‚ä¸‹ï¼Œå›¾ä¸­å¯è§ï¼Œæˆ‘ä»¬åœ¨ä¸é™ä½æ¨¡å‹çš„å¤æ‚åº¦çš„æƒ…å†µä¸‹ï¼ŒL2è§„èŒƒåŒ–(é»„è‰²æ›²çº¿)å’ŒDropOutï¼ˆç»¿è‰²æ›²çº¿ï¼‰éƒ½æœ‰æ•ˆçš„æ”¹å–„äº†æ¨¡å‹çš„è¿‡æ‹Ÿåˆé—®é¢˜ã€‚<br />
<img src="/attachments/201904/tensorFlow2/imdb-overfitting2.png" alt="" /></p>

<p>ï¼ˆå¾…ç»­â€¦ï¼‰</p>

:ET