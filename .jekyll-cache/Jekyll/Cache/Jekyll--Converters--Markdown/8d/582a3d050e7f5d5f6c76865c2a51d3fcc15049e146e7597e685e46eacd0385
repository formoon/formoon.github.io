I"Éî<p><img src="http://115.182.41.123/files/201904/tensorFlow2/tf-logo-card-2.png" alt="" /></p>

<h4 id="åŸºæœ¬æ¦‚å¿µ">åŸºæœ¬æ¦‚å¿µ</h4>
<p>â€œå˜åˆ†è‡ªåŠ¨ç¼–ç å™¨â€(Variational Autoencodersï¼Œç¼©å†™:VAE)çš„æ¦‚å¿µæ¥è‡ªDiederik P Kingmaå’ŒMax Wellingçš„è®ºæ–‡<a href="https://arxiv.org/abs/1312.6114">ã€ŠAuto-Encoding Variational Bayesã€‹</a>ã€‚ç°åœ¨æœ‰äº†å¾ˆå¹¿æ³›çš„åº”ç”¨ï¼Œåº”ç”¨èŒƒå›´å·²ç»è¿œè¿œè¶…å‡ºäº†å½“æ—¶è®ºæ–‡çš„è®¾æƒ³ã€‚ä¸è¿‡çœ‹èµ·æ¥ä¼¼ä¹ï¼Œå›½å†…è¿˜æ²¡æœ‰è§åˆ°ä»€ä¹ˆç›¸å…³äº§å“å‡ºç°ã€‚</p>

<p>ä½œä¸ºæ™®åŠå‹çš„æ–‡ç« ï¼Œä»‹ç»â€œå˜åˆ†è‡ªåŠ¨ç¼–ç å™¨â€ï¼Œè¦å…ˆä»ç¼–ç è¯´èµ·ã€‚<br />
ç®€å•è¯´ï¼Œç¼–ç å°±æ˜¯æ•°å­—åŒ–ï¼Œå‰é¢ç¬¬å…­ç¯‡æˆ‘ä»¬å·²ç»ä»‹ç»äº†ä¸€äº›å¸¸è§çš„ç¼–ç æ–¹æ³•ã€‚æ¯”å¦‚å¯¹äºä¸€å¥è¯ï¼šâ€œIt is easy to be wise after the event.â€ã€‚ä½¿ç”¨åºåˆ—ç¼–ç çš„æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥è®¾å®š1ä»£è¡¨it,2ä»£è¡¨is,3ä»£è¡¨easy,ä»¥æ­¤ç±»æ¨ï¼Œå°±å¥½åƒæˆ‘ä»¬æœºå™¨ç¿»è¯‘ç¨‹åºä¸­ç¬¬ä¸€æ­¥ç¼–ç åšçš„é‚£æ ·ã€‚å›¾ç‰‡ä¹Ÿæ˜¯ä¸€æ ·ï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥è®©1ä»£è¡¨çŒ«çŒ«çš„ç…§ç‰‡ï¼Œ2ä»£è¡¨ç‹—ç‹—çš„ç…§ç‰‡ã€‚<br />
æœ‰ç¼–ç å¯¹åº”å°±æœ‰è§£ç ï¼Œè§£ç æ˜¯ç¼–ç çš„åè¿‡ç¨‹ï¼Œæ¯”å¦‚è§åˆ°1å°±è¿˜åŸæˆâ€œitâ€ï¼Œæˆ–è€…è¿˜åŸæˆä¸€å¹…çŒ«çŒ«çš„ç…§ç‰‡ã€‚<br />
è¿™æ ·çš„ç¼–ç å¦‚æ­¤ç®€å•ï¼Œçœ‹ä¸Šå»å…¶å®æ ¹æœ¬ä¸éœ€è¦æœ‰ä»€ä¹ˆâ€œè‡ªåŠ¨ç¼–ç å™¨â€å­˜åœ¨ã€‚</p>

<p>ä½†è¿™äº›ç¼–ç æ˜¯æ²¡æœ‰â€œçµé­‚â€çš„ï¼Œæ‰€è°“æ²¡æœ‰çµé­‚ï¼Œå°±æ˜¯é™¤éä½ ä¿ç•™äº†å®Œæ•´çš„å¯¹ç…§è¡¨å’ŒåŸå§‹æ•°æ®ï¼Œå¦åˆ™ä½ çœ‹åˆ°1æ²¡åŠæ³•çŸ¥é“1ä»£è¡¨æ˜¯it,ä¹Ÿæ²¡åŠæ³•çŸ¥é“1ä»£è¡¨çŒ«çŒ«çš„ç…§ç‰‡ã€‚ç”šè‡³å³ä¾¿ä½ çŸ¥é“1ä»£è¡¨çŒ«çŒ«ï¼Œä½†çŒ«çŒ«å›¾ç‰‡é‚£ä¹ˆå¤šï¼Œç©¶ç«Ÿæ˜¯å“ªå¼ çŒ«çŒ«çš„ç…§ç‰‡ï¼Œä½ è¿˜æ˜¯ä¸çŸ¥é“ã€‚<br />
è¿™ä¸ªåªæœ‰æ™ºæ…§ç”Ÿç‰©æ‰å…·æœ‰çš„â€œçµé­‚â€ï¼ŒæŠŠç¼–ç çš„éš¾åº¦æé«˜äº†æ— æ•°å€ã€‚<br />
ä½†è¿™æ˜¯åˆç†çš„ï¼Œå°±æ¯”å¦‚ä½ è§åˆ°ä¸€åªçŒ«çŒ«ï¼Œä½ å¿ƒä¸­ä¼šæƒ³â€œè¿™æ˜¯ä¸€åªçŒ«â€ï¼›æœ‰äººç»™ä½ è¯´â€œæˆ‘åˆšæ‰è§åˆ°äº†ä¸€åªæ©˜çŒ«â€ï¼Œä½ è„‘æµ·ä¸­ä¼šå‡ºç°ä¸€åªå–èŒçš„åŠ è²ï¼Œä¹Ÿè®¸é¡ºä¾¿è¿˜åœ¨æƒ³â€œååªæ©˜çŒ«ä¹åªèƒ–â€ã€‚è¿™ä¸ªåŠ¨ä½œæ¥è‡ªäºä½ æ€ç»´ä¸­çš„é•¿æœŸç§¯ç´¯å½¢æˆçš„æ¦‚å¿µåŒ–å’Œè”æƒ³ï¼Œä¹Ÿå®è´¨ä¸Šç›¸å½“äºç¼–ç è¿‡ç¨‹ã€‚ä½ å¿ƒä¸­çš„â€œè‡ªåŠ¨ç¼–ç å™¨â€æ— æ—¶ä¸åœ¨é«˜æ•ˆçš„è¿è½¬ï¼Œåªä¸è¿‡æˆ‘ä»¬å·²ç»ä¹ ä»¥ä¸ºå¸¸ï¼Œè¿™ä¸ªâ€œè‡ªåŠ¨ç¼–ç å™¨â€å°±æ˜¯äººçš„æ™ºæ…§ã€‚è¿™ä¸ªâ€œè‡ªåŠ¨ç¼–ç å™¨â€çš„ç»ˆæç›®æ ‡å°±æ˜¯å¯èƒ½â€œæ— ä¸­ç”Ÿæœ‰â€ã€‚</p>

<p>ä¸Šä¸€èŠ‚ç¥ç»ç½‘ç»œç¿»è¯‘ï¼Œæˆ‘ä»¬çŸ¥é“è¿™ä¸ªç¼–ç ç»“æœå®é™…å°±æ˜¯ç¥ç»ç½‘ç»œå¯¹äºä¸€å¥è¯çš„ç†è§£ã€‚å¯¹äºè‡ªç„¶è¯­è¨€å¦‚æ­¤ï¼Œå¯¹äºå›¾åŒæ ·å¦‚æ­¤ã€‚<br />
æ·±åº¦å­¦ä¹ æŠ€æœ¯çš„å‘å±•ä¸ºè‡ªåŠ¨ç¼–ç å™¨èµ‹äºˆäº†â€œçµé­‚â€ï¼Œè‡ªåŠ¨ç¼–ç å™¨è¿…é€Ÿçš„å‡ºç°äº†å¾ˆå¤šã€‚æˆ‘ä»¬æ—©å°±ç†Ÿæ‚‰çš„åˆ†ç±»ç®—æ³•å°±å±äºå…¸å‹çš„è‡ªåŠ¨ç¼–ç å™¨ï¼Œå³ä¾¿ä»–ä»¬ä¸€å¼€å§‹è¡¨ç°çš„å¹¶ä¸åƒåœ¨å¹²è¿™ä¸ªã€‚æŒ‰ç…§æŸç§è§„åˆ™ï¼ŒæŠŠå…·æœ‰ç›¸åŒæ€§è´¨çš„æ•°æ®ï¼Œåˆ†é…åˆ°æŸä¸€ç±»ï¼Œäº§ç”Ÿç›¸åŒçš„ç¼–ç â€”â€”è¿™å°±æ˜¯åˆ†ç±»ç®—æ³•å¹²çš„ã€‚ä¸åƒè‡ªåŠ¨ç¼–ç å™¨çš„åŸå› ä¸»è¦æ˜¯åœ¨å­¦ä¹ çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å®é™…éƒ½ä½¿ç”¨äº†æ ‡æ³¨ä¹‹åçš„è®­ç»ƒé›†ï¼Œè¿™ä¸ªæ ‡æ³¨æœ¬èº«å°±æ˜¯äººä¸ºåˆ†ç±»çš„è¿‡ç¨‹ï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸ä¸Šè‡ªåŠ¨ã€‚ä½†ä¹Ÿæœ‰å¾ˆå¤šåˆ†ç±»ç®—æ³•æ˜¯ä¸éœ€è¦æ ‡æ³¨æ•°æ®çš„ï¼Œæ¯”å¦‚K-meansèšç±»ç®—æ³•ã€‚<br />
<img src="http://115.182.41.123/files/201904/tensorFlow2/vae1.jpg" alt="" /><br />
ä¸€ä¸ªåŸºäºæ·±åº¦å­¦ä¹ æ¨¡å‹çš„ç¼–ç å™¨å¯ä»¥è½»æ¾çš„ç»è¿‡è®­ç»ƒï¼ŒæŠŠä¸€å¹…å›¾ç‰‡è½¬æ¢ä¸ºä¸€ç»„æ•°æ®ã€‚å†é€šè¿‡è®­ç»ƒå¥½çš„æ¨¡å‹ï¼ˆä½ å¯ä»¥ç†è§£ä¸ºå­˜å‚¨æœ‰ä¿¡æ¯çš„æ¨¡å‹ï¼‰ï¼Œå®Œæ•´æŠŠç¼–ç æ•°æ®è¿˜åŸåˆ°å›¾ç‰‡ã€‚NMTæœºå™¨ç¿»è¯‘ï¼Œä¹Ÿç®—çš„ä¸Šå®ç°äº†è¿™ä¸ªè¿‡ç¨‹ã€‚<br />
æ‰€ä»¥åœ¨å›¾ç‰‡åº”ç”¨ä¸­çš„è‡ªåŠ¨ç¼–ç å™¨ï¼Œæœ€ç»ˆçš„æ•ˆæœæ›´ç±»ä¼¼äºå‹ç¼©å™¨æˆ–è€…å­˜å‚¨å™¨ï¼ŒæŠŠä¸€å¹…å›¾ç‰‡çš„æ•°æ®é‡é™ä½ã€‚éšåè§£ç å™¨æŠŠè¿™ä¸ªè¿‡ç¨‹é€†è½¬ï¼Œä»ä¸€ç»„å°çš„æ•°æ®é‡è¿˜åŸä¸ºå®Œæ•´çš„å›¾ç‰‡ã€‚</p>

<h4 id="å˜åˆ†è‡ªåŠ¨ç¼–ç å™¨">å˜åˆ†è‡ªåŠ¨ç¼–ç å™¨</h4>
<p>ä¼ ç»Ÿçš„è‡ªåŠ¨ç¼–ç å™¨ä¹‹æ‰€ä»¥æ›´ç±»ä¼¼äºå‹ç¼©å™¨æˆ–è€…å­˜å‚¨å™¨ã€‚åœ¨äºæ‰€ç”Ÿæˆçš„æ•°æ®ï¼ˆç¼–ç ç»“æœã€å‹ç¼©ç»“æœï¼‰åŸºæœ¬æ˜¯ç¡®å®šçš„ï¼Œè€Œè§£ç åè¿˜åŸçš„ç»“æœï¼Œä¹ŸåŸºæœ¬æ˜¯ç¡®å®šçš„ã€‚è¿™ä¸ªç¡®å®šæ€§é€šå¸¸æ˜¯ä¸€ç§ä¼˜ç‚¹ï¼Œä½†ä¹Ÿå¾€å¾€é™åˆ¶äº†æƒ³åƒåŠ›ã€‚</p>

<p>å˜åˆ†è‡ªåŠ¨ç¼–ç å™¨æœ€åˆçš„ç›®çš„åº”å½“ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œç®—æ˜¯ä¸€ç§ç¼–è§£ç å™¨çš„å®ç°ã€‚æœ€å¤§çš„ç‰¹ç‚¹æ˜¯é¦–å…ˆåšäº†ä¸€ä¸ªé¢„è®¾ï¼Œå°±æ˜¯ç¼–ç çš„ç»“æœä¸æ˜¯æŸä¸ªç¡®è®¤çš„å€¼ï¼Œè€Œæ˜¯ä¸€ä¸ªèŒƒå›´ã€‚ç®—æ³•è®¤ä¸ºç¼–ç çš„ç»“æœï¼Œæ ¹æ®åˆ†ç±»çš„ä¸åŒï¼Œç›®æ ‡å€¼åº”å½“å¹³å‡åˆ†å¸ƒåœ¨ä¸€ä¸ªèŒƒå›´å†…ã€‚è¿™æ ·è®¾è®¡æ˜¯éå¸¸åˆç†çš„ï¼Œå¹³å‡åˆ†å¸ƒåœ¨ä¸€ä¸ªèŒƒå›´ï¼Œæ‰èƒ½ä¿è¯ç¼–ç ç©ºé—´çš„åˆ©ç”¨ç‡æœ€å¤§åŒ–å¹¶ä¸”ç›¸è¿‘ç±»ä¹‹é—´åˆæœ‰è‰¯å¥½çš„åŒºåˆ†åº¦ã€‚<br />
å¦‚ä½•è¡¨ç¤ºä¸€ä¸ªèŒƒå›´å‘¢ï¼Ÿè®ºæ–‡ä¸­ä½¿ç”¨äº†å¹³å‡å€¼å’Œæ–¹å·®ã€‚ä¹Ÿå°±æ˜¯è¡¨ç¤ºï¼Œå¤šå¹…å›¾ç‰‡çš„ç¼–ç ç»“æœå€¼ï¼Œå¹³å‡åˆ†å¸ƒåœ¨å¹³å‡å€¼ä¸¤ä¾§çš„æ–¹å·®èŒƒå›´å†…ã€‚ä¹Ÿå¯ä»¥è¯´ç¬¦åˆé«˜æ–¯åˆ†å¸ƒæˆ–è€…æ­£æ€åˆ†å¸ƒã€‚åœ¨æœ¬ä¾‹çš„ç¨‹åºä¸­ï¼ˆæœ¬ä¾‹ä¸­çš„ä»£ç æ¥è‡ªTensorFlowå®˜æ–¹æ–‡æ¡£ï¼‰ï¼Œä½¿ç”¨äº†å¹³å‡å€¼å’Œå¯¹æ•°æ–¹å·®ï¼Œä»æ•°å­¦æ€§èƒ½ä¸Šï¼Œå¯¹æ•°æ–¹å·®æ•°å€¼ä¼šæ›´ç¨³å®šã€‚åŸºæœ¬åŸç†æ˜¯ç›¸åŒçš„ã€‚<br />
è¿™æ ·ä¸€ä¸ªæ”¹å˜ï¼Œä½¿å¾—ç¼–ç ç»“æœæœ‰äº†å¾ˆå¤šæœ‰è¶£çš„æ–°ç‰¹å¾ã€‚æ¯”å¦‚å¯¹äºç¼–ç ç»“æœçš„å€¼è¿›è¡Œå¾®è°ƒï¼Œç„¶åå†è§£ç è¿˜åŸä¹‹åï¼Œç”Ÿæˆçš„å›¾ç‰‡å¯èƒ½ä¼šäº§ç”Ÿäº†ä¸€äº›ä»¤äººå…´å¥‹çš„å˜åŒ–ã€‚<br />
ä»èµ„æ–™ä»‹ç»çš„æƒ…å†µçœ‹ï¼ˆ<a href="https://www.youtube.com/watch?v=9zKuYvjFFS8">å‚è€ƒèµ„æ–™</a>ï¼‰ï¼Œæ¯”å¦‚å¯¹ä¸€ç»„äººè„¸ç…§ç‰‡è¿›è¡Œç¼–ç ï¼Œè°ƒæ•´ç¼–ç çš„æŸä¸ªæ•°å€¼é¡¹ï¼Œç»“æœçš„äººè„¸è‚¤è‰²å¯èƒ½å‘ç”Ÿå˜åŒ–ï¼›è°ƒæ•´å¦å¤–ä¸€ä¸ªæ•°å€¼ï¼Œäººè„¸çš„æœå‘å¯èƒ½å‘ç”Ÿäº†å˜åŒ–ã€‚<br />
æ¨¡å‹å°±æ­¤ä¼¼ä¹è·å¾—äº†ä»¤äººå…´å¥‹çš„åˆ›é€ èƒ½åŠ›ï¼Œè€ŒåŸæœ¬è¿™åº”å½“æ˜¯è‰ºæœ¯å®¶ã€äººç±»çš„é¢†åŸŸèŒƒå›´ã€‚<br />
å¦å¤–ä¸€ä¸ªä¾‹å­ä¸­ï¼Œé€šè¿‡å¯¹ä¸€ç»„åºåˆ—çš„è§†é¢‘å›¾ç‰‡çš„å­¦ä¹ ï¼Œéšååˆ å»å…¶ä¸­çš„ä¸€éƒ¨åˆ†ï¼Œæ¯”å¦‚ä¸€è¾†é©¶è¿‡çš„æ±½è½¦ã€‚ç„¶åä½¿ç”¨VAEé‡æ–°ç”Ÿæˆåˆ é™¤çš„ç”»é¢ï¼Œå¯ä»¥å®Œç¾å†ç°ç”»é¢çš„èƒŒæ™¯ï¼Œæ±½è½¦ä¼¼ä¹ä»æœªå‡ºç°åœ¨é‚£é‡Œã€‚è¿™æ ·çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬åœ¨æŸå¤§å…¬å¸çš„å›¾åƒã€è§†é¢‘å¤„ç†è½¯ä»¶ä¸­å·²ç»è§åˆ°äº†å•†ä¸šåŒ–çš„å®ç°ï¼ˆNeural Inpaintingï¼‰ã€‚<br />
<img src="http://115.182.41.123/files/201904/tensorFlow2/vae-neural-inpainting0.jpg" alt="" /></p>

<h4 id="ç¨‹åºè¦ç‚¹">ç¨‹åºè¦ç‚¹</h4>
<p>æœ¬ç¤ºä¾‹ç¨‹åºä¸­ä½¿ç”¨çš„è®­ç»ƒå›¾ç‰‡ï¼Œå°±æ˜¯æ‰‹å†™æ•°å­—çš„æ ·æœ¬åº“ï¼Œè¿™æ˜¯æˆ‘ä»¬æœ€å®¹æ˜“è·å–åˆ°çš„æ ·æœ¬é›†ã€‚<br />
æˆ‘ä»¬å¸Œæœ›ç»è¿‡å¤§é‡çš„è®­ç»ƒä¹‹åï¼ŒVAEæ¨¡å‹èƒ½å¤Ÿè‡ªåŠ¨çš„ç”Ÿæˆå¯ä»¥ä¹±çœŸçš„æ‰‹å†™å­—ç¬¦å›¾ç‰‡ã€‚<br />
<img src="http://115.182.41.123/files/201904/tensorFlow2/vae-mnist0.jpeg" alt="" /><br />
(MNISTæ‰‹å†™æ•°å­—æ ·æœ¬å›¾ç‰‡)<br />
ç¨‹åºä¸€å¼€å§‹ï¼Œå…ˆè½½å…¥MNISTæ ·æœ¬åº“ã€‚æ ¹æ®æ¨¡å‹å·ç§¯å±‚çš„éœ€è¦ï¼Œå°†æ ·æœ¬æ•´å½¢ä¸ºæ ·æœ¬æ•°é‡xå®½xé«˜xè‰²æ·±çš„å½¢å¼ã€‚æœ€åæŠŠæ ·æœ¬è§„èŒƒåŒ–ä¸ºèƒŒæ™¯è‰²ä¸º0ã€å‰æ™¯ç¬”ç”»ä¸º1çš„å¼ é‡æ•°æ®ã€‚</p>

<p>ç¨‹åºè®­ç»ƒçš„ç»“æœï¼Œæ˜¯ä½¿ç”¨éšæœºç”Ÿæˆçš„ç¼–ç å‘é‡ï¼Œè¿˜åŸä¸ºæ‰‹å†™çš„æ•°å­—å›¾ç‰‡ã€‚å› ä¸ºç¼–ç æ˜¯éšæœºç”Ÿæˆçš„ï¼Œæ‰€ä»¥ä¸åŒçš„ç¼–ç ï¼Œç”Ÿæˆçš„å›¾ç‰‡ä¸å¯èƒ½å®Œå…¨å»åˆåŸæœ‰çš„æ ·æœ¬é›†ï¼Œè€Œè¿™ç§åˆç†çš„å·®å¼‚ï¼Œæ›´ç±»ä¼¼äººè‡ªå·±æ¯æ¬¡æ‰‹å†™çš„å­—ä½“â€”â€”å¤§ä½“ä¸Šæ˜¯ä¸€è‡´çš„ï¼Œä½†æœ‰å¾ˆå¤šç»†å¾®çš„åŒºåˆ«ã€‚çœ‹èµ·æ¥å°±å¥½åƒè®¡ç®—æœºæœ‰äº†äººçš„æ™ºæ…§ï¼Œåœ¨å­¦ä¹ äº†å¾ˆå¤šæ‰‹å†™æ•°å­—çš„æ ·æœ¬åï¼Œè‡ªå·±ä¹Ÿèƒ½æ‰‹å†™æ•°å­—ã€‚<br />
<img src="http://115.182.41.123/files/201904/tensorFlow2/vae-epoch99.png" alt="" /><br />
(VAEç»è¿‡100æ¬¡è®­ç»ƒè¿­ä»£åï¼Œç”Ÿæˆçš„æ‰‹å†™æ•°å­—æ ·æœ¬å›¾ç‰‡)<br />
ä¸‹é¢å°±æ˜¯éšæœºç”Ÿæˆ4æ ¼x4æ ¼å…±16ä¸ªæ ·æœ¬ç¼–ç å‘é‡ï¼Œæ¯ä¸ªå‘é‡é•¿åº¦æ˜¯50ä¸ªæµ®ç‚¹æ•°ï¼š</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="p">...</span>
<span class="n">latent_dim</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">num_examples_to_generate</span> <span class="o">=</span> <span class="mi">16</span>
	<span class="p">...</span>
<span class="n">random_vector_for_generation</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">normal</span><span class="p">(</span>
    <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="n">num_examples_to_generate</span><span class="p">,</span> <span class="n">latent_dim</span><span class="p">])</span>
</code></pre></div></div>
<p>è¿™ä¸€ç»„ç¼–ç åœ¨æ•´ä¸ªç¨‹åºä¸­æ˜¯ä¿æŒä¸å˜çš„ï¼Œè¿™æ ·æ¯æ¬¡ç”Ÿæˆçš„å›¾ç‰‡æ˜¯ç›¸åŒçš„ä¸€ç»„æ•°å­—ï¼Œä»è€Œï¼Œèƒ½è§‚å¯Ÿåˆ°ä»æœ€åˆç”Ÿæˆçš„ä¸€ç»„ç™½å™ªå£°ï¼Œä¸€ç‚¹ç‚¹æ¸…æ™°ï¼Œåˆ°ç¬¬100æ¬¡è¿­ä»£çš„æ—¶å€™è¾ƒä¸ºå¯ä»¥è¾¨åˆ«çš„æ‰‹å†™æ•°å­—ã€‚</p>

<p>ç¨‹åºçš„ç¼–ç æ¨¡å‹ï¼ˆæ¨ç†æ¨¡å‹ï¼‰å’Œè§£ç æ¨¡å‹ï¼ˆç”Ÿæˆæ¨¡å‹ï¼‰è™½ç„¶ç•¥å¾®å¤æ‚ï¼Œä½†åœ¨Keras.Sequentialçš„å¸®åŠ©ä¸‹çœ‹ä¸Šå»ä¹Ÿæ²¡æœ‰ä»€ä¹ˆã€‚çœŸæ­£å¤æ‚çš„æ˜¯ç¨‹åºçš„ä»£ä»·å‡½æ•°å’Œä»£ä»·å€¼çš„è®¡ç®—ã€‚<br />
å› ä¸ºæ¨¡å‹çš„ä»£ä»·å€¼æ˜¯çœŸå®å›¾ç‰‡åŒç”Ÿæˆå›¾ç‰‡ä¹‹é—´çš„å¯¹æ¯”ï¼Œä¹˜ä¸Šæ¯æ‰¹æ¬¡100å¹…æ ·æœ¬å›¾ç‰‡ï¼Œæ˜¯ä¸€ä¸ªæ¯”è¾ƒå¤§çš„æ•°æ®é‡ï¼Œå†è€ƒè™‘ç¼–ç æ‰€ä½¿ç”¨çš„èŒƒå›´æ–¹å¼ï¼ŒVAEä½¿ç”¨äº†ä¸€ä¸ªæ–°çš„è®¡ç®—æ–¹æ³•ã€‚è¿™éƒ¨åˆ†å…¬å¼è¯·å‚è€ƒæœ¬æ–‡å¼€å¤´é“¾æ¥çš„è®ºæ–‡ã€‚åœ¨ç¨‹åºä¸­ï¼ŒæŠŠå…¬å¼ä½¿ç”¨ä»£ç å®ç°æ˜¯ä¸‹é¢ä¸¤ä¸ªå‡½æ•°ï¼š</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># è®¡ç®—ä»£ä»·å€¼
</span><span class="k">def</span> <span class="nf">log_normal_pdf</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">logvar</span><span class="p">,</span> <span class="n">raxis</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">log2pi</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">math</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="n">pi</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tf</span><span class="p">.</span><span class="n">reduce_sum</span><span class="p">(</span>
        <span class="o">-</span><span class="p">.</span><span class="mi">5</span> <span class="o">*</span> <span class="p">((</span><span class="n">sample</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">**</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">tf</span><span class="p">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">logvar</span><span class="p">)</span> <span class="o">+</span> <span class="n">logvar</span> <span class="o">+</span> <span class="n">log2pi</span><span class="p">),</span>
        <span class="n">axis</span><span class="o">=</span><span class="n">raxis</span><span class="p">)</span>
<span class="c1"># ä»£ä»·å‡½æ•°
</span><span class="k">def</span> <span class="nf">compute_loss</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="c1"># ç¼–ç ä¸€ä¸ªæ‰¹æ¬¡ï¼ˆ100ï¼‰çš„å›¾ç‰‡
</span>    <span class="n">mean</span><span class="p">,</span> <span class="n">logvar</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="c1"># éšæœºç”Ÿæˆ100ä¸ªå‡åŒ€åˆ†å¸ƒçš„ç¼–ç å‘é‡
</span>    <span class="n">z</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">reparameterize</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">logvar</span><span class="p">)</span>
    <span class="c1"># ä½¿ç”¨ç¼–ç å‘é‡ç”Ÿæˆå›¾ç‰‡
</span>    <span class="n">x_logit</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>

    <span class="c1"># ä¸‹é¢æ˜¯ä»£ä»·ä¹‹è®¡ç®—ï¼Œç»“æ„å¾ˆå¤æ‚ï¼Œä½†æ¥æºæ˜¯ç”Ÿæˆå›¾ç‰‡å’Œæ ·æœ¬å›¾ç‰‡çš„å¯¹æ¯”
</span>    <span class="n">cross_ent</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="n">sigmoid_cross_entropy_with_logits</span><span class="p">(</span><span class="n">logits</span><span class="o">=</span><span class="n">x_logit</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
    <span class="n">logpx_z</span> <span class="o">=</span> <span class="o">-</span><span class="n">tf</span><span class="p">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">cross_ent</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
    <span class="n">logpz</span> <span class="o">=</span> <span class="n">log_normal_pdf</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="n">logqz_x</span> <span class="o">=</span> <span class="n">log_normal_pdf</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">logvar</span><span class="p">)</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">tf</span><span class="p">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">logpx_z</span> <span class="o">+</span> <span class="n">logpz</span> <span class="o">-</span> <span class="n">logqz_x</span><span class="p">)</span>
</code></pre></div></div>

<p>ç¼–ç å‘é‡çš„é•¿åº¦å€¼æ˜¯ä¸€å¼€å§‹å°±ç¡®å®šçš„ï¼Œæœ¬ä¾‹ä¸­æ˜¯50ã€‚è¿™ä¸ªé•¿åº¦æ ¹æ®éœ€è¦å¯ä»¥è°ƒæ•´ï¼Œä»£è¡¨äº†ç¼–ç æ‰€å ç”¨çš„å­˜å‚¨ç©ºé—´ã€‚ç¼–ç å¦‚æœæ¯”è¾ƒé•¿ï¼Œèƒ½åŒ…å«çš„å›¾ç‰‡ç»†èŠ‚å°±å¤šï¼Œè¿˜åŸçš„å›¾ç‰‡å®¹æ˜“åšåˆ°æ›´å»åˆåŸå›¾ã€‚ç¼–ç å¦‚æœçŸ­ï¼Œå‡†ç¡®çš„ç¼–ç æœ¬èº«ä¸€èˆ¬ä¸ä¼šæœ‰å¤§çš„é—®é¢˜ï¼Œä½†ç¼–ç ç¨æœ‰å˜åŒ–ï¼Œç»“æœçš„å›¾ç‰‡å˜åŒ–å¯èƒ½å°±å¾ˆå¤§ã€‚è¿™ç›¸å½“äºç­‰çº§æ¯”ä¾‹çš„å˜åŒ–ï¼Œå¾ˆå®¹æ˜“ç†è§£ã€‚ æ¯æ¬¡ç¼–ç å®Œæˆåï¼Œå¾—åˆ°çš„æ˜¯å¹³å‡å€¼å’Œå¯¹æ•°æ–¹å·®ã€‚æ˜¯è¡¨ç¤ºèŒƒå›´çš„é‡ï¼Œåœ¨æœ¬ä¾‹ä¸­ï¼Œè¿™ä¸ªèŒƒå›´ä»£è¡¨äº†100å‰¯å›¾ç‰‡çš„ç¼–ç ã€‚è€Œè§£ç çš„æ—¶å€™ï¼Œè§£ç å™¨è‚¯å®šéœ€è¦æŒ‡å®šå…·ä½“æŸå¹…å›¾ç‰‡çš„ç¼–ç å‘é‡å€¼ï¼Œè€Œä¸èƒ½æ˜¯ä¸€ä¸ªèŒƒå›´ã€‚ç¨‹åºä½¿ç”¨ä¸‹é¢çš„å‡½æ•°åœ¨æŒ‡å®šèŒƒå›´å†…ç”Ÿæˆ100ä¸ªç¼–ç å‘é‡çš„æ•°ç»„ï¼š</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1"># åœ¨å‘é‡ç©ºé—´å†…å‡åŒ€åˆ†å¸ƒç”Ÿæˆ100ä¸ªéšæœºç¼–ç 
</span>    <span class="k">def</span> <span class="nf">reparameterize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">logvar</span><span class="p">):</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">normal</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">mean</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">eps</span> <span class="o">*</span> <span class="n">tf</span><span class="p">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logvar</span> <span class="o">*</span> <span class="p">.</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">mean</span>
</code></pre></div></div>
<p>å†æ¬¡æé†’è¿™é‡Œä½¿ç”¨çš„æ˜¯å¯¹æ•°æ–¹å·®ï¼Œæ‰€ä»¥è·Ÿè®ºæ–‡ä¸­çš„å…¬å¼æœ‰åŒºåˆ«ã€‚<br />
æ­¤å¤–æ³¨æ„è¿™é‡Œæ¯æ¬¡ç”Ÿæˆçš„100ä¸ªéšæœºç¼–ç ï¼ŒåŒè®­ç»ƒé›†å®šä¹‰çš„æ¯ä¸ªæ‰¹æ¬¡100ä¸ªæ ·æœ¬çš„æ•°é‡ï¼Œæ˜¯å¿…é¡»å»åˆçš„ã€‚è¿™æ ·ç”Ÿæˆçš„å›¾ç‰‡æ‰æ˜¯ç›¸åŒçš„æ•°é‡ï¼Œä»è€ŒåŒç›¸åŒæ•°é‡çš„æ ·æœ¬é›†å¯¹æ¯”è®¡ç®—ä»£ä»·å€¼ã€‚<br />
ç¨‹åºåœ¨è®­ç»ƒçš„æ¯æ¬¡è¿­ä»£ä¸­éƒ½ç”Ÿæˆä¸€å¼ ç›¸åŒç¼–ç å€¼ã€ç›¸åŒæ¨¡å‹ã€ä¸åŒé˜¶æ®µï¼ˆä¸åŒæ¨¡å‹æƒé‡ï¼‰å¾—å‡ºçš„è§£ç æ ·æœ¬å›¾ç‰‡ï¼Œä¿å­˜ä¸ºæ–‡ä»¶ï¼š</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># äº§ç”Ÿä¸€å¹…å›¾ç‰‡ï¼Œè¾“å‡ºçš„æ—¶å€™æ–‡ä»¶ååŠ ä¸Šè¿­ä»£æ¬¡æ•°
</span><span class="k">def</span> <span class="nf">generate_and_save_images</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">test_input</span><span class="p">):</span>
    <span class="c1"># ç”Ÿæˆ16å¹…æ ·æœ¬å›¾ç‰‡
</span>    <span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">sample</span><span class="p">(</span><span class="n">test_input</span><span class="p">)</span>
    <span class="c1"># 4æ ¼*4æ ¼å›¾ç‰‡
</span>    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

    <span class="c1"># for i in range(predictions.shape[0]):
</span>    <span class="c1"># ç”¨æ ·æœ¬ä¸­çš„å‰16å¹…ç”Ÿæˆä¸€å¼ 4x4æ’å¸ƒçš„æ±‡æ€»å›¾ç‰‡
</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="mi">4</span><span class="p">):</span>
        <span class="n">plt</span><span class="p">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">plt</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">predictions</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s">'gray'</span><span class="p">)</span>
        <span class="n">plt</span><span class="p">.</span><span class="n">axis</span><span class="p">(</span><span class="s">'off'</span><span class="p">)</span>

    <span class="c1"># æŠŠç”Ÿæˆçš„å›¾ç‰‡ä¿å­˜ä¸ºå›¾ç‰‡æ–‡ä»¶
</span>    <span class="n">plt</span><span class="p">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">'image_at_epoch_{:04d}.png'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">))</span>
    <span class="c1"># ä¹Ÿå¯ç›´æ¥æ˜¾ç¤ºåœ¨å±å¹•ä¸Šï¼Œä½†è®­ç»ƒè¿‡ç¨‹æ¯”è¾ƒæ…¢ï¼Œä½ ä¸ä¸€å®šæƒ³ç­‰ç€çœ‹
</span>    <span class="c1"># plt.show()
</span>    <span class="c1"># å¦‚æœå›¾ç‰‡åªæ˜¯ç”¨äºä¿å­˜è€Œéæ˜¾ç¤ºï¼Œåˆ™ä¸ä¼šæœ‰ç”¨æˆ·æ‰‹åŠ¨â€œå…³é—­â€å›¾ç‰‡çª—å£
</span>    <span class="c1"># pltå¯¹è±¡ä¹Ÿå°±æ— æ³•å…³é—­ï¼Œæ‰€ä»¥éœ€è¦æ˜¾ç¤ºçš„å…³é—­é‡Šæ”¾å†…å­˜ï¼Œç‰¹åˆ«æ˜¯æœ¬ä¾‹ä¸­å›¾ç‰‡æ•°é‡éå¸¸å¤š
</span>    <span class="n">plt</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div></div>
<p>æœ€åä¸€å…±ç”Ÿæˆ100å¼ å›¾ç‰‡ï¼Œå¦‚æœç”Ÿæˆä¸€å¼ gifåŠ¨å›¾ï¼Œé‚£çœ‹èµ·æ¥ä¼šå¯¹è®­ç»ƒè¿‡ç¨‹çš„è®¤è¯†æ ¼å¤–æ·±åˆ»ï¼š<br />
<img src="http://115.182.41.123/files/201904/tensorFlow2/vae-100all.gif" alt="" /><br />
ç”ŸæˆåŠ¨å›¾çš„ç¨‹åºä»£ç å¦‚ä¸‹ï¼Œå¯ä»¥å•ç‹¬å½¢æˆä¸€ä¸ªç¨‹åºæ‰§è¡Œï¼š</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">unicode_literals</span>

<span class="c1"># æ‰§è¡Œå‰è¯·å…ˆå®‰è£…imageioåº“
# pip3 install imageio
</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">PIL</span>
<span class="kn">import</span> <span class="nn">imageio</span>

<span class="c1"># éå†æ‰€æœ‰pngå›¾ç‰‡ï¼Œç”Ÿæˆä¸€å¼ gifåŠ¨å›¾
</span><span class="n">anim_file</span> <span class="o">=</span> <span class="s">'cvae-100-all.gif'</span>
<span class="k">with</span> <span class="n">imageio</span><span class="p">.</span><span class="n">get_writer</span><span class="p">(</span><span class="n">anim_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">'I'</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
    <span class="n">filenames</span> <span class="o">=</span> <span class="n">glob</span><span class="p">.</span><span class="n">glob</span><span class="p">(</span><span class="s">'image*.png'</span><span class="p">)</span>
    <span class="n">filenames</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span>
    <span class="n">last</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">filename</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filenames</span><span class="p">):</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">round</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">round</span><span class="p">(</span><span class="n">last</span><span class="p">):</span>
            <span class="n">last</span> <span class="o">=</span> <span class="n">frame</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">imageio</span><span class="p">.</span><span class="n">imread</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">writer</span><span class="p">.</span><span class="n">append_data</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="c1"># æœ€åä¸€å¼ å›¾ç‰‡æ˜¯æœ€ç»ˆæ•ˆæœå›¾ï¼Œå¤šå­˜ä¸€å¼ è®©æ˜¾ç¤ºæ—¶é—´é•¿ä¸€ç‚¹
</span>    <span class="n">image</span> <span class="o">=</span> <span class="n">imageio</span><span class="p">.</span><span class="n">imread</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">writer</span><span class="p">.</span><span class="n">append_data</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="å®Œæ•´vaeä»£ç ">å®Œæ•´VAEä»£ç </h4>
<p>æœ€åæ˜¯å®Œæ•´çš„VAEä»£ç ï¼Œè¯·å‚è€ƒæ³¨é‡Šé˜…è¯»ï¼š</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span>
<span class="c1"># å¼•å…¥æ‰€éœ€åº“
</span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">unicode_literals</span>

<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="n">tf</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="c1"># è¯»å–æ‰‹å†™å­—ä½“æ ·æœ¬é›†
</span><span class="p">(</span><span class="n">train_images</span><span class="p">,</span> <span class="n">_</span><span class="p">),</span> <span class="p">(</span><span class="n">test_images</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">datasets</span><span class="p">.</span><span class="n">mnist</span><span class="p">.</span><span class="n">load_data</span><span class="p">()</span>

<span class="c1"># é‡æ•´ä¸ºï¼šæ ·æœ¬æ•°xå®½xé«˜xè‰²æ·± çš„æ ¼å¼
</span><span class="n">train_images</span> <span class="o">=</span> <span class="n">train_images</span><span class="p">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">train_images</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="n">astype</span><span class="p">(</span><span class="s">'float32'</span><span class="p">)</span>
<span class="n">test_images</span> <span class="o">=</span> <span class="n">test_images</span><span class="p">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">test_images</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="n">astype</span><span class="p">(</span><span class="s">'float32'</span><span class="p">)</span>

<span class="c1"># è§„èŒƒåŒ–æ•°æ®åˆ°0-1æµ®ç‚¹
</span><span class="n">train_images</span> <span class="o">/=</span> <span class="mf">255.</span>
<span class="n">test_images</span> <span class="o">/=</span> <span class="mf">255.</span>

<span class="c1"># å°†æ•°æ®äºŒå€¼åŒ–ï¼ŒèƒŒæ™¯æ˜¯0ï¼Œç¬”ç”»æ˜¯1
</span><span class="n">train_images</span><span class="p">[</span><span class="n">train_images</span> <span class="o">&gt;=</span> <span class="p">.</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
<span class="n">train_images</span><span class="p">[</span><span class="n">train_images</span> <span class="o">&lt;</span> <span class="p">.</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
<span class="n">test_images</span><span class="p">[</span><span class="n">test_images</span> <span class="o">&gt;=</span> <span class="p">.</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
<span class="n">test_images</span><span class="p">[</span><span class="n">test_images</span> <span class="o">&lt;</span> <span class="p">.</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>

<span class="n">TRAIN_BUF</span> <span class="o">=</span> <span class="mi">60000</span>
<span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">100</span>

<span class="n">TEST_BUF</span> <span class="o">=</span> <span class="mi">10000</span>

<span class="c1"># è¿™é‡Œéœ€è¦æ³¨æ„ä¸€ä¸‹æ‰¹æ¬¡æ•°é‡æ˜¯100
</span><span class="n">train_dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">Dataset</span><span class="p">.</span><span class="n">from_tensor_slices</span><span class="p">(</span><span class="n">train_images</span><span class="p">).</span><span class="n">shuffle</span><span class="p">(</span><span class="n">TRAIN_BUF</span><span class="p">).</span><span class="n">batch</span><span class="p">(</span><span class="n">BATCH_SIZE</span><span class="p">)</span>
<span class="n">test_dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">Dataset</span><span class="p">.</span><span class="n">from_tensor_slices</span><span class="p">(</span><span class="n">test_images</span><span class="p">).</span><span class="n">shuffle</span><span class="p">(</span><span class="n">TEST_BUF</span><span class="p">).</span><span class="n">batch</span><span class="p">(</span><span class="n">BATCH_SIZE</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">CVAE</span><span class="p">(</span><span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">latent_dim</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CVAE</span><span class="p">,</span> <span class="bp">self</span><span class="p">).</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">latent_dim</span> <span class="o">=</span> <span class="n">latent_dim</span>
        <span class="c1"># æ¨ç†æ¨¡å‹ï¼Œç›¸å½“äºEncoderï¼Œç”¨äºæŠŠæ‰‹å†™æ•°å­—å›¾ç‰‡ï¼Œç¼–ç åˆ°å‘é‡
</span>        <span class="c1"># è¿™é‡Œå¾—åˆ°çš„ä¸ç›´æ¥æ˜¯å‘é‡æœ¬èº«ï¼Œè€Œæ˜¯å‘é‡çš„å‡å€¼å’Œå¯¹æ•°æ–¹å·®
</span>        <span class="c1"># åŸå› çœ‹æ–‡ä¸­çš„è§£é‡Š
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">inference_net</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">InputLayer</span><span class="p">(</span><span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
                <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">Conv2D</span><span class="p">(</span>
                    <span class="n">filters</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">),</span>
                <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">Conv2D</span><span class="p">(</span>
                    <span class="n">filters</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">),</span>
                <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">Flatten</span><span class="p">(),</span>
                <span class="c1"># å‡å€¼å’Œå¯¹æ•°æ–¹å·®çš„é•¿åº¦éƒ½æ˜¯latent_dimï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯ä¸¤ä¸ª
</span>                <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">latent_dim</span> <span class="o">+</span> <span class="n">latent_dim</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># ç”Ÿæˆæ¨¡å‹ï¼Œç›¸å½“äºDecoderï¼Œä½¿ç”¨ç¼–ç ç”Ÿæˆå¯¹åº”çš„æ‰‹å†™æ•°å­—å›¾ç‰‡
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">generative_net</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">InputLayer</span><span class="p">(</span><span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="n">latent_dim</span><span class="p">,)),</span>
                <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="mi">7</span><span class="o">*</span><span class="mi">7</span><span class="o">*</span><span class="mi">32</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="n">tf</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="n">relu</span><span class="p">),</span>
                <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">Reshape</span><span class="p">(</span><span class="n">target_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">32</span><span class="p">)),</span>
                <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">Conv2DTranspose</span><span class="p">(</span>
                    <span class="n">filters</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
                    <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                    <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                    <span class="n">padding</span><span class="o">=</span><span class="s">"SAME"</span><span class="p">,</span>
                    <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">),</span>
                <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">Conv2DTranspose</span><span class="p">(</span>
                    <span class="n">filters</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
                    <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                    <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                    <span class="n">padding</span><span class="o">=</span><span class="s">"SAME"</span><span class="p">,</span>
                    <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">),</span>
                <span class="c1"># No activation
</span>                <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">Conv2DTranspose</span><span class="p">(</span>
                    <span class="n">filters</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s">"SAME"</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="p">)</span>
    <span class="c1"># è·å–ä¸€ç™¾å¹…æ ·æœ¬å›¾ç‰‡
</span>    <span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">eps</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">eps</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">normal</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">latent_dim</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="n">eps</span><span class="p">,</span> <span class="n">apply_sigmoid</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c1"># ç¼–ç å™¨
</span>    <span class="k">def</span> <span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">mean</span><span class="p">,</span> <span class="n">logvar</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">inference_net</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">num_or_size_splits</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
		<span class="c1"># æ¯ä¸€æ­¥éƒ½ä¿å­˜ä¸€ä»½å¹³å‡å€¼å’Œå¯¹æ•°æ–¹å·®ï¼Œä»¥ä¾¿å°†æ¥ä½ å¯èƒ½æƒ³ç”Ÿæˆä¸€ç»„ç¬¦åˆå¹³å‡åˆ†å¸ƒçš„ç¼–ç 
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">mean</span> <span class="o">=</span> <span class="n">mean</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">logvar</span> <span class="o">=</span> <span class="n">logvar</span>
        <span class="k">return</span> <span class="n">mean</span><span class="p">,</span> <span class="n">logvar</span>

    <span class="c1"># åœ¨å‘é‡ç©ºé—´å†…å‡åŒ€åˆ†å¸ƒç”Ÿæˆ100ä¸ªéšæœºç¼–ç 
</span>    <span class="k">def</span> <span class="nf">reparameterize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">logvar</span><span class="p">):</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">normal</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">mean</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="c1"># tf.exp  is e^(logvar*0.5)
</span>        <span class="k">return</span> <span class="n">eps</span> <span class="o">*</span> <span class="n">tf</span><span class="p">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logvar</span> <span class="o">*</span> <span class="p">.</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">mean</span>

    <span class="c1"># è§£ç å™¨
</span>    <span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">apply_sigmoid</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">logits</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">generative_net</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">apply_sigmoid</span><span class="p">:</span>
            <span class="n">probs</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">logits</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">probs</span>

        <span class="k">return</span> <span class="n">logits</span>

<span class="n">optimizer</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">optimizers</span><span class="p">.</span><span class="n">Adam</span><span class="p">(</span><span class="mf">1e-4</span><span class="p">)</span>

<span class="c1"># ä»£ä»·å€¼çš„è®¡ç®—æ¯”è¾ƒå¤æ‚ï¼Œæ˜¯å…¬å¼çš„ç¼–ç¨‹å®ç°
</span><span class="k">def</span> <span class="nf">log_normal_pdf</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">logvar</span><span class="p">,</span> <span class="n">raxis</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">log2pi</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">math</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="n">pi</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tf</span><span class="p">.</span><span class="n">reduce_sum</span><span class="p">(</span>
        <span class="o">-</span><span class="p">.</span><span class="mi">5</span> <span class="o">*</span> <span class="p">((</span><span class="n">sample</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">**</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">tf</span><span class="p">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">logvar</span><span class="p">)</span> <span class="o">+</span> <span class="n">logvar</span> <span class="o">+</span> <span class="n">log2pi</span><span class="p">),</span>
        <span class="n">axis</span><span class="o">=</span><span class="n">raxis</span><span class="p">)</span>
<span class="c1"># ä»£ä»·å‡½æ•°
</span><span class="k">def</span> <span class="nf">compute_loss</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="c1"># ç¼–ç ä¸€ä¸ªæ‰¹æ¬¡ï¼ˆ100ï¼‰çš„å›¾ç‰‡
</span>    <span class="n">mean</span><span class="p">,</span> <span class="n">logvar</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="c1"># éšæœºç”Ÿæˆ100ä¸ªå‡åŒ€åˆ†å¸ƒçš„ç¼–ç å‘é‡
</span>    <span class="n">z</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">reparameterize</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">logvar</span><span class="p">)</span>
    <span class="c1"># ä½¿ç”¨ç¼–ç å‘é‡ç”Ÿæˆå›¾ç‰‡
</span>    <span class="n">x_logit</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>

    <span class="c1"># ä¸‹é¢æ˜¯ä»£ä»·ä¹‹è®¡ç®—ï¼Œç»“æ„å¾ˆå¤æ‚ï¼Œä½†æ¥æºæ˜¯ç”Ÿæˆå›¾ç‰‡å’Œæ ·æœ¬å›¾ç‰‡çš„å¯¹æ¯”
</span>    <span class="n">cross_ent</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="n">sigmoid_cross_entropy_with_logits</span><span class="p">(</span><span class="n">logits</span><span class="o">=</span><span class="n">x_logit</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
    <span class="n">logpx_z</span> <span class="o">=</span> <span class="o">-</span><span class="n">tf</span><span class="p">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">cross_ent</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
    <span class="n">logpz</span> <span class="o">=</span> <span class="n">log_normal_pdf</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="n">logqz_x</span> <span class="o">=</span> <span class="n">log_normal_pdf</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">logvar</span><span class="p">)</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">tf</span><span class="p">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">logpx_z</span> <span class="o">+</span> <span class="n">logpz</span> <span class="o">-</span> <span class="n">logqz_x</span><span class="p">)</span>

<span class="c1"># è¿›è¡Œä¸€æ¬¡è®­ç»ƒå’Œæ¢¯åº¦è¿­ä»£
</span><span class="k">def</span> <span class="nf">compute_gradients</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">tf</span><span class="p">.</span><span class="n">GradientTape</span><span class="p">()</span> <span class="k">as</span> <span class="n">tape</span><span class="p">:</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">compute_loss</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tape</span><span class="p">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">model</span><span class="p">.</span><span class="n">trainable_variables</span><span class="p">),</span> <span class="n">loss</span>

<span class="c1"># æ ¹æ®æ¢¯åº¦ä¸‹é™è®¡ç®—çš„ç»“æœï¼Œè°ƒæ•´æ¨¡å‹çš„æƒé‡å€¼
</span><span class="k">def</span> <span class="nf">apply_gradients</span><span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">gradients</span><span class="p">,</span> <span class="n">variables</span><span class="p">):</span>
    <span class="n">optimizer</span><span class="p">.</span><span class="n">apply_gradients</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">gradients</span><span class="p">,</span> <span class="n">variables</span><span class="p">))</span>

<span class="c1"># è®­ç»ƒè¿­ä»£100æ¬¡
</span><span class="n">epochs</span> <span class="o">=</span> <span class="mi">100</span>
<span class="c1"># ç¼–ç å‘é‡çš„ç»´åº¦
</span><span class="n">latent_dim</span> <span class="o">=</span> <span class="mi">50</span>
<span class="c1"># ç”¨äºç”Ÿæˆå›¾ç‰‡çš„æ ·æœ¬æ•°ï¼Œ4æ ¼x4æ ¼å…±16å¹…
</span><span class="n">num_examples_to_generate</span> <span class="o">=</span> <span class="mi">16</span>

<span class="c1"># éšæœºç”Ÿæˆ16ä¸ªç¼–ç å‘é‡ï¼Œåœ¨æ•´ä¸ªç¨‹åºè¿‡ç¨‹ä¸­ä¿æŒä¸å˜ï¼Œä»è€Œå¯ä»¥çœ‹åˆ°
# æ¯æ¬¡è¿­ä»£ï¼Œæ‰€ç”Ÿæˆçš„å›¾ç‰‡çš„æ•ˆæœåœ¨é€æ¬¡éƒ½åœ¨ä¼˜åŒ–ã€‚ç›¸åŒçš„ç¼–ç ä¼šç”Ÿæˆç›¸åŒçš„ç›®æ ‡æ•°å­—å›¾ç‰‡
</span><span class="n">random_vector_for_generation</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">normal</span><span class="p">(</span>
    <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="n">num_examples_to_generate</span><span class="p">,</span> <span class="n">latent_dim</span><span class="p">])</span>
<span class="c1"># æ¨¡å‹å®ä¾‹åŒ–
</span><span class="n">model</span> <span class="o">=</span> <span class="n">CVAE</span><span class="p">(</span><span class="n">latent_dim</span><span class="p">)</span>

<span class="c1"># äº§ç”Ÿä¸€å¹…å›¾ç‰‡ï¼Œè¾“å‡ºçš„æ—¶å€™æ–‡ä»¶ååŠ ä¸Šè¿­ä»£æ¬¡æ•°
</span><span class="k">def</span> <span class="nf">generate_and_save_images</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">test_input</span><span class="p">):</span>
    <span class="c1"># ç”Ÿæˆ16å¹…æ ·æœ¬å›¾ç‰‡
</span>    <span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">sample</span><span class="p">(</span><span class="n">test_input</span><span class="p">)</span>
    <span class="c1"># 4æ ¼*4æ ¼å›¾ç‰‡
</span>    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

    <span class="c1"># for i in range(predictions.shape[0]):
</span>    <span class="c1"># ç”¨æ ·æœ¬ä¸­çš„å‰16å¹…ç”Ÿæˆä¸€å¼ 4x4æ’å¸ƒçš„æ±‡æ€»å›¾ç‰‡
</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="mi">4</span><span class="p">):</span>
        <span class="n">plt</span><span class="p">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">plt</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">predictions</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s">'gray'</span><span class="p">)</span>
        <span class="n">plt</span><span class="p">.</span><span class="n">axis</span><span class="p">(</span><span class="s">'off'</span><span class="p">)</span>

    <span class="c1"># æŠŠç”Ÿæˆçš„å›¾ç‰‡ä¿å­˜ä¸ºå›¾ç‰‡æ–‡ä»¶
</span>    <span class="n">plt</span><span class="p">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">'image_at_epoch_{:04d}.png'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">))</span>
    <span class="c1"># ä¹Ÿå¯ç›´æ¥æ˜¾ç¤ºåœ¨å±å¹•ä¸Šï¼Œä½†è®­ç»ƒè¿‡ç¨‹æ¯”è¾ƒæ…¢ï¼Œä½ ä¸ä¸€å®šæƒ³ç­‰ç€çœ‹
</span>    <span class="c1"># plt.show()
</span>    <span class="c1"># å¦‚æœå›¾ç‰‡åªæ˜¯ç”¨äºä¿å­˜è€Œéæ˜¾ç¤ºï¼Œåˆ™ä¸ä¼šæœ‰ç”¨æˆ·æ‰‹åŠ¨â€œå…³é—­â€å›¾ç‰‡çª—å£
</span>    <span class="c1"># pltå¯¹è±¡ä¹Ÿå°±æ— æ³•å…³é—­ï¼Œæ‰€ä»¥éœ€è¦æ˜¾ç¤ºçš„å…³é—­é‡Šæ”¾å†…å­˜ï¼Œç‰¹åˆ«æ˜¯æœ¬ä¾‹ä¸­å›¾ç‰‡æ•°é‡éå¸¸å¤š
</span>    <span class="n">plt</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1"># å…ˆç”Ÿæˆç¬¬ä¸€å¹…ã€æœªç»è®­ç»ƒæƒ…å†µä¸‹çš„æ ·æœ¬å›¾ç‰‡ï¼Œæ‰€æœ‰çš„æ‰‹å†™å­—ç¬¦éƒ½è¿˜åœ¨éšæœºå™ªç‚¹çŠ¶æ€
</span><span class="n">generate_and_save_images</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">random_vector_for_generation</span><span class="p">)</span>

<span class="c1"># è®­ç»ƒå¾ªç¯
</span><span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">epochs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">train_x</span> <span class="ow">in</span> <span class="n">train_dataset</span><span class="p">:</span>
        <span class="c1"># è®­ç»ƒä¸€ä¸ªæ‰¹æ¬¡
</span>        <span class="n">gradients</span><span class="p">,</span> <span class="n">loss</span> <span class="o">=</span> <span class="n">compute_gradients</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">train_x</span><span class="p">)</span>
        <span class="n">apply_gradients</span><span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">gradients</span><span class="p">,</span> <span class="n">model</span><span class="p">.</span><span class="n">trainable_variables</span><span class="p">)</span>
    <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># åœ¨æ¯ä¸ªè¿­ä»£å¾ªç¯ç”Ÿæˆä¸€å¼ å›¾ç‰‡å’Œæ˜¾ç¤ºä¸€æ¬¡æ¨¡å‹ä¿¡æ¯
</span>    <span class="c1"># å¯ä»¥ä¿®æ”¹ä¸ºå¤šæ¬¡å¾ªç¯æ˜¾ç¤ºä¸€æ¬¡å’Œç”Ÿæˆä¸€å¼ å›¾ç‰‡
</span>    <span class="k">if</span> <span class="n">epoch</span> <span class="o">%</span> <span class="mi">1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">metrics</span><span class="p">.</span><span class="n">Mean</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">test_x</span> <span class="ow">in</span> <span class="n">test_dataset</span><span class="p">:</span>
            <span class="n">loss</span><span class="p">(</span><span class="n">compute_loss</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test_x</span><span class="p">))</span>
        <span class="n">elbo</span> <span class="o">=</span> <span class="o">-</span><span class="n">loss</span><span class="p">.</span><span class="n">result</span><span class="p">()</span>
        <span class="c1"># æ˜¾ç¤ºè¿­ä»£æ¬¡æ•°ã€æŸå¤±å€¼ã€å’Œæœ¬æ¬¡è¿­ä»£å¾ªç¯è€—æ—¶
</span>        <span class="k">print</span><span class="p">(</span><span class="s">"============================"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span>
            <span class="s">'Epoch: {}, Test set ELBO: {}, '</span>
            <span class="s">'time elapse for current epoch {}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span>
                <span class="n">epoch</span><span class="p">,</span>
                <span class="n">elbo</span><span class="p">,</span>
                <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>
        <span class="c1"># ç”Ÿæˆä¸€å¼ å›¾ç‰‡ä¿å­˜èµ·æ¥
</span>        <span class="n">generate_and_save_images</span><span class="p">(</span>
            <span class="n">model</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">random_vector_for_generation</span><span class="p">)</span>
</code></pre></div></div>
<p>æœ€ç»ˆè®­ç»ƒè¿­ä»£100æ¬¡åç”Ÿæˆçš„æ‰‹å†™æ•°å­—æ ·æœ¬å›¾ï¼Œè™½ç„¶å·²ç»å¾ˆæœ‰è¾¨è¯†åº¦ã€‚ä½†åŒäººå†™çš„æ•°å­—ä»ç„¶åŒºåˆ«å¾ˆå¤§ï¼ŒåŸå› æ˜¯ï¼Œäººæ‰‹å†™æ—¶å€™è¯¯å·®é€ æˆçš„å˜å½¢ï¼Œäººç±»å·²ç»çœ‹ä¹ æƒ¯äº†ï¼Œå‡ ä¹ä¸å¤ªå½±å“è¾¨åˆ«ã€‚è€Œæœºå™¨å½¢æˆçš„è¯¯å·®ï¼Œä»äººç±»çš„çœ¼å…‰ä¸­çœ‹èµ·æ¥ï¼Œå¾ˆæ€ªå¼‚ï¼Œç”šè‡³å½±å“è¯†åˆ«ã€‚è¿™å¹¶ä¸èƒ½è¯´æœºå™¨ç”Ÿæˆçš„æ‰‹å†™å­—ä½“å°±ä¸å¯¹ï¼Œè‡³å°‘åœ¨æœºå™¨å­¦ä¹ æ¨¡å‹çœ‹èµ·æ¥ï¼Œè¿™æ ·çš„å­—ä½“å·²ç»å¯ä»¥è¯†åˆ«äº†ã€‚<br />
æˆ‘ä»¬ç¨‹åºä¸€ç›´ä½¿ç”¨åŒä¸€ç»„éšæœºæ•°ç”Ÿæˆçš„å‘é‡æ¥ç”Ÿæˆæ‰‹å†™å­—ç¬¦å›¾ç‰‡ï¼Œæ‰€ä»¥ç”Ÿæˆçš„æ•°å­—ä¸€ç›´æ˜¯åŒä¸€ç»„ã€‚å¦‚æœç¨‹åºä¸­å†æ¬¡æ‰§è¡Œéšæœºç”Ÿæˆï¼Œå¾—åˆ°å¦å¤–ä¸€ç»„éšæœºæ•°ï¼Œé‚£è§£ç ç”Ÿæˆçš„æ‰‹å†™å›¾ç‰‡ï¼Œä¹ŸåŒæ ·ä¼šæ¢ä¸ºå¦å¤–ä¸€ç»„ï¼š<br />
<img src="http://115.182.41.123/files/201904/tensorFlow2/vae-epoch101.png" alt="" /><br />
å½“ç„¶ä½œä¸ºéšæœºæ•°ï¼Œæœ¬èº«çš„éšæ„æ€§ï¼Œæ‰€è§£ç è¿˜åŸçš„å›¾ç‰‡è¾¨è¯†åº¦ï¼Œä¹ŸåŸºæœ¬æ˜¯åŒæ ·çš„ç­‰çº§ã€‚æŒ‰ç…§100æ¬¡çš„è¿­ä»£è®­ç»ƒæ¥çœ‹ï¼Œä¹Ÿå°±æ˜¯æ¯”å„¿ç«¥æ¶‚é¸¦ç•¥å¥½ã€‚<br />
æˆ‘ä»¬å¼€å§‹è¯´è¿‡äº†ï¼ŒVAEçš„ç¼–ç ç›®æ ‡æ˜¯å¹³å‡åˆ†é…åœ¨ä¸€ä¸ªç¼–ç ç©ºé—´å†…çš„ï¼Œç¬¦åˆé«˜æ–¯åˆ†å¸ƒã€‚é‚£ä¹ˆæˆ‘ä»¬ç”Ÿæˆçš„éšæœºæ•°ç¼–ç ç¬¦åˆè¿™ä¸ªè¦æ±‚å—ï¼Ÿä½œä¸º50ä¸ªæµ®ç‚¹æ•°é•¿åº¦çš„å‘é‡ï¼Œè¿™ç§å¯èƒ½æ€§å‡ ä¹æ²¡æœ‰ã€‚å¦‚æœå¸Œæœ›å¾—åˆ°ä¸€ä¸ªç¬¦åˆæ­£å¤ªåˆ†å¸ƒçš„éšæœºç¼–ç å‘é‡ï¼Œéœ€è¦ä½¿ç”¨å‡½æ•°reparameterizeä¸­æä¾›çš„æ–¹æ³•ã€‚æ¯”å¦‚æˆ‘ä»¬ä½¿ç”¨è¿™ä¸ªæ–¹æ³•ï¼Œç”Ÿæˆä¸€ç»„ç¼–ç ï¼Œå†è¿˜åŸä¸ºå›¾ç‰‡çœ‹ä¸€çœ‹ï¼š<br />
<img src="http://115.182.41.123/files/201904/tensorFlow2/vae-repara-0127.png" alt="" /><br />
æ˜¯ä¸æ˜¯å‘ç°è§£ç è¿˜åŸçš„å›¾ç‰‡è¾¨è¯†åº¦é«˜äº†å¾ˆå¤šï¼ŸåŸå› å¾ˆç®€å•ï¼Œç¬¦åˆVAEç¼–ç è§„åˆ™çš„ç¼–ç ï¼Œæ‰€ç”Ÿæˆçš„å›¾ç‰‡ï¼Œæœ¬èº«å°±æ˜¯å’Œè®­ç»ƒæ ·æœ¬å›¾ç‰‡æœ€æ¥è¿‘ã€ä»£ä»·å€¼æœ€ä½çš„å›¾ç‰‡ã€‚è¿™åœ¨äººçš„çœ¼å…‰ä¸­çœ‹èµ·æ¥å¥½çœ‹ï¼Œå®é™…ä¸Šï¼ŒåŒæ™®é€šçš„ç¼–ç å™¨ä¹Ÿå°±æ²¡ä»€ä¹ˆåŒºåˆ«äº†ã€‚å› ä¸ºè¿™ç®—ä¸ä¸Šæ¨¡å‹â€œåˆ›é€ â€å‡ºæ¥çš„å›¾ç‰‡ï¼Œåªæ˜¯â€œå­˜å‚¨â€çš„å›¾ç‰‡è€Œå·²ã€‚<br />
æ‰€ä»¥ï¼ŒVAEä¹‹æ‰€ä»¥å—æ¬¢è¿ï¼Œå°±æ˜¯åœ¨äºVAEå…·å¤‡äº†äººç±»æ‰æœ‰çš„åˆ›é€ åŠ›ï¼Œè™½ç„¶åˆ›é€ çš„ç»“æœä¸ä¸€å®šéƒ½ä»¤äººæ»¡æ„ï¼Œä½†æ¯•ç«Ÿå¯ä»¥â€œæ— ä¸­ç”Ÿæœ‰â€å•Šã€‚</p>

<p>ï¼ˆå¾…ç»­â€¦ï¼‰</p>

:ET