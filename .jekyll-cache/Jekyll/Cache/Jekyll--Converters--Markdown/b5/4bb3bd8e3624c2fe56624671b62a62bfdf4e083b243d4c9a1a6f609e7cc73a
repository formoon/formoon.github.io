I"¥«<p><img src="https://raw.githubusercontent.com/formoon/formoon.github.io/master/attachments/201904/tensorFlow2/tf-logo-card-2.png" alt="" /></p>
<h4 id="è¿ç§»å­¦ä¹ åŸºæœ¬æ¦‚å¿µ">è¿ç§»å­¦ä¹ åŸºæœ¬æ¦‚å¿µ</h4>
<p>è¿ç§»å­¦ä¹ æ˜¯è¿™ä¸¤å¹´æ¯”è¾ƒç«çš„ä¸€ä¸ªè¯é¢˜ï¼Œä¸»è¦åŸå› æ˜¯åœ¨å½“å‰çš„æœºå™¨å­¦ä¹ ä¸­ï¼Œæ ·æœ¬æ•°æ®çš„è·å–æ˜¯æˆæœ¬æœ€é«˜çš„ä¸€å—ã€‚è€Œè¿ç§»å­¦ä¹ å¯ä»¥æœ‰æ•ˆçš„æŠŠåŸæœ‰çš„å­¦ä¹ ç»éªŒï¼ˆå¯¹äºæ¨¡å‹å°±æ˜¯æ¨¡å‹æœ¬èº«åŠå…¶è®­ç»ƒå¥½çš„æƒé‡å€¼ï¼‰å¸¦å…¥åˆ°æ–°çš„é¢†åŸŸï¼Œä»è€Œä¸éœ€è¦è¿‡å¤šçš„æ ·æœ¬æ•°æ®ï¼Œä¹Ÿèƒ½è¾¾åˆ°å¤§æ‰¹é‡æ•°æ®æ‰€è¾¾æˆçš„æ•ˆæœï¼Œè¿›ä¸€æ­¥èŠ‚çœäº†å­¦ä¹ çš„è®¡ç®—é‡å’Œæ—¶é—´ã€‚</p>

<p>MobileNet V2æ˜¯ç”±è°·æ­Œåœ¨2018å¹´åˆå‘å¸ƒçš„ä¸€ä¸ªè§†è§‰æ¨¡å‹ï¼Œåœ¨Kerasä¸­å·²ç»å†…ç½®çš„å¹¶ä½¿ç”¨ImageNetå®Œæˆäº†è®­ç»ƒï¼Œå¯ä»¥ç›´æ¥æ‹¿æ¥å°±ç”¨ï¼Œè¿™ä¸ªæˆ‘ä»¬åœ¨æœ¬ç³»åˆ—ç¬¬äº”ç¯‡ä¸­å·²ç»æè¿‡äº†ã€‚MobileNet V2æœ‰è½»é‡å’Œé«˜æ•ˆçš„ç‰¹ç‚¹ã€‚é€šè¿‡Inverted residual blockç»“æ„ï¼Œå¯ä»¥ç”¨è¾ƒå°‘çš„è¿ç®—é‡å¾—åˆ°è¾ƒé«˜çš„ç²¾åº¦ï¼Œå¾ˆé€‚åˆç§»åŠ¨ç«¯çš„æœºå™¨å­¦ä¹ éœ€æ±‚ã€‚è®ºæ–‡åœ¨<a href="https://128.84.21.199/abs/1801.04381">è¿™é‡Œ</a>ã€‚<br />
åœ¨ImageNetæ•°æ®é›†ä¸Šï¼ŒMobileNet V2èƒ½è¾¾åˆ°92.5%çš„è¯†åˆ«æ­£ç¡®ç‡ã€‚æœ¬ç¯‡ä¸­ï¼Œæˆ‘ä»¬ä»¥æ­¤æ¨¡å‹ä¸ºåŸºç¡€ï¼Œä»‹ç»ä¸€ä¸ªå…¸å‹çš„è¿ç§»å­¦ä¹ å®ç°æ–¹æ³•ã€‚å¹¶é€šè¿‡è°ƒæ•´æ¨¡å‹å®Œæˆä¼˜åŒ–ã€‚</p>

<h4 id="é—®é¢˜æè¿°">é—®é¢˜æè¿°</h4>
<p>MobileNet V2åŸæœ¬æ˜¯è¯†åˆ«å›¾ç‰‡ä¸­ä¸»é¢˜çš„åç§°ã€‚åœ¨ImageNetä¸­ï¼Œæœ‰å¤§é‡çš„ç»è¿‡æ ‡æ³¨çš„ç…§ç‰‡ï¼Œæ ‡æ³¨çš„ä¿¡æ¯ä¹Ÿéå¸¸è¯¦ç»†ã€‚æ¯”å¦‚æˆ‘ä»¬ç†Ÿæ‚‰çš„çŒ«çŒ«ã€ç‹—ç‹—ï¼ŒImageNetå¹¶ä¸ç®€å•çš„æ ‡æ³¨ä¸ºcatæˆ–è€…dogï¼Œè€Œæ˜¯æ›´è¯¦ç»†çš„æ ‡æ³¨ä¸ºåŠ è²ã€å¾·ç‰§è¿™æ ·ç²¾ç¡®åˆ°å…·ä½“å“ç§çš„ä¿¡æ¯ã€‚<br />
æˆ‘ä»¬è¿™é‡Œä½¿ç”¨è°ƒæ•´ä¹‹åçš„MobileNet V2æ¨¡å‹ï¼Œç”¨äºå¯¹å›¾ç‰‡å†…å®¹çš„çŒ«çŒ«å’Œç‹—ç‹—åˆ†ç±»ã€‚ä¸å»ç®¡åŸæœ¬æ˜¯å“ªç§å…·ä½“çš„å“ç§ï¼Œåªåˆ†æˆcat/dogä¸¤ä¸ªå¤§ç±»ã€‚<br />
è¿™ä¸ªé—®é¢˜çš„æè¿°å®é™…ä¸Šéšè—äº†ä¸¤ä¸ªé‡ç‚¹ï¼š</p>
<ul>
  <li>è¿ç§»å­¦ä¹ å¹¶ä¸æ˜¯æ— é™åˆ¶ã€éšæ„å®ç°çš„ã€‚åŸæœ‰å­¦ä¹ æ•°æ®å’Œæ•°æ®çš„åœºæ™¯ï¼ŒåŒå½“å‰çš„é—®é¢˜ï¼Œæ˜¯æœ‰å…±åŒç‚¹ã€å¯å€Ÿé‰´å¯è¿ç§»çš„ã€‚</li>
  <li>æŠŠcatã€dogçš„å…·ä½“å“ç§å¿½ç•¥ï¼Œç®€å•çš„åˆ†æˆä¸¤ç±»ï¼Œå¹¶ä¸èƒ½è®¤ä¸ºå°±æ˜¯æŠŠé—®é¢˜ç®€åŒ–äº†ã€‚è¦çŸ¥é“äººå·¥æ™ºèƒ½å¹¶ä¸æ˜¯äººï¼Œä¸¾ä¾‹æ¥è¯´ï¼Œå…¶å®æœºå™¨å­¦ä¹ æ¨¡å‹è‡ªå·±ï¼Œå¹¶ä¸çŸ¥é“â€œè—ç’â€è·Ÿâ€œç‹—â€ä¹‹é—´æœ‰ä»€ä¹ˆå…³ç³»ã€‚åœ¨æœºå™¨å­¦ä¹ çš„æ¨¡å‹ä¸­ï¼Œä¼šè®¤ä¸ºè¿™æ˜¯ä¸¤ä¸ªä¸åŒçš„åˆ†ç±»ã€‚</li>
</ul>

<h4 id="ä»ç®€å•å¼€å§‹å…ˆå±•ç¤ºä¸€ä¸‹è¯†åˆ«">ä»ç®€å•å¼€å§‹ï¼Œå…ˆå±•ç¤ºä¸€ä¸‹è¯†åˆ«</h4>
<p>å¦‚åŒæœ¬ç³»åˆ—ç¬¬äº”ç¯‡ä¸€æ ·ï¼Œå…ˆä½¿ç”¨æœ€ç®€çŸ­çš„ä»£ç ç†Ÿæ‚‰ä¸€ä¸‹MobileNet V2ã€‚<br />
æˆ‘ä»¬è¿™ä¸ªä¾‹å­æ‰€ä½¿ç”¨çš„æ•°æ®ï¼Œæ˜¯ä½¿ç”¨tensorflow_datasetsæ¨¡å—æ¥è‡ªåŠ¨ä¸‹è½½ã€è§£å‹ã€ç®¡ç†çš„ã€‚æ‰€ä»¥è¯·å…ˆå®‰è£…è¿™ä¸ªæ‰©å±•åŒ…ï¼š</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span> <span class="n">pip3</span> <span class="n">install</span> <span class="n">tfds</span><span class="o">-</span><span class="n">nightly</span> 
</code></pre></div></div>
<p>ç¨‹åºåœ¨ç¬¬ä¸€æ¬¡è¿è¡Œçš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨ä¸‹è½½å¾®è½¯çš„å®éªŒæ•°æ®é›†ã€‚è¯·å°½é‡ä½¿ç”¨ç¨‹åºè‡ªåŠ¨ä¸‹è½½ï¼Œå› ä¸ºä¸‹è½½ä¹‹åä¼šè‡ªåŠ¨è§£å‹ã€‚æ•°æ®é›†çš„ä¿å­˜è·¯å¾„ä¸ºï¼šâ€œ~/tensorflow_datasets/â€ï¼Œè¿™ä¸ªæ˜¯tensorflow_datasetsé»˜è®¤çš„ã€‚<br />
æ•°æ®é›†ä¸­æ˜¯éšæœºå°ºå¯¸çš„å›¾ç‰‡ï¼Œç¨‹åºç¬¬ä¸€æ­¥ä¼šå°†å›¾ç‰‡ç»Ÿä¸€åˆ°224x224çš„å°ºå¯¸ï¼Œè¿™ä¸ªæ˜¯é¢„ç½®çš„MobileNet V2æ¨¡å‹æ‰€å†³å®šçš„ã€‚<br />
æˆ‘ä»¬ä»æ ·æœ¬ä¸­å–å¤´ä¸¤ä¸ªå›¾ç‰‡æ˜¾ç¤ºåœ¨å±å¹•ä¸Šï¼Œå¹¶ä¸”ä½¿ç”¨æ¨¡å‹é¢„æµ‹å›¾ç‰‡å†…å®¹ã€‚è¯·å‚è€ƒæºä»£ç ä¸­çš„æ³¨é‡Šé˜…è¯»ç¨‹åºï¼Œä¹Ÿå¯ä»¥å¯¹ç…§ä¸€ä¸‹ç¬¬äº”ç¯‡çš„vgg-19/ResNet50æ¨¡å‹é¢„æµ‹å›¾ç‰‡å†…å®¹çš„ç¨‹åºï¼Œè¿™äº›æ¨¡å‹çš„ä½¿ç”¨æ–¹æ³•å‡ ä¹æ˜¯ç›¸åŒçš„ã€‚</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span>
<span class="c1"># å¼•å…¥æ‰€ä½¿ç”¨åˆ°çš„æ‰©å±•åº“
</span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="n">tf</span>
<span class="kn">import</span> <span class="nn">tensorflow_datasets</span> <span class="k">as</span> <span class="n">tfds</span>

<span class="n">keras</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">keras</span>

<span class="c1"># è½½å…¥è®­ç»ƒæ•°æ®ï¼Œè½½å…¥æ—¶æŒ‰ç…§80%:10%:10%çš„æ¯”ä¾‹æ‹†åˆ†ä¸ºè®­ç»ƒã€éªŒè¯ã€æµ‹è¯•ä¸‰ä¸ªæ•°æ®é›†
# æœ¬ç¨‹åºåªæ˜¯æ¼”ç¤ºè¯†åˆ«å›¾ç‰‡ï¼ŒåŒºåˆ†ä¸ºä¸‰ç±»å¹¶æ²¡æœ‰ç›´æ¥æ„ä¹‰ï¼Œä½†ä¸‹é¢çš„ç¨‹åºè®­ç»ƒæ¨¡å‹ä¼šä½¿ç”¨åˆ°
</span><span class="n">SPLIT_WEIGHTS</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">splits</span> <span class="o">=</span> <span class="n">tfds</span><span class="p">.</span><span class="n">Split</span><span class="p">.</span><span class="n">TRAIN</span><span class="p">.</span><span class="n">subsplit</span><span class="p">(</span><span class="n">weighted</span><span class="o">=</span><span class="n">SPLIT_WEIGHTS</span><span class="p">)</span>
<span class="p">(</span><span class="n">raw_train</span><span class="p">,</span> <span class="n">raw_validation</span><span class="p">,</span> <span class="n">raw_test</span><span class="p">),</span> <span class="n">metadata</span> <span class="o">=</span> <span class="n">tfds</span><span class="p">.</span><span class="n">load</span><span class="p">(</span>
    <span class="s">'cats_vs_dogs'</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">splits</span><span class="p">),</span>
    <span class="n">with_info</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">as_supervised</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="c1"># å›¾ç‰‡æ ‡æ³¨
</span><span class="n">get_label_name</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">.</span><span class="n">features</span><span class="p">[</span><span class="s">'label'</span><span class="p">].</span><span class="n">int2str</span>

<span class="c1"># æ˜¾ç¤ºå¤´ä¸¤å¹…å›¾ç‰‡
</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">(</span><span class="s">'Dog &amp; Cat'</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="k">for</span> <span class="n">image</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">raw_train</span><span class="p">.</span><span class="n">take</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">title</span><span class="p">(</span><span class="n">get_label_name</span><span class="p">(</span><span class="n">label</span><span class="p">))</span>
    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># æ‰€æœ‰å›¾ç‰‡è½¬ä¸º224x224çš„å°ºå¯¸ï¼Œé€‚åº”æ¨¡å‹çš„è¦æ±‚
</span><span class="n">IMG_SIZE</span> <span class="o">=</span> <span class="mi">224</span>
<span class="k">def</span> <span class="nf">format_example</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">cast</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">tf</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">image</span> <span class="o">=</span> <span class="p">(</span><span class="n">image</span><span class="o">/</span><span class="mf">127.5</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">image</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="n">IMG_SIZE</span><span class="p">,</span> <span class="n">IMG_SIZE</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">label</span>
<span class="n">train</span> <span class="o">=</span> <span class="n">raw_train</span><span class="p">.</span><span class="nb">map</span><span class="p">(</span><span class="n">format_example</span><span class="p">)</span>

<span class="c1"># è½½å…¥æ¨¡å‹ï¼Œç¬¬ä¸€æ¬¡æ‰§è¡Œä¼šä¸‹è½½h5æ–‡ä»¶
# é¢„æµ‹å’Œè¿ç§»å­¦ä¹ æ‰€ç”¨çš„æ¨¡å‹å¹¶ä¸å®Œå…¨ç›¸åŒï¼Œæ‰€ä»¥ä¼šä¸‹è½½ä¸¤æ¬¡
</span><span class="n">test_model</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">applications</span><span class="p">.</span><span class="n">MobileNetV2</span><span class="p">(</span><span class="n">weights</span><span class="o">=</span><span class="s">'imagenet'</span><span class="p">)</span>

<span class="c1"># é¢„æµ‹å¤´ä¸¤å¼ ç…§ç‰‡å¹¶æ˜¾ç¤ºç»“æœ
</span><span class="k">for</span> <span class="n">image</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">train</span><span class="p">.</span><span class="n">take</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">predict_class</span> <span class="o">=</span> <span class="n">test_model</span><span class="p">.</span><span class="n">predict</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="n">desc</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">applications</span><span class="p">.</span><span class="n">mobilenet_v2</span><span class="p">.</span><span class="n">decode_predictions</span><span class="p">(</span><span class="n">predict_class</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">desc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</code></pre></div></div>
<p>æˆ‘ä»¬æ‰§è¡Œç¨‹åºçœ‹çœ‹é¢„æµ‹ç»“æœï¼š</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>./cats_dogs_1predict.py
<span class="o">[(</span><span class="s1">'n02089078'</span>, <span class="s1">'black-and-tan_coonhound'</span>, 0.46141574<span class="o">)</span>, <span class="o">(</span><span class="s1">'n02105412'</span>, <span class="s1">'kelpie'</span>, 0.15314996<span class="o">)</span>, <span class="o">(</span><span class="s1">'n02106550'</span>, <span class="s1">'Rottweiler'</span>, 0.092713624<span class="o">)]</span>
<span class="o">[(</span><span class="s1">'n02123045'</span>, <span class="s1">'tabby'</span>, 0.29928064<span class="o">)</span>, <span class="o">(</span><span class="s1">'n02123159'</span>, <span class="s1">'tiger_cat'</span>, 0.08147916<span class="o">)</span>, <span class="o">(</span><span class="s1">'n02096177'</span>, <span class="s1">'cairn'</span>, 0.047330838<span class="o">)]</span>
</code></pre></div></div>
<p><img src="https://raw.githubusercontent.com/formoon/formoon.github.io/master/attachments/201904/tensorFlow2/tl-dog-vs-cat1.png" alt="" /><br />
ç¨‹åºå‡†ç¡®çš„é¢„æµ‹å‡ºäº†ç»“æœã€‚</p>

<h4 id="è¿ç§»å­¦ä¹ æ”¹é€ ">è¿ç§»å­¦ä¹ æ”¹é€ </h4>
<p>æˆ‘ä»¬è¿›è¡ŒçŒ«ã€ç‹—åˆ†ç±»è®­ç»ƒï¼Œå…ˆäº†è§£ä¸€ä¸‹æ ·æœ¬é›†ã€‚æ ·æœ¬é›†çš„å›¾ç‰‡æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œåˆšæ‰æˆ‘ä»¬è§åˆ°äº†ã€‚æ ‡æ³¨åˆ™éå¸¸ç®€å•ï¼Œå°±æ˜¯1ï¼ˆä»£è¡¨Dogï¼‰æˆ–è€…0(ä»£è¡¨Cat)ã€‚ä¸Šé¢çš„ç¨‹åºä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨<code class="language-plaintext highlighter-rouge">get_label_name(label)</code>å°†æ•°å­—è½¬æ¢ä¸ºå¯è¯»çš„å­—ç¬¦ä¸²ã€‚è¿™ä¸ªæ ‡æ³¨æ¯”ImageNetè¦ç®€å•çš„å¤šã€‚<br />
MobileNet V2æ¨¡å‹é»˜è®¤æ˜¯å°†å›¾ç‰‡åˆ†ç±»åˆ°1000ç±»ï¼Œæ¯ä¸€ç±»éƒ½æœ‰å„è‡ªçš„æ ‡æ³¨ã€‚å› ä¸ºæœ¬é—®é¢˜åˆ†ç±»åªæœ‰ä¸¤ç±»ï¼Œæ‰€ä»¥åœ¨ä»£ç ä¸Šï¼Œæˆ‘ä»¬æ„å»ºæ¨¡å‹çš„æ—¶å€™å¢åŠ include_top=Falseå‚æ•°ï¼Œè¡¨ç¤ºæˆ‘ä»¬ä¸éœ€è¦åŸæœ‰æ¨¡å‹ä¸­æœ€åçš„ç¥ç»ç½‘ç»œå±‚ï¼ˆåˆ†ç±»åˆ°1000ç±»ï¼‰ï¼Œä»¥ä¾¿æˆ‘ä»¬å¢åŠ è‡ªå·±çš„è¾“å‡ºå±‚ã€‚å½“ç„¶è¿™æ ·åœ¨ç¬¬ä¸€æ¬¡æ‰§è¡Œç¨‹åºçš„æ—¶å€™ï¼Œéœ€è¦é‡æ–°ä¸‹è½½å¦å¤–ä¸€ä¸ªä¸åŒ…å«topå±‚çš„h5æ¨¡å‹æ•°æ®æ–‡ä»¶ã€‚<br />
éšåæˆ‘ä»¬åœ¨åŸæœ‰æ¨¡å‹çš„åé¢å¢åŠ ä¸€ä¸ªæ± åŒ–å±‚ï¼Œå¯¹æ•°æ®é™ç»´ã€‚æœ€åæ˜¯ä¸€ä¸ª1ä¸ªèŠ‚ç‚¹çš„è¾“å‡ºå±‚ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦çš„ç»“æœåªæœ‰ä¸¤ç±»ã€‚<br />
åˆ°äº†è¿ç§»å­¦ä¹ çš„é‡ç‚¹äº†ï¼Œæˆ‘ä»¬çš„åŸºç¡€æ¨¡å‹çš„å„é¡¹å‚æ•°å˜é‡ï¼Œæˆ‘ä»¬å¹¶ä¸æƒ³æ”¹å˜ï¼Œå› ä¸ºè¿™æ ·æ‰èƒ½ä¿ç•™åŸæ¥å¤§è§„æ¨¡è®­ç»ƒçš„ä¼˜åŠ¿ï¼Œä»è€Œä¿ç•™åŸæ¥çš„ç»éªŒã€‚æˆ‘ä»¬åœ¨ç¨‹åºä¸­ä½¿ç”¨<code class="language-plaintext highlighter-rouge">model.trainable = False</code>ï¼Œè®¾ç½®åœ¨è®­ç»ƒä¸­ï¼ŒåŸºç¡€æ¨¡å‹çš„å„é¡¹å‚æ•°å˜é‡ä¸ä¼šè¢«æ–°çš„è®­ç»ƒä¿®æ”¹æ•°æ®ã€‚<br />
æ¥ç€æˆ‘ä»¬æŠŠæ•°æ®é›†åˆ†ä¸ºè®­ç»ƒã€éªŒè¯ã€æµ‹è¯•ä¸‰ä¸ªæ•°æ®é›†ï¼Œç”¨æµ‹è¯•é›†æ•°æ®å’ŒéªŒè¯é›†æ•°æ®å¯¹æ–°çš„æ¨¡å‹è¿›è¡Œè®­ç»ƒå’Œè¿‡ç¨‹éªŒè¯ã€‚éšåå¯¹å®Œæˆè®­ç»ƒçš„æ¨¡å‹ï¼Œä½¿ç”¨æµ‹è¯•é›†æ•°æ®è¿›è¡Œè¯„ä¼°ã€‚<br />
è¯·çœ‹æºä»£ç ï¼š</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span>
<span class="c1"># å¼•å…¥æ‰€ä½¿ç”¨åˆ°çš„æ‰©å±•åº“
</span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="n">tf</span>
<span class="kn">import</span> <span class="nn">tensorflow_datasets</span> <span class="k">as</span> <span class="n">tfds</span>

<span class="n">keras</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">keras</span>

<span class="c1"># è½½å…¥è®­ç»ƒæ•°æ®ï¼Œè½½å…¥æ—¶æŒ‰ç…§80%:10%:10%çš„æ¯”ä¾‹æ‹†åˆ†ä¸ºè®­ç»ƒã€éªŒè¯ã€æµ‹è¯•ä¸‰ä¸ªæ•°æ®é›†
</span><span class="n">SPLIT_WEIGHTS</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">splits</span> <span class="o">=</span> <span class="n">tfds</span><span class="p">.</span><span class="n">Split</span><span class="p">.</span><span class="n">TRAIN</span><span class="p">.</span><span class="n">subsplit</span><span class="p">(</span><span class="n">weighted</span><span class="o">=</span><span class="n">SPLIT_WEIGHTS</span><span class="p">)</span>
<span class="p">(</span><span class="n">raw_train</span><span class="p">,</span> <span class="n">raw_validation</span><span class="p">,</span> <span class="n">raw_test</span><span class="p">),</span> <span class="n">metadata</span> <span class="o">=</span> <span class="n">tfds</span><span class="p">.</span><span class="n">load</span><span class="p">(</span>
    <span class="s">'cats_vs_dogs'</span><span class="p">,</span> <span class="n">split</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">splits</span><span class="p">),</span>
    <span class="n">with_info</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">as_supervised</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c1"># cat/dogä¸¤ç±»å›¾ç‰‡ï¼Œå¤æ‚åº¦è¦ä½äº1000ç±»çš„å›¾ç‰‡ï¼Œæ‰€ä»¥åˆ†è¾¨ç‡å¯ä»¥ç•¥ä½ï¼Œè¿™æ ·ä¹Ÿèƒ½èŠ‚çœè®­ç»ƒæ—¶é—´
# æ‰€æœ‰å›¾ç‰‡é‡æ–°è°ƒæ•´ä¸º160x160ç‚¹é˜µ
</span><span class="n">IMG_SIZE</span> <span class="o">=</span> <span class="mi">160</span>
<span class="k">def</span> <span class="nf">format_example</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">cast</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">tf</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="c1"># æ•°æ®è§„èŒƒåŒ–ä¸º-1åˆ°+1çš„æµ®ç‚¹æ•°
</span>    <span class="n">image</span> <span class="o">=</span> <span class="p">(</span><span class="n">image</span><span class="o">/</span><span class="mf">127.5</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">image</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">(</span><span class="n">IMG_SIZE</span><span class="p">,</span> <span class="n">IMG_SIZE</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">label</span>

<span class="n">train</span> <span class="o">=</span> <span class="n">raw_train</span><span class="p">.</span><span class="nb">map</span><span class="p">(</span><span class="n">format_example</span><span class="p">)</span>
<span class="n">validation</span> <span class="o">=</span> <span class="n">raw_validation</span><span class="p">.</span><span class="nb">map</span><span class="p">(</span><span class="n">format_example</span><span class="p">)</span>
<span class="n">test</span> <span class="o">=</span> <span class="n">raw_test</span><span class="p">.</span><span class="nb">map</span><span class="p">(</span><span class="n">format_example</span><span class="p">)</span>

<span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">32</span>
<span class="n">SHUFFLE_BUFFER_SIZE</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">train_batches</span> <span class="o">=</span> <span class="n">train</span><span class="p">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">SHUFFLE_BUFFER_SIZE</span><span class="p">).</span><span class="n">batch</span><span class="p">(</span><span class="n">BATCH_SIZE</span><span class="p">)</span>
<span class="n">validation_batches</span> <span class="o">=</span> <span class="n">validation</span><span class="p">.</span><span class="n">batch</span><span class="p">(</span><span class="n">BATCH_SIZE</span><span class="p">)</span>
<span class="n">test_batches</span> <span class="o">=</span> <span class="n">test</span><span class="p">.</span><span class="n">batch</span><span class="p">(</span><span class="n">BATCH_SIZE</span><span class="p">)</span>

<span class="c1"># è¾“å…¥å½¢çŠ¶å°±æ˜¯160x160x3,æœ€å3ä¸ºRGB3å­—èŠ‚è‰²
</span><span class="n">IMG_SHAPE</span> <span class="o">=</span> <span class="p">(</span><span class="n">IMG_SIZE</span><span class="p">,</span> <span class="n">IMG_SIZE</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">base_model</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">applications</span><span class="p">.</span><span class="n">MobileNetV2</span><span class="p">(</span><span class="n">input_shape</span><span class="o">=</span><span class="n">IMG_SHAPE</span><span class="p">,</span>
                                               <span class="n">include_top</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>  <span class="c1"># ä½¿ç”¨ä¸åŒ…å«åŸæœ‰1000ç±»è¾“å‡ºå±‚çš„æ¨¡å‹
</span>                                               <span class="n">weights</span><span class="o">=</span><span class="s">'imagenet'</span><span class="p">)</span>
<span class="c1"># è®¾ç½®åŸºç¡€æ¨¡å‹ï¼šMobileNetV2çš„å„é¡¹æƒé‡å‚æ•°ä¸ä¼šè¢«è®­ç»ƒæ‰€æ›´æ”¹
</span><span class="n">base_model</span><span class="p">.</span><span class="n">trainable</span> <span class="o">=</span> <span class="bp">False</span>
<span class="c1"># è¾“å‡ºæ¨¡å‹æ±‡æ€»ä¿¡æ¯
</span><span class="n">base_model</span><span class="p">.</span><span class="n">summary</span><span class="p">()</span>

<span class="c1"># å¢åŠ è¾“å‡ºæ± åŒ–å±‚
</span><span class="n">global_average_layer</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">GlobalAveragePooling2D</span><span class="p">()</span>

<span class="c1"># è¾“å‡ºå±‚
</span><span class="n">prediction_layer</span> <span class="o">=</span> <span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="c1"># å®šä¹‰æœ€ç»ˆå®Œæ•´çš„æ¨¡å‹
</span><span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">base_model</span><span class="p">,</span>
    <span class="n">global_average_layer</span><span class="p">,</span>
    <span class="n">prediction_layer</span>
<span class="p">])</span>
<span class="c1"># å­¦ä¹ æ¢¯åº¦
</span><span class="n">base_learning_rate</span> <span class="o">=</span> <span class="mf">0.0001</span>
<span class="c1"># ç¼–è¯‘æ¨¡å‹
</span><span class="n">model</span><span class="p">.</span><span class="nb">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">optimizers</span><span class="p">.</span><span class="n">RMSprop</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="n">base_learning_rate</span><span class="p">),</span>
              <span class="n">loss</span><span class="o">=</span><span class="s">'binary_crossentropy'</span><span class="p">,</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s">'accuracy'</span><span class="p">])</span>

<span class="c1"># å„éƒ¨åˆ†æ•°æ®æ•°é‡
</span><span class="n">num_train</span><span class="p">,</span> <span class="n">num_val</span><span class="p">,</span> <span class="n">num_test</span> <span class="o">=</span> <span class="p">(</span>
  <span class="n">metadata</span><span class="p">.</span><span class="n">splits</span><span class="p">[</span><span class="s">'train'</span><span class="p">].</span><span class="n">num_examples</span><span class="o">*</span><span class="n">weight</span><span class="o">/</span><span class="mi">10</span>
  <span class="k">for</span> <span class="n">weight</span> <span class="ow">in</span> <span class="n">SPLIT_WEIGHTS</span>
<span class="p">)</span>
<span class="c1"># è¿­ä»£æ¬¡æ•°
</span><span class="n">initial_epochs</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">steps_per_epoch</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">num_train</span><span class="p">)</span><span class="o">//</span><span class="n">BATCH_SIZE</span>
<span class="c1"># éªŒè¯å’Œè¯„ä¼°æ¬¡æ•°
</span><span class="n">validation_steps</span> <span class="o">=</span> <span class="mi">20</span>

<span class="c1"># æ˜¾ç¤ºä¸€ä¸‹æœªç»è®­ç»ƒçš„åˆå§‹æ¨¡å‹è¯„ä¼°ç»“æœ
</span><span class="n">loss0</span><span class="p">,</span> <span class="n">accuracy0</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_batches</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="n">validation_steps</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"initial loss: {:.2f}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">loss0</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s">"initial accuracy: {:.2f}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">accuracy0</span><span class="p">))</span>

<span class="c1"># è®­ç»ƒ
</span><span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_batches</span><span class="p">.</span><span class="n">repeat</span><span class="p">(),</span>
                    <span class="n">epochs</span><span class="o">=</span><span class="n">initial_epochs</span><span class="p">,</span>
                    <span class="n">steps_per_epoch</span><span class="o">=</span><span class="n">steps_per_epoch</span><span class="p">,</span>
                    <span class="n">validation_data</span><span class="o">=</span><span class="n">validation_batches</span><span class="p">.</span><span class="n">repeat</span><span class="p">(),</span> 
                    <span class="n">validation_steps</span><span class="o">=</span><span class="n">validation_steps</span><span class="p">)</span>
<span class="c1"># è¯„ä¼°
</span><span class="n">loss0</span><span class="p">,</span> <span class="n">accuracy0</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_batches</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="n">validation_steps</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Train1ed loss: {:.2f}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">loss0</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Train1ed accuracy: {:.2f}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">accuracy0</span><span class="p">))</span>
</code></pre></div></div>
<p>å› ä¸ºæ•°æ®é›†æ¯”è¾ƒå¤§ï¼Œæ¨¡å‹ä¹Ÿæ¯”è¾ƒå¤æ‚ï¼Œæ‰€ä»¥ç¨‹åºæ‰§è¡Œèµ·æ¥æ—¶é—´å¾ˆé•¿ã€‚æœ€ç»ˆçš„è¯„ä¼°ç»“æœç±»ä¼¼ä¸ºï¼š</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Train1ed loss: 0.38
Train1ed accuracy: 0.95
</code></pre></div></div>
<p>å¦‚æœä¸å¯¹æ¯”æ¥çœ‹ï¼Œè¿™ä¸ªç»“æœè¿˜ä¸é”™å•¦ã€‚ä¸è¿‡å‡†ç¡®ç‡æ¯”åŸæ¥å¯¹æ›´ä¸ºå¤æ‚çš„ImageNetæ•°æ®é›†çš„è¯„ä¼°å€¼è¿˜è¦ä½å¾ˆå¤šï¼Œæ˜¾ç„¶è¿˜æœ‰å¾ˆå¤§çš„ä¼˜åŒ–ç©ºé—´ã€‚</p>

<h4 id="æ¨¡å‹ä¼˜åŒ–">æ¨¡å‹ä¼˜åŒ–</h4>
<p>åœ¨æ•´ä¸ªæ¨¡å‹ä¸­ï¼Œæˆ‘ä»¬è‡ªå·±å¢åŠ çš„éƒ¨åˆ†å¾ˆå°‘ï¼Œä¼˜åŒ–çš„ä½™åœ°å¹¶ä¸å¤šã€‚è€ƒè™‘åˆ°åŸæœ‰ImageNetå›¾ç‰‡åº“çš„æ ·æœ¬ï¼Œå¤§å¤šå¹¶éçŒ«å’Œç‹—ã€‚æ‰€ä»¥å®Œå…¨ä¿ç•™åŸæœ‰çš„æ¨¡å‹å‚æ•°å¯èƒ½å¯¹MobileNet V2æ¥è®²ä¹Ÿæ˜¯èµ„æºä¸Šçš„æµªè´¹ã€‚<br />
å› æ­¤æˆ‘ä»¬é‡‡å–çš„ä¼˜åŒ–ç­–ç•¥å°±æ˜¯å¼€æ”¾ä¸€éƒ¨åˆ†æ¨¡å‹çš„ç½‘ç»œå±‚ï¼Œå…è®¸åœ¨è¿›ä¸€æ­¥çš„è®­ç»ƒä¸­ï¼Œè°ƒæ•´å…¶æƒé‡å€¼ï¼Œä»è€ŒæœŸæœ›æ›´å¥½çš„ç»“æœã€‚<br />
åœ¨MobileNet V2æ¨¡å‹ä¸­ï¼Œä¸€å…±æœ‰155å±‚å·ç§¯æˆ–è€…ç¥ç»ç½‘ç»œã€‚è¿™ä¸ªå€¼å¯ä»¥ä½¿ç”¨<code class="language-plaintext highlighter-rouge">len(model.layers)</code>æ¥æŸ¥çœ‹ã€‚æˆ‘ä»¬ä»ç„¶é”å®šå‰é¢çš„100å±‚ï¼ŒæŠŠåé¢çš„ç½‘ç»œå±‚æ‰“å¼€ï¼Œå…è®¸è®­ç»ƒä¿®æ”¹å…¶å‚æ•°ã€‚<br />
åœ¨éšåæ–°æ¨¡å‹çš„è®­ç»ƒä¸­ï¼Œä¹Ÿä¸éœ€è¦å…¨éƒ¨é‡å¤´å¼€å§‹è®­ç»ƒï¼Œmodel.fitæ–¹æ³•ä¸­ï¼Œå¯ä»¥æŒ‡å®šinitial_epochå‚æ•°ï¼Œæ¥ç€å‰é¢çš„è®­ç»ƒç»§ç»­è¿›è¡Œã€‚<br />
è¯·çœ‹æºä»£ç ï¼š</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="p">...</span><span class="n">ç»§ç»­å‰é¢çš„ä»£ç æœ€åè¾“å…¥</span><span class="p">...</span>
<span class="c1"># æ‰“å¼€å…è®¸ä¿®æ”¹åŸºç¡€æ¨¡å‹çš„æƒé‡å‚æ•°
</span><span class="n">base_model</span><span class="p">.</span><span class="n">trainable</span> <span class="o">=</span> <span class="bp">True</span>
<span class="c1"># ä»ç„¶é”æ­»å‰100å±‚çš„æƒé‡ä¸å…è®¸ä¿®æ”¹
</span><span class="n">fine_tune_at</span> <span class="o">=</span> <span class="mi">100</span>
<span class="c1"># å†»ç»“fine_tune_atä¹‹å‰çš„å±‚
</span><span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">base_model</span><span class="p">.</span><span class="n">layers</span><span class="p">[:</span><span class="n">fine_tune_at</span><span class="p">]:</span>
    <span class="n">layer</span><span class="p">.</span><span class="n">trainable</span> <span class="o">=</span> <span class="bp">False</span>
<span class="c1"># é‡æ–°ç¼–è¯‘æ¨¡å‹
</span><span class="n">model</span><span class="p">.</span><span class="nb">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s">'binary_crossentropy'</span><span class="p">,</span>
              <span class="n">optimizer</span><span class="o">=</span><span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">optimizers</span><span class="p">.</span><span class="n">RMSprop</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="n">base_learning_rate</span><span class="o">/</span><span class="mi">10</span><span class="p">),</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s">'accuracy'</span><span class="p">])</span>
<span class="c1"># è¾“å‡ºæ¨¡å‹çš„æ¦‚å†µï¼Œæ³¨æ„è§‚å¯Ÿæœ‰äº›å±‚è¢«é”å®šï¼Œæœ‰äº›å±‚å¯ä»¥æ›´æ”¹
</span><span class="n">model</span><span class="p">.</span><span class="n">summary</span><span class="p">()</span>
<span class="c1"># åœ¨å‰æ¬¡è®­ç»ƒçš„åŸºç¡€ä¸Šå†è®­ç»ƒ10æ¬¡
</span><span class="n">fine_tune_epochs</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">total_epochs</span> <span class="o">=</span> <span class="n">initial_epochs</span> <span class="o">+</span> <span class="n">fine_tune_epochs</span>
<span class="c1"># è®­ç»ƒæ¨¡å‹
</span><span class="n">history_fine</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_batches</span><span class="p">.</span><span class="n">repeat</span><span class="p">(),</span> 
                         <span class="n">steps_per_epoch</span><span class="o">=</span><span class="n">steps_per_epoch</span><span class="p">,</span>
                         <span class="n">epochs</span><span class="o">=</span><span class="n">total_epochs</span><span class="p">,</span> 
                         <span class="n">initial_epoch</span><span class="o">=</span><span class="n">initial_epochs</span><span class="p">,</span>
                         <span class="n">validation_data</span><span class="o">=</span><span class="n">validation_batches</span><span class="p">.</span><span class="n">repeat</span><span class="p">(),</span> 
                         <span class="n">validation_steps</span><span class="o">=</span><span class="n">validation_steps</span><span class="p">)</span>
<span class="c1"># è¯„ä¼°æ–°æ¨¡å‹
</span><span class="n">loss0</span><span class="p">,</span> <span class="n">accuracy0</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_batches</span><span class="p">,</span> <span class="n">steps</span><span class="o">=</span><span class="n">validation_steps</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"final loss: {:.2f}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">loss0</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s">"final accuracy: {:.2f}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">accuracy0</span><span class="p">))</span>

</code></pre></div></div>
<p>æ‰§è¡Œä¼˜åŒ–åçš„ç¨‹åºï¼Œå…¶ä¸­model.summary()çš„è¾“å‡ºä¿¡æ¯ï¼š</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Model: <span class="s2">"sequential"</span>
_________________________________________________________________
Layer <span class="o">(</span><span class="nb">type</span><span class="o">)</span>                 Output Shape              Param <span class="c">#</span>
<span class="o">=================================================================</span>
mobilenetv2_1.00_160 <span class="o">(</span>Model<span class="o">)</span> <span class="o">(</span>None, 5, 5, 1280<span class="o">)</span>        2257984
_________________________________________________________________
global_average_pooling2d <span class="o">(</span>Gl <span class="o">(</span>None, 1280<span class="o">)</span>              0
_________________________________________________________________
dense <span class="o">(</span>Dense<span class="o">)</span>                <span class="o">(</span>None, 1<span class="o">)</span>                 1281
<span class="o">=================================================================</span>
Total params: 2,259,265
Trainable params: 1,863,873
Non-trainable params: 395,392
</code></pre></div></div>
<p>Non-trainable paramsè¿™ä¸€éƒ¨åˆ†ï¼Œå°±æ˜¯æŒ‡æˆ‘ä»¬é”å®šä¸å‚ä¸æ–°æ•°æ®è®­ç»ƒçš„å‚æ•°æ•°é‡ã€‚å¦‚æœä½ æ³¨æ„çœ‹å‰é¢ä¸€éƒ¨åˆ†base_model.summary()çš„è¾“å‡ºï¼Œæ‰€æœ‰çš„å‚æ•°éƒ½è¢«é”å®šä¸å‚ä¸è®­ç»ƒã€‚<br />
æœ€åçš„è¯„ä¼°ç»“æœä¸ºï¼š</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>final loss: 0.23
final accuracy: 0.97
</code></pre></div></div>
<p>çœ‹èµ·æ¥è™½ç„¶ç•¥å¥½ï¼Œä½†ä¼¼ä¹ä¼˜åŒ–æ•ˆæœå¹¶ä¸æ˜æ˜¾ã€‚<br />
å…¶å®è¿™ä¸»è¦æ˜¯è§‚å¯Ÿæ•°å€¼ä¸å¤Ÿç›´è§‚é€ æˆçš„ï¼Œæˆ‘ä»¬ç»§ç»­ä¸ºç¨‹åºå¢åŠ ç»˜å›¾åŠŸèƒ½ï¼š</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="p">...</span><span class="n">ç»§ç»­å‰é¢çš„ä»£ç æœ€åè¾“å…¥</span><span class="p">...</span>
<span class="c1"># ä¼˜åŒ–å‰è®­ç»ƒè¿­ä»£æ•°æ®
</span><span class="n">acc</span> <span class="o">=</span> <span class="n">history</span><span class="p">.</span><span class="n">history</span><span class="p">[</span><span class="s">'accuracy'</span><span class="p">]</span>
<span class="n">val_acc</span> <span class="o">=</span> <span class="n">history</span><span class="p">.</span><span class="n">history</span><span class="p">[</span><span class="s">'val_accuracy'</span><span class="p">]</span>

<span class="n">loss</span> <span class="o">=</span> <span class="n">history</span><span class="p">.</span><span class="n">history</span><span class="p">[</span><span class="s">'loss'</span><span class="p">]</span>
<span class="n">val_loss</span> <span class="o">=</span> <span class="n">history</span><span class="p">.</span><span class="n">history</span><span class="p">[</span><span class="s">'val_loss'</span><span class="p">]</span>

<span class="c1"># ä¼˜åŒ–åè®­ç»ƒè¿­ä»£æ•°æ®
</span><span class="n">acc</span> <span class="o">+=</span> <span class="n">history_fine</span><span class="p">.</span><span class="n">history</span><span class="p">[</span><span class="s">'accuracy'</span><span class="p">]</span>
<span class="n">val_acc</span> <span class="o">+=</span> <span class="n">history_fine</span><span class="p">.</span><span class="n">history</span><span class="p">[</span><span class="s">'val_accuracy'</span><span class="p">]</span>

<span class="n">loss</span> <span class="o">+=</span> <span class="n">history_fine</span><span class="p">.</span><span class="n">history</span><span class="p">[</span><span class="s">'loss'</span><span class="p">]</span>
<span class="n">val_loss</span> <span class="o">+=</span> <span class="n">history_fine</span><span class="p">.</span><span class="n">history</span><span class="p">[</span><span class="s">'val_loss'</span><span class="p">]</span>

<span class="c1"># ä½¿ç”¨è®­ç»ƒæ•°æ®ç»˜å›¾
</span><span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">plt</span><span class="p">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">acc</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">'Training Accuracy'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">val_acc</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">'Validation Accuracy'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">ylim</span><span class="p">([</span><span class="mf">0.8</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">([</span><span class="n">initial_epochs</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">initial_epochs</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
          <span class="n">plt</span><span class="p">.</span><span class="n">ylim</span><span class="p">(),</span> <span class="n">label</span><span class="o">=</span><span class="s">'Start Fine Tuning'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s">'lower right'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">title</span><span class="p">(</span><span class="s">'Training and Validation Accuracy'</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">'Training Loss'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">val_loss</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">'Validation Loss'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
<span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">([</span><span class="n">initial_epochs</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">initial_epochs</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
         <span class="n">plt</span><span class="p">.</span><span class="n">ylim</span><span class="p">(),</span> <span class="n">label</span><span class="o">=</span><span class="s">'Start Fine Tuning'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s">'upper right'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">title</span><span class="p">(</span><span class="s">'Training and Validation Loss'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'epoch'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>
<p>æˆ‘ä»¬ä¸ºäº†è®²è§£æ–¹ä¾¿ï¼ŒæŠŠæœ€ç»ˆçš„ç¨‹åºåˆ†æˆäº†å‡ ä¸ªéƒ¨åˆ†ï¼Œå®é™…ä¸Šä¸ºäº†èŠ‚çœæ—¶é—´ï¼Œæ˜¯å¯ä»¥åˆå¹¶åœ¨ä¸€èµ·æ‰§è¡Œçš„ï¼Œè¿™æ ·ä¸éœ€è¦é‡å¤è®­ç»ƒå¾ˆå¤šæ¬¡ã€‚<br />
ä»ç»˜å›¾ç»“æœçœ‹ï¼Œä¼˜åŒ–çš„æ•ˆæœè¿˜æ˜¯å¾ˆæ˜æ˜¾çš„ï¼š<br />
<img src="https://raw.githubusercontent.com/formoon/formoon.github.io/master/attachments/201904/tensorFlow2/tl-dog-vs-cat2.png" alt="" /><br />
ä¸¤å¼ å›¾ï¼Œä¸­é—´éƒ½æœ‰ä¸€æ¡ç»¿çº¿åˆ†éš”å¼€ä¼˜åŒ–å‰å’Œä¼˜åŒ–åçš„è®­ç»ƒæ•°æ®ã€‚åœ¨å‰åŠæ®µï¼Œæ­£ç¡®ç‡å’ŒæŸå¤±å€¼çš„ä¼˜åŒ–è¿‡ç¨‹æ˜¯æ˜æ˜¾æ¯”è¾ƒæ…¢çš„ï¼Œè€Œä¸”è®­ç»ƒé›†å’ŒéªŒè¯é›†ä¸¤æ¡çº¿çš„åˆ†ç¦»ä¹Ÿè¯´æ˜æœ‰è¿‡æ‹Ÿåˆçš„ç°è±¡ã€‚åœ¨ååŠæ®µï¼Œæœ‰ä¸€ä¸ªæ˜æ˜¾çš„é˜¶æ¢¯è¡¨ç°å‡ºæ¥æ¨¡å‹æ€§èƒ½æ˜æ˜¾æ”¹å–„ï¼Œè®­ç»ƒé›†å’ŒéªŒè¯é›†ä¹Ÿæ›´æ¥è¿‘ã€‚è¯´æ˜å„é¡¹æŒ‡æ ‡éƒ½æœ‰æ•ˆæ”¹å–„äº†ã€‚<br />
ï¼ˆå¾…ç»­â€¦ï¼‰</p>

:ET