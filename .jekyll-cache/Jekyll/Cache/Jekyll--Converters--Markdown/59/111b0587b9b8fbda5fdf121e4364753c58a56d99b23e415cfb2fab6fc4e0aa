I"¿¼<p><img src="/attachments/201904/tensorFlow2/tf-logo-card-2.png" alt="" /></p>
<h4 id="ä¸‰ç§å¼€å‘æ¨¡å¼">ä¸‰ç§å¼€å‘æ¨¡å¼</h4>
<p>ä½¿ç”¨TensorFlow 2.0å®Œæˆæœºå™¨å­¦ä¹ ä¸€èˆ¬æœ‰ä¸‰ç§æ–¹å¼ï¼š</p>
<ul>
  <li>ä½¿ç”¨åº•å±‚é€»è¾‘<br />
è¿™ç§æ–¹å¼ä½¿ç”¨Pythonå‡½æ•°è‡ªå®šä¹‰å­¦ä¹ æ¨¡å‹ï¼ŒæŠŠæ•°å­¦å…¬å¼è½¬åŒ–ä¸ºå¯æ‰§è¡Œçš„ç¨‹åºé€»è¾‘ã€‚æ¥ç€åœ¨è®­ç»ƒå¾ªç¯ä¸­ï¼Œé€šè¿‡tf.GradientTape()è¿­ä»£ï¼Œä½¿ç”¨tape.gradient()æ¢¯åº¦ä¸‹é™ï¼Œä½¿ç”¨optimizer.apply_gradients()æ›´æ–°æ¨¡å‹æƒé‡ï¼Œé€æ¬¡é€¼è¿‘ï¼Œå®Œæˆæ¨¡å‹è®­ç»ƒã€‚</li>
  <li>ä½¿ç”¨Kerasé«˜å±‚æ¥å£<br />
TensorFlow 1.xçš„å¼€å‘ä¸­ï¼ŒKeraså°±ä½œä¸ºç¬¬ä¸‰æ–¹åº“å­˜åœ¨ã€‚2.0ä¸­ï¼Œæ›´æ˜¯å·²ç»æˆä¸ºæ ‡å‡†é…ç½®ã€‚æˆ‘ä»¬å‰é¢å¤§å¤šçš„ä¾‹å­éƒ½æ˜¯åŸºäºKerasæˆ–è€…è‡ªå®šä¹‰Kerasæ¨¡å‹é…åˆåº•å±‚è®­ç»ƒå¾ªç¯å®Œæˆã€‚ä»ç½‘ä¸Šçš„ä¸€äº›å¼€æºé¡¹ç›®æ¥çœ‹ï¼Œè¿™å·²ç»æ˜¯åº”ç”¨æœ€å¹¿æ³›çš„æ–¹å¼ã€‚</li>
  <li>ä»Šå¤©è¦ä»‹ç»çš„è¯„ä¼°å™¨tf.estimator<br />
è¯„ä¼°å™¨æ˜¯TensorFlowå®˜æ–¹æ¨èçš„å†…ç½®é«˜çº§APIï¼Œå±‚æ¬¡ä¸Šçœ‹è·ŸKeraså®é™…å¤„äºåŒæ ·ä½ç½®ï¼Œåªæ˜¯ä¼¼ä¹å¤§å®¶éƒ½è§†è€Œä¸è§äº†ï¼Œä»¥è‡³äºç°åœ¨ä»ç”¨æˆ·çš„å®é™…æƒ…å†µçœ‹ç”¨çš„äººè¦è¿œè¿œå°‘äºKerasã€‚</li>
</ul>

<p><img src="/attachments/201904/tensorFlow2/est-struct-1.png" alt="" />
é€šå¸¸è®¤ä¸ºè¯„ä¼°å™¨å› ä¸ºå†…ç½®çš„ç´§å¯†ç»“åˆï¼Œè¿è¡Œé€Ÿåº¦è¦é«˜äºKerasã€‚Kerasä¸€ç›´æ˜¯ä¸€ä¸ªé€šç”¨çš„é«˜å±‚æ¡†æ¶ï¼Œé™¤äº†æ”¯æŒTensorFlowä½œä¸ºåç«¯ï¼Œè¿˜åŒæ—¶æ”¯æŒTheanoå’ŒCNTKã€‚é«˜åº¦çš„æŠ½è±¡è‚¯å®šä¼šå½±å“Kerasçš„é€Ÿåº¦ï¼Œä¸è¿‡æœ¬äººå¹¶æœªå®é™…å¯¹æ¯”æµ‹è¯•ã€‚æˆ‘è§‰çš„ï¼Œå¯¹äºå¤§é‡æ•°æ®å¯¼è‡´çš„é•¿æ—¶é—´è®­ç»ƒæ¥è¯´ï¼Œè¿™ç‚¹æ•ˆç‡ä¸Šçš„å·®å¼‚ä¸åº”å½“æˆä¸ºå¤§é—®é¢˜ï¼Œå¦åˆ™Pythonè¿™ç§è§£é‡Šå‹çš„è¯­è¨€å°±ä¸ä¼šæˆä¸ºä¼˜é€‰çš„æœºå™¨å­¦ä¹ åŸºç¡€å¹³å°äº†ã€‚<br />
åœ¨TensorFlow 1.xä¸­å¯ä»¥ä½¿ç”¨tf.estimator.model_to_estimatoræ–¹æ³•å°†Kerasæ¨¡å‹è½¬æ¢ä¸ºTensorFlowè¯„ä¼°å™¨ã€‚TensorFlow 2.0ä¸­ï¼Œç»Ÿä¸€åˆ°äº†tf.keras.estimator.model_to_estimatoræ–¹æ³•ã€‚æ‰€ä»¥å¦‚æœåçˆ±è¯„ä¼°å™¨çš„è¯ï¼Œä½¿ç”¨Kerasä¹Ÿä¸ä¼šæˆä¸ºéšœç¢ã€‚</p>

<h4 id="è¯„ä¼°å™¨åŸºæœ¬å·¥ä½œæµç¨‹">è¯„ä¼°å™¨åŸºæœ¬å·¥ä½œæµç¨‹</h4>
<p>å…¶å®ä»ç¼–ç¨‹é€»è¾‘æ¥çœ‹ï¼Œè¿™äº›é«˜å±‚APIæ‰€æä¾›çš„å·¥ä½œæ–¹å¼æ˜¯å¾ˆç›¸ä¼¼çš„ã€‚ä½¿ç”¨è¯„ä¼°å™¨å¼€å‘æœºå™¨å­¦ä¹ å¤§è‡´åˆ†ä¸ºå¦‚ä¸‹æ­¥éª¤ï¼š</p>
<ul>
  <li>è½½å…¥æ•°æ®</li>
  <li>æ•°æ®æ¸…æ´—å’Œæ•°æ®é¢„å¤„ç†</li>
  <li>ç¼–å†™æ•°æ®æµæ°´çº¿è¾“å…¥å‡½æ•°</li>
  <li>å®šä¹‰è¯„ä¼°å™¨æ¨¡å‹</li>
  <li>è®­ç»ƒ</li>
  <li>è¯„ä¼°</li>
</ul>

<p>åœ¨è¿™ä¸ªæµç¨‹é‡Œé¢ï¼Œåªæœ‰â€œç¼–å†™æ•°æ®æµæ°´çº¿è¾“å…¥å‡½æ•°â€è¿™ä¸€æ­¥æ˜¯è·ŸKerasæ¨¡å‹æ˜¯ä¸åŒçš„ã€‚åœ¨Kerasæ¨¡å‹ä¸­ï¼Œæˆ‘ä»¬ç›´æ¥å‡†å¤‡æ•°æ®é›†ï¼ŒæŠŠæ•°æ®é›†é€å…¥åˆ°æ¨¡å‹å³å¯ã€‚è€Œåœ¨è¯„ä¼°å™¨ä¸­ï¼Œæ•°æ®çš„è¾“å…¥ï¼Œéœ€è¦æŒ‡å®šä¸€ä¸ªå‡½æ•°ä¾›è¯„ä¼°å™¨è°ƒç”¨ã€‚</p>

<h4 id="ä½¿ç”¨è¯„ä¼°å™¨çš„å®ä¾‹">ä½¿ç”¨è¯„ä¼°å™¨çš„å®ä¾‹</h4>
<p>è¿™ä¸€ä¸ªæ¥è‡ªå®˜æ–¹æ–‡æ¡£çš„å®ä¾‹æ¯”è¾ƒæ®‹é…·ï¼Œä½¿ç”¨æ³°å¦å°¼å…‹å·çš„ä¹˜å®¢åå•ï¼Œè¯„ä¼°åœ¨æ²‰èˆ¹äº‹ä»¶å‘ç”Ÿåï¼Œå®¢æˆ·èƒ½ç”Ÿå­˜ä¸‹æ¥çš„å¯èƒ½æ€§ã€‚<br />
æ•°æ®æ ¼å¼æ˜¯csvï¼Œå»ºè®®å…ˆä¸‹è½½ï¼Œä¿å­˜åˆ°å·¥ä½œç›®å½•ï¼š<br />
è®­ç»ƒé›†æ•°æ®ï¼š<a href="https://storage.googleapis.com/tf-datasets/titanic/train.csv">https://storage.googleapis.com/tf-datasets/titanic/train.csv</a><br />
è¯„ä¼°é›†æ•°æ®ï¼š<a href="https://storage.googleapis.com/tf-datasets/titanic/eval.csv">https://storage.googleapis.com/tf-datasets/titanic/eval.csv</a><br />
æ–‡ä»¶ä¸‹è½½åä¸è¦ä¿®æ”¹åç§°ã€‚</p>

<p>æ•°æ®åŒ…å«å¦‚ä¸‹å±æ€§ç»´åº¦ï¼š</p>

<table>
  <thead>
    <tr>
      <th>å±æ€§åç§°</th>
      <th>å±æ€§æè¿°</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>sex</td>
      <td>ä¹˜å®¢æ€§åˆ«</td>
    </tr>
    <tr>
      <td>age</td>
      <td>ä¹˜å®¢å¹´é¾„</td>
    </tr>
    <tr>
      <td>n_siblings_spouses</td>
      <td>éšè¡Œå…„å¼Ÿæˆ–è€…é…å¶æ•°é‡</td>
    </tr>
    <tr>
      <td>parch</td>
      <td>éšè¡Œçˆ¶æ¯æˆ–è€…å­å¥³æ•°é‡</td>
    </tr>
    <tr>
      <td>fare</td>
      <td>èˆ¹è´¹é‡‘é¢</td>
    </tr>
    <tr>
      <td>class</td>
      <td>èˆ¹èˆ±ç­‰çº§</td>
    </tr>
    <tr>
      <td>deck</td>
      <td>ç”²æ¿ç¼–å·</td>
    </tr>
    <tr>
      <td>embark_town</td>
      <td>ç™»èˆ¹åœ°ç‚¹</td>
    </tr>
    <tr>
      <td>alone</td>
      <td>æ˜¯å¦ä¸ºç‹¬è‡ªæ—…è¡Œ</td>
    </tr>
  </tbody>
</table>

<p>ä»è¿™äº›å±æ€§ä¸­èƒ½çœ‹å‡ºï¼Œæ•°æ®çš„æ”¶é›†è€…æ˜¯éå¸¸ç”¨å¿ƒçš„ã€‚<br />
æ¯”å¦‚éšè¡Œå…„å¼Ÿæˆ–è€…é…å¶ã€éšè¡Œçˆ¶æ¯æˆ–è€…å­å¥³è¿™ç§ç‰¹å¾ï¼Œåœ¨å¤§å¤šäººçš„ä¼ ç»Ÿè§‚å¿µä¸­ï¼Œè‚¯å®šä¼šç”¨ç±»ä¼¼â€œéšè¡Œå®¶å±æ•°é‡â€è¿™æ ·çš„ç»´åº¦åˆå¹¶åœ¨ä¸€èµ·ã€‚<br />
ä½†åœ¨è¿™ä¸ªæ¡ˆä¾‹ä¸­ï¼Œä¸¤ä¸ªä¸åŒçš„ç»´åº¦ï¼Œå¯¹äºæœ€ç»ˆå­˜æ´»å½±å“è‚¯å®šæ˜¯ä¸åŒçš„ã€‚</p>

<h4 id="åŸºæœ¬æ•°æ®åˆ†æ">åŸºæœ¬æ•°æ®åˆ†æ</h4>
<p>è¿™éƒ¨åˆ†çš„å·¥ä½œå…¶å®è·Ÿè¯„ä¼°å™¨çš„ä½¿ç”¨æ²¡æœ‰ä»€ä¹ˆå…³ç³»ï¼Œä½†è¿™æ­£æ˜¯å¤§æ•°æ®æ—¶ä»£çš„é­…åŠ›æ‰€åœ¨ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜æ˜¯å»¶ç»­å®˜æ–¹æ–‡æ¡£çš„æ€è·¯æ¥çœ‹ä¸€çœ‹ã€‚</p>

<p>å…ˆåœ¨å‘½ä»¤è¡Œæ‰§è¡ŒPythonï¼Œå¯åŠ¨äº¤äº’ç¯å¢ƒã€‚ç„¶åæŠŠä¸‹é¢è¿™éƒ¨åˆ†ä»£ç æ‹·è´åˆ°Pythonæ‰§è¡Œã€‚è¿™äº›ä»£ç å®Œæˆå¼•ç”¨æ‰©å±•åº“ã€è½½å…¥æ•°æ®ç­‰åŸºæœ¬å·¥ä½œã€‚</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># å¼•å…¥æ‰©å±•åº“
</span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">unicode_literals</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="n">tf</span>

<span class="c1"># è½½å…¥æ•°æ®
</span><span class="n">dftrain</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">'train.csv'</span><span class="p">)</span>
<span class="n">dfeval</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">'eval.csv'</span><span class="p">)</span>
<span class="c1"># åˆ†ç¦»æ ‡æ³¨å­—æ®µ
</span><span class="n">y_train</span> <span class="o">=</span> <span class="n">dftrain</span><span class="p">.</span><span class="n">pop</span><span class="p">(</span><span class="s">'survived'</span><span class="p">)</span>
<span class="n">y_eval</span> <span class="o">=</span> <span class="n">dfeval</span><span class="p">.</span><span class="n">pop</span><span class="p">(</span><span class="s">'survived'</span><span class="p">)</span>

<span class="n">dftrain</span><span class="p">.</span><span class="n">head</span><span class="p">()</span>

</code></pre></div></div>
<p>è¿™æ—¶å€™å‘½ä»¤è¡Œçœ‹èµ·æ¥å¤§è‡´æ˜¯è¿™ä¸ªæ ·å­ï¼š</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>python3
Python 3.7.3 <span class="o">(</span>default, Mar 27 2019, 09:23:39<span class="o">)</span> 
<span class="o">[</span>Clang 10.0.0 <span class="o">(</span>clang-1000.11.45.5<span class="o">)]</span> on darwin
Type <span class="s2">"help"</span>, <span class="s2">"copyright"</span>, <span class="s2">"credits"</span> or <span class="s2">"license"</span> <span class="k">for </span>more information.
<span class="o">&gt;&gt;&gt;</span> <span class="c"># å¼•å…¥æ‰©å±•åº“</span>
... from __future__ import absolute_import, division, print_function, unicode_literals
<span class="o">&gt;&gt;&gt;</span> 
<span class="o">&gt;&gt;&gt;</span> import numpy as np
<span class="o">&gt;&gt;&gt;</span> import pandas as pd
<span class="o">&gt;&gt;&gt;</span> import matplotlib.pyplot as plt
<span class="o">&gt;&gt;&gt;</span> import tensorflow as tf
<span class="o">&gt;&gt;&gt;</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="c"># è½½å…¥æ•°æ®</span>
... dftrain <span class="o">=</span> pd.read_csv<span class="o">(</span><span class="s1">'train.csv'</span><span class="o">)</span>
<span class="o">&gt;&gt;&gt;</span> dfeval <span class="o">=</span> pd.read_csv<span class="o">(</span><span class="s1">'eval.csv'</span><span class="o">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="c"># åˆ†ç¦»æ ‡æ³¨å­—æ®µ</span>
... y_train <span class="o">=</span> dftrain.pop<span class="o">(</span><span class="s1">'survived'</span><span class="o">)</span>
<span class="o">&gt;&gt;&gt;</span> y_eval <span class="o">=</span> dfeval.pop<span class="o">(</span><span class="s1">'survived'</span><span class="o">)</span>
<span class="o">&gt;&gt;&gt;</span> 
<span class="o">&gt;&gt;&gt;</span> dftrain.head<span class="o">()</span>
      sex   age  n_siblings_spouses  parch     fare  class     deck  embark_town alone
0    male  22.0                   1      0   7.2500  Third  unknown  Southampton     n
1  female  38.0                   1      0  71.2833  First        C    Cherbourg     n
2  female  26.0                   0      0   7.9250  Third  unknown  Southampton     y
3  female  35.0                   1      0  53.1000  First        C  Southampton     n
4    male  28.0                   0      0   8.4583  Third  unknown   Queenstown     y
<span class="o">&gt;&gt;&gt;</span> 
</code></pre></div></div>
<p>æœ€åæ˜¯åˆ—å‡ºçš„è®­ç»ƒé›†å¤´5æ¡è®°å½•ã€‚<br />
æˆ‘ä»¬å…ˆçœ‹çœ‹ä¹˜å®¢çš„å¹´é¾„åˆ†å¸ƒ(åç»­çš„ä»£ç éƒ½æ˜¯ç›´æ¥æ‹·è´åˆ°Pythonå‘½ä»¤è¡Œæ‰§è¡Œ)ï¼š</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dftrain</span><span class="p">.</span><span class="n">age</span><span class="p">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>
<p><img src="/attachments/201904/tensorFlow2/est-age-0.png" alt="" />
ç›´æ–¹å›¾ä¸­æ˜¾ç¤ºï¼Œä¹˜å®¢å¹´é¾„ä¸»è¦åˆ†å¸ƒåœ¨20å²è‡³30å²ä¹‹é—´ã€‚<br />
å†æ¥çœ‹çœ‹æ€§åˆ«åˆ†å¸ƒï¼š</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dftrain</span><span class="p">.</span><span class="n">sex</span><span class="p">.</span><span class="n">value_counts</span><span class="p">().</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s">'barh'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>
<p><img src="/attachments/201904/tensorFlow2/est-sex-0.png" alt="" />
ç”·æ€§ä¹˜å®¢çš„æ•°é‡ï¼Œå‡ ä¹æ˜¯å¥³æ€§ä¹˜å®¢çš„ä¸¤å€ã€‚<br />
æ¥ç€æ˜¯èˆ¹èˆ±ç­‰çº§çš„åˆ†å¸ƒï¼Œè¿™ä¸ªå‚æ•°èƒ½é—´æ¥ä½“ç°ä¹˜å®¢çš„ç»æµå®åŠ›ï¼š</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dftrain</span><span class="p">[</span><span class="s">'class'</span><span class="p">].</span><span class="n">value_counts</span><span class="p">().</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s">'barh'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>
<p><img src="/attachments/201904/tensorFlow2/est-class-0.png" alt="" />
å›¾ä¸­æ˜¾ç¤ºï¼Œå¤§å¤šæ•°ä¹˜å®¢è¿˜æ˜¯åœ¨ä¸‰ç­‰èˆ±ã€‚<br />
ç»§ç»­çœ‹ä¹˜å®¢ä¸Šèˆ¹çš„åœ°ç‚¹ï¼š</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">dftrain</span><span class="p">[</span><span class="s">'embark_town'</span><span class="p">].</span><span class="n">value_counts</span><span class="p">().</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s">'barh'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>
<p><img src="/attachments/201904/tensorFlow2/est-town-0.png" alt="" />
å¤§å¤šæ•°ä¹˜å®¢æ¥è‡ªå—å®‰æ™®é¡¿ã€‚<br />
ç»§ç»­ï¼ŒæŠŠæ€§åˆ«è·Ÿæœ€åç”Ÿå­˜æ ‡æ³¨å…³è”èµ·æ¥ï¼š</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pd</span><span class="p">.</span><span class="n">concat</span><span class="p">([</span><span class="n">dftrain</span><span class="p">,</span> <span class="n">y_train</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">).</span><span class="n">groupby</span><span class="p">(</span><span class="s">'sex'</span><span class="p">).</span><span class="n">survived</span><span class="p">.</span><span class="n">mean</span><span class="p">().</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s">'barh'</span><span class="p">).</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">'% survive'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>
<p><img src="/attachments/201904/tensorFlow2/est-sex-1.png" alt="" />
å¥³æ€§çš„å­˜æ´»ç‡å‡ ä¹è¶…è¿‡ç”·æ€§çš„5å€ã€‚<br />
å†æ¥ä¸€ä¸ªæ›´å¤æ‚çš„ç»Ÿè®¡ï¼Œæˆ‘ä»¬é¦–å…ˆæŠŠå¹´é¾„åˆ†æ®µï¼Œç„¶åçœ‹çœ‹ä¸åŒå¹´é¾„æ®µçš„ä¹˜å®¢æœ€ç»ˆå­˜æ´»ç‡ï¼š</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">calc_age_section</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">lim</span><span class="p">):</span>
    <span class="k">return</span><span class="s">'[%.f,%.f)'</span> <span class="o">%</span> <span class="p">(</span><span class="n">lim</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">//</span><span class="n">lim</span><span class="p">),</span> <span class="n">lim</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">//</span><span class="n">lim</span><span class="p">)</span><span class="o">+</span><span class="n">lim</span><span class="p">)</span>  <span class="c1"># map function
</span>
<span class="n">addone</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">Series</span><span class="p">([</span><span class="n">calc_age_section</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">dftrain</span><span class="p">.</span><span class="n">age</span><span class="p">])</span>
<span class="n">dftrain</span><span class="p">[</span><span class="s">'ages'</span><span class="p">]</span> <span class="o">=</span> <span class="n">addone</span>
<span class="n">pd</span><span class="p">.</span><span class="n">concat</span><span class="p">([</span><span class="n">dftrain</span><span class="p">,</span> <span class="n">y_train</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">).</span><span class="n">groupby</span><span class="p">(</span><span class="s">'ages'</span><span class="p">).</span><span class="n">survived</span><span class="p">.</span><span class="n">mean</span><span class="p">().</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s">'barh'</span><span class="p">).</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">'% survive'</span><span class="p">);</span>
<span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>

</code></pre></div></div>
<p><img src="/attachments/201904/tensorFlow2/est-survive-ages-0.png" alt="" />
10å²ä»¥ä¸‹å„¿ç«¥å’Œ80å²ä»¥ä¸Šçš„è€äººå¾—åˆ°äº†æœ€å¤šçš„ç”Ÿå­˜æœºä¼šã€‚<br />
åœ¨é‚£ä¸ªå¯’å†·ã€æ…Œä¹±çš„æ²‰èˆ¹å¤œæ™šï¼Œå¼±è€…åè€Œæ›´å¤šçš„æ´»äº†ä¸‹æ¥ã€‚</p>

<h4 id="æ•°æ®çš„é¢„å¤„ç†">æ•°æ®çš„é¢„å¤„ç†</h4>
<p>æ•°æ®é¢„å¤„ç†è¿™ä¸ªè¯é¢˜æˆ‘ä»¬è®²äº†å¾ˆå¤šæ¬¡ï¼Œè¿™æ˜¯é€šå¸¸æœºå™¨å­¦ä¹ ç ”å‘å·¥ä½œä¸­ï¼Œå·¥ç¨‹å¸ˆéœ€è¦åšçš„æœ€å¤šå·¥ä½œã€‚<br />
æ³°å¦å°¼å…‹å·ä¹˜å®¢åå•çš„æ•°æ®è™½ç„¶ä¸å¤æ‚ï¼Œä¹Ÿå±äºå…¸å‹çš„ç»“æ„åŒ–æ•°æ®ã€‚<br />
å…¶ä¸­ä¸»è¦åŒ…å«ä¸¤ç±»ï¼Œä¸€ç§æ˜¯åˆ†ç±»å‹çš„æ•°æ®ï¼Œæ¯”å¦‚èˆ¹èˆ±ç­‰çº§ï¼Œæ¯”å¦‚ä¸Šèˆ¹åŸå¸‚åç§°ã€‚å¦ä¸€ç±»åˆ™æ˜¯ç®€å•çš„æ•°å€¼ï¼Œæ¯”å¦‚å¹´é¾„å’Œè´­ç¥¨ä»·æ ¼ã€‚<br />
å¯¹äºæ•°å€¼å‹çš„æ•°æ®å¯ä»¥ç›´æ¥è§„èŒƒåŒ–åè¿›å…¥æ¨¡å‹ï¼Œå¯¹äºåˆ†ç±»å‹çš„æ•°æ®ï¼Œåˆ™è¿˜éœ€è¦åšç¼–ç ï¼Œæˆ‘ä»¬è¿™é‡Œè¿˜æ˜¯ä½¿ç”¨æœ€å¸¸è§çš„one-hotã€‚</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># å®šä¹‰æ‰€éœ€çš„æ•°æ®åˆ—ï¼Œåˆ†ä¸ºåˆ†ç±»å‹å±æ€§å’Œæ•°å€¼å‹å±æ€§åˆ†åˆ«å®šä¹‰
</span><span class="n">CATEGORICAL_COLUMNS</span> <span class="o">=</span> <span class="p">[</span><span class="s">'sex'</span><span class="p">,</span> <span class="s">'n_siblings_spouses'</span><span class="p">,</span> <span class="s">'parch'</span><span class="p">,</span> <span class="s">'class'</span><span class="p">,</span> <span class="s">'deck'</span><span class="p">,</span> 
                       <span class="s">'embark_town'</span><span class="p">,</span> <span class="s">'alone'</span><span class="p">]</span>
<span class="n">NUMERIC_COLUMNS</span> <span class="o">=</span> <span class="p">[</span><span class="s">'age'</span><span class="p">,</span> <span class="s">'fare'</span><span class="p">]</span>

<span class="c1"># è¾…åŠ©å‡½æ•°ï¼ŒæŠŠç»™å®šæ•°æ®åˆ—åšone-hotç¼–ç 
</span><span class="k">def</span> <span class="nf">one_hot_cat_column</span><span class="p">(</span><span class="n">feature_name</span><span class="p">,</span> <span class="n">vocab</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">tf</span><span class="p">.</span><span class="n">feature_column</span><span class="p">.</span><span class="n">indicator_column</span><span class="p">(</span>
        <span class="n">tf</span><span class="p">.</span><span class="n">feature_column</span><span class="p">.</span><span class="n">categorical_column_with_vocabulary_list</span><span class="p">(</span><span class="n">feature_name</span><span class="p">,</span>
                                                                  <span class="n">vocab</span><span class="p">))</span>

<span class="c1"># æœ€ç»ˆä½¿ç”¨çš„æ•°æ®åˆ—ï¼Œå…ˆç½®ç©º
</span><span class="n">feature_columns</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">feature_name</span> <span class="ow">in</span> <span class="n">CATEGORICAL_COLUMNS</span><span class="p">:</span>
    <span class="c1"># åˆ†ç±»çš„å±æ€§éƒ½è¦åšone-hotç¼–ç ï¼Œç„¶ååŠ å…¥æ•°æ®åˆ—
</span>    <span class="n">vocabulary</span> <span class="o">=</span> <span class="n">dftrain</span><span class="p">[</span><span class="n">feature_name</span><span class="p">].</span><span class="n">unique</span><span class="p">()</span>
    <span class="n">feature_columns</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">one_hot_cat_column</span><span class="p">(</span><span class="n">feature_name</span><span class="p">,</span> <span class="n">vocabulary</span><span class="p">))</span>

<span class="k">for</span> <span class="n">feature_name</span> <span class="ow">in</span> <span class="n">NUMERIC_COLUMNS</span><span class="p">:</span>
    <span class="c1"># æ•°å€¼ç±»çš„å±æ€§ç›´æ¥å…¥åˆ—
</span>    <span class="n">feature_columns</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">tf</span><span class="p">.</span><span class="n">feature_column</span><span class="p">.</span><span class="n">numeric_column</span><span class="p">(</span><span class="n">feature_name</span><span class="p">,</span>
                                                            <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="p">.</span><span class="n">float32</span><span class="p">))</span>
</code></pre></div></div>

<h4 id="æ•°æ®è¾“å…¥å‡½æ•°">æ•°æ®è¾“å…¥å‡½æ•°</h4>
<p>è¯„ä¼°å™¨çš„è®­ç»ƒã€è¯„ä¼°éƒ½éœ€è¦ä½¿ç”¨æ•°æ®è¾“å…¥å‡½æ•°ä½œä¸ºå‚æ•°ã€‚è¾“å…¥å‡½æ•°æœ¬èº«ä¸æ¥å—ä»»ä½•å‚æ•°ï¼Œè¿”å›ä¸€ä¸ªtf.data.Datasetå¯¹è±¡ç»™æ¨¡å‹ç”¨äºä¾›ç»™æ•°æ®ã€‚<br />
å› ä¸ºé™¤äº†æ•°æ®é›†ä¸åŒï¼Œè®­ç»ƒå’Œè¯„ä¼°æ¨¡å‹æ‰€ä½¿ç”¨çš„æ•°æ®æ ¼å¼é€šå¸¸éƒ½æ˜¯ä¸€æ ·çš„ã€‚æ‰€ä»¥ç»å¸¸ä¼šåœ¨ç¨‹åºä»£ç ä¸Šï¼Œå…±ç”¨ä¸€ä¸ªå‡½æ•°ï¼Œç„¶åç”¨å‚æ•°æ¥åŒºåˆ†ç”¨äºè¯„ä¼°è¿˜æ˜¯ç”¨äºè®­ç»ƒã€‚<br />
ç„¶è€Œè¾“å…¥å‡½æ•°ç›¸å½“äºå›è°ƒå‡½æ•°ï¼Œç”±è¯„ä¼°å™¨æ§åˆ¶ç€è°ƒç”¨ï¼Œè¿™è¿‡ç¨‹ä¸­å¹¶æ²¡æœ‰å‚æ•°ä¼ é€’ã€‚æ‰€ä»¥æ¯”è¾ƒèªæ˜çš„åšæ³•å¯ä»¥ä½¿ç”¨åµŒå¥—å‡½æ•°çš„æ–¹æ³•æ¥å®šä¹‰ï¼Œæ¯”å¦‚ï¼š</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># è¿™æ˜¯ä¸€ä¸ªå¾ˆå°‘é‡æ•°æ®çš„æ ·æœ¬ï¼Œç›´æ¥æŠŠæ•´ä¸ªæ•°æ®é›†å½“åšä¸€æ‰¹
</span><span class="n">NUM_EXAMPLES</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span>
<span class="c1"># è¾“å…¥å‡½æ•°çš„æ„é€ å‡½æ•°
</span><span class="k">def</span> <span class="nf">make_input_fn</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">n_epochs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">input_fn</span><span class="p">():</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">Dataset</span><span class="p">.</span><span class="n">from_tensor_slices</span><span class="p">((</span><span class="nb">dict</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">y</span><span class="p">))</span>
        <span class="c1"># ä¹±åº
</span>        <span class="k">if</span> <span class="n">shuffle</span><span class="p">:</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">NUM_EXAMPLES</span><span class="p">)</span>
        <span class="c1"># è®­ç»ƒæ—¶è®©æ•°æ®é‡å¤å°½é‡å¤šçš„æ¬¡æ•°
</span>        <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">n_epochs</span><span class="p">)</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">.</span><span class="n">batch</span><span class="p">(</span><span class="n">NUM_EXAMPLES</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dataset</span>
    <span class="k">return</span> <span class="n">input_fn</span>

<span class="c1"># è®­ç»ƒã€è¯„ä¼°æ‰€ä½¿ç”¨çš„æ•°æ®è¾“å…¥å‡½æ•°ï¼ŒåŒºåˆ«åªæ˜¯æ•°æ®æ˜¯å¦ä¹±åºä»¥åŠè¿­ä»£å¤šå°‘æ¬¡
</span><span class="n">train_input_fn</span> <span class="o">=</span> <span class="n">make_input_fn</span><span class="p">(</span><span class="n">dftrain</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">eval_input_fn</span> <span class="o">=</span> <span class="n">make_input_fn</span><span class="p">(</span><span class="n">dfeval</span><span class="p">,</span> <span class="n">y_eval</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">n_epochs</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

</code></pre></div></div>

<h4 id="æ¨¡å‹å’Œæºç ">æ¨¡å‹å’Œæºç </h4>
<p>æœ¬ä¾‹ä¸­æˆ‘ä»¬ç›´æ¥ä½¿ç”¨é¢„å®šä¹‰çš„è¯„ä¼°å™¨æ¨¡å‹(pre-made estimator)ã€‚æ‰€ä»¥ä»£ç éå¸¸ç®€å•ï¼Œå®šä¹‰ã€è®­ç»ƒã€è¯„ä¼°éƒ½æ˜¯åªéœ€è¦ä¸€è¡Œä»£ç ï¼š</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ä½¿ç”¨çº¿æ€§åˆ†ç±»å™¨ä½œä¸ºæ¨¡å‹
</span><span class="n">linear_est</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">estimator</span><span class="p">.</span><span class="n">LinearClassifier</span><span class="p">(</span><span class="n">feature_columns</span><span class="p">)</span>

<span class="c1"># è®­ç»ƒ
</span><span class="n">linear_est</span><span class="p">.</span><span class="n">train</span><span class="p">(</span><span class="n">train_input_fn</span><span class="p">,</span> <span class="n">max_steps</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

<span class="c1"># è¯„ä¼°
</span><span class="n">result</span> <span class="o">=</span> <span class="n">linear_est</span><span class="p">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">eval_input_fn</span><span class="p">)</span>
</code></pre></div></div>
<p>æˆ‘ä»¬æ¥çœ‹çœ‹å®Œæ•´ä»£ç ï¼š</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span>
<span class="c1"># å¼•å…¥æ‰©å±•åº“
</span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">unicode_literals</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="n">tf</span>

<span class="c1"># è½½å…¥æ•°æ®
</span><span class="n">dftrain</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">'train.csv'</span><span class="p">)</span>
<span class="n">dfeval</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">'eval.csv'</span><span class="p">)</span>
<span class="c1"># åˆ†ç¦»æ ‡æ³¨å­—æ®µ
</span><span class="n">y_train</span> <span class="o">=</span> <span class="n">dftrain</span><span class="p">.</span><span class="n">pop</span><span class="p">(</span><span class="s">'survived'</span><span class="p">)</span>
<span class="n">y_eval</span> <span class="o">=</span> <span class="n">dfeval</span><span class="p">.</span><span class="n">pop</span><span class="p">(</span><span class="s">'survived'</span><span class="p">)</span>

<span class="c1">################################################################
# å®šä¹‰æ‰€éœ€çš„æ•°æ®åˆ—ï¼Œåˆ†ä¸ºåˆ†ç±»å‹å±æ€§å’Œæ•°å€¼å‹å±æ€§åˆ†åˆ«å®šä¹‰
</span><span class="n">CATEGORICAL_COLUMNS</span> <span class="o">=</span> <span class="p">[</span><span class="s">'sex'</span><span class="p">,</span> <span class="s">'n_siblings_spouses'</span><span class="p">,</span> <span class="s">'parch'</span><span class="p">,</span> <span class="s">'class'</span><span class="p">,</span> <span class="s">'deck'</span><span class="p">,</span> 
                       <span class="s">'embark_town'</span><span class="p">,</span> <span class="s">'alone'</span><span class="p">]</span>
<span class="n">NUMERIC_COLUMNS</span> <span class="o">=</span> <span class="p">[</span><span class="s">'age'</span><span class="p">,</span> <span class="s">'fare'</span><span class="p">]</span>

<span class="c1"># è¾…åŠ©å‡½æ•°ï¼ŒæŠŠç»™å®šæ•°æ®åˆ—åšone-hotç¼–ç 
</span><span class="k">def</span> <span class="nf">one_hot_cat_column</span><span class="p">(</span><span class="n">feature_name</span><span class="p">,</span> <span class="n">vocab</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">tf</span><span class="p">.</span><span class="n">feature_column</span><span class="p">.</span><span class="n">indicator_column</span><span class="p">(</span>
        <span class="n">tf</span><span class="p">.</span><span class="n">feature_column</span><span class="p">.</span><span class="n">categorical_column_with_vocabulary_list</span><span class="p">(</span><span class="n">feature_name</span><span class="p">,</span>
                                                                  <span class="n">vocab</span><span class="p">))</span>

<span class="c1"># æœ€ç»ˆä½¿ç”¨çš„æ•°æ®åˆ—ï¼Œå…ˆç½®ç©º
</span><span class="n">feature_columns</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">feature_name</span> <span class="ow">in</span> <span class="n">CATEGORICAL_COLUMNS</span><span class="p">:</span>
    <span class="c1"># åˆ†ç±»çš„å±æ€§éƒ½è¦åšone-hotç¼–ç ï¼Œç„¶ååŠ å…¥æ•°æ®åˆ—
</span>    <span class="n">vocabulary</span> <span class="o">=</span> <span class="n">dftrain</span><span class="p">[</span><span class="n">feature_name</span><span class="p">].</span><span class="n">unique</span><span class="p">()</span>
    <span class="n">feature_columns</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">one_hot_cat_column</span><span class="p">(</span><span class="n">feature_name</span><span class="p">,</span> <span class="n">vocabulary</span><span class="p">))</span>

<span class="k">for</span> <span class="n">feature_name</span> <span class="ow">in</span> <span class="n">NUMERIC_COLUMNS</span><span class="p">:</span>
    <span class="c1"># æ•°å€¼ç±»çš„å±æ€§ç›´æ¥å…¥åˆ—
</span>    <span class="n">feature_columns</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">tf</span><span class="p">.</span><span class="n">feature_column</span><span class="p">.</span><span class="n">numeric_column</span><span class="p">(</span><span class="n">feature_name</span><span class="p">,</span>
                                                            <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="p">.</span><span class="n">float32</span><span class="p">))</span>

<span class="c1">################################################################
# è¿™æ˜¯ä¸€ä¸ªå¾ˆå°‘é‡æ•°æ®çš„æ ·æœ¬ï¼Œç›´æ¥æŠŠæ•´ä¸ªæ•°æ®é›†å½“åšä¸€æ‰¹
</span><span class="n">NUM_EXAMPLES</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">)</span>
<span class="c1"># è¾“å…¥å‡½æ•°çš„æ„é€ å‡½æ•°
</span><span class="k">def</span> <span class="nf">make_input_fn</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">n_epochs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">input_fn</span><span class="p">():</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">Dataset</span><span class="p">.</span><span class="n">from_tensor_slices</span><span class="p">((</span><span class="nb">dict</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">y</span><span class="p">))</span>
        <span class="c1"># ä¹±åº
</span>        <span class="k">if</span> <span class="n">shuffle</span><span class="p">:</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">NUM_EXAMPLES</span><span class="p">)</span>
        <span class="c1"># è®­ç»ƒæ—¶è®©æ•°æ®é‡å¤å°½é‡å¤šçš„æ¬¡æ•°
</span>        <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">n_epochs</span><span class="p">)</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">.</span><span class="n">batch</span><span class="p">(</span><span class="n">NUM_EXAMPLES</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dataset</span>
    <span class="k">return</span> <span class="n">input_fn</span>

<span class="c1"># è®­ç»ƒã€è¯„ä¼°æ‰€ä½¿ç”¨çš„æ•°æ®è¾“å…¥å‡½æ•°ï¼ŒåŒºåˆ«åªæ˜¯æ•°æ®æ˜¯å¦ä¹±åºä»¥åŠè¿­ä»£å¤šå°‘æ¬¡
</span><span class="n">train_input_fn</span> <span class="o">=</span> <span class="n">make_input_fn</span><span class="p">(</span><span class="n">dftrain</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">eval_input_fn</span> <span class="o">=</span> <span class="n">make_input_fn</span><span class="p">(</span><span class="n">dfeval</span><span class="p">,</span> <span class="n">y_eval</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">n_epochs</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># ä½¿ç”¨çº¿æ€§åˆ†ç±»å™¨ä½œä¸ºæ¨¡å‹
</span><span class="n">linear_est</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">estimator</span><span class="p">.</span><span class="n">LinearClassifier</span><span class="p">(</span><span class="n">feature_columns</span><span class="p">)</span>

<span class="c1"># è®­ç»ƒ
</span><span class="n">linear_est</span><span class="p">.</span><span class="n">train</span><span class="p">(</span><span class="n">train_input_fn</span><span class="p">,</span> <span class="n">max_steps</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

<span class="c1"># è¯„ä¼°
</span><span class="n">result</span> <span class="o">=</span> <span class="n">linear_est</span><span class="p">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">eval_input_fn</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"----------------------------------"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">pd</span><span class="p">.</span><span class="n">Series</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
</code></pre></div></div>
<p>ç¨‹åºæ‰§è¡Œçš„æœ€åæ˜¾ç¤ºäº†è¯„ä¼°çš„ç»“æœï¼Œåœ¨æˆ‘çš„ç”µè„‘ä¸Šæ˜¾ç¤ºçš„ç»“æœæ˜¯è¿™æ ·çš„ï¼š</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">----------------------------------</span>
accuracy                  0.765152
accuracy_baseline         0.625000
auc                       0.832844
auc_precision_recall      0.789631
average_loss              0.478908
label/mean                0.375000
loss                      0.478908
precision                 0.703297
prediction/mean           0.350790
recall                    0.646465
global_step             100.000000
</code></pre></div></div>
<p>æ­£ç¡®ç‡ä¸ç®—å¤ªé«˜ã€‚<br />
è¯„ä¼°å™¨çš„æ¨¡å‹ä½¿ç”¨èµ·æ¥å¾ˆç®€å•ï¼Œæˆ‘ä»¬å°è¯•æ¢ç”¨å¦å¤–ä¸€ç§æ¨¡å‹ï¼Œæ¯”å¦‚æå‡æ ‘åˆ†ç±»å™¨ã€‚</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ä»¥ä¸‹ä»£ç æ”¾åœ¨ç¨‹åºæœ€åï¼Œå› ä¸ºè¿™ä¸ªæ•°æ®é›†éå¸¸å°ï¼Œé€Ÿåº¦å¾ˆå¿«ï¼Œæ‰€ä»¥åšä¸¤æ¬¡å­¦ä¹ ä¹Ÿå¹¶ä¸æ„Ÿè§‰æ…¢
</span><span class="n">n_batches</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">est</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">estimator</span><span class="p">.</span><span class="n">BoostedTreesClassifier</span><span class="p">(</span><span class="n">feature_columns</span><span class="p">,</span>
                                          <span class="n">n_batches_per_layer</span><span class="o">=</span><span class="n">n_batches</span><span class="p">)</span>

<span class="c1"># è®­ç»ƒ
</span><span class="n">est</span><span class="p">.</span><span class="n">train</span><span class="p">(</span><span class="n">train_input_fn</span><span class="p">,</span> <span class="n">max_steps</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

<span class="c1"># è¯„ä¼°
</span><span class="n">result</span> <span class="o">=</span> <span class="n">est</span><span class="p">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">eval_input_fn</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"----------------------------------"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">pd</span><span class="p">.</span><span class="n">Series</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>

</code></pre></div></div>
<p>è¿™æ¬¡å¾—åˆ°çš„ç»“æœæ˜¯è¿™æ ·çš„ï¼š</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">----------------------------------</span>
<span class="n">accuracy</span>                  <span class="mf">0.825758</span>
<span class="n">accuracy_baseline</span>         <span class="mf">0.625000</span>
<span class="n">auc</span>                       <span class="mf">0.872360</span>
<span class="n">auc_precision_recall</span>      <span class="mf">0.857325</span>
<span class="n">average_loss</span>              <span class="mf">0.411853</span>
<span class="n">label</span><span class="o">/</span><span class="n">mean</span>                <span class="mf">0.375000</span>
<span class="n">loss</span>                      <span class="mf">0.411853</span>
<span class="n">precision</span>                 <span class="mf">0.784946</span>
<span class="n">prediction</span><span class="o">/</span><span class="n">mean</span>           <span class="mf">0.382282</span>
<span class="n">recall</span>                    <span class="mf">0.737374</span>
<span class="n">global_step</span>             <span class="mf">100.000000</span>
</code></pre></div></div>
<p>è™½ç„¶å‡†ç¡®ç‡ä»ç„¶å¹¶ä¸é«˜ï¼Œä½†æ¯”èµ·æ¥çº¿æ€§åˆ†ç±»å™¨ï¼Œæé«˜è¿˜æ˜¯ç®—çš„ä¸Šæ˜æ˜¾ã€‚</p>

<h4 id="æ€§èƒ½è¯„ä»·">æ€§èƒ½è¯„ä»·</h4>
<p>è¯„ä»·æœºå™¨å­¦ä¹ æ¨¡å‹çš„æ€§èƒ½ï¼Œé™¤äº†çœ‹åˆšæ‰çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œç»˜å›¾æ˜¯éå¸¸å¥½çš„ä¸€ç§æ–¹å¼ï¼Œå¯ä»¥æ›´ç›´è§‚ï¼ŒæŸäº›é—®é¢˜ä¹Ÿèƒ½ä½“ç°çš„ä¸€ç›®äº†ç„¶ã€‚<br />
æˆ‘ä»¬åœ¨ä¸Šé¢ç¨‹åºçš„æœ€åå†å¢åŠ å‡ è¡Œä»£ç ï¼Œç»˜åˆ¶é¢„æµ‹æ¦‚ç‡çš„ç»Ÿè®¡ä¿¡æ¯ï¼š</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ç»˜åˆ¶é¢„æµ‹æ¦‚ç‡ç›´æ–¹å›¾
</span><span class="n">pred_dicts1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">linear_est</span><span class="p">.</span><span class="n">predict</span><span class="p">(</span><span class="n">eval_input_fn</span><span class="p">))</span>
<span class="n">pred_dicts2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">bt_est</span><span class="p">.</span><span class="n">predict</span><span class="p">(</span><span class="n">eval_input_fn</span><span class="p">))</span>
<span class="n">probs1</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">Series</span><span class="p">([</span><span class="n">pred</span><span class="p">[</span><span class="s">'probabilities'</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">pred</span> <span class="ow">in</span> <span class="n">pred_dicts1</span><span class="p">])</span>
<span class="n">probs2</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">Series</span><span class="p">([</span><span class="n">pred</span><span class="p">[</span><span class="s">'probabilities'</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">pred</span> <span class="ow">in</span> <span class="n">pred_dicts2</span><span class="p">])</span>

<span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="p">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">probs1</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s">'hist'</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s">'linear-est predicted probabilities'</span><span class="p">);</span>
<span class="n">plt</span><span class="p">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">probs2</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s">'hist'</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s">'bt-est predicted probabilities'</span><span class="p">);</span>
<span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>
<p><img src="/attachments/201904/tensorFlow2/est-predicted-probabilities-0.png" alt="" />
å¤§é‡é›†ä¸­åœ¨å›¾å½¢å·¦ä¾§çš„æ•°æ®ç°‡ï¼Œæ˜¾ç¤ºäº†ä¹˜å®¢ä¹æ­»ä¸€ç”Ÿçš„æ‚²æƒ¨å‘½è¿ã€‚<br />
å› ä¸ºæˆ‘ä»¬çš„é¢„æµ‹ç»“æœåªæœ‰ä¸¤ç§å¯èƒ½ï¼š0è¡¨ç¤ºæœªèƒ½ç”Ÿå­˜ï¼›1è¡¨ç¤ºç”Ÿå­˜ä¸‹æ¥ã€‚æ‰€ä»¥é¢„æµ‹çš„ç»“æœï¼Œåº”å½“æ˜æ˜¾çš„å°½é‡é è¿‘0å’Œ1ä¸¤ç«¯ã€‚ä¸­é—´æ‚¬è€Œæœªå†³çš„éƒ¨åˆ†åº”å½“å°½å¯èƒ½å°‘ã€‚ä»å›¾å½¢çš„æƒ…å†µçœ‹ï¼Œå¦‚æœä¸è€ƒè™‘åˆ†ç±»å‡†ç¡®ç‡é—®é¢˜ï¼Œæå‡æ ‘åˆ†ç±»å™¨æ•ˆæœè¦æ›´å¥½ä¸€äº›ã€‚<br />
å½“ç„¶ä½œä¸ºæˆç†Ÿçš„é¢„å®šä¹‰æ¨¡å‹ï¼Œæ¨¡å‹éƒ½æ˜¯å¾ˆä¼˜ç§€çš„ï¼Œåªæ˜¯æå‡æ ‘å¯èƒ½æ›´é€‚åˆæœ¬åº”ç”¨çš„åœºæ™¯ã€‚</p>

<p>å°½ç®¡è¿™ä¸ªä¾‹å­å¾ˆç®€å•ï¼Œä½†ç°åœ¨çš„åˆ†ç±»ç®—æ³•å®é™…è¶Šæ¥è¶Šå¤æ‚ã€‚é¢„æµ‹ç»“æœåœ¨ä¸åŒç±»åˆ«æ•°æ®ä¸Šè¡¨ç°å¹¶ä¸ä¸å‡è¡¡ï¼Œä½¿å¾—ä½¿ç”¨æ­£ç¡®ç‡è¿™æ ·çš„ä¼ ç»Ÿæ ‡å‡†ä¸èƒ½æ°å½“çš„ååº”åˆ†ç±»å™¨çš„æ€§èƒ½ï¼Œæœ¬ä¾‹ä¸­ä¹Ÿå·²ç»å‡ºç°äº†è¿™ç§å€¾å‘ã€‚æˆ–è€…è¯´ï¼Œåˆ†ç±»å™¨ï¼Œå¯¹äºä¸åŒç±»åˆ«çš„æ ·æœ¬ï¼Œæ€§èƒ½è¡¨ç°æ˜¯ä¸ä¸€è‡´çš„ã€‚<br />
è¿™ç§æƒ…å†µï¼Œä½¿ç”¨ROC(Receiver Operating Characteristic)è§‚å¯Ÿè€…æ“ä½œæ›²çº¿èƒ½å¤Ÿè¡¨ç°çš„æ›´æ¸…æ¥šã€‚<br />
å¯¹äºä¸€ä¸ªåˆ†ç±»å™¨çš„åˆ†ç±»ç»“æœï¼Œä¸€èˆ¬æœ‰ä»¥ä¸‹å››ç§æƒ…å†µï¼š</p>
<ol>
  <li>çœŸé˜³æ€§ï¼ˆTPï¼‰ï¼šåˆ¤æ–­ä¸º1ï¼Œå®é™…ä¸Šä¹Ÿä¸º1ã€‚</li>
  <li>ä¼ªé˜³æ€§ï¼ˆFPï¼‰ï¼šåˆ¤æ–­ä¸º1ï¼Œå®é™…ä¸Šä¸º0ã€‚</li>
  <li>çœŸé˜´æ€§ï¼ˆTNï¼‰ï¼šåˆ¤æ–­ä¸º0ï¼Œå®é™…ä¸Šä¹Ÿä¸º0ã€‚</li>
  <li>ä¼ªé˜´æ€§ï¼ˆFNï¼‰ï¼šåˆ¤æ–­ä¸º0ï¼Œå®é™…ä¸Šä¸º1ã€‚</li>
</ol>

<p>ROCå›¾ä¸­ï¼Œå·¦ä¸Šè§’æ˜¯çœŸé˜³æ€§çš„æç‚¹ï¼Œæ›²çº¿è¶Šæ¥è¿‘å·¦ä¸Šè§’ï¼Œæ„å‘³ç€åˆ†ç±»å™¨æ€§èƒ½è¶Šå¥½ã€‚æ‰€ä»¥å·¦ä¸Šè§’æ˜¯åˆ†ç±»å™¨è¿½æ±‚çš„æ–¹å‘ã€‚<br />
ä¸‹é¢ä»£ç ï¼Œè¯·æ¥ç»­åœ¨ä¸Šé¢ä»£ç ä¹‹åï¼Œç”¨æ¥ç»˜åˆ¶ROCæ›²çº¿ï¼š</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ç»˜åˆ¶ROC(Receiver Operating Characteristic)æ›²çº¿
</span><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">roc_curve</span>

<span class="k">def</span> <span class="nf">plot_roc</span><span class="p">(</span><span class="n">probs</span><span class="p">,</span> <span class="n">title</span><span class="p">):</span>
    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">y_eval</span><span class="p">,</span> <span class="n">probs</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'false positive rate'</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'true positive rate'</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="p">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">plot_roc</span><span class="p">(</span><span class="n">probs1</span><span class="p">,</span> <span class="s">"linear-est ROC"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">plot_roc</span><span class="p">(</span><span class="n">probs2</span><span class="p">,</span> <span class="s">"bt-est ROC"</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>
<p><img src="/attachments/201904/tensorFlow2/est-predicted-ROC-1.png" alt="" />
ä»ROCæ›²çº¿çœ‹ï¼Œåœ¨æœ¬ä¾‹ä¸­ä½¿ç”¨æå‡æ ‘æ¨¡å‹çš„ä¼˜åŠ¿æ›´ä¸ºæ˜æ˜¾ã€‚</p>

<p>ï¼ˆå¾…ç»­â€¦ï¼‰</p>

:ET