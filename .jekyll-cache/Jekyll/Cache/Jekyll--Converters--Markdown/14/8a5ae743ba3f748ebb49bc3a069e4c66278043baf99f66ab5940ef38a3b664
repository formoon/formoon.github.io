I"Ä<p><img src="http://115.182.41.123/files/201904/tensorFlow2/tf-logo-card-2.png" alt="" /></p>
<h4 id="ç”Ÿæˆå¯¹æŠ—ç½‘ç»œçš„æ¦‚å¿µ">ç”Ÿæˆå¯¹æŠ—ç½‘ç»œçš„æ¦‚å¿µ</h4>
<p>ä¸Šä¸€ç¯‡ä¸­ä»‹ç»çš„VAEè‡ªåŠ¨ç¼–ç å™¨å…·å¤‡äº†ä¸€å®šç¨‹åº¦çš„åˆ›é€ ç‰¹å¾ï¼Œèƒ½å¤Ÿâ€œæ— ä¸­ç”Ÿæœ‰â€çš„ç”±ä¸€ç»„éšæœºæ•°å‘é‡ç”Ÿæˆæ‰‹å†™å­—ç¬¦çš„å›¾ç‰‡ã€‚<br />
è¿™ä¸ªâ€œåˆ›é€ èƒ½åŠ›â€æˆ‘ä»¬åœ¨æ¨¡å‹ä¸­åˆ†ä¸ºç¼–ç å™¨å’Œè§£ç å™¨ä¸¤ä¸ªéƒ¨åˆ†ã€‚å…¶èƒ½åŠ›æ¥æºå®é™…ä¸Šæ˜¯å¤§é‡æ ·æœ¬ç»è¿‡å­¦ä¹ ç¼–ç åï¼Œåœ¨æ•°å­—å±‚é¢å¯¹ç¼–ç ç»“æœè¿›è¡Œå¾®è°ƒï¼Œå†è§£ç ç”Ÿæˆå›¾ç‰‡çš„è¿‡ç¨‹ã€‚æ‰€ç”Ÿæˆçš„å›¾ç‰‡ï¼Œæ˜¯å¯¹åŸæ ·æœ¬å›¾çš„æŸç§å˜å½¢æ¨¡ä»¿ã€‚</p>

<p>ä»Šå¤©çš„è¦ä»‹ç»çš„ç”Ÿæˆå¯¹æŠ—ç½‘ç»œ(GAN)ä¹Ÿå…·å¤‡å¾ˆç±»ä¼¼çš„åŠŸèƒ½ï¼Œæ‰€å»ºç«‹çš„æ¨¡å‹ï¼Œèƒ½å¤Ÿç”Ÿæˆéå¸¸æ¥è¿‘æ ·æœ¬å›¾ç‰‡çš„ç»“æœã€‚<br />
ç›¸å¯¹äºVAEï¼Œç”Ÿæˆå¯¹æŠ—ç½‘ç»œGANæ›´æ¥è¿‘ä¸€ç§æ€æƒ³ï¼Œå¹¶éé’ˆå¯¹æœºå™¨è§†è§‰é¢†åŸŸï¼Œè€Œæ˜¯ä¸€ç§å¾ˆé€šç”¨çš„æœºå™¨å­¦ä¹ ç†å¿µã€‚</p>

<p>è®©æˆ‘ä»¬ç”¨ä¸€ä¸ªä¾‹å­æ¥ç†è§£ç”Ÿæˆå¯¹æŠ—ç½‘ç»œï¼š<br />
æ¯”å¦‚æˆ‘ä»¬æƒ³å­¦ä¹ è‹±è¯­æœ—è¯»ã€‚ä¸€å¼€å§‹ï¼Œæˆ‘ä»¬çš„æœ—è¯»èƒ½åŠ›è‚¯å®šå¾ˆå·®ï¼Œæ¯æ¬¡è€ƒè¯•éƒ½æ˜¯ä¸åŠæ ¼ã€‚è¿™æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šåŠªåŠ›çš„å­¦ä¹ ã€‚å½“ç„¶äººçš„å­¦ä¹ æ˜¯é€šè¿‡å„ç§å¯èƒ½æ‰‹æ®µï¼Œå¬å½•éŸ³ã€çœ‹è§†é¢‘ã€æ‰¾å¤–æ•™ã€‚å­¦ä¹ ä¸€æ®µæ—¶é—´åï¼Œå†å»å‚åŠ è€ƒè¯•ï¼Œå¦‚æœæˆç»©ä¾ç„¶å¾ˆå·®ï¼Œæˆ‘ä»¬å›æ¥ç»§ç»­å­¦ä¹ ã€‚ä¸€ç›´åˆ°æˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ªè‡ªå·±æ»¡æ„çš„æˆç»©ã€‚<br />
è¿™ä¸ªä¾‹å­ä¸­æœ‰å‡ ä¸ªé‡è¦çš„å› ç´ ï¼šå­¦ä¹ è€…æœ¬äººå°±æ˜¯æœºå™¨å­¦ä¹ ä¸­çš„ç¥ç»ç½‘ç»œï¼Œè´Ÿè´£ç”ŸæˆæŸä¸ªç»“æœï¼Œæ¯”å¦‚æœ—è¯»ï¼›è€ƒå®˜è´Ÿè´£åˆ¤æ–­æˆ‘ä»¬æœ—è¯»çš„è‹±è¯­æ˜¯å¦è¾¾åˆ°äº†æ°´å¹³è¦æ±‚ã€‚è€ƒå®˜å®é™…ä¹Ÿæ˜¯ä¸€ä¸ªç½‘ç»œæ¨¡å‹ï¼Œæœ¬èº«å¹¶ä¸èƒ½çŸ¥é“ä»€ä¹ˆæ ·çš„æœ—è¯»å«å¥½ï¼Œä»€ä¹ˆæ ·çš„æœ—è¯»å«å·®ï¼Œå…¶åˆ¤æ–­ä¾æ®æ¥è‡ªäºå¯¹â€œå¥½çš„æœ—è¯»â€æ ·æœ¬çš„å­¦ä¹ ï¼›å­¦ä¹ è€…ä¸æ–­å­¦ä¹ æé«˜çš„è¿‡ç¨‹ï¼Œè¿™ä¸ªå°±ç›¸å½“äºç½‘ç»œæ¨¡å‹ä¸æ–­çš„è®­ç»ƒè¿­ä»£ã€‚</p>

<p>å›åˆ°æˆ‘ä»¬çš„å›¾ç‰‡ç”Ÿæˆè¿‡ç¨‹ã€‚å›¾ç‰‡ç”Ÿæˆæ˜¯ä¸€ä¸ªæ¨¡å‹ï¼Œè´Ÿè´£ç”Ÿæˆæ‰€éœ€è¦çš„å›¾ç‰‡ï¼›<br />
<img src="http://115.182.41.123/files/201904/tensorFlow2/gan-l1.png" alt="" /><br />
(å›¾ç‰‡æ¥è‡ªå®˜æ–¹æ–‡æ¡£)<br />
â€œè€ƒå®˜â€è´Ÿè´£æ£€æŸ¥æ ·æœ¬å’Œç”Ÿæˆå›¾ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªåŒºåˆ«äºVAEæ¨¡å‹çš„é‡ç‚¹ï¼ŒVAEæ˜¯ç›´æ¥æ¯”è¾ƒæ ·æœ¬å’Œç”Ÿæˆå›¾ï¼Œä»¥ä¸¤è€…çš„å·®è·ä½œä¸ºä»£ä»·ã€‚<br />
è€ŒGANä¸­ï¼Œè€ƒå®˜æœ¬èº«çš„å­¦ä¹ ï¼Œè‡ªåŠ¨ä¸ºæ ·æœ¬å›¾æ·»åŠ æ ‡æ³¨1ï¼Œä¸ºç”Ÿæˆå›¾æ·»åŠ æ ‡æ³¨0ã€‚å®Œæˆå­¦ä¹ åï¼Œå¦‚æœç”Ÿæˆçš„å›¾ç‰‡ï¼Œè€ƒå®˜ä¼šåˆ¤æ–­ä¸ºçœŸå®æ ·æœ¬ï¼Œè¯´æ˜æ‰€ç”Ÿæˆçš„å›¾ç‰‡è¾¾åˆ°äº†åº”æœ‰çš„æ°´å‡†ã€‚<br />
<img src="http://115.182.41.123/files/201904/tensorFlow2/gan-l2.png" alt="" /><br />
ï¼ˆå›¾ç‰‡æ¥è‡ªå®˜æ–¹æ–‡æ¡£ï¼‰<br />
è¿™æ ·çš„æœºå™¨å­¦ä¹ æ–¹å¼ï¼Œå¯ä»¥ä¸ä½¿ç”¨ç»è¿‡æ ‡æ³¨çš„æ ·æœ¬æ•°æ®ï¼Œèƒ½å¤Ÿå¤§é‡èŠ‚çœæˆæœ¬ã€‚è™½ç„¶ä¼šå¸¦æ¥å­¦ä¹ è¿‡ç¨‹çš„åŠ é•¿å’Œå¤§é‡ç®—åŠ›éœ€æ±‚ï¼Œä½†é€šå¸¸æ¥è¯´ï¼Œç®—åŠ›è¿˜æ˜¯æ›´å®¹æ˜“è·å¾—çš„ã€‚<br />
å¦ä¸€ä¸ªè§’åº¦ä¸Šè¯´ï¼ŒVAEç›´æ¥æ¯”è¾ƒæ ·æœ¬å›¾ç‰‡å’Œç”Ÿæˆå›¾ç‰‡ï¼Œå¤§é‡çš„æ•°æ®å’Œå¤æ‚æ€§ï¼Œå¯¼è‡´VAEçš„æŸå¤±å‡½æ•°çš„ä»£ç é‡å¤§ï¼Œè®¡ç®—é€Ÿåº¦ä¹Ÿæ…¢ã€‚GANåªæœ‰çœŸã€ä¼ªä¸¤ä¸ªåˆ¤æ–­ç»“æœï¼Œæ¨¡å‹è¾“å‡ºç®€å•ï¼Œä»£ä»·å‡½æ•°ä¹Ÿå®¹æ˜“çš„å¤šã€‚æ‰€ä»¥åœ¨åŒä¸€ç»„æ•°æ®ä¸Šï¼Œä½¿ç”¨VAEç®—æ³•å¾€å¾€ä¼šæ¯”GANç•¥æ…¢ä¸€äº›ã€‚<br />
çœ‹èµ·æ¥å¦‚æœåªæ˜¯ç”Ÿæˆå›¾ç‰‡è¿™ä¸€ä¸ªç»´åº¦çš„ç»“æœï¼ŒGANä¼¼ä¹æ›´æœ‰ä¼˜åŠ¿ï¼Œä½†å¦‚æœè€ƒè™‘åˆ°è¾“å‡ºç»“æœçš„å¯æ§æ€§ç­‰å› ç´ ï¼ŒVAEåœ¨æœºå™¨è§†è§‰é¢†åŸŸçš„åº”ç”¨ä»ç„¶æ˜¯å¾ˆå¹¿æ³›ã€‚<br />
ä¸è¿‡GANçš„æ€æƒ³æ˜¯æ¯”è¾ƒåˆ¤æ–­ç»“æœè€ŒéåŸå›¾ï¼Œæ˜¯â€œè£åˆ¤â€ï¼Œæ‰€ä»¥è¿™ç§æ€æƒ³å¾ˆå®¹æ˜“æ¨å¹¿åˆ°å¤šä¸ªåº”ç”¨é¢†åŸŸï¼Œè€Œä¸ä»…ä»…æ˜¯æœºå™¨è§†è§‰èŒƒç•´ã€‚</p>

<h4 id="ganå®ä¾‹">GANå®ä¾‹</h4>
<p>æœ¬ç¯‡æˆ‘ä»¬å°è¯•ä½¿ç”¨æ—¶å°šå•å“çš„æ ·æœ¬åº“ä½œä¸ºè®­ç»ƒæ•°æ®ï¼Œæœ€ç»ˆè®©æ¨¡å‹å¯ä»¥ç”±éšæœºçš„ç§å­å‘é‡ï¼Œç”Ÿæˆæ—¶å°šå•å“çš„å›¾ç‰‡ã€‚<br />
æˆ‘ä»¬å‰é¢å·²ç»åšè¿‡ä»‹ç»ï¼Œæ—¶å°šå•å“çš„æ ·æœ¬ä¹Ÿæ˜¯28x28å•è‰²å›¾ç‰‡ï¼ŒåŒMNISTæ‰‹å†™æ•°å­—æ ·æœ¬æ˜¯å®Œå…¨ç›¸åŒçš„æ ¼å¼ã€‚å› æ­¤æ¢ç”¨æ‰‹å†™æ•°å­—çš„å›¾ç‰‡æ ·æœ¬ï¼Œåªè¦æŠŠè½½å…¥æ ·æœ¬æ•°æ®çš„éƒ¨åˆ†æ›¿æ¢æ‰å°±å¯ä»¥ï¼Œå…¶å®ƒä»£ç æ— éœ€ä¿®æ”¹ã€‚<br />
<img src="http://115.182.41.123/files/201904/tensorFlow2/fashion-mnist-sprite.png" alt="" /></p>

<p>æ ·æœ¬æ•°æ®è½½å…¥çš„éƒ¨åˆ†ï¼š</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="n">train_images</span><span class="p">,</span> <span class="n">_</span><span class="p">),</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">keras</span><span class="p">.</span><span class="n">datasets</span><span class="p">.</span><span class="n">fashion_mnist</span><span class="p">.</span><span class="n">load_data</span><span class="p">()</span>
</code></pre></div></div>
<p>æˆ‘ä»¬å®é™…åªéœ€è¦äº†è®­ç»ƒçš„æ•°æ®é›†ï¼Œæµ‹è¯•é›†å’Œä¸¤ä¸ªæ•°æ®é›†çš„æ ‡æ³¨æˆ‘ä»¬éƒ½ç›´æ¥æŠ›å¼ƒäº†ã€‚GANæ˜¯å…¸å‹çš„éç›‘ç£å­¦ä¹ ï¼Œå¹¶ä¸éœ€è¦æ ‡æ³¨ã€‚</p>

<p>æºç ä¸­æ–¹æ³•make_generator_modelç”¨æ¥å»ºç«‹å›¾ç‰‡ç”Ÿæˆæ¨¡å‹ï¼›make_discriminator_modelæ–¹æ³•ç”¨æ¥å»ºç«‹è¾¨åˆ«æ¨¡å‹ï¼Œè¾¨åˆ«æ¨¡å‹ä¹Ÿå°±æ˜¯æˆ‘ä»¬åˆšæ‰è¯´çš„â€œè€ƒå®˜â€ã€‚<br />
ä¸¤ä¸ªæ¨¡å‹éƒ½ä½¿ç”¨keras.Sequentialå¸®åŠ©å»ºç«‹ï¼Œç»“æ„å¹¶ä¸å¤æ‚ã€‚<br />
æ¨¡å‹çš„å­¦ä¹ ä¸€å®šè¦å…³æ³¨è¾“å…¥å’Œè¾“å‡ºï¼Œä¸­é—´çš„éƒ¨åˆ†å¦‚æœæ²¡æœ‰ç†è®ºåŸºç¡€ï¼Œåè€Œå¯ä»¥å¹¶ä¸æ˜¯å¾ˆåœ¨æ„ã€‚å› ä¸ºç®—æ³•çš„ç ”ç©¶ä¼šå…³æ³¨æ¨¡å‹ï¼Œè½¯ä»¶å¼€å‘å·¥ç¨‹å¸ˆæ›´å…³å¿ƒä½¿ç”¨ã€‚</p>

<p>ç”Ÿæˆç½‘ç»œè¾“å…¥éšæœºæ•°ç§å­å‘é‡åºåˆ—ï¼Œè¾“å‡ºæ˜¯28x28x1çš„å›¾ç‰‡åºåˆ—ã€‚ä¸€æ¬¡è°ƒç”¨å¯ä»¥ç”Ÿæˆå¤šå¹…å›¾ç‰‡ã€‚<br />
è¾¨åˆ«æ¨¡å‹è¾“å…¥æ˜¯28x28x1çš„åºåˆ—å›¾ç‰‡ï¼Œè¾“å‡ºåªæœ‰1ç»´ã€‚è¾“å‡ºå€¼æ¥è¿‘0ä»£è¡¨è¾¨åˆ«ç»“æœæ˜¯ä¼ªå›¾ç‰‡ï¼Œè¾“å‡ºå€¼æ¥è¿‘1è¡¨ç¤ºè¾¨åˆ«ç»“æœæ˜¯çœŸå®æ ·æœ¬å›¾ç‰‡ã€‚<br />
å…¶ä¸­çš„å·ç§¯ç½‘ç»œå±‚ï¼Œæˆ‘ä»¬åœ¨ä¸Šä¸€ä¸ªç³»åˆ—ä¸­åšäº†ä»”ç»†çš„ä»‹ç»ï¼Œè¿™é‡Œå¯ä»¥å†ç¨å¾®å¤ä¹ ä¸€ä¸‹å…³äºå·ç§¯çš„è¾“å‡ºç»´åº¦ã€‚å·ç§¯å±‚çš„è¾“å…¥å¿…é¡»æ˜¯å®½xé«˜xè‰²æ·±çš„å¤šç»´æ•°ç»„ã€‚è¾“å‡ºçš„è‰²æ·±éƒ¨åˆ†ï¼ŒåŒå·ç§¯å±‚çš„èŠ‚ç‚¹æ•°ç›¸åŒã€‚å®½ã€é«˜åˆ™åŒå·ç§¯æ ¸çš„æ­¥é•¿æ•°ç›¸å…³ï¼Œä¸€èˆ¬æ˜¯ä¹˜çš„å…³ç³»ã€‚æ¯”å¦‚ï¼š</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="p">...</span><span class="n">å‡è®¾æœ¬å±‚è¾“å…¥ä¸º7x7x256</span><span class="p">...</span>
<span class="n">layers</span><span class="p">.</span><span class="n">Conv2DTranspose</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s">'same'</span><span class="p">,</span> <span class="n">use_bias</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>
    <span class="p">...</span><span class="n">å› ä¸ºèŠ‚ç‚¹æ•°ä¸º128</span><span class="err">ï¼Œ</span><span class="n">æ­¥é•¿æ˜¯1</span><span class="p">...</span>
    <span class="p">...</span><span class="n">æ‰€ä»¥è¾“å‡ºç»´åº¦æ˜¯7x7x128</span><span class="p">...</span>
<span class="n">layers</span><span class="p">.</span><span class="n">Conv2DTranspose</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s">'same'</span><span class="p">,</span> <span class="n">use_bias</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>
    <span class="p">...</span><span class="n">è¾“å‡ºç»´åº¦ä¸º14x14x64</span><span class="p">...</span>
</code></pre></div></div>
<p>ä½¿ç”¨Kerasä¹‹åï¼Œè¿™äº›ç»†èŠ‚ä¸€èˆ¬éƒ½ä¸éœ€è¦è‡ªå·±å»ç®—äº†ã€‚ä½†åœ¨è¿™ç§å›¾ç‰‡ä½œä¸ºè¾“å…¥ã€è¾“å‡ºå‚æ•°çš„æ¨¡å‹ä¸­ï¼Œä¸ºäº†ä¿è¯ç»“æœå›¾ç‰‡æ˜¯æŒ‡å®šåˆ†è¾¨ç‡ï¼Œè¿™æ ·çš„è®¡ç®—è¿˜æ˜¯éš¾ä»¥é¿å…çš„ã€‚</p>

<p>ä¸¤ä¸ªæ¨¡å‹åˆ†åˆ«ä½¿ç”¨ä¸¤ä¸ªä¸åŒçš„ä»£ä»·å‡½æ•°ï¼Œç”Ÿæˆæ¨¡å‹çš„ä»£ä»·å‡½æ•°å¾ˆç®€å•ã€‚æˆ‘ä»¬æœŸæœ›ç”Ÿæˆç½‘ç»œçš„å›¾ç‰‡ï¼Œç»è¿‡è¾¨åˆ«æ¨¡å‹åï¼Œç»“æœæ— é™æ¥è¿‘1ï¼Œä¹Ÿå°±æ˜¯çœŸå®æ ·æœ¬çš„æ°´å¹³ï¼š</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ç”Ÿæˆæ¨¡å‹çš„æŸå¤±å‡½æ•°
</span><span class="k">def</span> <span class="nf">generator_loss</span><span class="p">(</span><span class="n">fake_output</span><span class="p">):</span>
    <span class="c1"># ç”Ÿæˆæ¨¡å‹æœŸæœ›æœ€ç»ˆçš„ç»“æœè¶Šæ¥è¶Šæ¥è¿‘1ï¼Œä¹Ÿå°±æ˜¯çœŸå®æ ·æœ¬
</span>    <span class="k">return</span> <span class="n">cross_entropy</span><span class="p">(</span><span class="n">tf</span><span class="p">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">fake_output</span><span class="p">),</span> <span class="n">fake_output</span><span class="p">)</span>
</code></pre></div></div>
<p>è¾¨åˆ«æ¨¡å‹çš„ä»£ä»·å‡½æ•°ï¼Œåˆ™æ˜¯è¦å¯¹æ‰€æœ‰çš„æ ·æœ¬å›¾ç‰‡äººä¸ºæŒ‡å®šæ ‡æ³¨ç»“æœæ˜¯1ï¼Œå¯¹æ‰€æœ‰ç”Ÿæˆçš„å›¾ç‰‡ï¼Œåˆ™äººä¸ºæŒ‡å®šæ ‡æ³¨ç»“æœ0ã€‚è¿™ç›®çš„æ˜¯è®­ç»ƒè¾¨åˆ«æ¨¡å‹å¯¹äºè¾¨åˆ«çœŸä¼ªçš„èƒ½åŠ›è¶Šæ¥è¶Šå¼ºï¼Œä»è€Œå¯ä»¥åˆ¤æ–­ç”Ÿæˆçš„å›¾ç‰‡ï¼Œæ˜¯å¦èƒ½æ— é™æ¥è¿‘çœŸå®æ ·æœ¬å›¾ç‰‡çš„æ°´å¹³ã€‚è¿™ä¸ªè¿‡ç¨‹ï¼Œå…¶å®å°±æ˜¯â€œå¯¹æŠ—â€çš„è¿‡ç¨‹ã€‚</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># è¾¨åˆ«æ¨¡å‹æŸå¤±å‡½æ•°
</span><span class="k">def</span> <span class="nf">discriminator_loss</span><span class="p">(</span><span class="n">real_output</span><span class="p">,</span> <span class="n">fake_output</span><span class="p">):</span>
    <span class="c1"># æ ·æœ¬å›¾å¸Œæœ›ç»“æœè¶‹è¿‘1
</span>    <span class="n">real_loss</span> <span class="o">=</span> <span class="n">cross_entropy</span><span class="p">(</span><span class="n">tf</span><span class="p">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">real_output</span><span class="p">),</span> <span class="n">real_output</span><span class="p">)</span>
    <span class="c1"># è‡ªå·±ç”Ÿæˆçš„å›¾å¸Œæœ›ç»“æœè¶‹è¿‘0
</span>    <span class="n">fake_loss</span> <span class="o">=</span> <span class="n">cross_entropy</span><span class="p">(</span><span class="n">tf</span><span class="p">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">fake_output</span><span class="p">),</span> <span class="n">fake_output</span><span class="p">)</span>
    <span class="c1"># æ€»æŸå¤±
</span>    <span class="n">total_loss</span> <span class="o">=</span> <span class="n">real_loss</span> <span class="o">+</span> <span class="n">fake_loss</span>
    <span class="k">return</span> <span class="n">total_loss</span>
</code></pre></div></div>

<h4 id="å®Œæ•´æºç ">å®Œæ•´æºç </h4>
<p>ç¨‹åºçš„å…¶å®ƒéƒ¨åˆ†ï¼Œéƒ½åŒé€šå¸¸çš„æœºå™¨å­¦ä¹ é¡¹ç›®éå¸¸ç±»ä¼¼ï¼Œåº”å½“è¯»èµ·æ¥æ²¡æœ‰éš¾åº¦äº†ã€‚</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">unicode_literals</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="n">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">imageio</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">PIL</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">layers</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="c1"># å¦‚æœä½¿ç”¨trainå‚æ•°è¿è¡Œåˆ™è¿›å…¥è®­ç»ƒæ¨¡å¼
</span><span class="n">TRAIN</span> <span class="o">=</span> <span class="bp">False</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">'train'</span><span class="p">:</span>
    <span class="n">TRAIN</span> <span class="o">=</span> <span class="bp">True</span>

<span class="c1"># ä½¿ç”¨æ‰‹å†™å­—ä½“æ ·æœ¬åšè®­ç»ƒ
# (train_images, _), (_, _) = keras.datasets.mnist.load_data()
# ä½¿ç”¨æ—¶å°šå•å“æ ·æœ¬åšè®­ç»ƒ
</span><span class="p">(</span><span class="n">train_images</span><span class="p">,</span> <span class="n">_</span><span class="p">),</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">keras</span><span class="p">.</span><span class="n">datasets</span><span class="p">.</span><span class="n">fashion_mnist</span><span class="p">.</span><span class="n">load_data</span><span class="p">()</span>

<span class="c1"># å› ä¸ºå·ç§¯å±‚çš„éœ€æ±‚ï¼Œå¢åŠ è‰²æ·±ç»´åº¦
</span><span class="n">train_images</span> <span class="o">=</span> <span class="n">train_images</span><span class="p">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">train_images</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="n">astype</span><span class="p">(</span><span class="s">'float32'</span><span class="p">)</span>
<span class="c1"># è§„èŒƒåŒ–ä¸º-1 - +1
</span><span class="n">train_images</span> <span class="o">=</span> <span class="p">(</span><span class="n">train_images</span> <span class="o">-</span> <span class="mf">127.5</span><span class="p">)</span> <span class="o">/</span> <span class="mf">127.5</span>

<span class="n">BUFFER_SIZE</span> <span class="o">=</span> <span class="mi">60000</span>
<span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">256</span>
<span class="n">train_dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">Dataset</span><span class="p">.</span><span class="n">from_tensor_slices</span><span class="p">(</span><span class="n">train_images</span><span class="p">).</span><span class="n">shuffle</span><span class="p">(</span><span class="n">BUFFER_SIZE</span><span class="p">).</span><span class="n">batch</span><span class="p">(</span><span class="n">BATCH_SIZE</span><span class="p">)</span>

<span class="c1"># å›¾ç‰‡ç”Ÿæˆæ¨¡å‹
</span><span class="k">def</span> <span class="nf">make_generator_model</span><span class="p">():</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">Sequential</span><span class="p">()</span>
    <span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="p">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">7</span><span class="o">*</span><span class="mi">7</span><span class="o">*</span><span class="mi">256</span><span class="p">,</span> <span class="n">use_bias</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">100</span><span class="p">,)))</span>
    <span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="p">.</span><span class="n">BatchNormalization</span><span class="p">())</span>
    <span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="p">.</span><span class="n">LeakyReLU</span><span class="p">())</span>

    <span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="p">.</span><span class="n">Reshape</span><span class="p">((</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">256</span><span class="p">)))</span>
    <span class="k">assert</span> <span class="n">model</span><span class="p">.</span><span class="n">output_shape</span> <span class="o">==</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span> <span class="c1"># Note: None is the batch size
</span>
    <span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="p">.</span><span class="n">Conv2DTranspose</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s">'same'</span><span class="p">,</span> <span class="n">use_bias</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">model</span><span class="p">.</span><span class="n">output_shape</span> <span class="o">==</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>  
    <span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="p">.</span><span class="n">BatchNormalization</span><span class="p">())</span>
    <span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="p">.</span><span class="n">LeakyReLU</span><span class="p">())</span>

    <span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="p">.</span><span class="n">Conv2DTranspose</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s">'same'</span><span class="p">,</span> <span class="n">use_bias</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">model</span><span class="p">.</span><span class="n">output_shape</span> <span class="o">==</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>    
    <span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="p">.</span><span class="n">BatchNormalization</span><span class="p">())</span>
    <span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="p">.</span><span class="n">LeakyReLU</span><span class="p">())</span>

    <span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="p">.</span><span class="n">Conv2DTranspose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s">'same'</span><span class="p">,</span> <span class="n">use_bias</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'tanh'</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">model</span><span class="p">.</span><span class="n">output_shape</span> <span class="o">==</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">model</span>

<span class="n">generator</span> <span class="o">=</span> <span class="n">make_generator_model</span><span class="p">()</span>

<span class="c1"># åŸå›¾ã€ç”Ÿæˆå›¾è¾¨åˆ«ç½‘ç»œ
</span><span class="k">def</span> <span class="nf">make_discriminator_model</span><span class="p">():</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">Sequential</span><span class="p">()</span>
    <span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="p">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s">'same'</span><span class="p">,</span> 
                                     <span class="n">input_shape</span><span class="o">=</span><span class="p">[</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>
    <span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="p">.</span><span class="n">LeakyReLU</span><span class="p">())</span>
    <span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="p">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.3</span><span class="p">))</span>

    <span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="p">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s">'same'</span><span class="p">))</span>
    <span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="p">.</span><span class="n">LeakyReLU</span><span class="p">())</span>
    <span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="p">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.3</span><span class="p">))</span>

    <span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="p">.</span><span class="n">Flatten</span><span class="p">())</span>
    <span class="n">model</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">layers</span><span class="p">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">model</span>

<span class="n">discriminator</span> <span class="o">=</span> <span class="n">make_discriminator_model</span><span class="p">()</span>

<span class="c1"># éšæœºç”Ÿæˆä¸€ä¸ªå‘é‡ï¼Œç”¨äºç”Ÿæˆå›¾ç‰‡
</span><span class="n">noise</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">normal</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span>
<span class="c1"># ç”Ÿæˆä¸€å¼ ï¼Œæ­¤æ—¶æ¨¡å‹æœªç»è®­ç»ƒï¼Œå›¾ç‰‡ä¸ºå™ªç‚¹
</span><span class="n">generated_image</span> <span class="o">=</span> <span class="n">generator</span><span class="p">(</span><span class="n">noise</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="c1"># plt.imshow(generated_image[0, :, :, 0], cmap='gray')
# åˆ¤æ–­ç»“æœ
</span><span class="n">decision</span> <span class="o">=</span> <span class="n">discriminator</span><span class="p">(</span><span class="n">generated_image</span><span class="p">)</span>
<span class="c1"># æ­¤æ—¶çš„ç»“æœåº”å½“åº”å½“è¶‹è¿‘äº0ï¼Œè¡¨ç¤ºä¸ºä¼ªé€ å›¾ç‰‡
</span><span class="k">print</span><span class="p">(</span><span class="n">decision</span><span class="p">)</span>

<span class="c1"># äº¤å‰ç†µæŸå¤±å‡½æ•°
</span><span class="n">cross_entropy</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">losses</span><span class="p">.</span><span class="n">BinaryCrossentropy</span><span class="p">(</span><span class="n">from_logits</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c1"># è¾¨åˆ«æ¨¡å‹æŸå¤±å‡½æ•°
</span><span class="k">def</span> <span class="nf">discriminator_loss</span><span class="p">(</span><span class="n">real_output</span><span class="p">,</span> <span class="n">fake_output</span><span class="p">):</span>
    <span class="c1"># æ ·æœ¬å›¾å¸Œæœ›ç»“æœè¶‹è¿‘1
</span>    <span class="n">real_loss</span> <span class="o">=</span> <span class="n">cross_entropy</span><span class="p">(</span><span class="n">tf</span><span class="p">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">real_output</span><span class="p">),</span> <span class="n">real_output</span><span class="p">)</span>
    <span class="c1"># è‡ªå·±ç”Ÿæˆçš„å›¾å¸Œæœ›ç»“æœè¶‹è¿‘0
</span>    <span class="n">fake_loss</span> <span class="o">=</span> <span class="n">cross_entropy</span><span class="p">(</span><span class="n">tf</span><span class="p">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">fake_output</span><span class="p">),</span> <span class="n">fake_output</span><span class="p">)</span>
    <span class="c1"># æ€»æŸå¤±
</span>    <span class="n">total_loss</span> <span class="o">=</span> <span class="n">real_loss</span> <span class="o">+</span> <span class="n">fake_loss</span>
    <span class="k">return</span> <span class="n">total_loss</span>

<span class="c1"># ç”Ÿæˆæ¨¡å‹çš„æŸå¤±å‡½æ•°
</span><span class="k">def</span> <span class="nf">generator_loss</span><span class="p">(</span><span class="n">fake_output</span><span class="p">):</span>
    <span class="c1"># ç”Ÿæˆæ¨¡å‹æœŸæœ›æœ€ç»ˆçš„ç»“æœè¶Šæ¥è¶Šæ¥è¿‘1ï¼Œä¹Ÿå°±æ˜¯çœŸå®æ ·æœ¬
</span>    <span class="k">return</span> <span class="n">cross_entropy</span><span class="p">(</span><span class="n">tf</span><span class="p">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">fake_output</span><span class="p">),</span> <span class="n">fake_output</span><span class="p">)</span>

<span class="n">generator_optimizer</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">optimizers</span><span class="p">.</span><span class="n">Adam</span><span class="p">(</span><span class="mf">1e-4</span><span class="p">)</span>
<span class="n">discriminator_optimizer</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">optimizers</span><span class="p">.</span><span class="n">Adam</span><span class="p">(</span><span class="mf">1e-4</span><span class="p">)</span>

<span class="c1"># è®­ç»ƒç»“æœä¿å­˜
</span><span class="n">checkpoint_dir</span> <span class="o">=</span> <span class="s">'dcgan_training_checkpoints'</span>
<span class="n">checkpoint_prefix</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">checkpoint_dir</span><span class="p">,</span> <span class="s">"ckpt"</span><span class="p">)</span>
<span class="n">checkpoint</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">train</span><span class="p">.</span><span class="n">Checkpoint</span><span class="p">(</span><span class="n">generator_optimizer</span><span class="o">=</span><span class="n">generator_optimizer</span><span class="p">,</span>
                                 <span class="n">discriminator_optimizer</span><span class="o">=</span><span class="n">discriminator_optimizer</span><span class="p">,</span>
                                 <span class="n">generator</span><span class="o">=</span><span class="n">generator</span><span class="p">,</span>
                                 <span class="n">discriminator</span><span class="o">=</span><span class="n">discriminator</span><span class="p">)</span>

<span class="n">EPOCHS</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">noise_dim</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">num_examples_to_generate</span> <span class="o">=</span> <span class="mi">16</span>

<span class="c1"># åˆå§‹åŒ–16ä¸ªç§å­å‘é‡ï¼Œç”¨äºç”Ÿæˆ4x4çš„å›¾ç‰‡
</span><span class="n">seed</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">normal</span><span class="p">([</span><span class="n">num_examples_to_generate</span><span class="p">,</span> <span class="n">noise_dim</span><span class="p">])</span>

<span class="c1"># @tf.functionè¡¨ç¤ºTensorFlowç¼–è¯‘ã€ç¼“å­˜æ­¤å‡½æ•°ï¼Œç”¨äºåœ¨è®­ç»ƒä¸­å¿«é€Ÿè°ƒç”¨
</span><span class="o">@</span><span class="n">tf</span><span class="p">.</span><span class="n">function</span>
<span class="k">def</span> <span class="nf">train_step</span><span class="p">(</span><span class="n">images</span><span class="p">):</span>
    <span class="c1"># éšæœºç”Ÿæˆä¸€ä¸ªæ‰¹æ¬¡çš„ç§å­å‘é‡
</span>    <span class="n">noise</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">normal</span><span class="p">([</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="n">noise_dim</span><span class="p">])</span>

    <span class="k">with</span> <span class="n">tf</span><span class="p">.</span><span class="n">GradientTape</span><span class="p">()</span> <span class="k">as</span> <span class="n">gen_tape</span><span class="p">,</span> <span class="n">tf</span><span class="p">.</span><span class="n">GradientTape</span><span class="p">()</span> <span class="k">as</span> <span class="n">disc_tape</span><span class="p">:</span>
        <span class="c1"># ç”Ÿæˆä¸€ä¸ªæ‰¹æ¬¡çš„å›¾ç‰‡
</span>        <span class="n">generated_images</span> <span class="o">=</span> <span class="n">generator</span><span class="p">(</span><span class="n">noise</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="c1"># è¾¨åˆ«ä¸€ä¸ªæ‰¹æ¬¡çš„çœŸå®æ ·æœ¬
</span>        <span class="n">real_output</span> <span class="o">=</span> <span class="n">discriminator</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="c1"># è¾¨åˆ«ä¸€ä¸ªæ‰¹æ¬¡çš„ç”Ÿæˆå›¾ç‰‡
</span>        <span class="n">fake_output</span> <span class="o">=</span> <span class="n">discriminator</span><span class="p">(</span><span class="n">generated_images</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="c1"># è®¡ç®—ä¸¤ä¸ªæŸå¤±å€¼
</span>        <span class="n">gen_loss</span> <span class="o">=</span> <span class="n">generator_loss</span><span class="p">(</span><span class="n">fake_output</span><span class="p">)</span>
        <span class="n">disc_loss</span> <span class="o">=</span> <span class="n">discriminator_loss</span><span class="p">(</span><span class="n">real_output</span><span class="p">,</span> <span class="n">fake_output</span><span class="p">)</span>

    <span class="c1"># æ ¹æ®æŸå¤±å€¼è°ƒæ•´æ¨¡å‹çš„æƒé‡å‚é‡
</span>    <span class="n">gradients_of_generator</span> <span class="o">=</span> <span class="n">gen_tape</span><span class="p">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">gen_loss</span><span class="p">,</span> <span class="n">generator</span><span class="p">.</span><span class="n">trainable_variables</span><span class="p">)</span>
    <span class="n">gradients_of_discriminator</span> <span class="o">=</span> <span class="n">disc_tape</span><span class="p">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">disc_loss</span><span class="p">,</span> <span class="n">discriminator</span><span class="p">.</span><span class="n">trainable_variables</span><span class="p">)</span>

    <span class="c1"># è®¡ç®—å‡ºçš„å‚é‡åº”ç”¨åˆ°æ¨¡å‹
</span>    <span class="n">generator_optimizer</span><span class="p">.</span><span class="n">apply_gradients</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">gradients_of_generator</span><span class="p">,</span> <span class="n">generator</span><span class="p">.</span><span class="n">trainable_variables</span><span class="p">))</span>
    <span class="n">discriminator_optimizer</span><span class="p">.</span><span class="n">apply_gradients</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">gradients_of_discriminator</span><span class="p">,</span> <span class="n">discriminator</span><span class="p">.</span><span class="n">trainable_variables</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">epochs</span><span class="p">):</span>  
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">image_batch</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">:</span>
            <span class="n">train_step</span><span class="p">(</span><span class="n">image_batch</span><span class="p">)</span>

        <span class="c1"># æ¯ä¸ªè®­ç»ƒæ‰¹æ¬¡ç”Ÿæˆä¸€å¼ å›¾ç‰‡ä½œä¸ºé˜¶æ®µæˆåŠŸ
</span>        <span class="k">print</span><span class="p">(</span><span class="s">"======================================="</span><span class="p">)</span>
        <span class="n">generate_and_save_images</span><span class="p">(</span>
            <span class="n">generator</span><span class="p">,</span>
            <span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">seed</span><span class="p">)</span>

        <span class="c1"># æ¯20æ¬¡è¿­ä»£ä¿å­˜ä¸€æ¬¡è®­ç»ƒæ•°æ®
</span>        <span class="k">if</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">20</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">checkpoint</span><span class="p">.</span><span class="n">save</span><span class="p">(</span><span class="n">file_prefix</span><span class="o">=</span><span class="n">checkpoint_prefix</span><span class="p">)</span>

        <span class="k">print</span><span class="p">(</span><span class="s">'Time for epoch {} is {} sec'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">generate_and_save_images</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">test_input</span><span class="p">):</span>
    <span class="c1"># è®¾ç½®ä¸ºéè®­ç»ƒçŠ¶æ€ï¼Œç”Ÿæˆä¸€ç»„å›¾ç‰‡
</span>    <span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">test_input</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>

    <span class="c1"># 4æ ¼x4æ ¼æ‹¼æ¥
</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">predictions</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">plt</span><span class="p">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">plt</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">predictions</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">127.5</span> <span class="o">+</span> <span class="mf">127.5</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s">'gray'</span><span class="p">)</span>
        <span class="n">plt</span><span class="p">.</span><span class="n">axis</span><span class="p">(</span><span class="s">'off'</span><span class="p">)</span>

    <span class="c1"># ä¿å­˜ä¸ºpng
</span>    <span class="n">plt</span><span class="p">.</span><span class="n">savefig</span><span class="p">(</span><span class="s">'image_at_epoch_{:04d}.png'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">))</span>
    <span class="c1"># plt.show()
</span>    <span class="n">plt</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1"># éå†æ‰€æœ‰pngå›¾ç‰‡ï¼Œæ±‡æ€»ä¸ºgifåŠ¨å›¾
</span><span class="k">def</span> <span class="nf">write_gif</span><span class="p">():</span>
    <span class="n">anim_file</span> <span class="o">=</span> <span class="s">'dcgan.gif'</span>
    <span class="k">with</span> <span class="n">imageio</span><span class="p">.</span><span class="n">get_writer</span><span class="p">(</span><span class="n">anim_file</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">'I'</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
        <span class="n">filenames</span> <span class="o">=</span> <span class="n">glob</span><span class="p">.</span><span class="n">glob</span><span class="p">(</span><span class="s">'image*.png'</span><span class="p">)</span>
        <span class="n">filenames</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span>
        <span class="n">last</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">filename</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filenames</span><span class="p">):</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">round</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">round</span><span class="p">(</span><span class="n">last</span><span class="p">):</span>
                <span class="n">last</span> <span class="o">=</span> <span class="n">frame</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">imageio</span><span class="p">.</span><span class="n">imread</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">writer</span><span class="p">.</span><span class="n">append_data</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">imageio</span><span class="p">.</span><span class="n">imread</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">writer</span><span class="p">.</span><span class="n">append_data</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

<span class="c1"># ç”Ÿæˆä¸€å¼ åˆå§‹çŠ¶æ€çš„4æ ¼å›¾ç‰‡ï¼Œåº”å½“æ˜¯å™ªç‚¹
</span><span class="n">generate_and_save_images</span><span class="p">(</span>
        <span class="n">generator</span><span class="p">,</span>
        <span class="mi">0000</span><span class="p">,</span>
        <span class="n">seed</span><span class="p">)</span>

<span class="k">if</span> <span class="n">TRAIN</span><span class="p">:</span>
    <span class="c1"># ä»¥è®­ç»ƒæ¨¡å¼è¿è¡Œï¼Œè¿›å…¥è®­ç»ƒçŠ¶æ€
</span>    <span class="n">train</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">EPOCHS</span><span class="p">)</span>
    <span class="n">write_gif</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># éè®­ç»ƒæ¨¡å¼ï¼Œæ¢å¤è®­ç»ƒæ•°æ®
</span>    <span class="n">checkpoint</span><span class="p">.</span><span class="n">restore</span><span class="p">(</span><span class="n">tf</span><span class="p">.</span><span class="n">train</span><span class="p">.</span><span class="n">latest_checkpoint</span><span class="p">(</span><span class="n">checkpoint_dir</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"After training:"</span><span class="p">)</span>
    <span class="c1"># æ˜¾ç¤ºè®­ç»ƒå®Œæˆåï¼Œç”Ÿæˆå›¾ç‰‡çš„è¾¨åˆ«ç»“æœ
</span>    <span class="n">generated_image</span> <span class="o">=</span> <span class="n">generator</span><span class="p">(</span><span class="n">noise</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">decision</span> <span class="o">=</span> <span class="n">discriminator</span><span class="p">(</span><span class="n">generated_image</span><span class="p">)</span>
    <span class="c1"># ç»“æœåº”å½“è¶‹è¿‘1
</span>    <span class="k">print</span><span class="p">(</span><span class="n">decision</span><span class="p">)</span>
    <span class="c1"># é‡æ–°ç”Ÿæˆéšæœºå€¼ï¼Œç”Ÿæˆä¸€ç»„å›¾ç‰‡ä¿å­˜
</span>    <span class="n">seed</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">normal</span><span class="p">([</span><span class="n">num_examples_to_generate</span><span class="p">,</span> <span class="n">noise_dim</span><span class="p">])</span>
    <span class="n">generate_and_save_images</span><span class="p">(</span>
            <span class="n">generator</span><span class="p">,</span>
            <span class="mi">9999</span><span class="p">,</span>
            <span class="n">seed</span><span class="p">)</span>
</code></pre></div></div>
<p>ç¨‹åºç»è¿‡100æ¬¡è¿­ä»£ï¼Œæœ€ç»ˆç”Ÿæˆçš„çš„å›¾ç‰‡ç±»ä¼¼è¿™ä¸ªæ ·å­ï¼š<br />
<img src="http://115.182.41.123/files/201904/tensorFlow2/gan-output-100.png" alt="" /><br />
è¿˜æ˜¯è€è¯ï¼Œçœ‹èµ·æ¥çš„ç¡®ä¸€èˆ¬ï¼Œä½†åº”å½“è¯´å·²ç»æœ‰ä¸€äº›ç¥ä¼¼çœŸå®çš„æ ·æœ¬äº†ã€‚</p>

<p>è€ŒæŠŠå®Œæ•´çš„è®­ç»ƒè¿‡ç¨‹è¿ç»­èµ·æ¥ä½œä¸ºä¸€å¼ åŠ¨å›¾ï¼ŒåŒVAEä¸€æ ·ï¼Œæ˜¯ä¸€å¹…ä»å™ªå£°åˆ°æ¸…æ™°ï¼Œç¼“æ…¢çš„æ¸è¿›è¿‡ç¨‹ã€‚å› ä¸ºGANç½‘ç»œå¹¶éç›´æ¥æ¯”è¾ƒå›¾ç‰‡ç»“æœï¼Œæ— æ³•æ›´ç›´æ¥çš„æŒ‡å‡ºå›¾ç‰‡å·®è·ï¼Œå› æ­¤åœ¨æ¸è¿›è¿‡ç¨‹ä¸­ï¼Œèƒ½çœ‹åˆ°ä¸€äº›åå¤å’Œè·³åŠ¨ã€‚è¿™è¯´æ˜ï¼Œåœ¨æœºå™¨è§†è§‰é¢†åŸŸGANçš„å¯æ§æ€§å¹¶ä¸å¦‚VAEã€‚<br />
<img src="http://115.182.41.123/files/201904/tensorFlow2/gan-final.gif" alt="" />
åœ¨æ‰€æœ‰æ¨¡å‹æœªç»è®­ç»ƒçš„æ—¶å€™ï¼Œæˆ‘ä»¬éšæœºç”Ÿæˆäº†ä¸€å¹…å›¾ç‰‡ï¼Œä½¿ç”¨è¾¨åˆ«å™¨è¿›è¡Œäº†åˆ¤æ–­ã€‚åœ¨è®­ç»ƒå®Œæˆä¹‹åï¼Œæˆ‘ä»¬å†æ¬¡é‡å¤è¿™ä¸€è¿‡ç¨‹ã€‚é€šè¿‡å‘½ä»¤è¡Œçš„è¾“å‡ºï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç±»ä¼¼è¿™æ ·çš„ç»“æœï¼š</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tf.Tensor<span class="o">([[</span><span class="nt">-4</span>.8871705e-05]], <span class="nv">shape</span><span class="o">=(</span>1, 1<span class="o">)</span>, <span class="nv">dtype</span><span class="o">=</span>float32<span class="o">)</span>
After training:
tf.Tensor<span class="o">([[</span><span class="nt">-1</span>.5235078]], <span class="nv">shape</span><span class="o">=(</span>1, 1<span class="o">)</span>, <span class="nv">dtype</span><span class="o">=</span>float32<span class="o">)</span>
</code></pre></div></div>
<p>ä¸€å¼€å§‹æ˜¯ä¸€ä¸ªå¾ˆè¶‹è¿‘äº0çš„å€¼ï¼Œè¿™æ˜¯å› ä¸ºé‚£å¼ å®Œå…¨æ˜¯å™ªç‚¹ç»„æˆçš„ç”Ÿæˆå›¾ç‰‡ï¼ŒåŒçœŸå®æ ·æœ¬å›¾ç‰‡å®Œå…¨æ²¡æœ‰ç›¸ä¼¼ç‚¹ï¼Œè™½ç„¶è¾¨åˆ«æ¨¡å‹å¹¶æœªè®­ç»ƒï¼Œä½†è¿™ä¾ç„¶æ˜¯å¾ˆä½çš„å¾—åˆ†ã€‚<br />
åœ¨è®­ç»ƒå®Œæˆåï¼Œæ‰€ç”Ÿæˆçš„å›¾ç‰‡ï¼Œä»è¾¨åˆ«å™¨çš„çœ¼ä¸­çœ‹æ¥ï¼Œå·²ç»å¾ˆæ¥è¿‘çœŸå®æ ·æœ¬ï¼Œå› æ­¤æˆ‘ä»¬è·å¾—äº†ä¸€ä¸ªè¾ƒé«˜çš„å¾—åˆ†ã€‚</p>

<p>GANå‚è€ƒè®ºæ–‡ï¼š<a href="https://arxiv.org/abs/1701.00160">ã€ŠNIPS 2016 Tutorial: Generative Adversarial Networks&gt;</a></p>

<p>ï¼ˆå¾…ç»­â€¦ï¼‰</p>

:ET