I"K¼<p><img src="/attachments/201904/tensorFlow2/tf-logo-card-2.png" alt="" /></p>
<h4 id="keraså†…ç½®çš„é¢„å®šä¹‰æ¨¡å‹">Keraså†…ç½®çš„é¢„å®šä¹‰æ¨¡å‹</h4>
<p>ä¸Šä¸€èŠ‚æˆ‘ä»¬è®²è¿‡äº†å®Œæ•´çš„ä¿å­˜æ¨¡å‹åŠå…¶è®­ç»ƒå®Œæˆçš„å‚æ•°ã€‚<br />
Kerasä¸­ä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œé¢„ç½®äº†å¤šä¸ªè‘—åçš„æˆç†Ÿç¥ç»ç½‘ç»œæ¨¡å‹ã€‚å½“ç„¶ï¼Œè¿™å®é™…æ˜¯Kerasçš„åŠŸåŠ³ï¼Œå¹¶ä¸é€‚åˆç®—åœ¨TensorFlow 2.0å¤´ä¸Šã€‚<br />
å½“å‰TensorFlow 2.0-alphaç‰ˆæœ¬æ†ç»‘çš„Kerasä¸­åŒ…å«ï¼š</p>
<ul>
  <li>densenet</li>
  <li>inception_resnet_v2</li>
  <li>inception_v3</li>
  <li>mobilenet</li>
  <li>mobilenet_v2</li>
  <li>nasnet</li>
  <li>resnet50</li>
  <li>vgg16</li>
  <li>vgg19</li>
  <li>xception</li>
</ul>

<p>è¿™äº›æ¨¡å‹éƒ½å·²ç»ä½¿ç”¨å¤§è§„æ¨¡çš„æ•°æ®è®­ç»ƒå®Œæˆï¼Œå¯ä»¥ä¸Šæ‰‹å³ç”¨ï¼Œå®ä¸ºè‰¯å¿ƒä½³ä½œã€ç å†œç¦åˆ©ã€‚<br />
åœ¨<a href="http://blog.17study.com.cn/2018/01/15/tensorFlow-series-8/">ã€Šä»é”…ç‚‰å·¥åˆ°AIä¸“å®¶(8)ã€‹</a>æ–‡ä¸­ï¼Œæˆ‘ä»¬æ¼”ç¤ºäº†ä¸€ä¸ªä½¿ç”¨vgg19ç¥ç»ç½‘ç»œè¯†åˆ«å›¾ç‰‡å†…å®¹çš„ä¾‹å­ã€‚é‚£æ®µä»£ç å¹¶ä¸éš¾ï¼Œä½†æ˜¯ä½¿ç”¨TensorFlow 1.xçš„APIæ„å»ºvgg19è¿™ç§å¤æ‚çš„ç¥ç»ç½‘ç»œå¯è¯´è´¹åŠ²ä¸å°ã€‚æœ‰å…´è¶£çš„è¯»è€…å¯ä»¥ç§»æ­¥è‡³åŸæ–‡å†ä½“ä¼šä¸€ä¸‹é‚£ç§çº ç»“ã€‚</p>

<p>è€Œç°åœ¨å†åšåŒæ ·çš„äº‹åˆ™æ˜¯å†ç®€å•ä¸è¿‡äº†ï¼Œä½ å®Œå…¨å¯ä»¥åœ¨ä½ åŒäº‹å»èŒ¶æ°´é—´å€’å’–å•¡çš„æ—¶é—´å®Œæˆä¸€ä¸ªå…¨åŠŸèƒ½çš„å¯ç”¨ä»£ç ã€‚æ¯”å¦‚è·Ÿä¸Šæ–‡åŠŸèƒ½ç›¸åŒçš„ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="n">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>
<span class="c1"># è½½å…¥vgg19æ¨¡å‹
</span><span class="kn">from</span> <span class="nn">tensorflow.keras.applications</span> <span class="kn">import</span> <span class="n">vgg19</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.preprocessing</span> <span class="kn">import</span> <span class="n">image</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">argparse</span>

<span class="c1"># ç”¨äºä¿å­˜å‘½ä»¤è¡Œå‚æ•°
</span><span class="n">FLAGS</span> <span class="o">=</span> <span class="bp">None</span>

<span class="c1"># åˆå§‹åŒ–vgg19æ¨¡å‹ï¼Œweightså‚æ•°æŒ‡çš„æ˜¯ä½¿ç”¨ImageNetå›¾ç‰‡é›†è®­ç»ƒçš„æ¨¡å‹
# æ¯ç§æ¨¡å‹ç¬¬ä¸€æ¬¡ä½¿ç”¨çš„æ—¶å€™éƒ½ä¼šè‡ªç½‘ç»œä¸‹è½½ä¿å­˜çš„h5æ–‡ä»¶
# vgg19çš„æ•°æ®æ–‡ä»¶çº¦ä¸º584M
</span><span class="n">model</span> <span class="o">=</span> <span class="n">vgg19</span><span class="p">.</span><span class="n">VGG19</span><span class="p">(</span><span class="n">weights</span><span class="o">=</span><span class="s">'imagenet'</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">imgPath</span><span class="p">):</span>
	<span class="c1"># è½½å…¥å‘½ä»¤è¡Œå‚æ•°æŒ‡å®šçš„å›¾ç‰‡æ–‡ä»¶, è½½å…¥æ—¶å˜å½¢ä¸º224x224ï¼Œè¿™æ˜¯æ¨¡å‹è§„èŒƒæ•°æ®è¦æ±‚çš„
</span>    <span class="n">img</span> <span class="o">=</span> <span class="n">image</span><span class="p">.</span><span class="n">load_img</span><span class="p">(</span><span class="n">imgPath</span><span class="p">,</span> <span class="n">target_size</span><span class="o">=</span><span class="p">(</span><span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">))</span>
	<span class="c1"># å°†å›¾ç‰‡è½¬æ¢ä¸º(224,224,3)æ•°ç»„ï¼Œæœ€åçš„3æ˜¯å› ä¸ºRGBä¸‰è‰²å½©å›¾
</span>    <span class="n">img</span> <span class="o">=</span> <span class="n">image</span><span class="p">.</span><span class="n">img_to_array</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
	<span class="c1"># è·Ÿå‰é¢çš„ä¾‹å­ä¸€æ ·ï¼Œä½¿ç”¨æ¨¡å‹è¿›è¡Œé¢„æµ‹æ˜¯æ‰¹å¤„ç†æ¨¡å¼ï¼Œ
</span>	<span class="c1"># æ‰€ä»¥å¯¹äºå•ä¸ªçš„å›¾ç‰‡ï¼Œè¦æ‰©å±•ä¸€ç»´æˆä¸ºï¼ˆ1,224,224,3)è¿™æ ·çš„å½¢å¼
</span>	<span class="c1"># ç›¸å½“äºå»ºç«‹ä¸€ä¸ªé¢„æµ‹é˜Ÿåˆ—ï¼Œä½†å…¶ä¸­åªæœ‰ä¸€å¼ å›¾ç‰‡
</span>    <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
	<span class="c1"># ä½¿ç”¨æ¨¡å‹é¢„æµ‹ï¼ˆè¯†åˆ«ï¼‰
</span>    <span class="n">predict_class</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">predict</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
	<span class="c1"># è·å–å›¾ç‰‡è¯†åˆ«å¯èƒ½æ€§æœ€é«˜çš„3ä¸ªç»“æœ
</span>    <span class="n">desc</span> <span class="o">=</span> <span class="n">vgg19</span><span class="p">.</span><span class="n">decode_predictions</span><span class="p">(</span><span class="n">predict_class</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
	<span class="c1"># æˆ‘ä»¬çš„é¢„æµ‹é˜Ÿåˆ—ä¸­åªæœ‰ä¸€å¼ å›¾ç‰‡ï¼Œæ‰€ä»¥ç»“æœä¹Ÿåªæœ‰ç¬¬ä¸€ä¸ªæœ‰æ•ˆï¼Œæ˜¾ç¤ºå‡ºæ¥
</span>    <span class="k">print</span><span class="p">(</span><span class="n">desc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
	<span class="c1"># å‘½ä»¤è¡Œå‚æ•°å¤„ç†
</span>    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'-i'</span><span class="p">,</span> <span class="s">'--image_file'</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">'pics/bigcat.jpeg'</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">'Pic file name'</span><span class="p">)</span>
    <span class="n">FLAGS</span><span class="p">,</span> <span class="n">unparsed</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="n">parse_known_args</span><span class="p">()</span>
    <span class="n">main</span><span class="p">(</span><span class="n">FLAGS</span><span class="p">.</span><span class="n">image_file</span><span class="p">)</span>

</code></pre></div></div>
<p>Kerasåº“è½½å…¥å›¾ç‰‡æ–‡ä»¶çš„ä»£ç é—´æ¥å¼•ç”¨äº†pillowåº“ï¼Œæ‰€ä»¥ç¨‹åºæ‰§è¡Œå‰è¯·å…ˆå®‰è£…ï¼š<code class="language-plaintext highlighter-rouge">pip3 install pillow</code>ã€‚<br />
ä»ç„¶ä½¿ç”¨åŸæ–‡ä¸­çš„å›¾ç‰‡å°è¯•è¯†åˆ«ï¼š<br />
<img src="/attachments/201904/tensorFlow2/bigcat.jpeg" alt="" /></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span> <span class="p">.</span><span class="o">/</span><span class="n">pic</span><span class="o">-</span><span class="n">recognize</span><span class="p">.</span><span class="n">py</span> <span class="o">-</span><span class="n">i</span> <span class="n">pics</span><span class="o">/</span><span class="n">bigcat</span><span class="p">.</span><span class="n">jpeg</span> 
<span class="p">[(</span><span class="s">'n02128385'</span><span class="p">,</span> <span class="s">'leopard'</span><span class="p">,</span> <span class="mf">0.9778516</span><span class="p">),</span> <span class="p">(</span><span class="s">'n02130308'</span><span class="p">,</span> <span class="s">'cheetah'</span><span class="p">,</span> <span class="mf">0.008372171</span><span class="p">),</span> <span class="p">(</span><span class="s">'n02128925'</span><span class="p">,</span> <span class="s">'jaguar'</span><span class="p">,</span> <span class="mf">0.007467962</span><span class="p">)]</span>
</code></pre></div></div>
<p>ç»“æœè¡¨ç¤ºï¼Œå›¾ç‰‡æ˜¯leopard(ç¾æ´²è±¹)çš„å¯èƒ½æ€§ä¸º97.79%ï¼Œæ˜¯cheetah(çŒè±¹)çš„å¯èƒ½æ€§ä¸º0.84%ï¼Œæ˜¯jaguar(ç¾æ´²è™)çš„å¯èƒ½æ€§ä¸º0.75%ã€‚</p>

<p>ä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œåœ¨å›¾ç‰‡è¯†åˆ«ä¸­ï¼Œæ¢ç”¨å…¶ä»–ç½‘ç»œæ¨¡å‹éå¸¸è½»æ¾ï¼Œåªéœ€è¦æ›¿æ¢ç¨‹åºä¸­çš„ä¸‰æ¡è¯­å¥ï¼Œæ¯”å¦‚æˆ‘ä»¬å°†æ¨¡å‹æ¢ä¸ºresnet50ï¼š</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">æ¨¡å‹å¼•å…¥</span><span class="err">ï¼Œ</span><span class="n">ç”±</span><span class="err">ï¼š</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.applications</span> <span class="kn">import</span> <span class="n">vgg19</span>
<span class="n">æ›¿æ¢ä¸º</span><span class="err">ï¼š</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.applications</span> <span class="kn">import</span> <span class="n">resnet50</span>

<span class="n">æ¨¡å‹æ„å»º</span><span class="err">ï¼Œ</span><span class="n">ç”±</span><span class="err">ï¼š</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">vgg19</span><span class="p">.</span><span class="n">VGG19</span><span class="p">(</span><span class="n">weights</span><span class="o">=</span><span class="s">'imagenet'</span><span class="p">)</span>
<span class="n">æ›¿æ¢ä¸º</span><span class="err">ï¼š</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">resnet50</span><span class="p">.</span><span class="n">ResNet50</span><span class="p">(</span><span class="n">weights</span><span class="o">=</span><span class="s">'imagenet'</span><span class="p">)</span>
<span class="n">æ³¨æ„ç¬¬ä¸€æ¬¡è¿è¡Œçš„æ—¶å€™</span><span class="err">ï¼Œ</span><span class="n">åŒæ ·ä¼šä¸‹è½½resnet50çš„h5æ–‡ä»¶</span><span class="err">ï¼Œ</span><span class="n">è¿™éœ€è¦ä¸çŸ­æ—¶é—´</span><span class="err">ã€‚</span>  

<span class="n">æ˜¾ç¤ºé¢„æµ‹ç»“æœ</span><span class="err">ï¼Œ</span><span class="n">ç”±</span><span class="err">ï¼š</span>
    <span class="n">desc</span> <span class="o">=</span> <span class="n">vgg19</span><span class="p">.</span><span class="n">decode_predictions</span><span class="p">(</span><span class="n">predict_class</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">æ›¿æ¢ä¸º</span><span class="err">ï¼š</span>
    <span class="n">desc</span> <span class="o">=</span> <span class="n">resnet50</span><span class="p">.</span><span class="n">decode_predictions</span><span class="p">(</span><span class="n">predict_class</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</code></pre></div></div>
<p>å› ä¸ºæ¨¡å‹ä¸åŒï¼Œæ‰§è¡Œç»“æœä¼šæœ‰ç»†å¾®åŒºåˆ«ï¼Œä½†è¿™ç§ä¹…ç»è€ƒéªŒçš„æˆç†Ÿç½‘ç»œï¼Œè¯†åˆ«æ­£ç¡®æ€§æ²¡æœ‰é—®é¢˜ï¼š</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>./pic-recognize.py <span class="nt">-i</span> pics/bigcat.jpeg 
<span class="o">[(</span><span class="s1">'n02128385'</span>, <span class="s1">'leopard'</span>, 0.8544763<span class="o">)</span>, <span class="o">(</span><span class="s1">'n02128925'</span>, <span class="s1">'jaguar'</span>, 0.09733019<span class="o">)</span>, <span class="o">(</span><span class="s1">'n02128757'</span>, <span class="s1">'snow_leopard'</span>, 0.040557403<span class="o">)]</span>
</code></pre></div></div>

<h4 id="è‡ªç„¶è¯­ä¹‰è¯†åˆ«">è‡ªç„¶è¯­ä¹‰è¯†åˆ«</h4>
<p>ç±»ä¼¼è¿™æ ·çš„åŠŸèƒ½é›†æˆã€æ•°æ®é¢„å¤„ç†å·¥ä½œåœ¨TensorFlow 2.0ä¸­å¢åŠ äº†å¾ˆå¤šï¼Œå¯¹æŠ€æœ¯äººå‘˜æ˜¯æå¤§çš„æ–¹ä¾¿ã€‚æ¯”å¦‚åœ¨<a href="http://blog.17study.com.cn/2018/01/16/tensorFlow-series-9/">ã€Šä»é”…ç‚‰å·¥åˆ°AIä¸“å®¶(9)ã€‹</a>ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº†NLPé¡¹ç›®é‡è¦çš„é¢„å¤„ç†å·¥ä½œï¼šå•è¯å‘é‡åŒ–ã€‚<br />
åœ¨Kerasä¸­ï¼Œå•è¯å‘é‡åŒ–å·²ç»æ ‡å‡†åŒ–ä¸ºäº†æ¨¡å‹ä¸­çš„ä¸€å±‚ã€‚å›ºåŒ–çš„åŒæ—¶ï¼Œä½¿ç”¨çš„è‡ªç”±åº¦ä¹Ÿå¾ˆé«˜ï¼Œå¯ä»¥åœ¨ä»£ç ä¸­æ§åˆ¶éœ€è¦ç¼–ç çš„å•è¯æ•°é‡å’Œå‘é‡åŒ–çš„ç»´åº¦ä»¥åŠå¾ˆå¤šå…¶å®ƒå‚æ•°ã€‚è¯¦ç»†çš„æ–‡æ¡£å¯ä»¥çœ‹<a href="https://www.tensorflow.org/versions/r2.0/api_docs/python/tf/keras/layers/Embedding">å®˜æ–¹æ–‡æ¡£</a>ã€‚<br />
å•è¯æ•°å­—åŒ–çš„ç›¸å…³çŸ¥è¯†ï¼Œæˆ‘ä»¬åé¢ä¸€ç¯‡ä¹Ÿä¼šä»‹ç»ã€‚</p>

<p>æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªTensorFlow 2.0æ•™ç¨‹ä¸­çš„ä¾‹å­ï¼Œè‡ªç„¶è¯­ä¹‰è¯†åˆ«ã€‚<br />
ç¨‹åºä½¿ç”¨IMDBå½±ç‰‡ç‚¹è¯„æ ·æœ¬é›†ä½œä¸ºè®­ç»ƒæ•°æ®ã€‚æ•°æ®é›†çš„ä¸‹è½½ã€è½½å…¥å’Œç®¡ç†ï¼Œæˆ‘ä»¬ä½¿ç”¨tensorflow_datasetså·¥å…·åŒ…ã€‚æ‰€ä»¥é¦–å…ˆè¦å®‰è£…ä¸€ä¸‹ï¼š</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>pip3 <span class="nb">install </span>tfds-nightly 
</code></pre></div></div>
<p>IMDBæ•°æ®é›†åŒ…æ‹¬å½±è¯„å’Œæ ‡æ³¨ä¸¤ä¸ªéƒ¨åˆ†ï¼šå½±è¯„å°±æ˜¯æ‘˜é€‰çš„å…³äºå½±ç‰‡çš„è¯„è®ºï¼Œæ˜¯ä¸€æ®µè‹±æ–‡æ–‡å­—ï¼›æ ‡æ³¨åªæœ‰0æˆ–è€…1ä¸¤ä¸ªæ•°å­—ã€‚0è¡¨ç¤ºæœ¬æ¡å½±è¯„å¯¹å½±ç‰‡è¯„ä»·ä½ï¼Œè®¤ä¸ºç”µå½±ä¸å¥½çœ‹ï¼Œæ˜¯è´Ÿé¢æƒ…ç»ªã€‚1åˆ™è¡¨ç¤ºæœ¬æ¡å½±è¯„å¯¹ç”µå½±è¯„ä»·é«˜ï¼Œè®¤ä¸ºæ˜¯å¥½çœ‹çš„ç”µå½±ï¼Œæ˜¯æ­£é¢æƒ…ç»ªã€‚<br />
å¯æƒœæ˜¯è‹±æ–‡çš„æ•°æ®é›†ã€‚å¦‚æœæƒ³åšç±»ä¼¼çš„ä¸­æ–‡è¯­ä¹‰åˆ†æå·¥ä½œï¼Œéœ€è¦æˆ‘ä»¬è‡ªå·±é…åˆä¼˜ç§€çš„åˆ†è¯å·¥å…·æ¥å®Œæˆã€‚<br />
æˆ‘ä»¬ä½¿ç”¨çš„IMDBçš„æ•°æ®é›†å·²ç»é¢„å…ˆå®Œæˆäº†å•è¯æ•°å­—åŒ–çš„å·¥ä½œï¼Œä¹Ÿå°±æ˜¯å·²ç»ç”±æ•´æ•°ç¼–ç ä»£è¡¨å•è¯ã€‚æ‰€ä»¥é…åˆçš„ï¼Œå¿…é¡»æœ‰ç¼–ç è¡¨æ¥å¯¹åº”ä½¿ç”¨ï¼Œæ‰èƒ½è¿˜åŸåŸå§‹çš„è¯„è®ºæ–‡å­—ã€‚<br />
ä¸‹é¢æˆ‘ä»¬åœ¨Pythonå‘½ä»¤è¡Œä½¿ç”¨äº¤äº’æ¨¡å¼ï¼Œæ¥çœ‹ä¸€ä¸‹åŸå§‹æ•°æ®çš„æ ·å­ï¼š</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span> <span class="n">python3</span>
<span class="n">Python</span> <span class="mf">3.7</span><span class="p">.</span><span class="mi">3</span> <span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="n">Mar</span> <span class="mi">27</span> <span class="mi">2019</span><span class="p">,</span> <span class="mi">09</span><span class="p">:</span><span class="mi">23</span><span class="p">:</span><span class="mi">39</span><span class="p">)</span> 
<span class="p">[</span><span class="n">Clang</span> <span class="mf">10.0</span><span class="p">.</span><span class="mi">0</span> <span class="p">(</span><span class="n">clang</span><span class="o">-</span><span class="mf">1000.11</span><span class="p">.</span><span class="mf">45.5</span><span class="p">)]</span> <span class="n">on</span> <span class="n">darwin</span>
<span class="n">Type</span> <span class="s">"help"</span><span class="p">,</span> <span class="s">"copyright"</span><span class="p">,</span> <span class="s">"credits"</span> <span class="ow">or</span> <span class="s">"license"</span> <span class="k">for</span> <span class="n">more</span> <span class="n">information</span><span class="p">.</span>
<span class="c1"># å¼•å…¥TensorFlowæ•°æ®é›†å¤„ç†å·¥å…·
</span><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">tensorflow_datasets</span> <span class="k">as</span> <span class="n">tfds</span>
<span class="c1"># è½½å…¥ç®€åŒ–ç‰ˆè®­ç»ƒæ ·æœ¬æ•°æ®é›†ï¼Œç®€åŒ–ç‰ˆåªåŒ…å«8000+å•è¯ï¼Œè¿™èƒ½è®©è®­ç»ƒè¿‡ç¨‹å¿«ä¸€ç‚¹ï¼Œ
# å®Œæ•´ç‰ˆåˆ™åŒ…å«å‡ ä¸‡
</span><span class="o">&gt;&gt;&gt;</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">tfds</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="s">'imdb_reviews/subwords8k'</span><span class="p">,</span> <span class="n">with_info</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
<span class="p">...</span>                           <span class="n">as_supervised</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="c1"># æ•°æ®é›†ä¸­å·²ç»åˆ’åˆ†å¥½äº†è®­ç»ƒæ•°æ®é›†å’Œæµ‹è¯•æ•°æ®é›†
</span><span class="o">&gt;&gt;&gt;</span> <span class="n">train_dataset</span><span class="p">,</span> <span class="n">test_dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="s">'train'</span><span class="p">],</span> <span class="n">dataset</span><span class="p">[</span><span class="s">'test'</span><span class="p">]</span>
<span class="c1"># åˆå§‹åŒ–å•è¯ç¼–ç å¯¹ç…§è¡¨ï¼Œç”¨äºä¸€ä¼šå„¿è¿˜åŸæ•°å­—æ•°ç»„åˆ°å½±è¯„æ–‡å­—
</span><span class="o">&gt;&gt;&gt;</span> <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">info</span><span class="p">.</span><span class="n">features</span><span class="p">[</span><span class="s">'text'</span><span class="p">].</span><span class="n">encoder</span>
<span class="c1"># æ˜¾ç¤ºä¸€æ¡åŸå§‹æ•°æ®ï¼Œæ˜¯ä¸€ä¸ªæ•°å­—æ•°ç»„åŠä¸€ä¸ªå•ç‹¬çš„æ•°å­—
# å‰è€…æ˜¯å·²ç»ç¼–ç çš„å½±è¯„ï¼Œåè€…æ˜¯æ ‡æ³¨
</span><span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">train_dataset</span><span class="p">.</span><span class="n">take</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
<span class="p">...</span>     <span class="k">print</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="p">...</span> 
<span class="n">tf</span><span class="p">.</span><span class="n">Tensor</span><span class="p">(</span>
<span class="p">[</span> <span class="mi">768</span>   <span class="mi">99</span>  <span class="mi">416</span>    <span class="mi">9</span>  <span class="mi">733</span>    <span class="mi">1</span>  <span class="mi">626</span>    <span class="mi">6</span>  <span class="mi">467</span>  <span class="mi">159</span>   <span class="mi">33</span>  <span class="mi">788</span>   <span class="mi">53</span>   <span class="mi">29</span>
 <span class="mi">1224</span>    <span class="mi">3</span>  <span class="mi">156</span>  <span class="mi">155</span> <span class="mi">1234</span> <span class="mi">2492</span>   <span class="mi">14</span>   <span class="mi">32</span>  <span class="mi">151</span> <span class="mi">7968</span>   <span class="mi">40</span>  <span class="mi">193</span>   <span class="mi">31</span>  <span class="mi">303</span>
 <span class="mi">7976</span>   <span class="mi">59</span> <span class="mi">4159</span>  <span class="mi">104</span>    <span class="mi">3</span>   <span class="mi">12</span>  <span class="mi">258</span> <span class="mi">2674</span>  <span class="mi">551</span> <span class="mi">5557</span>   <span class="mi">40</span>   <span class="mi">44</span>  <span class="mi">113</span>   <span class="mi">55</span>
  <span class="mi">143</span>  <span class="mi">121</span>   <span class="mi">83</span>   <span class="mi">35</span> <span class="mi">1151</span>   <span class="mi">11</span>  <span class="mi">195</span>   <span class="mi">13</span>  <span class="mi">746</span>   <span class="mi">61</span>   <span class="mi">55</span>  <span class="mi">300</span>    <span class="mi">3</span> <span class="mi">3075</span>
 <span class="mi">8044</span>   <span class="mi">38</span>   <span class="mi">66</span>   <span class="mi">54</span>    <span class="mi">9</span>    <span class="mi">4</span>  <span class="mi">355</span>  <span class="mi">811</span>   <span class="mi">23</span> <span class="mi">1406</span> <span class="mi">6481</span> <span class="mi">7961</span> <span class="mi">1060</span> <span class="mi">6786</span>
  <span class="mi">409</span> <span class="mi">3570</span> <span class="mi">7411</span> <span class="mi">3743</span> <span class="mi">2314</span> <span class="mi">7998</span> <span class="mi">8005</span> <span class="mi">1782</span>    <span class="mi">3</span>   <span class="mi">19</span>  <span class="mi">953</span>    <span class="mi">9</span> <span class="mi">5922</span> <span class="mi">8029</span>
    <span class="mi">3</span>   <span class="mi">12</span>  <span class="mi">207</span> <span class="mi">7968</span>   <span class="mi">21</span>  <span class="mi">582</span>   <span class="mi">72</span> <span class="mi">8002</span> <span class="mi">7968</span>  <span class="mi">123</span>  <span class="mi">853</span>  <span class="mi">178</span>  <span class="mi">132</span> <span class="mi">1527</span>
    <span class="mi">3</span>   <span class="mi">19</span> <span class="mi">1575</span>   <span class="mi">29</span> <span class="mi">1288</span> <span class="mi">2847</span> <span class="mi">2742</span> <span class="mi">8029</span>    <span class="mi">3</span>   <span class="mi">19</span>  <span class="mi">188</span>    <span class="mi">9</span>  <span class="mi">715</span> <span class="mi">7974</span>
 <span class="mi">7753</span>   <span class="mi">26</span>  <span class="mi">144</span>    <span class="mi">1</span>  <span class="mi">263</span>   <span class="mi">85</span>   <span class="mi">33</span>  <span class="mi">479</span>  <span class="mi">892</span>    <span class="mi">3</span> <span class="mi">1566</span> <span class="mi">1380</span>    <span class="mi">7</span> <span class="mi">1929</span>
 <span class="mi">4887</span> <span class="mi">7961</span> <span class="mi">3760</span>   <span class="mi">47</span> <span class="mi">4584</span>  <span class="mi">204</span>   <span class="mi">88</span>  <span class="mi">183</span>  <span class="mi">800</span> <span class="mi">1160</span>    <span class="mi">5</span>   <span class="mi">42</span>    <span class="mi">9</span> <span class="mi">6396</span>
   <span class="mi">20</span> <span class="mi">1838</span>   <span class="mi">24</span>   <span class="mi">10</span>   <span class="mi">16</span>   <span class="mi">10</span>   <span class="mi">17</span>   <span class="mi">19</span>  <span class="mi">349</span>  <span class="mi">233</span>    <span class="mi">9</span>    <span class="mi">1</span> <span class="mi">5845</span>  <span class="mi">432</span>
    <span class="mi">6</span>   <span class="mi">15</span>  <span class="mi">208</span>    <span class="mi">3</span>   <span class="mi">69</span>    <span class="mi">9</span>   <span class="mi">20</span>   <span class="mi">75</span>    <span class="mi">1</span> <span class="mi">1876</span>  <span class="mi">574</span>   <span class="mi">61</span>    <span class="mi">6</span>   <span class="mi">79</span>
  <span class="mi">141</span>    <span class="mi">7</span>  <span class="mi">115</span>   <span class="mi">15</span>   <span class="mi">51</span>   <span class="mi">20</span>  <span class="mi">785</span>   <span class="mi">20</span> <span class="mi">3374</span>    <span class="mi">3</span> <span class="mi">1976</span> <span class="mi">1515</span> <span class="mi">7968</span>    <span class="mi">8</span>
  <span class="mi">171</span>   <span class="mi">29</span> <span class="mi">7463</span>  <span class="mi">104</span>    <span class="mi">2</span> <span class="mi">5114</span>    <span class="mi">5</span>  <span class="mi">569</span>    <span class="mi">6</span> <span class="mi">2203</span>   <span class="mi">95</span>  <span class="mi">185</span>   <span class="mi">52</span> <span class="mi">5374</span>
  <span class="mi">376</span>  <span class="mi">231</span>    <span class="mi">5</span>  <span class="mi">789</span>   <span class="mi">47</span> <span class="mi">7514</span>   <span class="mi">11</span> <span class="mi">2246</span>  <span class="mi">714</span>    <span class="mi">2</span> <span class="mi">7779</span>   <span class="mi">49</span> <span class="mi">1709</span> <span class="mi">1877</span>
    <span class="mi">4</span>    <span class="mi">5</span>   <span class="mi">19</span> <span class="mi">3583</span> <span class="mi">3599</span> <span class="mi">7961</span>    <span class="mi">7</span> <span class="mi">1302</span>  <span class="mi">146</span>    <span class="mi">6</span>    <span class="mi">1</span> <span class="mi">1871</span>    <span class="mi">3</span>  <span class="mi">128</span>
   <span class="mi">11</span>    <span class="mi">1</span> <span class="mi">2674</span>  <span class="mi">194</span> <span class="mi">3754</span>  <span class="mi">100</span> <span class="mi">7974</span>  <span class="mi">267</span>    <span class="mi">6</span>  <span class="mi">405</span>   <span class="mi">68</span>   <span class="mi">29</span> <span class="mi">1966</span> <span class="mi">5928</span>
  <span class="mi">291</span>    <span class="mi">7</span> <span class="mi">2862</span>  <span class="mi">488</span>   <span class="mi">52</span> <span class="mi">2048</span>  <span class="mi">858</span>  <span class="mi">700</span> <span class="mi">1532</span>   <span class="mi">28</span> <span class="mi">1551</span>    <span class="mi">2</span>  <span class="mi">142</span> <span class="mi">7968</span>
    <span class="mi">8</span>  <span class="mi">638</span>  <span class="mi">152</span>    <span class="mi">1</span> <span class="mi">2246</span> <span class="mi">2968</span>  <span class="mi">739</span>  <span class="mi">251</span>   <span class="mi">19</span> <span class="mi">3712</span> <span class="mi">1183</span>  <span class="mi">830</span> <span class="mi">1379</span> <span class="mi">5368</span>
   <span class="mi">47</span>    <span class="mi">5</span> <span class="mi">1889</span> <span class="mi">7974</span> <span class="mi">4038</span>   <span class="mi">34</span> <span class="mi">4636</span>   <span class="mi">52</span> <span class="mi">3653</span> <span class="mi">6991</span>   <span class="mi">34</span> <span class="mi">4491</span> <span class="mi">8029</span> <span class="mi">7975</span><span class="p">],</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">280</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">int64</span><span class="p">)</span> <span class="n">tf</span><span class="p">.</span><span class="n">Tensor</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">int64</span><span class="p">)</span>
<span class="c1"># æ˜¾ç¤ºä¸€æ¡è¿˜åŸçš„å½±è¯„å’Œæ ‡æ³¨
</span><span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">train_dataset</span><span class="p">.</span><span class="n">take</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
<span class="p">...</span>     <span class="k">print</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">numpy</span><span class="p">())</span>
<span class="p">...</span> 
<span class="n">Just</span> <span class="n">because</span> <span class="n">someone</span> <span class="ow">is</span> <span class="n">under</span> <span class="n">the</span> <span class="n">age</span> <span class="n">of</span> <span class="mi">10</span> <span class="n">does</span> <span class="ow">not</span> <span class="n">mean</span> <span class="n">they</span> <span class="n">are</span> <span class="n">stupid</span><span class="p">.</span> <span class="n">If</span> <span class="n">your</span> <span class="n">child</span> <span class="n">likes</span> <span class="n">this</span> <span class="n">film</span> <span class="n">you</span><span class="s">'d better have him/her tested. I am continually amazed at how so many people can be involved in something that turns out so bad. This "film" is a showcase for digital wizardry AND NOTHING ELSE. The writing is horrid. I can'</span><span class="n">t</span> <span class="n">remember</span> <span class="n">when</span> <span class="n">I</span><span class="s">'ve heard such bad dialogue. The songs are beyond wretched. The acting is sub-par but then the actors were not given much. Who decided to employ Joey Fatone? He cannot sing and he is ugly as sin.&lt;br /&gt;&lt;br /&gt;The worst thing is the obviousness of it all. It is as if the writers went out of their way to make it all as stupid as possible. Great children'</span><span class="n">s</span> <span class="n">movies</span> <span class="n">are</span> <span class="n">wicked</span><span class="p">,</span> <span class="n">smart</span> <span class="ow">and</span> <span class="n">full</span> <span class="n">of</span> <span class="n">wit</span> <span class="o">-</span> <span class="n">films</span> <span class="n">like</span> <span class="n">Shrek</span> <span class="ow">and</span> <span class="n">Toy</span> <span class="n">Story</span> <span class="ow">in</span> <span class="n">recent</span> <span class="n">years</span><span class="p">,</span> <span class="n">Willie</span> <span class="n">Wonka</span> <span class="ow">and</span> <span class="n">The</span> <span class="n">Witches</span> <span class="n">to</span> <span class="n">mention</span> <span class="n">two</span> <span class="n">of</span> <span class="n">the</span> <span class="n">past</span><span class="p">.</span> <span class="n">But</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">continual</span> <span class="n">dumbing</span><span class="o">-</span><span class="n">down</span> <span class="n">of</span> <span class="n">American</span> <span class="n">more</span> <span class="n">are</span> <span class="n">flocking</span> <span class="n">to</span> <span class="n">dreck</span> <span class="n">like</span> <span class="n">Finding</span> <span class="n">Nemo</span> <span class="p">(</span><span class="n">yes</span><span class="p">,</span> <span class="n">that</span><span class="s">'s right), the recent Charlie &amp; The Chocolate Factory and eye-crossing trash like Red Riding Hood. 0
# å½±è¯„éƒ¨åˆ†ä¸å¤šè¯´ï¼Œæ ‡æ³¨éƒ¨åˆ†æ˜¯æ•°å­—0ï¼Œè¡¨ç¤ºè¿™æ˜¯ä¸€æ¡è´Ÿé¢è¯„ä»·
</span></code></pre></div></div>
<p>NLPç±»é¡¹ç›®ï¼Œé€šå¸¸å¤šç”¨RNNã€LSTMã€GRUç½‘ç»œã€‚ä¸»è¦åŸå› æ˜¯ä¸€æ¡æ–‡æœ¬ï¼Œå•è¯æ•°å¹¶ä¸ç¡®å®šï¼Œè™½ç„¶å¯ä»¥åšè¡¥è¶³(Padding)ï¼Œä½†ä½¿ç”¨é€šå¸¸ç¥ç»ç½‘ç»œæ•ˆæœå¹¶ä¸å¥½ã€‚æ­¤å¤–æ–‡æœ¬ä¸­å„å•è¯ä¹‹é—´æ˜¯æœ‰ç›¸å…³æ€§çš„ï¼Œè¿™ç±»ä¼¼å›¾ç‰‡ä¸­çš„ç›¸é‚»ç‚¹ä¹‹é—´çš„ç›¸å…³ï¼Œä½†æ–‡æœ¬çš„ç›¸å…³æ€§è·¨åº¦æ›´å¤§ã€‚ <br />
å…³äºRNN/LSTM/GRUçš„åŸç†æˆ‘ä»¬åœ¨<a href="http://blog.17study.com.cn/2018/01/17/tensorFlow-series-10/">ã€Šä»é”…ç‚‰å·¥åˆ°AIä¸“å®¶(10)ã€‹</a>ä¸€æ–‡ä¸­å·²ç»æœ‰è¿‡ä»‹ç»ã€‚è¿™é‡Œä¸å†é‡å¤ï¼Œç›´æ¥è¿›å…¥ä»£ç éƒ¨åˆ†ï¼Œé€šè¿‡æ³¨é‡Šæ¥ç†è§£æ‰€åšçš„å·¥ä½œï¼š</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>

<span class="c1"># å¼•å…¥tensorflowæ•°æ®é›†å·¥å…·åŒ…
</span><span class="kn">import</span> <span class="nn">tensorflow_datasets</span> <span class="k">as</span> <span class="n">tfds</span>
<span class="c1"># å¼•å…¥tensorflow
</span><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="n">tf</span>

<span class="c1"># åŠ è½½æ•°æ®é›†ï¼Œç¬¬ä¸€æ¬¡ä¼šéœ€è¦ä»ç½‘ä¸Šä¸‹è½½imdbæ•°æ®åº“
</span><span class="n">dataset</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">tfds</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="s">'imdb_reviews/subwords8k'</span><span class="p">,</span> <span class="n">with_info</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                          <span class="n">as_supervised</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="c1"># å°†è®­ç»ƒé›†å’Œæµ‹è¯•é›†åˆ†åˆ«èµ‹äºˆä¸¤ä¸ªå˜é‡                          
</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">test_dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="s">'train'</span><span class="p">],</span> <span class="n">dataset</span><span class="p">[</span><span class="s">'test'</span><span class="p">]</span>

<span class="c1"># åˆå§‹åŒ–å¯¹åº”çš„æ–‡æœ¬ç¼–ç å¯¹ç…§è¡¨
</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">info</span><span class="p">.</span><span class="n">features</span><span class="p">[</span><span class="s">'text'</span><span class="p">].</span><span class="n">encoder</span>
<span class="c1"># æ˜¾ç¤ºå½“å‰æ ·æœ¬é›†åŒ…å«çš„æ‰€æœ‰å•è¯æ•°
</span><span class="k">print</span><span class="p">(</span><span class="s">'Vocabulary size: {}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">.</span><span class="n">vocab_size</span><span class="p">))</span>

<span class="n">BUFFER_SIZE</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">64</span>
<span class="c1"># å°†è®­ç»ƒé›†æ‰“ä¹±é¡ºåº
</span><span class="n">train_dataset</span> <span class="o">=</span> <span class="n">train_dataset</span><span class="p">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">BUFFER_SIZE</span><span class="p">)</span>
<span class="c1"># æ¯æ‰¹æ¬¡çš„æ•°æ®å¯¹é½
</span><span class="n">train_dataset</span> <span class="o">=</span> <span class="n">train_dataset</span><span class="p">.</span><span class="n">padded_batch</span><span class="p">(</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="n">train_dataset</span><span class="p">.</span><span class="n">output_shapes</span><span class="p">)</span>
<span class="n">test_dataset</span> <span class="o">=</span> <span class="n">test_dataset</span><span class="p">.</span><span class="n">padded_batch</span><span class="p">(</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="n">test_dataset</span><span class="p">.</span><span class="n">output_shapes</span><span class="p">)</span>

<span class="c1"># æ„é€ ç¥ç»ç½‘ç»œæ¨¡å‹
# ç¬¬ä¸€å±‚å°±æ˜¯å°†å·²ç»æ•°å­—åŒ–çš„å½±è¯„æ•°æ®å‘é‡åŒ–
# å‘é‡åŒ–åœ¨ä¸Šä¸ªç³»åˆ—ä¸­å·²ç»è®²è¿‡ï¼ŒåŠŸèƒ½å°±æ˜¯å°†å•è¯åµŒå…¥å¤šç»´çŸ©é˜µ
# å¹¶ä½¿å¾—è¯­ä¹‰ç›¸è¿‘çš„å•è¯ï¼Œåœ¨ç©ºé—´è·ç¦»ä¸Šæ›´æ¥è¿‘
</span><span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">tokenizer</span><span class="p">.</span><span class="n">vocab_size</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span>
    <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">Bidirectional</span><span class="p">(</span><span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">LSTM</span><span class="p">(</span>
        <span class="mi">64</span><span class="p">,</span> <span class="n">return_sequences</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
    <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">Bidirectional</span><span class="p">(</span><span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">LSTM</span><span class="p">(</span><span class="mi">32</span><span class="p">)),</span>
    <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">),</span>
    <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'sigmoid'</span><span class="p">)</span>
<span class="p">])</span>
<span class="c1"># ç¼–è¯‘æ¨¡å‹
</span><span class="n">model</span><span class="p">.</span><span class="nb">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s">'binary_crossentropy'</span><span class="p">,</span>
              <span class="n">optimizer</span><span class="o">=</span><span class="s">'adam'</span><span class="p">,</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s">'accuracy'</span><span class="p">])</span>
<span class="c1"># è®­ç»ƒæ¨¡å‹
</span><span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                    <span class="n">validation_data</span><span class="o">=</span><span class="n">test_dataset</span><span class="p">)</span>

<span class="c1"># æœ¬è®­ç»ƒè€—æ—¶æ¯”è¾ƒé•¿ï¼Œæ‰€ä»¥è®­ç»ƒå®Œä¿å­˜ä¸€æ¬¡æ•°æ®ï¼Œä»¥ä¾¿ä»¥åæˆ‘ä»¬ä¼šæƒ³å†æ¬¡å°è¯•
</span><span class="n">model</span><span class="p">.</span><span class="n">save_weights</span><span class="p">(</span><span class="s">'./imdb-classify-lstm/final_chkp'</span><span class="p">)</span>

<span class="c1"># æ¢å¤æ•°æ®ï¼Œå¦‚æœä»¥åæƒ³å†æ¬¡æµ‹è¯•å½±è¯„é¢„æµ‹ï¼Œå¯ä»¥å°†ä¸Šé¢è®­ç»ƒã€ä¿å­˜å±è”½èµ·æ¥
# ç„¶åä»è¿™é‡Œå¼€å§‹ä½¿ç”¨
</span><span class="n">model</span><span class="p">.</span><span class="n">load_weights</span><span class="p">(</span><span class="s">'./imdb-classify-lstm/final_chkp'</span><span class="p">)</span>
<span class="c1"># ä½¿ç”¨æµ‹è¯•é›†æ•°æ®è¯„ä¼°æ¨¡å‹ï¼Œå¹¶æ˜¾ç¤ºæŸå¤±å€¼å’Œå‡†ç¡®åº¦
</span><span class="n">test_loss</span><span class="p">,</span> <span class="n">test_acc</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">Test Loss: {}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">test_loss</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s">'Test Accuracy: {}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">test_acc</span><span class="p">))</span>

<span class="c1">#########################################################
# ä»¥ä¸‹ä¸ºä½¿ç”¨æ¨¡å‹å¯¹ä¸€æ®µæ–‡å­—è¿›è¡Œæƒ…ç»ªé¢„æµ‹
</span>
<span class="c1"># å·¥å…·å‡½æ•°ï¼Œå°†ä¸€ä¸ªä¸è¶³æŒ‡å®šé•¿åº¦çš„æ•°ç»„ï¼Œä½¿ç”¨0åœ¨å°¾éƒ¨å¡«å……ï¼Œä»¥å‡‘å¤Ÿé•¿åº¦
# æˆ‘ä»¬ä½¿ç”¨çš„æ¨¡å‹åµŒå…¥å±‚è¾“å…¥åºåˆ—æ²¡æœ‰æŒ‡å®šinput_lengthï¼Œä½†è¿™ä¸ªå‚æ•°æ˜¯æœ‰é»˜è®¤å€¼çš„ï¼Œ
# ç›¸å½“äºå®é™…ä¸Šæ˜¯å®šé•¿çš„ï¼Œè¡¥å……åˆ°åŒåµŒå…¥çŸ©é˜µç›¸åŒç»´åº¦çš„é•¿åº¦ï¼Œå‡†ç¡®ç‡ä¼šæ›´é«˜
# å½“ç„¶å¯¹äºåªæœ‰0ã€1ä¸¤ä¸ªç»“æœçš„åˆ†ç±»æ¥è¯´ï¼Œæ•ˆæœå¹¶ä¸æ˜æ˜¾
</span><span class="k">def</span> <span class="nf">pad_to_size</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
    <span class="n">zeros</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">vec</span><span class="p">))</span>
    <span class="n">vec</span><span class="p">.</span><span class="n">extend</span><span class="p">(</span><span class="n">zeros</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">vec</span>

<span class="c1"># å¯¹ä¸€æ®µæ–‡å­—è¿›è¡Œé¢„æµ‹
</span><span class="k">def</span> <span class="nf">sample_predict</span><span class="p">(</span><span class="n">sentence</span><span class="p">,</span> <span class="n">pad</span><span class="p">):</span>
    <span class="c1"># è¾“å…¥çš„æ–‡å­—ï¼Œé¦–å…ˆè¦ä½¿ç”¨imdbæ•°æ®åº“ç›¸åŒçš„æ•°å­—ã€å•è¯å¯¹ç…§è¡¨è¿›è¡Œç¼–ç 
</span>    <span class="c1"># å¯¹äºè¡¨ä¸­æ²¡æœ‰çš„å•è¯ï¼Œè¿˜ä¼šå»ºç«‹æ–°å¯¹ç…§é¡¹
</span>    <span class="n">tokenized_sample_pred_text</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="n">sentence</span><span class="p">)</span>
    <span class="c1"># è¡¥å……çŸ­çš„æ–‡å­—æ®µåˆ°å®šé•¿
</span>    <span class="k">if</span> <span class="n">pad</span><span class="p">:</span>
        <span class="n">tokenized_sample_pred_text</span> <span class="o">=</span> <span class="n">pad_to_size</span><span class="p">(</span><span class="n">tokenized_sample_pred_text</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
    <span class="c1"># æ‰©å±•ä¸€ç»´ï¼Œä½¿æ•°æ®æˆä¸ºåªæœ‰1ä¸ªæ•°æ®çš„ä¸€ä¸ªæ‰¹æ¬¡
</span>    <span class="n">predictions</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">predict</span><span class="p">(</span><span class="n">tf</span><span class="p">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">tokenized_sample_pred_text</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">predictions</span><span class="p">)</span>

<span class="c1"># é¢„æµ‹1ï¼Œæ–‡å­—å¤§æ„ï¼šç”µå½±ä¸å¥½ï¼ŒåŠ¨ç”»å’Œç”»é¢éƒ½å¾ˆå¯æ€•ï¼Œæˆ‘ä¸ä¼šæ¨èè¿™ä¸ªç”µå½±
</span><span class="n">sample_pred_text</span> <span class="o">=</span> <span class="p">(</span><span class="s">'The movie was not good. The animation and the graphics '</span>
                    <span class="s">'were terrible. I would not recommend this movie.'</span><span class="p">)</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">sample_predict</span><span class="p">(</span><span class="n">sample_pred_text</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>

<span class="c1"># é¢„æµ‹2ï¼Œæ–‡å­—å¤§æ„ï¼šç”µå½±å¾ˆæ— èŠï¼Œæˆ‘ä¸å–œæ¬¢è¿™ä¸ªç”µå½±
</span><span class="n">sample_pred_text</span> <span class="o">=</span> <span class="p">(</span><span class="s">"The movie was boring. I don't like this movie."</span><span class="p">)</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">sample_predict</span><span class="p">(</span><span class="n">sample_pred_text</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>

<span class="c1"># é¢„æµ‹3ï¼Œæ–‡å­—å¤§æ„ï¼šè¿™ä¸ªç”µå½±å¾ˆèµï¼Œé‡Œé¢çš„ä¸€åˆ‡éƒ½å¾ˆç²¾è‡´ï¼Œæˆ‘å–œæ¬¢å®ƒ
</span><span class="n">sample_pred_text</span> <span class="o">=</span> <span class="p">(</span><span class="s">'The movie was great. Everything in this movies '</span>
                    <span class="s">'is delicate, I love it.'</span><span class="p">)</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">sample_predict</span><span class="p">(</span><span class="n">sample_pred_text</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>
</code></pre></div></div>
<p>è¿™ä¸ªæ ·ä¾‹çš„è®­ç»ƒå·²ç»æ¯”è¾ƒæ…¢äº†ï¼Œåœ¨æˆ‘ç”¨çš„ç”µè„‘ä½¿ç”¨å…¥é—¨çº§çš„GPUè¿ç®—è·‘äº†å·®ä¸å¤š20åˆ†é’Ÿã€‚æ‰€ä»¥ç¨‹åºè®­ç»ƒç»“æŸçš„æ—¶å€™ä¿å­˜äº†ä¸€æ¬¡æ¨¡å‹çš„å‚æ•°ï¼Œä»¥ä¾¿ä»¥åæˆ‘ä»¬è¿˜æƒ³å†æµ‹è¯•æ›´å¤šçš„æ–‡æœ¬ã€‚<br />
ç¨‹åºæ‰§è¡Œçš„è¾“å‡ºå¤§è‡´å¦‚ä¸‹:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>./imdb-classify-lstm.py
Vocabulary size: 8185
Epoch 1/10
391/391 <span class="o">[==============================]</span> - 117s 299ms/step - loss: 0.5763 - accuracy: 0.6985 - val_loss: 0.0000e+00 - val_accuracy: 0.0000e+00
Epoch 2/10
391/391 <span class="o">[==============================]</span> - 114s 292ms/step - loss: 0.4639 - accuracy: 0.7876 - val_loss: 0.5006 - val_accuracy: 0.7731
Epoch 3/10
391/391 <span class="o">[==============================]</span> - 115s 295ms/step - loss: 0.3296 - accuracy: 0.8680 - val_loss: 0.3920 - val_accuracy: 0.8344
Epoch 4/10
391/391 <span class="o">[==============================]</span> - 115s 295ms/step - loss: 0.2674 - accuracy: 0.8977 - val_loss: 0.3640 - val_accuracy: 0.8597
Epoch 5/10
391/391 <span class="o">[==============================]</span> - 115s 295ms/step - loss: 0.2168 - accuracy: 0.9218 - val_loss: 0.3190 - val_accuracy: 0.8698
Epoch 6/10
391/391 <span class="o">[==============================]</span> - 115s 294ms/step - loss: 0.1717 - accuracy: 0.9423 - val_loss: 0.3201 - val_accuracy: 0.8754
Epoch 7/10
391/391 <span class="o">[==============================]</span> - 114s 293ms/step - loss: 0.1339 - accuracy: 0.9573 - val_loss: 0.3470 - val_accuracy: 0.8678
Epoch 8/10
391/391 <span class="o">[==============================]</span> - 115s 294ms/step - loss: 0.1044 - accuracy: 0.9693 - val_loss: 0.4094 - val_accuracy: 0.8569
Epoch 9/10
391/391 <span class="o">[==============================]</span> - 116s 296ms/step - loss: 0.0826 - accuracy: 0.9771 - val_loss: 0.4496 - val_accuracy: 0.8704
Epoch 10/10
391/391 <span class="o">[==============================]</span> - 115s 295ms/step - loss: 0.0671 - accuracy: 0.9820 - val_loss: 0.4516 - val_accuracy: 0.8696
    391/Unknown - 37s 95ms/step - loss: 0.4516 - accuracy: 0.8696
Test Loss: 0.45155299115745
Test Accuracy: 0.8695999979972839
<span class="o">[[</span>0.00420592]]
<span class="o">[[</span>0.00562131]]
<span class="o">[[</span>0.99653375]]

</code></pre></div></div>
<p>æœ€ç»ˆçš„ç»“æœï¼Œå‰ä¸¤ä¸ªå€¼å¾ˆæ¥è¿‘0ï¼Œè¡¨ç¤ºè¿™ä¸¤å¥å½±è¯„å€¾å‘äºæ‰¹è¯„æ„è§ã€‚ç¬¬ä¸‰ä¸ªå€¼æ¥è¿‘1ï¼Œè¡¨ç¤ºè¿™æ¡å½±è¯„æ˜¯æ­£é¢æ„è§ã€‚æ³¨æ„è¿™ä¸‰æ¡å½±è¯„éƒ½æ˜¯æˆ‘ä»¬å³å…´éšæ„å†™å‡ºçš„ï¼Œå¹¶éæ ·æœ¬åº“ä¸­çš„æ•°æ®ï¼Œæ˜¯çœŸæ­£çš„â€œè‡ªç„¶è¯­è¨€â€ã€‚</p>

<p>ï¼ˆå¾…ç»­â€¦ï¼‰</p>

:ET