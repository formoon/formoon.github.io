I"¯<p><img src="/attachments/201904/tensorFlow2/tf-logo-card-2.png" alt="" /></p>
<h4 id="é£æ ¼è¿ç§»">é£æ ¼è¿ç§»</h4>
<p><a href="http://blog.17study.com.cn/2018/01/15/tensorFlow-series-8/">ã€Šä»é”…ç‚‰å·¥åˆ°AIä¸“å®¶(8)ã€‹</a>ä¸­æˆ‘ä»¬ä»‹ç»äº†ä¸€ä¸ªâ€œå›¾ç‰‡é£æ ¼è¿ç§»â€çš„ä¾‹å­ã€‚å› ä¸ºæ‰€å¼•ç”¨çš„ä½œå“ä¸­ä½¿ç”¨äº†TensorFlow 1.xçš„ä»£ç ï¼Œç®—æ³•ä¹Ÿç›¸å¯¹å¤æ‚ï¼Œæ‰€ä»¥æ–‡ä¸­æ²¡æœ‰ä»”ç»†ä»‹ç»é£æ ¼è¿ç§»çš„åŸç†ã€‚<br />
ä»Šå¤©åœ¨TensorFlow 2.0çš„å¸®åŠ©ï¼Œå’Œæ–°ç®—æ³•æ€æƒ³çš„ä¼˜åŒ–ä¸‹ï¼Œå®ç°åŒæ ·åŠŸèƒ½çš„ä»£ç é‡å¤§å¹…å‡å°‘ï¼Œç»“æ„ä¹Ÿè¶Šå‘æ¸…æ™°ã€‚æ‰€ä»¥ä»Šå¤©å°±æ¥è®²è®²è¿™ä¸ªè¯é¢˜ã€‚</p>

<p>â€œé£æ ¼è¿ç§»â€æŒ‡çš„æ˜¯å°†è‰ºæœ¯ä½œå“çš„ç¬”è§¦ã€æŠ€æ³•ç­‰è¡¨ç°å‡ºæ¥çš„è§†è§‰æ•ˆæœï¼Œåº”ç”¨åœ¨æ™®é€šç…§ç‰‡ä¸Šï¼Œä½¿å¾—æ‰€ç”Ÿæˆçš„å›¾ç‰‡ï¼Œç±»ä¼¼ä½¿ç”¨åŒæ ·ç¬”è§¦ã€æŠ€æ³•æ‰€ç»˜åˆ¶å®Œæˆï¼Œä½†å†…å®¹è·Ÿç…§ç‰‡ç›¸åŒçš„â€œä¼ªç”»ä½œâ€ã€‚<br />
åœ¨ç¥ç»ç½‘ç»œæœºå™¨å­¦ä¹ çš„å¸®åŠ©ä¸‹ï¼Œç”Ÿæˆå›¾ç‰‡çš„è§‚èµæ€§éå¸¸é«˜ï¼Œè¿œéæ—©æœŸä¼ ç»Ÿæ–¹æ³•å¾—åˆ°çš„å›¾ç‰‡å¯æ¯”ã€‚<br />
è¿™é‡Œé‡è´´ä¸€éå‰æ–‡ä¸­çš„ä¾‹å›¾ï¼Œè®©æˆ‘ä»¬æœ‰ä¸€ä¸ªæ›´ç›´è§‚çš„æ„Ÿå—ã€‚<br />
é¦–å…ˆæ˜¯ä¸€å¼ åŸç¨‹åºä½œè€…çš„çš„è‡ªæ‹ç…§ï¼š<br />
<img src="https://raw.githubusercontent.com/anishathalye/neural-style/master/examples/1-content.jpg" alt="" />
æ¥ç€ä¸é™Œç”Ÿï¼Œè‘—åå¤§ä½œã€Šæ˜Ÿç©ºã€‹ï¼š<br />
<img src="https://raw.githubusercontent.com/anishathalye/neural-style/master/examples/1-style.jpg" alt="" /><br />
ï¼ˆè¯·å°†ä»¥ä¸Šä¸¤å›¾ä¿å­˜è‡³å·¥ä½œç›®å½•ï¼Œä¸è¦ä¿®æ”¹æ–‡ä»¶åï¼Œæˆ‘ä»¬ç¨æ™šçš„ä»£ç ä¸­ä¼šç”¨åˆ°ã€‚ï¼‰<br />
ä¸¤å¼ å›¾ç‰‡ç»è¿‡ç¨‹åºå¤„ç†åï¼Œä¼šå¾—åˆ°ä¸€å¹…æ–°çš„å›¾ç‰‡ï¼š<br />
<img src="https://raw.githubusercontent.com/anishathalye/neural-style/master/examples/1-output.jpg" alt="" /><br />
å³ä½¿ç”¨ã€Šæ˜Ÿç©ºã€‹é£æ ¼æ¨¡ä»¿çš„æ‰‹ç»˜ä½œå“ã€Šé»„ç²±ä¸€æ¢¦ã€‹:)</p>
<h4 id="åŸºæœ¬åŸç†">åŸºæœ¬åŸç†</h4>
<p>é£æ ¼è¿ç§»åŸç†åŸºäºè®ºæ–‡<a href="https://arxiv.org/abs/1508.06576">ã€ŠA Neural Algorithm of Artistic Styleã€‹</a>ã€‚<br />
è™½ç„¶è®ºæ–‡ä¸­å¹¶æ²¡æœ‰æ˜è¯´ï¼Œä½†é‡‡ç”¨å·ç§¯ç¥ç»ç½‘ç»œåšå›¾åƒçš„é£æ ¼è¿ç§»åº”å½“å±äºä¸€ä¸ªå®éªŒç§‘å­¦çš„æˆæœè€Œéå•çº¯çš„ç†è®ºç ”ç©¶ã€‚<br />
æˆ‘ä»¬å†å¼•ç”¨ä¸€å¼ å‰ç³»åˆ—è®²è§£CNNæ—¶å€™çš„å›¾ç‰‡ï¼š<br />
<img src="/attachments/201801/ml-nn/cnn1.png" alt="" /><br />
ä¸€å¼ å›¾ç‰‡æ•°æ®æ‰€å½¢æˆçš„çŸ©é˜µï¼Œåœ¨ç»è¿‡å·ç§¯ç½‘ç»œçš„æ—¶å€™ï¼Œå›¾åƒä¸­è¾¹ç¼˜ç­‰è§†è§‰ç‰¹å¾ä¼šè¢«æ”¾å¤§ã€å¼ºåŒ–ï¼Œä»è€Œå½¢æˆä¸€ç§ç‰¹æ®Šçš„è¾“å‡ºã€‚é€šå¸¸æˆ‘ä»¬åªå…³å¿ƒæ•°æ®ç»“æœï¼Œå¹¶æ²¡æœ‰æŠŠè¿™äº›æ•°æ®è¿˜åŸä¸ºå›¾ç‰‡æ¥è§‚å¯Ÿã€‚è€Œè®ºæ–‡ä½œè€…ä¸ä»…è¿™æ ·åšäº†ï¼Œææ€•è¿˜è¿›è¡Œäº†å¤§é‡çš„å®éªŒã€‚<br />
è¿™äº›ç¥ç»ç½‘ç»œä¸­é—´ç»“æœå›¾ç‰‡å…·æœ‰å¦‚æ­¤å…¸å‹çš„ç‰¹å¾ï¼Œå¯ä»¥è„±ç¦»å‡ºä¸»é¢˜å†…å®¹è€Œæˆä¸ºå•çº¯é£æ ¼çš„æè¿°ã€‚è¢«æ•é”çš„ä½œè€…æŠ“ä½æ·±å…¥ç ”ç©¶ä¹Ÿå°±ä¸å¥‡æ€ªäº†ã€‚<br />
<img src="/attachments/201904/tensorFlow2/nst-cnn1.jpg" alt="" />
æœ€ç»ˆç ”ç©¶æˆæœç¡®ç«‹äº†å·ç§¯ç¥ç»ç½‘ç»œè¿›è¡Œå›¾ç‰‡è¿ç§»çš„ä¸¤å¤§åŸºç¡€ç®—æ³•ï¼š</p>
<ul>
  <li>åœ¨ç¥ç»ç½‘ç»œä¸­ï¼Œç¡®å®šçš„æŠ½å–æŸäº›å±‚ä»£è¡¨å†…å®¹çš„æ•°å­—æè¿°ï¼Œä»¥åŠå¦å¤–ä¸€äº›å±‚ä»£è¡¨é£æ ¼çš„æ•°å­—æè¿°ã€‚</li>
  <li>å¤šä¸ªå±‚çš„è¾“å‡ºæ•°æ®ï¼Œé€šè¿‡å…¬å¼çš„è®¡ç®—ï¼Œæ‹Ÿåˆåˆ°åŒè¾“å…¥å›¾åƒç›¸åŒçš„è‰²åŸŸç©ºé—´ã€‚è¿™ä¸ªå…¬å¼å³èƒ½ç”¨äºä»£ä»·å‡½æ•°ä¸­åŸå§‹é£æ ¼åŒç›®æ ‡é£æ ¼ä¹‹é—´çš„å¯¹æ¯”ï¼Œä¹Ÿå¯ä»¥å˜å½¢åé€šè¿‡ç»„åˆå¤šä¸ªé£æ ¼å±‚ï¼Œç”Ÿæˆæ–°çš„ç›®æ ‡å›¾ç‰‡ã€‚</li>
</ul>

<p>æœ¬ç³»åˆ—æ–‡ç« éƒ½æ˜¯å°½åŠ›ä¸å‡ºç°æ•°å­¦å…¬å¼ï¼Œç”¨ä»£ç è®²åŸç†ã€‚<br />
åœ¨ã€Šä»é”…ç‚‰å·¥åˆ°AIä¸“å®¶(8)ã€‹å¼•ç”¨çš„ä»£ç ä¸­ï¼Œé™¤äº†æ„å»ºç¥ç»ç½‘ç»œã€è®­ç»ƒï¼Œä¸»è¦å·¥ä½œæ˜¯åœ¨æŸå¤±å‡½æ•°é™ä½åˆ°æ»¡æ„ç¨‹åº¦ä¹‹åï¼Œä½¿ç”¨ç½‘ç»œä¸­é—´å±‚çš„è¾“å‡ºç»“æœè®¡ç®—ã€ç»„åˆæˆç›®æ ‡å›¾ç‰‡ã€‚åŸæ–‡ä¸­å¯¹è¿™éƒ¨åˆ†çš„æµç¨‹ä¹Ÿåšäº†ç®€ä»‹ã€‚<br />
æ–°çš„ä»£ç æ¥è‡ªTensorFlowå®˜æ–¹æ–‡æ¡£ã€‚é™¤äº†ç¨‹åºå‡çº§ä¸ºTensorFlow 2.0åŸç”Ÿä»£ç ã€‚åœ¨å›¾ç‰‡çš„äº§ç”Ÿä¸Šä¹Ÿåšäº†å¤§å¹…åˆ›æ–°ï¼šä½¿ç”¨ç…§ç‰‡å›¾ç‰‡è®­ç»ƒç¥ç»ç½‘ç»œï¼Œæ¯ä¸€é˜¶æ¢¯çš„è®­ç»ƒç»“æœï¼Œä¸åº”ç”¨å›ç¥ç»ç½‘ç»œï¼ˆç½‘ç»œçš„æƒé‡å‚æ•°ä¸€ç›´å›ºå®šé”æ­»çš„ï¼‰ï¼Œè€ŒæŠŠè®­ç»ƒç»“æœåº”ç”¨åˆ°å›¾ç‰‡æœ¬èº«ã€‚åœ¨ä¸‹ä¸€æ¬¡çš„è®­ç»ƒå¾ªç¯ä¸­ï¼Œä½¿ç”¨æ–°çš„å›¾ç‰‡å†æ¬¡è®¡ç®—æŸå¤±å€¼ã€‚è¿™æ ·ï¼Œå½“æŸå¤±å€¼æœ€å°çš„æ—¶å€™ï¼Œè®­ç»ƒå›¾ç‰‡æœ¬èº«å°±å·²ç»æ˜¯ç¬¦åˆæˆ‘ä»¬è¦æ±‚çš„ç”Ÿæˆå›¾ç‰‡ã€‚å½“ç„¶æœ¬è´¨ä¸Šï¼Œè·Ÿå‰ä¸€ç§æ–¹æ³•ä¸€æ ·çš„ã€‚ä½†æ„Ÿè§‰ä¸Šï¼Œç»“æ„æ¸…æ™°äº†å¾ˆå¤šã€‚è¿™ä¸ªè¿‡ç¨‹å¯¹æ¯”èµ·æ¥ï¼Œå¤§é‡èŠ‚çœäº†å›¾ç‰‡ç”Ÿæˆçš„è®¡ç®—ã€‚å½“ç„¶ï¼Œä¸»è¦åŸå› è¿˜æ˜¯TensorFlow 2.0å†…ç½®çš„tf.linalg.einsumæ–¹æ³•å¼ºå¤§å¥½ç”¨ã€‚</p>

<p>åœ¨ç‰¹å¾å±‚çš„å®šä¹‰ä¸Šï¼Œç…§ç‰‡å†…å®¹çš„æè¿°ä½¿ç”¨vgg-19ç½‘ç»œçš„ç¬¬5éƒ¨åˆ†çš„ç¬¬2å±‚å·ç§¯è¾“å‡ºç»“æœã€‚è‰ºæœ¯å›¾ç‰‡é£æ ¼ç‰¹å¾çš„æè¿°ä½¿ç”¨äº†5ä¸ªå±‚ï¼Œåˆ†åˆ«æ˜¯vgg-19ç½‘ç»œçš„ç¬¬1è‡³ç¬¬5éƒ¨åˆ†ç¬¬1ä¸ªç½‘ç»œå±‚çš„è¾“å‡ºç»“æœã€‚åœ¨ç¨‹åºä¸­ï¼Œå¯ä»¥è¿™æ ·æè¿°ï¼š</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># å®šä¹‰æœ€èƒ½ä»£è¡¨å†…å®¹ç‰¹å¾çš„ç½‘ç»œå±‚
</span><span class="n">content_layers</span> <span class="o">=</span> <span class="p">[</span><span class="s">'block5_conv2'</span><span class="p">]</span> 

<span class="c1"># å®šä¹‰æœ€èƒ½ä»£è¡¨é£æ ¼ç‰¹å¾çš„ç½‘ç»œå±‚
</span><span class="n">style_layers</span> <span class="o">=</span> <span class="p">[</span><span class="s">'block1_conv1'</span><span class="p">,</span>
                <span class="s">'block2_conv1'</span><span class="p">,</span>
                <span class="s">'block3_conv1'</span><span class="p">,</span> 
                <span class="s">'block4_conv1'</span><span class="p">,</span> 
                <span class="s">'block5_conv1'</span><span class="p">]</span>
</code></pre></div></div>
<p>ç½‘ç»œå±‚çš„åç§°æ¥è‡ªäºvgg-19ç½‘ç»œå®šä¹‰å®Œæˆåï¼Œå„å±‚çš„åç§°ã€‚å¯ä»¥ä½¿ç”¨å¦‚ä¸‹ä»£ç å¾—åˆ°æ‰€æœ‰å±‚çš„åç§°ï¼š</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="p">...</span>
<span class="c1"># å»ºç«‹æ— éœ€åˆ†ç±»ç»“æœçš„vggç½‘ç»œ
</span><span class="n">vgg</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">applications</span><span class="p">.</span><span class="n">VGG19</span><span class="p">(</span><span class="n">include_top</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="s">'imagenet'</span><span class="p">)</span>

<span class="c1"># æ˜¾ç¤ºvggä¸­æ‰€æœ‰å±‚çš„åç§°
</span><span class="k">print</span><span class="p">()</span>
<span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">vgg</span><span class="p">.</span><span class="n">layers</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">layer</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
    <span class="p">...</span>
</code></pre></div></div>

<p>é€šå¸¸çš„æ¨¡å‹è®­ç»ƒï¼Œéƒ½æ˜¯ä½¿ç”¨ä»£ä»·å‡½æ•°æ¯”è¾ƒç½‘ç»œè¾“å‡ºç»“æœï¼Œå’Œç›®æ ‡æ ‡æ³¨å€¼çš„å·®å¼‚ï¼Œä½¿å¾—å·®å¼‚é€æ¸ç¼©å°ã€‚<br />
æœ¬ä¾‹çš„è®­ç»ƒç›®æ ‡æ¯”è¾ƒå¤æ‚ï¼Œå¯ä»¥æè¿°ä¸ºä¸¤æ¡ï¼š</p>
<ul>
  <li>ç”Ÿæˆå›¾ç‰‡çš„é£æ ¼å±‚è¾“å‡ºï¼ŒåŒè‰ºæœ¯å›¾ç‰‡çš„é£æ ¼å±‚è¾“å‡ºå·®å¼‚æœ€å°</li>
  <li>ç”Ÿæˆå›¾ç‰‡çš„å†…å®¹å±‚è¾“å‡ºï¼ŒåŒåŸå§‹ç…§ç‰‡çš„å†…å®¹å±‚è¾“å‡ºå·®å¼‚æœ€å°</li>
</ul>

<p>è™½ç„¶è¿™ä¸ªä»£ä»·å‡½æ•°ç•¥å¾®å¤æ‚ï¼Œä¸è¿‡æ¯”VAEçš„ä»£ä»·å‡½æ•°è¿˜æ˜¯ç®€å•å¤šäº†:)</p>

<h4 id="æºä»£ç ">æºä»£ç </h4>
<p>ç¨‹åºä¸­çš„æ³¨é‡Šéå¸¸è¯¦ç»†ã€‚è·Ÿä»¥å‰çš„ç¨‹åºæœ‰ä¸€ç‚¹åŒºåˆ«ï¼Œå°±æ˜¯ç›´æ¥ä½¿ç”¨TensorFlowå†…ç½®æ–¹æ³•è¯»å–äº†å›¾ç‰‡æ–‡ä»¶ï¼Œç„¶åè°ƒç”¨jpgè§£ç è¿˜åŸä¸ºçŸ©é˜µã€‚<br />
ä¸è¿‡TensorFlowå†…ç½®çš„å°†å›¾åƒ0-255æ•´æ•°å€¼è½¬æ¢ä¸ºæµ®ç‚¹æ•°çš„è¿‡ç¨‹ï¼Œä¼šè‡ªåŠ¨å°†æ•°å€¼å˜ä¸º0-1çš„æµ®ç‚¹å°æ•°ã€‚<br />
è¿™ä¸ªè¿‡ç¨‹å…¶å®å¯¹æˆ‘ä»¬å¤šæ­¤ä¸€ä¸¾ï¼Œå› ä¸ºæˆ‘ä»¬åç»­çš„å¾ˆå¤šè®¡ç®—éƒ½éœ€è¦è½¬æ¢å›0-255ã€‚</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">unicode_literals</span>

<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="n">tf</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="n">mpl</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>

<span class="c1"># è®¾ç½®ç»˜å›¾çª—å£å‚æ•°ï¼Œç”¨äºå›¾ç‰‡æ˜¾ç¤º
</span><span class="n">mpl</span><span class="p">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s">'figure.figsize'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">mpl</span><span class="p">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s">'axes.grid'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>

<span class="c1"># è·å–ä¸‹è½½åæœ¬åœ°å›¾ç‰‡çš„è·¯å¾„ï¼Œcontent_pathæ˜¯çœŸå®ç…§ç‰‡ï¼Œstyle_pathæ˜¯è‰ºæœ¯å“é£æ ¼å›¾ç‰‡
</span><span class="n">content_path</span> <span class="o">=</span> <span class="s">"1-content.jpg"</span>
<span class="n">style_path</span> <span class="o">=</span> <span class="s">"1-style.jpg"</span>

<span class="c1"># è¯»å–ä¸€å¼ å›¾ç‰‡ï¼Œå¹¶åšé¢„å¤„ç†
</span><span class="k">def</span> <span class="nf">load_img</span><span class="p">(</span><span class="n">path_to_img</span><span class="p">):</span>
    <span class="n">max_dim</span> <span class="o">=</span> <span class="mi">512</span>
    <span class="c1"># è¯»å–äºŒè¿›åˆ¶æ–‡ä»¶
</span>    <span class="n">img</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">path_to_img</span><span class="p">)</span>
    <span class="c1"># åšJPEGè§£ç ï¼Œè¿™æ—¶å€™å¾—åˆ°å®½xé«˜xè‰²æ·±çŸ©é˜µï¼Œæ•°å­—0-255
</span>    <span class="n">img</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">image</span><span class="p">.</span><span class="n">decode_jpeg</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="c1"># ç±»å‹ä»intè½¬æ¢åˆ°32ä½æµ®ç‚¹ï¼Œæ•°å€¼èŒƒå›´0-1
</span>    <span class="n">img</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">image</span><span class="p">.</span><span class="n">convert_image_dtype</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">tf</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="c1"># å‡æ‰æœ€åè‰²æ·±ä¸€ç»´ï¼Œè·å–åˆ°çš„ç›¸å½“äºå›¾ç‰‡å°ºå¯¸ï¼ˆæ•´æ•°ï¼‰ï¼Œè½¬ä¸ºæµ®ç‚¹
</span>    <span class="n">shape</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">cast</span><span class="p">(</span><span class="n">tf</span><span class="p">.</span><span class="n">shape</span><span class="p">(</span><span class="n">img</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">tf</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="c1"># è·å–å›¾ç‰‡é•¿ç«¯
</span>    <span class="nb">long</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
    <span class="c1"># ä»¥é•¿ç«¯ä¸ºæ¯”ä¾‹ç¼©æ”¾ï¼Œè®©å›¾ç‰‡æˆä¸º512x???
</span>    <span class="n">scale</span> <span class="o">=</span> <span class="n">max_dim</span><span class="o">/</span><span class="nb">long</span>
    <span class="n">new_shape</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">cast</span><span class="p">(</span><span class="n">shape</span><span class="o">*</span><span class="n">scale</span><span class="p">,</span> <span class="n">tf</span><span class="p">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="c1"># å®é™…ç¼©æ”¾å›¾ç‰‡
</span>    <span class="n">img</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">image</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">new_shape</span><span class="p">)</span>
    <span class="c1"># å†æ‰©å±•ä¸€ç»´ï¼Œæˆä¸ºå›¾ç‰‡æ•°å­—ä¸­çš„ä¸€å¼ å›¾ç‰‡ï¼ˆ1ï¼Œé•¿ï¼Œå®½ï¼Œè‰²æ·±ï¼‰
</span>    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">tf</span><span class="p">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
    <span class="k">return</span> <span class="n">img</span>

<span class="c1"># è¯»å…¥ä¸¤å¼ å›¾ç‰‡
</span><span class="n">content_image</span> <span class="o">=</span> <span class="n">load_img</span><span class="p">(</span><span class="n">content_path</span><span class="p">)</span>
<span class="n">style_image</span> <span class="o">=</span> <span class="n">load_img</span><span class="p">(</span><span class="n">style_path</span><span class="p">)</span>

<span class="c1">############################################################
# å®šä¹‰æœ€èƒ½ä»£è¡¨å†…å®¹ç‰¹å¾çš„ç½‘ç»œå±‚
</span><span class="n">content_layers</span> <span class="o">=</span> <span class="p">[</span><span class="s">'block5_conv2'</span><span class="p">]</span> 

<span class="c1"># å®šä¹‰æœ€èƒ½ä»£è¡¨é£æ ¼ç‰¹å¾çš„ç½‘ç»œå±‚
</span><span class="n">style_layers</span> <span class="o">=</span> <span class="p">[</span><span class="s">'block1_conv1'</span><span class="p">,</span>
                <span class="s">'block2_conv1'</span><span class="p">,</span>
                <span class="s">'block3_conv1'</span><span class="p">,</span> 
                <span class="s">'block4_conv1'</span><span class="p">,</span> 
                <span class="s">'block5_conv1'</span><span class="p">]</span>
<span class="c1"># ç¥ç»ç½‘ç»œå±‚çš„æ•°é‡
</span><span class="n">num_content_layers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">content_layers</span><span class="p">)</span>
<span class="n">num_style_layers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">style_layers</span><span class="p">)</span>

<span class="c1"># å®šä¹‰ä¸€ä¸ªå·¥å…·å‡½æ•°ï¼Œå¸®åŠ©å»ºç«‹å¾—åˆ°ç‰¹å®šä¸­é—´å±‚è¾“å‡ºç»“æœçš„æ–°æ¨¡å‹
</span><span class="k">def</span> <span class="nf">vgg_layers</span><span class="p">(</span><span class="n">layer_names</span><span class="p">):</span>
    <span class="s">""" Creates a vgg model that returns a list of intermediate output values."""</span>
    <span class="c1"># å®šä¹‰ä½¿ç”¨ImageNetæ•°æ®è®­ç»ƒçš„vgg19ç½‘ç»œ
</span>    <span class="n">vgg</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">applications</span><span class="p">.</span><span class="n">VGG19</span><span class="p">(</span><span class="n">include_top</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="s">'imagenet'</span><span class="p">)</span>
    <span class="c1"># å·²ç»ç»è¿‡äº†è®­ç»ƒï¼Œæ‰€ä»¥é”å®šå„é¡¹å‚æ•°é¿å…å†æ¬¡è®­ç»ƒ
</span>    <span class="n">vgg</span><span class="p">.</span><span class="n">trainable</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="c1"># è·å–æ‰€éœ€å±‚çš„è¾“å‡ºç»“æœ
</span>    <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">vgg</span><span class="p">.</span><span class="n">get_layer</span><span class="p">(</span><span class="n">name</span><span class="p">).</span><span class="n">output</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">layer_names</span><span class="p">]</span>
    <span class="c1"># æœ€ç»ˆè¿”å›ç»“æœæ˜¯ä¸€ä¸ªæ¨¡å‹ï¼Œè¾“å…¥æ˜¯å›¾ç‰‡ï¼Œè¾“å‡ºä¸ºæ‰€éœ€çš„ä¸­é—´å±‚è¾“å‡º
</span>    <span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">Model</span><span class="p">([</span><span class="n">vgg</span><span class="p">.</span><span class="nb">input</span><span class="p">],</span> <span class="n">outputs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span>

<span class="c1"># å®šä¹‰å‡½æ•°è®¡ç®—é£æ ¼çŸ©é˜µï¼Œè¿™å®é™…æ˜¯ç”±æŠ½å–å‡ºæ¥çš„5ä¸ªç½‘ç»œå±‚çš„è¾“å‡ºè®¡ç®—å¾—æ¥çš„
</span><span class="k">def</span> <span class="nf">gram_matrix</span><span class="p">(</span><span class="n">input_tensor</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">linalg</span><span class="p">.</span><span class="n">einsum</span><span class="p">(</span><span class="s">'bijc,bijd-&gt;bcd'</span><span class="p">,</span> <span class="n">input_tensor</span><span class="p">,</span> <span class="n">input_tensor</span><span class="p">)</span>
    <span class="n">input_shape</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">shape</span><span class="p">(</span><span class="n">input_tensor</span><span class="p">)</span>
    <span class="n">num_locations</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">cast</span><span class="p">(</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">tf</span><span class="p">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span><span class="o">/</span><span class="p">(</span><span class="n">num_locations</span><span class="p">)</span>

<span class="c1"># è‡ªå®šä¹‰kerasæ¨¡å‹
</span><span class="k">class</span> <span class="nc">StyleContentModel</span><span class="p">(</span><span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">models</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">style_layers</span><span class="p">,</span> <span class="n">content_layers</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">StyleContentModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">).</span><span class="n">__init__</span><span class="p">()</span>
        <span class="c1"># è‡ªå·±çš„vggæ¨¡å‹ï¼ŒåŒ…å«ä¸Šé¢æ‰€åˆ—çš„é£æ ¼æŠ½å–å±‚å’Œå†…å®¹æŠ½å–å±‚
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">vgg</span> <span class="o">=</span> <span class="n">vgg_layers</span><span class="p">(</span><span class="n">style_layers</span> <span class="o">+</span> <span class="n">content_layers</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">style_layers</span> <span class="o">=</span> <span class="n">style_layers</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">content_layers</span> <span class="o">=</span> <span class="n">content_layers</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">num_style_layers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">style_layers</span><span class="p">)</span>
        <span class="c1"># vggå„å±‚å‚æ•°é”å®šä¸å†å‚æ•°è®­ç»ƒ
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">vgg</span><span class="p">.</span><span class="n">trainable</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
        <span class="c1"># è¾“å…¥çš„å›¾ç‰‡æ˜¯0-1èŒƒå›´æµ®ç‚¹ï¼Œè½¬æ¢åˆ°0-255ä»¥ç¬¦åˆvggè¦æ±‚
</span>        <span class="nb">input</span> <span class="o">=</span> <span class="nb">input</span><span class="o">*</span><span class="mf">255.0</span>
        <span class="c1"># å¯¹è¾“å…¥å›¾ç‰‡æ•°æ®åšé¢„å¤„ç†
</span>        <span class="n">preprocessed_input</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">applications</span><span class="p">.</span><span class="n">vgg19</span><span class="p">.</span><span class="n">preprocess_input</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
        <span class="c1"># è·å–é£æ ¼å±‚å’Œå†…å®¹å±‚è¾“å‡º
</span>        <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">vgg</span><span class="p">(</span><span class="n">preprocessed_input</span><span class="p">)</span>
        <span class="c1"># è¾“å‡ºå®é™…æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ‹†åˆ†ä¸ºé£æ ¼è¾“å‡ºå’Œå†…å®¹è¾“å‡º
</span>        <span class="n">style_outputs</span><span class="p">,</span> <span class="n">content_outputs</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">outputs</span><span class="p">[:</span><span class="bp">self</span><span class="p">.</span><span class="n">num_style_layers</span><span class="p">],</span>
                <span class="n">outputs</span><span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">num_style_layers</span><span class="p">:])</span>
        <span class="c1"># è®¡ç®—é£æ ¼çŸ©é˜µ
</span>        <span class="n">style_outputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">gram_matrix</span><span class="p">(</span><span class="n">style_output</span><span class="p">)</span>
                         <span class="k">for</span> <span class="n">style_output</span> <span class="ow">in</span> <span class="n">style_outputs</span><span class="p">]</span>

        <span class="c1"># è½¬æ¢ä¸ºå­—å…¸
</span>        <span class="n">content_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">content_name</span><span class="p">:</span> <span class="n">value</span>
                        <span class="k">for</span> <span class="n">content_name</span><span class="p">,</span> <span class="n">value</span>
                        <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">content_layers</span><span class="p">,</span> <span class="n">content_outputs</span><span class="p">)}</span>
        <span class="c1"># è½¬æ¢ä¸ºå­—å…¸
</span>        <span class="n">style_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">style_name</span><span class="p">:</span> <span class="n">value</span>
                      <span class="k">for</span> <span class="n">style_name</span><span class="p">,</span> <span class="n">value</span>
                      <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">style_layers</span><span class="p">,</span> <span class="n">style_outputs</span><span class="p">)}</span>
        <span class="c1"># è¿”å›å†…å®¹å’Œé£æ ¼ç»“æœ
</span>        <span class="k">return</span> <span class="p">{</span><span class="s">'content'</span><span class="p">:</span> <span class="n">content_dict</span><span class="p">,</span> <span class="s">'style'</span><span class="p">:</span> <span class="n">style_dict</span><span class="p">}</span>

<span class="c1"># ä½¿ç”¨è‡ªå®šä¹‰æ¨¡å‹å»ºç«‹ä¸€ä¸ªæŠ½å–å™¨
</span><span class="n">extractor</span> <span class="o">=</span> <span class="n">StyleContentModel</span><span class="p">(</span><span class="n">style_layers</span><span class="p">,</span> <span class="n">content_layers</span><span class="p">)</span>

<span class="c1"># è®¾å®šé£æ ¼ç‰¹å¾çš„ç›®æ ‡ï¼Œå³æœ€ç»ˆç”Ÿæˆçš„å›¾ç‰‡ï¼Œå¸Œæœ›é£æ ¼ä¸Šå°½é‡æ¥è¿‘é£æ ¼å›¾ç‰‡
</span><span class="n">style_targets</span> <span class="o">=</span> <span class="n">extractor</span><span class="p">(</span><span class="n">style_image</span><span class="p">)[</span><span class="s">'style'</span><span class="p">]</span>
<span class="c1"># è®¾å®šå†…å®¹ç‰¹å¾çš„ç›®æ ‡ï¼Œå³æœ€ç»ˆç”Ÿæˆçš„å›¾ç‰‡ï¼Œå¸Œæœ›å†…å®¹ä¸Šå°½é‡æ¥è¿‘å†…å®¹å›¾ç‰‡
</span><span class="n">content_targets</span> <span class="o">=</span> <span class="n">extractor</span><span class="p">(</span><span class="n">content_image</span><span class="p">)[</span><span class="s">'content'</span><span class="p">]</span>

<span class="c1"># å†…å®¹å›¾ç‰‡è½¬æ¢ä¸ºå¼ é‡
</span><span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">content_image</span><span class="p">)</span>

<span class="c1"># æˆªå–0-1çš„æµ®ç‚¹æ•°ï¼Œè¶…èŒƒå›´éƒ¨åˆ†è¢«æˆªå–
</span><span class="k">def</span> <span class="nf">clip_0_1</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">tf</span><span class="p">.</span><span class="n">clip_by_value</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">clip_value_min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">clip_value_max</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

<span class="c1"># ä¼˜åŒ–å™¨
</span><span class="n">opt</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">optimizers</span><span class="p">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">beta_1</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-1</span><span class="p">)</span>
<span class="c1"># é¢„å®šä¹‰é£æ ¼å’Œå†…å®¹åœ¨æœ€ç»ˆç»“æœä¸­çš„æƒé‡å€¼ï¼Œç”¨äºåœ¨æŸå¤±å‡½æ•°ä¸­è®¡ç®—æ€»æŸå¤±å€¼
</span><span class="n">style_weight</span> <span class="o">=</span> <span class="mf">1e-2</span>
<span class="n">content_weight</span> <span class="o">=</span> <span class="mf">1e4</span>

<span class="c1"># æŸå¤±å‡½æ•°
</span><span class="k">def</span> <span class="nf">style_content_loss</span><span class="p">(</span><span class="n">outputs</span><span class="p">):</span>
    <span class="n">style_outputs</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s">'style'</span><span class="p">]</span>
    <span class="n">content_outputs</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s">'content'</span><span class="p">]</span>
    <span class="c1"># é£æ ¼æŸå¤±å€¼ï¼Œå°±æ˜¯è®¡ç®—æ–¹å·®
</span>    <span class="n">style_loss</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">add_n</span><span class="p">([</span><span class="n">tf</span><span class="p">.</span><span class="n">reduce_mean</span><span class="p">((</span><span class="n">style_outputs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">-</span><span class="n">style_targets</span><span class="p">[</span><span class="n">name</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> 
                           <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">style_outputs</span><span class="p">.</span><span class="n">keys</span><span class="p">()])</span>
    <span class="c1"># æƒé‡å€¼å¹³å‡åˆ°æ¯å±‚ï¼Œè®¡ç®—æ€»ä½“é£æ ¼æŸå¤±å€¼
</span>    <span class="n">style_loss</span> <span class="o">*=</span> <span class="n">style_weight</span><span class="o">/</span><span class="n">num_style_layers</span>

    <span class="c1"># å†…å®¹æŸå¤±å€¼ï¼Œä¹Ÿæ˜¯è®¡ç®—æ–¹å·®
</span>    <span class="n">content_loss</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">add_n</span><span class="p">([</span><span class="n">tf</span><span class="p">.</span><span class="n">reduce_mean</span><span class="p">((</span><span class="n">content_outputs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">-</span><span class="n">content_targets</span><span class="p">[</span><span class="n">name</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> 
                             <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">content_outputs</span><span class="p">.</span><span class="n">keys</span><span class="p">()])</span>
    <span class="n">content_loss</span> <span class="o">*=</span> <span class="n">content_weight</span><span class="o">/</span><span class="n">num_content_layers</span>
    <span class="c1"># æ€»æŸå¤±å€¼
</span>    <span class="n">loss</span> <span class="o">=</span> <span class="n">style_loss</span><span class="o">+</span><span class="n">content_loss</span>
    <span class="k">return</span> <span class="n">loss</span>
<span class="c1">################################################################
</span>
<span class="c1"># ä¸€æ¬¡è®­ç»ƒ
</span><span class="o">@</span><span class="n">tf</span><span class="p">.</span><span class="n">function</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">train_step</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">tf</span><span class="p">.</span><span class="n">GradientTape</span><span class="p">()</span> <span class="k">as</span> <span class="n">tape</span><span class="p">:</span>
        <span class="c1"># æŠ½å–é£æ ¼å±‚ã€å†…å®¹å±‚è¾“å‡º
</span>        <span class="n">outputs</span> <span class="o">=</span> <span class="n">extractor</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="c1"># è®¡ç®—æŸå¤±å€¼
</span>        <span class="n">loss</span> <span class="o">=</span> <span class="n">style_content_loss</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span>

    <span class="c1"># æ¢¯åº¦ä¸‹é™
</span>    <span class="n">grad</span> <span class="o">=</span> <span class="n">tape</span><span class="p">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>
    <span class="c1"># åº”ç”¨è®¡ç®—åçš„æ–°å‚æ•°ï¼Œæ³¨æ„è¿™ä¸ªæ–°å€¼ä¸æ˜¯åº”ç”¨åˆ°ç½‘ç»œ
</span>    <span class="c1"># ä½œä¸ºè®­ç»ƒå®Œæˆçš„vggç½‘ç»œï¼Œå…¶å‚æ•°å‰é¢å·²ç»è®¾å®šä¸å¯æ›´æ”¹
</span>    <span class="c1"># è¿™ä¸ªå‚æ•°å®é™…å°†åº”ç”¨äºåŸå›¾
</span>    <span class="c1"># ä»¥æ±‚å–ï¼Œæ–°å›¾ç‰‡ç»è¿‡ç½‘ç»œåï¼ŒæŸå¤±å€¼æœ€å°
</span>    <span class="n">opt</span><span class="p">.</span><span class="n">apply_gradients</span><span class="p">([(</span><span class="n">grad</span><span class="p">,</span> <span class="n">image</span><span class="p">)])</span>
    <span class="c1"># æ›´æ–°å›¾ç‰‡ï¼Œç”¨æ–°å›¾ç‰‡è¿›è¡Œä¸‹æ¬¡è®­ç»ƒè¿­ä»£
</span>    <span class="n">image</span><span class="p">.</span><span class="n">assign</span><span class="p">(</span><span class="n">clip_0_1</span><span class="p">(</span><span class="n">image</span><span class="p">))</span>

<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">epochs</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">steps_per_epoch</span> <span class="o">=</span> <span class="mi">100</span>

<span class="n">step</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">steps_per_epoch</span><span class="p">):</span>
        <span class="n">step</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">train_step</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"."</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">''</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">""</span><span class="p">)</span>
    <span class="c1"># æ¯100æ¬¡è¿­ä»£æ˜¾ç¤ºä¸€æ¬¡å›¾ç‰‡
</span>    <span class="c1"># imshow(image.read_value())
</span>    <span class="c1"># plt.title("Train step: {}".format(step))
</span>    <span class="c1"># plt.show()
</span>
<span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Total time: {:.1f}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="p">))</span>

<span class="c1">########################################
#ä¿å­˜ç»“æœå›¾ç‰‡
</span><span class="n">file_name</span> <span class="o">=</span> <span class="s">'newart1.png'</span>
<span class="n">mpl</span><span class="p">.</span><span class="n">image</span><span class="p">.</span><span class="n">imsave</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">image</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</code></pre></div></div>
<p>ç¨‹åºçš„è¾“å‡ºç»“æœå¦‚ä¸‹å›¾ï¼š<br />
<img src="/attachments/201904/tensorFlow2/nst-newart1.png" alt="" />
çœ‹èµ·æ¥åŸºæœ¬è¾¾åˆ°äº†è®¾è®¡è¦æ±‚ï¼Œä¸è¿‡å†ä»”ç»†è§‚å¯Ÿï¼Œä¼¼ä¹æ•ˆæœè™½ç„¶éƒ½æœ‰äº†ï¼Œä½†ç”»é¢çœ‹ä¸Šå»æœ‰ä¸€ç‚¹ä¸å¹²å‡€ï¼Œæœ‰å¾ˆå¤šå°çš„å™ªç‚¹ç”šè‡³æœ‰äº†å¹²æ¶‰çº¹ã€‚<br />
è¿™æ˜¯å› ä¸ºï¼Œåœ¨ç…§ç‰‡åŸå›¾å’Œè‰ºæœ¯ä½œå“åŸå›¾ä¸­ï¼Œè‚¯å®šå¤©ç„¶å°±å­˜åœ¨æœ‰å™ªç‚¹ä»¥åŠå›¾ç‰‡ä¸­æœ¬èº«åº”å½“æœ‰çš„å°è€Œé¢‘ç¹çš„èŠ±çº¹ã€‚è¿™äº›å†…å®¹åœ¨é€šè¿‡å·ç§¯åŠ å¼ºåï¼Œä¸¤å¹…ç…§ç‰‡å†å åŠ ï¼Œè¿™äº›å™ªå£°å°±è¢«å¼ºåŒ–äº†ï¼Œä»è€Œåœ¨ç”Ÿæˆçš„å›¾ç‰‡ä¸­ä½“ç°çš„éå¸¸æ˜æ˜¾ã€‚<br />
è¿™ä¸ªé—®é¢˜å¦‚æœåœ¨ä¼ ç»Ÿç®—æ³•ä¸­å¯ä»¥ä½¿ç”¨é«˜é€šæ»¤æ³¢ã€‚åœ¨å·ç§¯ç¥ç»ç½‘ç»œä¸­åˆ™æ›´å®¹æ˜“ï¼Œæ˜¯ç»Ÿè®¡æ€»ä½“å˜åˆ†æŸå¤±å€¼(Total Variation Loss)ï¼Œåœ¨ä»£ä»·å‡½æ•°ä¸­ï¼Œè®©è¿™ä¸ªæŸå¤±å€¼é™åˆ°æœ€å°ï¼Œå°±æŠ‘åˆ¶äº†è¿™ç§å™ªç‚¹çš„äº§ç”Ÿã€‚ä¹Ÿç›¸å½“äºç¥ç»ç½‘ç»œå…·æœ‰äº†é™å™ªçš„æ•ˆæœã€‚<br />
å˜åˆ†æŸå¤±æ˜¯è®¡ç®—å›¾ç‰‡ä¸­ï¼Œåœ¨Xæ–¹å‘åŠYæ–¹å‘ï¼Œç›¸é‚»åƒç´ çš„å·®å€¼ã€‚å¦‚æœåƒç´ å·®åˆ«ä¸å¤§ï¼Œé‚£å·®è‚¯å®šå¾ˆå°ç”šè‡³è¶‹è¿‘äº0ã€‚å¦‚æœå·®åˆ«å¤§ï¼Œå½“ç„¶å·®å€¼å°±å¤§ã€‚<br />
è¯·ä½¿ç”¨ä¸‹é¢çš„ä»£ç ï¼Œæ›¿æ¢ä¸Šé¢ç¨‹åºä¸­è®­ç»ƒçš„éƒ¨åˆ†ï¼š</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">###################################################
# è®¡ç®—xæ–¹å‘åŠyæ–¹å‘ç›¸é‚»åƒç´ å·®å€¼ï¼Œå¦‚æœæœ‰é«˜é¢‘èŠ±çº¹ï¼Œè¿™ä¸ªå€¼è‚¯å®šä¼šé«˜ï¼Œ
# å› ä¸ºç›¸é‚»ç‚¹ç›¸åŒå·®å€¼æ¥è¿‘0ï¼ŒåŒºåˆ«è¶Šå¤§ï¼Œå·®å€¼å½“ç„¶è¶Šå¤§
</span><span class="k">def</span> <span class="nf">high_pass_x_y</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
    <span class="n">x_var</span> <span class="o">=</span> <span class="n">image</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">image</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">y_var</span> <span class="o">=</span> <span class="n">image</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">image</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>

    <span class="k">return</span> <span class="n">x_var</span><span class="p">,</span> <span class="n">y_var</span>

<span class="c1"># è®¡ç®—æ€»ä½“å˜åˆ†æŸå¤±
</span><span class="k">def</span> <span class="nf">total_variation_loss</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
    <span class="n">x_deltas</span><span class="p">,</span> <span class="n">y_deltas</span> <span class="o">=</span> <span class="n">high_pass_x_y</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tf</span><span class="p">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">x_deltas</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">tf</span><span class="p">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">y_deltas</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>


<span class="c1"># æ€»ä½“å˜åˆ†æŸå¤±å€¼åœ¨æŸå¤±å€¼ä¸­æ‰€å æƒé‡
</span><span class="n">total_variation_weight</span> <span class="o">=</span> <span class="mf">1e8</span>

<span class="c1"># ä¸€æ¬¡è®­ç»ƒ
</span><span class="o">@</span><span class="n">tf</span><span class="p">.</span><span class="n">function</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">train_step</span><span class="p">(</span><span class="n">image</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">tf</span><span class="p">.</span><span class="n">GradientTape</span><span class="p">()</span> <span class="k">as</span> <span class="n">tape</span><span class="p">:</span>
        <span class="c1"># æŠ½å–é£æ ¼å±‚ã€å†…å®¹å±‚è¾“å‡º
</span>        <span class="n">outputs</span> <span class="o">=</span> <span class="n">extractor</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="c1"># è®¡ç®—æŸå¤±å€¼
</span>        <span class="n">loss</span> <span class="o">=</span> <span class="n">style_content_loss</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">+=</span> <span class="n">total_variation_weight</span><span class="o">*</span><span class="n">total_variation_loss</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

    <span class="c1"># æ¢¯åº¦ä¸‹é™
</span>    <span class="n">grad</span> <span class="o">=</span> <span class="n">tape</span><span class="p">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>
    <span class="c1"># åº”ç”¨è®¡ç®—åçš„æ–°å‚æ•°ï¼Œæ³¨æ„è¿™ä¸ªæ–°å€¼ä¸æ˜¯åº”ç”¨åˆ°ç½‘ç»œ
</span>    <span class="c1"># ä½œä¸ºè®­ç»ƒå®Œæˆçš„vggç½‘ç»œï¼Œå…¶å‚æ•°å‰é¢å·²ç»è®¾å®šä¸å¯æ›´æ”¹
</span>    <span class="c1"># è¿™ä¸ªå‚æ•°å®é™…å°†åº”ç”¨äºåŸå›¾
</span>    <span class="c1"># ä»¥æ±‚å–ï¼Œæ–°å›¾ç‰‡ç»è¿‡ç½‘ç»œåï¼ŒæŸå¤±å€¼æœ€å°
</span>    <span class="n">opt</span><span class="p">.</span><span class="n">apply_gradients</span><span class="p">([(</span><span class="n">grad</span><span class="p">,</span> <span class="n">image</span><span class="p">)])</span>
    <span class="c1"># æ›´æ–°å›¾ç‰‡ï¼Œç”¨æ–°å›¾ç‰‡è¿›è¡Œä¸‹æ¬¡è®­ç»ƒè¿­ä»£
</span>    <span class="n">image</span><span class="p">.</span><span class="n">assign</span><span class="p">(</span><span class="n">clip_0_1</span><span class="p">(</span><span class="n">image</span><span class="p">))</span>

<span class="c1"># å†…å®¹å›¾ç‰‡ä½œä¸ºé€æ­¥è¿­ä»£ç”Ÿæˆçš„æ–°å›¾ç‰‡ï¼Œä¸€å¼€å§‹å½“ç„¶æ˜¯åŸå›¾ï¼Œè¿™é‡Œæ˜¯è½¬æ¢ä¸ºå¼ é‡
</span><span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">content_image</span><span class="p">)</span>

<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>

<span class="c1"># è¿­ä»£10æ¬¡ï¼Œæ¯æ¬¡100æ­¥è®­ç»ƒ
</span><span class="n">epochs</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">steps</span> <span class="o">=</span> <span class="mi">100</span>

<span class="n">step</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">steps</span><span class="p">):</span>
        <span class="n">step</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">train_step</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"."</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">''</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">""</span><span class="p">)</span>
<span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Total time: {:.1f}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="p">))</span>

<span class="c1">#ä¿å­˜ç»“æœå›¾ç‰‡
</span><span class="n">file_name</span> <span class="o">=</span> <span class="s">'newart1.png'</span>
<span class="n">mpl</span><span class="p">.</span><span class="n">image</span><span class="p">.</span><span class="n">imsave</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">image</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</code></pre></div></div>
<p>å†æ¬¡æ‰§è¡Œï¼Œæ‰€å¾—åˆ°çš„è¾“å‡ºå›¾ç‰‡å¦‚ä¸‹ï¼š<br />
<img src="/attachments/201904/tensorFlow2/nst-newart2.png" alt="" />
æ•ˆæœä¸é”™å§ï¼Ÿå¯ä»¥æ¢ä¸Šè‡ªå·±çš„ç…§ç‰‡è¿˜æœ‰è‡ªå·±å¿ƒä»ªçš„è‰ºæœ¯ä½œå“æ¥è¯•è¯•ã€‚<br />
ç¨‹åºä¸­é™åˆ¶äº†å›¾ç‰‡å®½ã€é«˜æœ€å¤§å€¼æ˜¯512ï¼Œå¦‚æœè®¾å¤‡æ€§èƒ½æ¯”è¾ƒå¥½ï¼Œæˆ–è€…æœ‰æ›´å¤§å°ºå¯¸çš„éœ€æ±‚ï¼Œå¯ä»¥ä¿®æ”¹ç¨‹åºä¸­çš„å¸¸é‡ã€‚</p>

<p>ï¼ˆå¾…ç»­â€¦ï¼‰</p>

:ET