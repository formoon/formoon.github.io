I"÷/<p><img src="/attachments/201904/tensorFlow2/tf-logo-card-2.png" alt="" /></p>
<h4 id="åŸºæœ¬æ¦‚å¿µ">åŸºæœ¬æ¦‚å¿µ</h4>
<p>æœºå™¨ç¿»è¯‘å’Œè¯­éŸ³è¯†åˆ«æ˜¯æœ€æ—©å¼€å±•çš„ä¸¤é¡¹äººå·¥æ™ºèƒ½ç ”ç©¶ã€‚ä»Šå¤©ä¹Ÿå–å¾—äº†æœ€æ˜¾è‘—çš„å•†ä¸šæˆæœã€‚<br />
æ—©å…ˆçš„æœºå™¨ç¿»è¯‘å®é™…è„±èƒäºç”µå­è¯å…¸ï¼Œèƒ½åŠ›æ›´æ“…é•¿äºè¯æˆ–è€…çŸ­è¯­çš„ç¿»è¯‘ã€‚é‚£æ—¶å€™çš„ç¿»è¯‘é€šå¸¸ä¼šå°†ä¸€å¥è¯æ‰“æ–­ä¸ºä¸€ç³»åˆ—çš„ç‰‡æ®µï¼Œéšåé€šè¿‡å¤æ‚çš„ç¨‹åºé€»è¾‘å¯¹æ¯ä¸€ä¸ªç‰‡æ®µè¿›è¡Œç¿»è¯‘ï¼Œæœ€ç»ˆç»„åˆåœ¨ä¸€èµ·ã€‚æ‰€å¾—åˆ°çš„ç¿»è¯‘ç»“æœåº”å½“è¯´ä¼¼æ˜¯è€Œéï¼Œæœ€å¤§çš„é—®é¢˜æ˜¯å¯è¯»æ€§å’Œè¿è´¯æ€§éå¸¸å·®ã€‚<br />
å®é™…ä»æœºå™¨å­¦ä¹ çš„è§‚ç‚¹æ¥è®²ï¼Œè¿™ç§ç¿»è¯‘æ–¹å¼ï¼Œä¹Ÿä¸ç¬¦åˆäººç±»åœ¨åšè¯­è¨€ç¿»è¯‘æ—¶æ‰€åšçš„åŠ¨ä½œã€‚å…¶å®ä»¥ç¥ç»ç½‘ç»œä¸ºä»£è¡¨çš„æœºå™¨å­¦ä¹ ï¼Œæ›´å¤šçš„éƒ½æ˜¯åœ¨â€œæ¨¡ä»¿â€äººç±»çš„è¡Œä¸ºä¹ æƒ¯ã€‚<br />
ä¸€åèŒä¸šç¿»è¯‘é€šå¸¸æ˜¯è¿™æ ·åšï¼šé¦–å…ˆå®Œæ•´å¬æ‡‚è¦ç¿»è¯‘çš„è¯­å¥ï¼Œå°†è¯­ä¹‰å……åˆ†ç†è§£ï¼ŒéšåæŠŠç†è§£åˆ°çš„å†…å®¹ï¼Œç”¨ç›®æ ‡è¯­è¨€å¤è¿°å‡ºæ¥ã€‚<br />
è€Œç°åœ¨çš„æœºå™¨ç¿»è¯‘ï¼Œä¹Ÿæ­£æ˜¯è¿™æ ·åšçš„ï¼Œè°·æ­Œçš„<a href="https://github.com/tensorflow/nmt">seq2seq</a>æ˜¯è¿™ä¸€æ¨¡å¼çš„å¼€åˆ›è€…ã€‚<br />
å¦‚æœç”¨è®¡ç®—æœºç§‘å­¦çš„è¯­è¨€æ¥è¯´ï¼Œè¿™ä¸€è¿‡ç¨‹å¾ˆåƒä¸€ä¸ªç¼–è§£ç è¿‡ç¨‹ã€‚åŸå§‹çš„è¯­å¥è¿›å…¥ç¼–ç å™¨ï¼Œå¾—åˆ°ä¸€ç»„ç”¨äºä»£è¡¨åŸå§‹è¯­å¥â€œå†…æ¶µâ€çš„æ•°ç»„ã€‚è¿™äº›æ•°ç»„ä¸­çš„æ•°å­—å°±æ˜¯åŸå§‹è¯­å¥æ‰€ä»£è¡¨çš„å«ä¹‰ï¼Œåªæ˜¯è¿™ä¸ªå«ä¹‰äººç±»æ— æ³•è¯»æ‡‚ï¼Œæ˜¯éœ€è¦ç”±ç¥ç»ç½‘ç»œæ¨¡å‹å»ç†è§£çš„ã€‚éšåè§£ç è¿‡ç¨‹ï¼Œå°†â€œæœ‰å«ä¹‰çš„æ•°å­—â€è§£ç ä¸ºå¯¹åº”çš„ç›®æ ‡è¯­è¨€ã€‚ä»è€Œå®Œæˆæ•´ä¸ªç¿»è¯‘è¿‡ç¨‹ã€‚è¿™æ ·çš„å¾—åˆ°çš„ç¿»è¯‘ç»“æœï¼Œéå¸¸æµç•…ï¼Œå…·æœ‰æ›´å¥½çš„å¯è¯»æ€§ã€‚<br />
<img src="/attachments/201904/tensorFlow2/nmt-encdec.jpg" alt="" /><br />
ï¼ˆå›¾ç‰‡æ¥è‡ªè°·æ­ŒNMTæ–‡æ¡£ï¼‰</p>

<p>æ³¨æ„åŠ›æœºåˆ¶æ˜¯äººç±»ç‰¹æœ‰çš„å¤§è„‘æ€ç»´æ–¹å¼ï¼Œæ¯”å¦‚çœ‹åˆ°ä¸‹é¢è¿™å¹…ç…§ç‰‡ï¼š
<img src="/attachments/201904/tensorFlow2/nmt-attention.png" alt="" /><br />
ï¼ˆå›¾ç‰‡æ¥è‡ªäº’è”ç½‘ï¼‰<br />
ç…§ç‰‡çš„å†…å®¹å®é™…å¾ˆå¤šï¼Œç”šè‡³å¦‚æœä»æ•°å­¦ä¸Šè¯´ï¼ŒèƒŒæ™¯æ ‘æ—çš„å¤æ‚åº¦è¦é«˜äºå‰æ™¯ã€‚ä½†çœ‹åˆ°ç…§ç‰‡çš„äººï¼Œéƒ½ä¼šå…ˆæ³¨æ„åˆ°è¿é¢è€Œæ¥çš„é£ç›˜ï¼Œéšåæ˜¯æŠ•æ·è€…ï¼Œæ¥ç€æ˜¯å›¾åƒå³ä¾§çš„å°å­©å­ã€‚å…¶å®ƒçš„ä¿¡æ¯éƒ½è¢«å¿½ç•¥äº†ã€‚<br />
è¿™æ˜¯äººç±»åœ¨ä¸Šä¸‡å¹´çš„è¿›åŒ–ä¸­æ‰€å½¢æˆçš„æœ¬èƒ½ã€‚å¯¹äºå¿«é€Ÿå‘è‡ªå·±ç§»åŠ¨çš„ç‰©ä½“é¦–å…ˆä¼šçœ‹åˆ°ã€è¯†åˆ«å±é™©ã€å¹¶ä¸”å¿«é€Ÿåº”å¯¹ã€‚æ¥ç€æ˜¯å¯èƒ½å¯¹è‡ªå·±é€ æˆå¨èƒçš„åŒç±»æˆ–è€…ç”Ÿç‰©ã€‚ä¸ºäº†åšåˆ°é›†æ³¨ï¼Œä¸å¾—ä¸å¿½ç•¥çœ‹èµ·æ¥æ— å…³ç´§è¦çš„ä¸œè¥¿ã€‚<br />
åœ¨æœºå™¨å­¦ä¹ ä¸­å¼•å…¥æ³¨æ„åŠ›æ¨¡å‹ï¼Œåœ¨å›¾åƒå¤„ç†ã€æœºå™¨ç¿»è¯‘ã€ç­–ç•¥åšå¼ˆç­‰å„ä¸ªé¢†åŸŸä¸­éƒ½æœ‰åº”ç”¨ã€‚è¿™é‡Œçš„æ³¨æ„åŠ›æœºåˆ¶æœ‰ä¸¤ä¸ªä½œç”¨ï¼šä¸€æ˜¯é™ä½æ¨¡å‹çš„å¤æ‚åº¦æˆ–è€…è®¡ç®—é‡ï¼ŒæŠŠä¸»è¦èµ„æºåˆ†é…ç»™æ›´é‡è¦çš„å†…å®¹ã€‚äºŒæ˜¯å¯¹åº”æŠŠæœ€ç›¸å…³çš„è¾“å…¥å¯¼å‡ºåˆ°ç›¸å…³çš„è¾“å‡ºï¼Œæ›´æœ‰é’ˆå¯¹æ€§çš„å¾—åˆ°ç»“æœã€‚</p>

<p>åœ¨æœºå™¨ç¿»è¯‘é¢†åŸŸï¼Œå‰é¢æˆ‘ä»¬å·²ç»ç¡®å®šå’Œè§£é‡Šäº†ç¼–ç ã€è§£ç æ¨¡å‹ã€‚é‚£ä¹ˆç¬¬äºŒç‚¹çš„è¾“å…¥è¾“å‡ºç›¸å…³æ€§å°±æ˜¾å¾—æ›´é‡è¦ã€‚<br />
æˆ‘ä»¬ä¸¾ä¾‹æ¥è¯´æ˜ï¼šæ¯”å¦‚è‹±æ–‡â€œI love youâ€ï¼Œç¿»è¯‘ä¸ºä¸­æ–‡æ˜¯â€œæˆ‘çˆ±ä½ â€ã€‚åœ¨ä¸€ä¸ªç¼–ç è§£ç æ¨¡å‹ä¸­ï¼Œé¦–å…ˆç”±ç¼–ç å™¨å¤„ç†â€œI love youâ€ï¼Œä»è€Œå¾—åˆ°ä¸­é—´è¯­ä¹‰ï¼Œæ¯”å¦‚æˆ‘ä»¬ç§°ä¸ºCï¼š</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="n">C</span> <span class="o">=</span> <span class="n">Encoder</span><span class="p">(</span><span class="s">"I love you"</span><span class="p">)</span>  
</code></pre></div></div>
<p>è§£ç çš„æ—¶å€™ï¼Œå¦‚æœæ²¡æœ‰æ³¨æ„åŠ›æœºåˆ¶ï¼Œé‚£åºåˆ—è¾“å‡ºåˆ™æ˜¯ï¼š</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="s">"æˆ‘"</span> <span class="o">=</span> <span class="n">Decoder</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>  
	<span class="s">"çˆ±"</span> <span class="o">=</span> <span class="n">Decoder</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>  
	<span class="s">"ä½ "</span> <span class="o">=</span> <span class="n">Decoder</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>  
</code></pre></div></div>
<p>å› ä¸ºCç›¸å½“äºâ€œI love youâ€ä¸‰ä¸ªå•è¯å…±åŒçš„ä½œç”¨ã€‚é‚£ä¹ˆè§£ç çš„æ—¶å€™ï¼Œæ¯ä¸€ä¸ªå­—çš„è¾“å‡ºï¼Œéƒ½ç›¸å½“äº3ä¸ªå•è¯å…±åŒä½œç”¨çš„ç»“æœã€‚è¿™æ˜¾ç„¶æ˜¯ä¸åˆç†çš„ï¼Œè€Œä¸”ä¹Ÿä¸å¤§å¯èƒ½å¾—åˆ°ä¸€ä¸ªç†æƒ³ã€é¡ºç•…çš„ç»“æœã€‚<br />
ä¸€ä¸ªç†æƒ³çš„è§£ç æ¨¡å‹åº”å½“ç±»ä¼¼è¿™æ ·çš„æ–¹å¼ï¼š</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="s">"æˆ‘"</span> <span class="o">=</span> <span class="n">Decoder</span><span class="p">(</span><span class="n">C</span><span class="o">+</span><span class="s">"I"</span><span class="p">)</span>  
	<span class="s">"çˆ±"</span> <span class="o">=</span> <span class="n">Decoder</span><span class="p">(</span><span class="n">C</span><span class="o">+</span><span class="s">"love"</span><span class="p">)</span>  
	<span class="s">"ä½ "</span> <span class="o">=</span> <span class="n">Decoder</span><span class="p">(</span><span class="n">C</span><span class="o">+</span><span class="s">"you"</span><span class="p">)</span>  
</code></pre></div></div>
<p>å½“ç„¶ï¼Œæœºå™¨å­¦ä¹ ä¸æ˜¯äººã€‚äººé€šè¿‡å¤§é‡çš„å­¦ä¹ ã€ç»éªŒçš„ç§¯ç´¯ï¼Œä¸€çœ¼å°±èƒ½çœ‹å‡ºæ¥â€œIâ€å¯¹åº”ç¿»è¯‘æˆâ€œæˆ‘â€ï¼Œâ€œloveâ€ç¿»è¯‘æˆâ€œçˆ±â€ã€‚æœºå™¨ä¸å¯èƒ½æå‰çŸ¥é“è¿™ä¸€åˆ‡ï¼Œæ‰€ä»¥æˆ‘ä»¬æ¯”è¾ƒåˆ‡å®çš„æ–¹æ³•ï¼Œåªèƒ½æ˜¯å¢åŠ ä¸€å¥—æƒé‡é€»è¾‘ï¼Œåœ¨ä¸åŒçš„ç¿»è¯‘å¤„ç†ä¸­ï¼Œå¯¹åº”ä¸åŒçš„æƒé‡å±æ€§ã€‚è¿™å°±å¥½åƒä¸‹é¢è¿™æ ·çš„æ–¹å¼ï¼š</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="s">"æˆ‘"</span> <span class="o">=</span> <span class="n">Decoder</span><span class="p">(</span><span class="n">C</span><span class="o">+</span><span class="mf">0.8</span><span class="n">x</span><span class="s">"I"</span><span class="o">+</span><span class="mf">0.1</span><span class="n">x</span><span class="s">"love"</span><span class="o">+</span><span class="mf">0.2</span><span class="n">x</span><span class="s">"you"</span><span class="p">)</span>  
	<span class="s">"çˆ±"</span> <span class="o">=</span> <span class="n">Decoder</span><span class="p">(</span><span class="n">C</span><span class="o">+</span><span class="mf">0.1</span><span class="n">x</span><span class="s">"I"</span><span class="o">+</span><span class="mf">0.7</span><span class="n">x</span><span class="s">"love"</span><span class="o">+</span><span class="mf">0.1</span><span class="n">x</span><span class="s">"you"</span><span class="p">)</span>  
	<span class="s">"ä½ "</span> <span class="o">=</span> <span class="n">Decoder</span><span class="p">(</span><span class="n">C</span><span class="o">+</span><span class="mf">0.2</span><span class="n">x</span><span class="s">"I"</span><span class="o">+</span><span class="mf">0.1</span><span class="n">x</span><span class="s">"love"</span><span class="o">+</span><span class="mf">0.8</span><span class="n">x</span><span class="s">"you"</span><span class="p">)</span>  
</code></pre></div></div>
<p>æ²¡é”™äº†ï¼Œè¿™ä¸ªæƒé‡å€¼ï¼Œæ¯”å¦‚ç¿»è¯‘â€œæˆ‘â€çš„æ—¶å€™çš„æƒé‡åºåˆ—ï¼š(0.8,0.1,0.2)ï¼Œå°±æ˜¯æ³¨æ„åŠ›æœºåˆ¶ã€‚åœ¨ç¿»è¯‘æŸä¸ªç›®æ ‡å•è¯è¾“å‡ºçš„æ—¶å€™ï¼Œé€šè¿‡æ³¨æ„åŠ›æœºåˆ¶ï¼Œæ¨¡å‹é›†æ³¨åœ¨å¯¹åº”çš„æŸä¸ªè¾“å…¥å•è¯ã€‚<br />
å½“ç„¶ï¼Œæ³¨æ„åŠ›æœºåˆ¶è¿˜åŒ…å«ä¸Šé¢ç¤ºæ„æ€§çš„è¡¨è¾¾å¼æ²¡æœ‰æ˜¾ç¤ºå‡ºæ¥çš„ä¸€ä¸ªé‡è¦æ“ä½œï¼šç»“åˆè§£ç å™¨çš„å½“å‰çŠ¶æ€ã€å’Œç¼–ç å™¨è¾“å…¥å†…å®¹ä¹‹åçš„çŠ¶æ€ï¼Œåœ¨æ¯ä¸€æ¬¡ç¿»è¯‘è§£ç æ“ä½œä¸­æ›´æ–°æ³¨æ„åŠ›çš„æƒé‡å€¼ã€‚</p>

<h4 id="ç¿»è¯‘æ¨¡å‹">ç¿»è¯‘æ¨¡å‹</h4>
<p>å›åˆ°ä¸Šé¢çš„ç¼–è§£ç æ¨¡å‹ç¤ºæ„å›¾ã€‚ç¼–ç å™¨ã€è§£ç å™¨åœ¨æˆ‘ä»¬çš„æœºå™¨å­¦ä¹ ä¸­ï¼Œå®é™…éƒ½æ˜¯ç¥ç»ç½‘ç»œæ¨¡å‹ã€‚é‚£ä¹ˆæŠŠä¸Šé¢çš„ç¤ºæ„å›¾å±•å¼€ï¼Œä¸€ä¸ªæ²¡æœ‰æ³¨æ„åŠ›æœºåˆ¶çš„ç¼–ç ã€è§£ç ç¿»è¯‘æ¨¡å‹æ˜¯è¿™ä¸ªæ ·å­ï¼š<br />
<img src="/attachments/201904/tensorFlow2/nmt-seq2seq.jpg" alt="" /><br />
ï¼ˆå›¾ç‰‡æ¥è‡ªè°·æ­ŒNMTæ–‡æ¡£ï¼‰</p>

<p>éšåï¼Œæˆ‘ä»¬ä¸ºè¿™ä¸ªæ¨¡å‹å¢åŠ è§£ç æ—¶å€™çš„æƒé‡æœºåˆ¶ã€‚æ¨¡å‹åœ¨å¤„ç†æ¯ä¸ªå•è¯è¾“å‡ºçš„æ—¶å€™ï¼Œä¼šåœ¨æƒé‡çš„å¸®åŠ©ä¸‹ï¼ŒæŠŠé‡ç‚¹æ”¾åœ¨å¯¹åº”çš„è¾“å…¥å•è¯ä¸Šã€‚ç¤ºæ„å›¾å¦‚ä¸‹ï¼š<br />
<img src="/attachments/201904/tensorFlow2/nmt-greedy_dec.jpg" alt="" /><br />
ï¼ˆå›¾ç‰‡æ¥è‡ªè°·æ­ŒNMTæ–‡æ¡£ï¼‰</p>

<p>æœ€ç»ˆï¼Œç»“åˆæƒé‡ç”Ÿæˆçš„è¿‡ç¨‹ï¼Œæˆä¸ºå®Œæ•´çš„æ³¨æ„åŠ›æœºåˆ¶ã€‚æ³¨æ„åŠ›æœºåˆ¶ä¸»è¦ä½œç”¨äºè§£ç ï¼Œåœ¨æ¯ä¸€ä¸ªè¾“å‡ºæ­¥éª¤ä¸­éƒ½è¦é‡æ–°è®¡ç®—æ³¨æ„åŠ›æƒé‡ï¼Œå¹¶æ›´æ–°åˆ°è§£ç æ¨¡å‹ä»è€Œå¯¹è¾“å‡ºäº§ç”Ÿå½±å“ã€‚æ¨¡å‹çš„ç¤ºæ„å›¾å¦‚ä¸‹ï¼š<br />
<img src="/attachments/201904/tensorFlow2/nmt-attention_mechanism.jpg" alt="" /><br />
ï¼ˆå›¾ç‰‡æ¥è‡ªè°·æ­ŒNMTæ–‡æ¡£ï¼‰<br />
å›¾ç‰‡ä¸­æ³¨æ„åŠ›æƒé‡çš„æ¥æºå’Œå»å‘ç®­å¤´ï¼Œè¦æ³¨æ„çœ‹æ¸…æ¥šï¼Œè¿™å¯¹ä½ ä¸‹é¢é˜…è¯»å®ç°çš„ä»£ç ä¼šå¾ˆæœ‰å¸®åŠ©ã€‚</p>

<h4 id="æ ·æœ¬åŠæ ·æœ¬é¢„å¤„ç†">æ ·æœ¬åŠæ ·æœ¬é¢„å¤„ç†</h4>
<p>å‰é¢çš„ç¼–è§£ç æ¨¡å‹ç¤ºæ„å›¾ï¼Œè¿˜æœ‰æ¨¡æ‹Ÿçš„è¡¨è¾¾å¼ï¼Œå½“ç„¶éƒ½åšäº†å¾ˆå¤šç®€åŒ–ã€‚å®é™…ä¸Šä¸­é—´è¿˜æœ‰å¾ˆå¤šå·¥ä½œè¦åšï¼Œé¦–å…ˆæ˜¯ç¿»è¯‘æ ·æœ¬åº“ã€‚</p>

<p>æœ¬ä¾‹ä¸­ä½¿ç”¨<a href="http://www.manythings.org/anki/">http://www.manythings.org/anki/</a>æä¾›çš„è‹±æ–‡å¯¹æ¯”è¥¿ç­ç‰™æ–‡æ ·æœ¬åº“ï¼Œç½‘ç«™ä¸Šè¿˜æœ‰å¾ˆå¤šå…¶å®ƒè¯­è¨€çš„å¯¹æ¯”æ ·æœ¬å¯ä»¥ä¸‹è½½ï¼Œæœ‰å…´è¶£çš„è¯»è€…ä¸å¦¨åœ¨åšå®Œè¿™ä¸ªç»ƒä¹ åå°è¯•ä¸€ä¸‹å…¶å®ƒè¯­è¨€çš„æœºå™¨ç¿»è¯‘ã€‚<br />
è¿™ä¸ªæ ·æœ¬æ˜¯æ–‡æœ¬æ ¼å¼ï¼ŒåŒ…å«å¾ˆå¤šè¡Œï¼Œæ¯ä¸€è¡Œéƒ½æ˜¯ä¸€ä¸ªå®Œæ•´çš„å¥å­ï¼ŒåŒ…å«è‹±æ–‡å’Œè¥¿ç­ç‰™æ–‡ä¸¤éƒ¨åˆ†ï¼Œä¸¤ç§æ–‡å­—ä¹‹é—´ä½¿ç”¨åˆ¶è¡¨ç¬¦éš”å¼€ï¼Œæ¯”å¦‚ï¼š</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>May I borrow this book? Â¿Puedo tomar prestado este libro?
</code></pre></div></div>
<p>å¯¹äºæ ·æœ¬åº“ï¼Œæˆ‘ä»¬è¦è¿›è¡Œä»¥ä¸‹å‡ é¡¹é¢„å¤„ç†ï¼š</p>
<ul>
  <li>è¯»å–æ ·æœ¬åº“ï¼Œå»ºç«‹æ•°æ®é›†ã€‚æ¯ä¸€è¡Œçš„æ ·æœ¬æŒ‰è¯­è¨€åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ã€‚</li>
  <li>ä¸ºæ¯ä¸€å¥æ ·æœ¬ï¼Œå¢åŠ å¼€å§‹æ ‡å¿—<code class="language-plaintext highlighter-rouge">&lt;start&gt;</code>å’Œç»“æŸæ ‡å¿—<code class="language-plaintext highlighter-rouge">&lt;end&gt;</code>ã€‚çœ‹è¿‡<a href="http://blog.17study.com.cn/2018/01/17/tensorFlow-series-10/">ã€Šä»é”…ç‚‰å·¥åˆ°AIä¸“å®¶(10)ã€‹</a>çš„è¯ï¼Œä½ åº”å½“ç†è§£è¿™ç§åšæ³•ã€‚ç»è¿‡è®­ç»ƒåï¼Œæ¨¡å‹ä¼šæ ¹æ®è¿™ä¸¤ä¸ªæ ‡å¿—ä½œä¸ºç¿»è¯‘çš„å¼€å§‹å’Œç»“æŸã€‚</li>
</ul>

<p>åšå®Œä¸Šé¢çš„å¤„ç†åï¼Œåˆšæ‰çš„é‚£è¡Œæ ·æœ¬çœ‹èµ·æ¥ä¼šæ˜¯è¿™ä¸ªæ ·å­ï¼š</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;start&gt; may i borrow this book ? &lt;end&gt;
&lt;start&gt; Â¿ puedo tomar prestado este libro ? &lt;end&gt;
</code></pre></div></div>
<p>æ³¨æ„æ ‡ç‚¹ç¬¦å·ä¹Ÿæ˜¯è¯­è¨€çš„ç»„æˆéƒ¨åˆ†ï¼Œæ¯ä¸ªéƒ¨åˆ†ç”¨ç©ºæ ¼éš”å¼€ï¼Œéƒ½éœ€è¦å•ç‹¬æ•°å­—åŒ–ã€‚æ‰€ä»¥ä½ èƒ½çœ‹åˆ°ï¼Œä¸Šé¢çš„ä¸¤è¡Œä¾‹å¥ï¼Œæ ‡ç‚¹ç¬¦å·ä¹‹å‰ä¹Ÿæ·»åŠ äº†ç©ºæ ¼ã€‚</p>
<ul>
  <li>è¿›è¡Œæ•°æ®æ¸…æ´—ï¼Œå»æ‰ä¸æ”¯æŒçš„å­—ç¬¦ã€‚</li>
  <li>æŠŠå•è¯æ•°å­—åŒ–ï¼Œå»ºç«‹ä»å•è¯åˆ°æ•°å­—å’Œä»æ•°å­—åˆ°å•è¯çš„å¯¹ç…§è¡¨ã€‚</li>
  <li>è®¾ç½®ä¸€ä¸ªå¥å­çš„æœ€å¤§é•¿åº¦ï¼ŒæŠŠæ¯ä¸ªå¥å­æŒ‰ç…§æœ€å¤§é•¿åº¦åœ¨å¥å­çš„åç«¯è¡¥é½ã€‚</li>
</ul>

<p>ä¸€è¡Œå¥å­æ•°å­—åŒ–ä¹‹åï¼Œç¼–ç åŒå•è¯ä¹‹é—´çš„å¯¹ç…§å…³ç³»å¯èƒ½ç±»ä¼¼ä¸‹é¢çš„æ ·å­ï¼š</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Input Language<span class="p">;</span> index to word mapping
1 <span class="nt">----</span><span class="o">&gt;</span> &lt;start&gt;
8 <span class="nt">----</span><span class="o">&gt;</span> no
38 <span class="nt">----</span><span class="o">&gt;</span> puedo
804 <span class="nt">----</span><span class="o">&gt;</span> confiar
20 <span class="nt">----</span><span class="o">&gt;</span> en
1000 <span class="nt">----</span><span class="o">&gt;</span> vosotras
3 <span class="nt">----</span><span class="o">&gt;</span> <span class="nb">.</span>
2 <span class="nt">----</span><span class="o">&gt;</span> &lt;end&gt;

Target Language<span class="p">;</span> index to word mapping
1 <span class="nt">----</span><span class="o">&gt;</span> &lt;start&gt;
4 <span class="nt">----</span><span class="o">&gt;</span> i
25 <span class="nt">----</span><span class="o">&gt;</span> can
12 <span class="nt">----</span><span class="o">&gt;</span> t
345 <span class="nt">----</span><span class="o">&gt;</span> trust
6 <span class="nt">----</span><span class="o">&gt;</span> you
3 <span class="nt">----</span><span class="o">&gt;</span> <span class="nb">.</span>
2 <span class="nt">----</span><span class="o">&gt;</span> &lt;end&gt;
</code></pre></div></div>
<p>ä½ å¯èƒ½æ³¨æ„åˆ°äº†ï¼Œâ€œcanâ€™tâ€ä¸­çš„å•å¼•å·ä½œä¸ºä¸æ”¯æŒçš„å­—ç¬¦è¢«è¿‡æ»¤æ‰äº†ï¼Œä¸è¿‡ä½ æ”¾å¿ƒï¼Œè¿™å¹¶ä¸ä¼šå½±å“æ¨¡å‹çš„è®­ç»ƒã€‚å½“ç„¶åœ¨ä¸€ä¸ªå®Œå–„çš„ç¿»è¯‘ç³»ç»Ÿä¸­ï¼Œè¿™æ ·çš„å­—ç¬¦éƒ½åº”å½“å•ç‹¬å¤„ç†ï¼Œæœ¬ä¾‹ä¸­å°±å¿½ç•¥äº†ã€‚</p>

<h4 id="æ¨¡å‹æ„å»º">æ¨¡å‹æ„å»º</h4>
<p>æœ¬ä¾‹ä¸­ä½¿ç”¨äº†ç¼–ç å™¨ã€è§£ç å™¨ã€æ³¨æ„åŠ›æœºåˆ¶ä¸‰ä¸ªç½‘ç»œæ¨¡å‹ï¼Œéƒ½ç»§æ‰¿è‡ªkeras.Modelï¼Œå±äºä¸‰ä¸ªè‡ªå®šä¹‰çš„Kerasæ¨¡å‹ã€‚<br />
ä¸‰ä¸ªæ¨¡å‹å…±åŒç»„æˆäº†å®Œæ•´çš„ç¿»è¯‘æ¨¡å‹ã€‚å®Œæ•´æ¨¡å‹çš„ç»„è£…ï¼Œæ˜¯åœ¨è®­ç»ƒè¿‡ç¨‹å’Œç¿»è¯‘ï¼ˆé¢„æµ‹ï¼‰è¿‡ç¨‹ä¸­ï¼Œé€šè¿‡ç›¸åº”å­ç¨‹åºæŠŠä»–ä»¬ç»„è£…åœ¨ä¸€èµ·çš„ã€‚è¿™æ˜¯å› ä¸ºå®ƒä»¬ä¸‰è€…ä¹‹é—´çš„é€»è¾‘æœºåˆ¶ç›¸å¯¹æ¯”è¾ƒå¤æ‚ã€‚æ— æ³•ç”¨å‰é¢å¸¸ç”¨çš„keras.models.Sequentialæ–¹æ³•ç›´æ¥è€¦åˆåœ¨ä¸€èµ·ã€‚<br />
è‡ªå®šä¹‰Kerasæ¨¡å‹åœ¨æœ¬ç³»åˆ—ä¸­æ˜¯ç¬¬ä¸€æ¬¡é‡åˆ°ï¼Œæ‰€ä»¥ç€é‡è®²ä¸€ä¸‹ã€‚å®ç°è‡ªå®šä¹‰æ¨¡å‹æœ‰ä¸‰ä¸ªåŸºæœ¬è¦æ±‚ï¼š</p>
<ul>
  <li>ç»§æ‰¿è‡ªkeras.Modelç±»ã€‚</li>
  <li>å®ç°<code class="language-plaintext highlighter-rouge">__init__</code>æ–¹æ³•ï¼Œç”¨äºå®ç°ç±»çš„åˆå§‹åŒ–ï¼ŒåŒæ‰€æœ‰é¢å‘å¯¹è±¡çš„è¯­è¨€ä¸€æ ·ï¼Œè¿™é‡Œä¸»è¦å®ŒæˆåŸºç±»å’Œç±»æˆå‘˜çš„åˆå§‹åŒ–å·¥ä½œã€‚</li>
  <li>å®ç°callæ–¹æ³•ï¼Œè¿™æ˜¯ä¸»è¦çš„è®¡ç®—é€»è¾‘ã€‚æ¨¡å‹æ¥å…¥åˆ°ç¥ç»ç½‘ç»œä¹‹åï¼Œè®­ç»ƒé€»è¾‘å’Œé¢„æµ‹é€»è¾‘ï¼Œéƒ½é€šè¿‡é€å±‚è°ƒç”¨callæ–¹æ³•æ¥å®Œæˆè®¡ç®—ã€‚æ–¹æ³•ä¸­å¯ä»¥ä½¿ç”¨kerasä¸­åŸæœ‰çš„ç½‘ç»œæ¨¡å‹å’Œè‡ªå·±çš„è®¡ç®—é€šè¿‡ç»„åˆæ¥å®Œæˆå·¥ä½œã€‚</li>
</ul>

<p>è‡ªå®šä¹‰æ¨¡å‹ä¹‹æ‰€ä»¥æœ‰è¿™äº›è¦æ±‚ï¼Œä¸»è¦æ˜¯ä¸ºäº†è‡ªå®šä¹‰çš„æ¨¡å‹ï¼Œå¯ä»¥è·ŸKerasåŸç”Ÿå±‚ä¸€æ ·ï¼Œäº’ç›¸å…¼å®¹ï¼Œæ”¯æŒå¤šç§æ¨¡å‹çš„ç»„åˆã€äº’è”ï¼Œä»è€Œå…±åŒå½¢æˆæ›´å¤æ‚çš„æ¨¡å‹ã€‚</p>

<p>Encoder/Decoderä¸»ä½“éƒ½ä½¿ç”¨GRUç½‘ç»œï¼Œè¯»èµ·æ¥åº”å½“æ¯”è¾ƒå®¹æ˜“ç†è§£ã€‚æœ‰éœ€è¦çš„è¯ï¼Œå¤ä¹ ä¸€ä¸‹<a href="http://blog.17study.com.cn/2018/01/17/tensorFlow-series-10/">ã€Šä»é”…ç‚‰å·¥åˆ°AIä¸“å®¶(10)ã€‹</a>ã€‚<br />
æ³¨æ„åŠ›æœºåˆ¶çš„BahdanauAttentionæ¨¡å‹å°±å¾ˆä»¤äººè´¹è§£äº†ï¼Œå›°æƒ‘çš„å…³é”®åœ¨äºå…¶ä¸­çš„ç®—æ³•ã€‚ç®—æ³•çš„è®¡ç®—éƒ¨åˆ†åªæœ‰ä¸¤è¡Œä»£ç ï¼Œä»£ç æœ¬èº«éƒ½çŸ¥é“æ˜¯åœ¨åšä»€ä¹ˆï¼Œä½†å®Œå…¨ä¸æ˜ç™½ç»„åˆåœ¨ä¸€èµ·æ˜¯ä»€ä¹ˆåŠŸèƒ½ä»¥åŠä¸ºä»€ä¹ˆè¿™æ ·åšã€‚å…¶å®é˜…è¯»ç”±æ•°å­¦å…¬å¼æ¨å¯¼ã€è½¬æ¢è€Œæ¥çš„ç¨‹åºä»£ç éƒ½æœ‰è¿™ç§æ„Ÿè§‰ã€‚æ‰€ä»¥ç°åœ¨å¾ˆå¤šçš„çŸ¥è¯†ä¿æŠ¤ï¼Œæ ¹æœ¬ä¸åœ¨äºæºä»£ç ï¼Œè€Œåœ¨äºå…¬å¼æœ¬èº«ã€‚æ²¡æœ‰å…¬å¼ï¼Œå¾ˆå¤šæºä»£ç éå¸¸éš¾ä»¥è¯»æ‡‚ã€‚<br />
è¿™éƒ¨åˆ†æ¨èé˜…è¯»Dzmitry Bahdanauçš„è®ºæ–‡<a href="https://arxiv.org/abs/1409.0473">ã€ŠNeural Machine Translation by Jointly Learning to Align and Translateã€‹</a>å’Œä¹‹åMinh-Thang Luongæ”¹è¿›çš„ç®—æ³•<a href="https://arxiv.org/abs/1508.04025">ã€ŠEffective Approaches to Attention-based Neural Machine Translationã€‹</a>ã€‚è®ºæ–‡ä¸­å¯¹äºç†è®ºåšäº†è¯¦å°½è§£é‡Šï¼Œä¹Ÿæœ‰å…¬å¼çš„æ¨å¯¼è¿‡ç¨‹ã€‚<br />
è¿™é‡Œçš„BahdanauAttentionæ¨¡å‹å®é™…å°±æ˜¯å…¬å¼çš„ç¨‹åºå®ç°ã€‚å¦‚æœç²¾åŠ›ä¸å¤Ÿçš„è¯ï¼Œæ­»è®°å…¬å¼ä¹Ÿç®—ä¸€ç§å­¦ä¹ æ–¹æ³•ã€‚</p>

<h5 id="è®­ç»ƒå’Œé¢„æµ‹">è®­ç»ƒå’Œé¢„æµ‹</h5>
<p>æˆ‘ä»¬ä»¥å¾€ç¢°åˆ°çš„æ¨¡å‹ï¼Œè®­ç»ƒå’Œé¢„æµ‹åŸºæœ¬éƒ½æ˜¯ä¸€è¡Œä»£ç ï¼Œå‡ ä¹æ²¡æœ‰ä»€ä¹ˆéœ€è¦è§£é‡Šçš„ã€‚<br />
ä»Šå¤©çš„æ¨¡å‹æ¶‰åŠäº†å¸¦æœ‰æ³¨æ„åŠ›æœºåˆ¶çš„è‡ªå®šä¹‰æ¨¡å‹ï¼Œä¸»è¦çš„é€»è¾‘ï¼Œæ˜¯é€šè¿‡ç¨‹åºä»£ç ï¼Œåœ¨è®­ç»ƒå’Œè¯„ä¼°å­ç¨‹åºä¸­æŠŠæ¨¡å‹ç»„åˆèµ·æ¥å®Œæˆçš„ã€‚<br />
ç¨‹åºå¦‚æœåªæ˜¯ç¼–ç å™¨å’Œè§£ç å™¨ä¸²è”çš„é€»è¾‘ï¼Œå®Œå…¨å¯ä»¥åŒä»¥å‰ä¸€æ ·ï¼Œä¸€æ¡keras.Sequentialå‡½æ•°å®Œæˆç»„è£…ï¼Œé‚£å°±ä¸€ç‚¹éš¾åº¦æ²¡æœ‰äº†ã€‚è€ŒåŠ ä¸Šæ³¨æ„åŠ›æœºåˆ¶ï¼Œå¤æ‚åº¦é«˜äº†å¾ˆå¤šï¼Œä¹Ÿæ˜¯æœ€éš¾ç†è§£çš„åœ°æ–¹ã€‚åšä¸€ä¸ªç®€å•çš„åˆ†æï¼š</p>
<ul>
  <li>ç¼–ç å™¨Encoderæ˜¯ä¸€æ¬¡æ•´å¥ç¼–ç ï¼Œå¾—åˆ°ä¸€ä¸ªenc_outputã€‚enc_outputç›¸å½“äºæ¨¡å‹å¯¹æ•´å¥è¯­ä¹‰çš„ç†è§£ã€‚</li>
  <li>è§£ç å™¨Decoderæ˜¯é€ä¸ªå•è¯è¾“å…¥ï¼Œé€ä¸ªå•è¯è¾“å‡ºçš„ã€‚è®­ç»ƒæ—¶ï¼Œè¾“å…¥åºåˆ—ç”±<code class="language-plaintext highlighter-rouge">&lt;start&gt;</code>èµ·å§‹æ ‡å¿—å¼€å§‹ï¼Œåˆ°<code class="language-plaintext highlighter-rouge">&lt;end&gt;</code>æ ‡å¿—ç»“æŸã€‚é¢„æµ‹æ—¶ï¼Œæ²¡æœ‰äººçŸ¥é“è¿™ä¸€å¥ç¿»è¯‘çš„ç»“æœæ˜¯å¤šå°‘ä¸ªå•è¯ï¼Œå°±æ˜¯é€ä¸ªè·å–Decoderçš„è¾“å‡ºï¼Œç›´åˆ°å¾—åˆ°ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">&lt;end&gt;</code>æ ‡å¿—ã€‚</li>
  <li>Encoderå’ŒDecoderéƒ½å¼•å‡ºäº†éšè—å±‚ï¼Œç”¨äºè®¡ç®—æ³¨æ„åŠ›æƒé‡ã€‚keras.layers.GRUçš„stateè¾“å‡ºå…¶å®å°±æ˜¯éšè—å±‚ï¼Œå¹³æ—¶è¿™ä¸ªå‚æ•°æˆ‘ä»¬æ˜¯ç”¨ä¸åˆ°çš„ã€‚</li>
  <li>å¯¹äºæ¯ä¸€ä¸ªç¿»è¯‘çš„è¾“å‡ºè¯ï¼Œæ³¨æ„åŠ›å¯¹å…¶å½±å“å°±æ˜¯é€šè¿‡<code class="language-plaintext highlighter-rouge">attention_weights * values</code>ï¼Œç„¶åå°†ç»“æœè·Ÿå‰ä¸€ä¸ªè¾“å‡ºè¯ä¸€èµ·ä½œä¸ºDecoderçš„GRUè¾“å…¥ï¼Œvalueså®é™…å°±æ˜¯ç¼–ç å™¨è¾“å‡ºenc_outputã€‚</li>
  <li>Decoderè¾“å‡ºä¸Šä¸€ä¸ªè¯æ—¶å€™çš„éšè—å±‚ï¼Œè·Ÿenc_outputä¸€èµ·é€šè¿‡å…¬å¼è®¡ç®—ï¼Œå¾—åˆ°ä¸‹ä¸€ä¸ªè¯çš„æ³¨æ„åŠ›æƒé‡attention_weightsã€‚åœ¨ç¬¬ä¸€æ¬¡å¾ªç¯çš„æ—¶å€™Decoderè¿˜æ²¡æœ‰è¾“å‡ºè¿‡éšè—å±‚ï¼Œè¿™æ—¶å€™ä½¿ç”¨çš„æ˜¯Encoderçš„éšè—å±‚ã€‚</li>
  <li>æ³¨æ„åŠ›æƒé‡attention_weightsä»ç¨‹åºé€»è¾‘ä¸Šå¹¶ä¸éœ€è¦å¼•å‡ºï¼Œç¨‹åºä¸­åœ¨Decoderä¸­è¾“å‡ºè¿™ä¸ªå€¼æ˜¯ä¸ºäº†ç»˜åˆ¶æ³¨æ„åŠ›æ˜ å°„å›¾ï¼Œå¸®åŠ©ä½ æ›´å¥½çš„ç†è§£æ³¨æ„åŠ›æœºåˆ¶ã€‚æ‰€ä»¥å¦‚æœæ˜¯åœ¨è¿™ä¸ªåŸºç¡€ä¸Šåšç¿»è¯‘ç³»ç»Ÿï¼Œè¾“å‡ºæƒé‡å€¼åˆ°æ¨¡å‹å¤–éƒ¨æ˜¯ä¸éœ€è¦çš„ã€‚</li>
  <li>ä¸ºäº†åŒ¹é…å„ä¸ªç½‘ç»œçš„ä¸åŒç»´åº¦å’Œä¸åŒå½¢çŠ¶ï¼Œæ³¨æ„åŠ›æœºåˆ¶çš„è®¡ç®—é€»è¾‘å’Œæ³¨æ„åŠ›æƒé‡ç»è¿‡äº†å„ç§ç»´åº¦å˜å½¢ã€‚Decoderçš„è¾“å…¥è™½ç„¶æ˜¯ä¸€ä¸ªè¯ï¼Œä½†ä¹Ÿéœ€è¦æ‰©å±•æˆä¸€æ‰¹è¯çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼ˆä¹Ÿæ˜¯å”¯ä¸€ä¸€ä¸ªå…ƒç´ ï¼‰ï¼Œè¿™ä¸ªè·Ÿæˆ‘ä»¬ä»¥å‰çš„æ¨¡å‹åœ¨é¢„æµ‹æ—¶æ‰€åšçš„æ˜¯å®Œå…¨ä¸€æ ·çš„ã€‚</li>
</ul>

<h4 id="å®Œæ•´æºç ">å®Œæ•´æºç </h4>
<p>ä¸‹é¢æ˜¯å®Œæ•´çš„å¯æ‰§è¡Œæºä»£ç ï¼Œè¯·å‚è€ƒæ³¨é‡Šé˜…è¯»ï¼š</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/env python3
</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">unicode_literals</span>

<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="n">tf</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>

<span class="kn">import</span> <span class="nn">unicodedata</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="c1"># å¦‚æœå‘½ä»¤è¡Œå¢åŠ äº†å‚æ•°'train'åˆ™è¿›å…¥è®­ç»ƒæ¨¡å¼ï¼Œå¦åˆ™æŒ‰ç…§ç¿»è¯‘æ¨¡å¼æ‰§è¡Œ
</span><span class="n">TRAIN</span> <span class="o">=</span> <span class="bp">False</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">'train'</span><span class="p">:</span>
    <span class="n">TRAIN</span> <span class="o">=</span> <span class="bp">True</span>

<span class="c1"># ä¸‹è½½æ ·æœ¬é›†ï¼Œä¸‹è½½åè‡ªåŠ¨è§£å‹ã€‚æ•°æ®ä¿å­˜åœ¨è·¯å¾„ï¼š~/.keras/datasets/
</span><span class="n">path_to_zip</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">utils</span><span class="p">.</span><span class="n">get_file</span><span class="p">(</span>
    <span class="s">'spa-eng.zip'</span><span class="p">,</span>
    <span class="n">origin</span><span class="o">=</span><span class="s">'http://storage.googleapis.com/download.tensorflow.org/data/spa-eng.zip'</span><span class="p">,</span>
    <span class="n">extract</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="c1"># æŒ‡å‘è§£å‹åçš„æ ·æœ¬æ–‡ä»¶
</span><span class="n">path_to_file</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path_to_zip</span><span class="p">)</span><span class="o">+</span><span class="s">"/spa-eng/spa.txt"</span>

<span class="c1"># å°†æ–‡æœ¬ä»unicodeç¼–ç è½¬æ¢ä¸ºasciiç¼–ç 
</span><span class="k">def</span> <span class="nf">unicode_to_ascii</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">''</span><span class="p">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">unicodedata</span><span class="p">.</span><span class="n">normalize</span><span class="p">(</span><span class="s">'NFD'</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">unicodedata</span><span class="p">.</span><span class="n">category</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">!=</span> <span class="s">'Mn'</span><span class="p">)</span>

<span class="c1"># å¯¹æ‰€æœ‰çš„å¥å­åšé¢„å¤„ç†
</span><span class="k">def</span> <span class="nf">preprocess_sentence</span><span class="p">(</span><span class="n">w</span><span class="p">):</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">unicode_to_ascii</span><span class="p">(</span><span class="n">w</span><span class="p">.</span><span class="n">lower</span><span class="p">().</span><span class="n">strip</span><span class="p">())</span>

    <span class="c1"># åœ¨å•è¯å’Œæ ‡ç‚¹ä¹‹é—´å¢åŠ ç©ºæ ¼
</span>    <span class="c1"># æ¯”å¦‚: "he is a boy." =&gt; "he is a boy ."
</span>    <span class="c1"># å‚è€ƒ: https://stackoverflow.com/questions/3645931/python-padding-punctuation-with-white-spaces-keeping-punctuation
</span>    <span class="n">w</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s">"([?.!,Â¿])"</span><span class="p">,</span> <span class="sa">r</span><span class="s">" \1 "</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s">'[" "]+'</span><span class="p">,</span> <span class="s">" "</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>

    <span class="c1"># ç”¨ç©ºæ ¼æ›¿æ¢æ‰é™¤äº†å¤§å°å†™å­—æ¯å’Œ"."/ "?"/ "!"/ ","ä¹‹å¤–çš„å­—ç¬¦
</span>    <span class="n">w</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s">"[^a-zA-Z?.!,Â¿]+"</span><span class="p">,</span> <span class="s">" "</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
    <span class="c1"># æˆªæ–­ä¸¤ç«¯çš„ç©ºç™½
</span>    <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="p">.</span><span class="n">rstrip</span><span class="p">().</span><span class="n">strip</span><span class="p">()</span>

    <span class="c1"># åœ¨å¥å­ä¸¤ç«¯å¢åŠ å¼€å§‹å’Œç»“æŸæ ‡å¿—
</span>    <span class="c1"># è¿™æ ·ç»è¿‡è®­ç»ƒåï¼Œæ¨¡å‹çŸ¥é“ä»€ä¹ˆæ—¶å€™å¼€å§‹å’Œä»€ä¹ˆæ—¶å€™ç»“æŸ
</span>    <span class="n">w</span> <span class="o">=</span> <span class="s">'&lt;start&gt; '</span> <span class="o">+</span> <span class="n">w</span> <span class="o">+</span> <span class="s">' &lt;end&gt;'</span>
    <span class="k">return</span> <span class="n">w</span>

<span class="c1"># è½½å…¥æ ·æœ¬é›†ï¼Œå¯¹å¥å­è¿›è¡Œé¢„å¤„ç†
# æœ€ç»ˆè¿”å›(è‹±æ–‡,è¥¿ç­ç‰™æ–‡)è¿™æ ·çš„é…å¯¹å…ƒç»„
</span><span class="k">def</span> <span class="nf">create_dataset</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">num_examples</span><span class="p">):</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">'UTF-8'</span><span class="p">).</span><span class="n">read</span><span class="p">().</span><span class="n">strip</span><span class="p">().</span><span class="n">split</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>

    <span class="n">word_pairs</span> <span class="o">=</span> <span class="p">[[</span><span class="n">preprocess_sentence</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">l</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">'</span><span class="se">\t</span><span class="s">'</span><span class="p">)]</span>  <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[:</span><span class="n">num_examples</span><span class="p">]]</span>

    <span class="k">return</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">word_pairs</span><span class="p">)</span>
<span class="c1"># è‡³æ­¤çš„è¾“å‡ºä¸ºï¼š
# &lt;start&gt; go away ! &lt;end&gt;
# &lt;start&gt; salga de aqui ! &lt;end&gt;
# è¿™æ ·çš„å½¢å¼ã€‚
</span>
<span class="c1"># è·å–æœ€é•¿çš„å¥å­é•¿åº¦
</span><span class="k">def</span> <span class="nf">max_length</span><span class="p">(</span><span class="n">tensor</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tensor</span><span class="p">)</span>

<span class="c1"># å°†å•è¯æ•°å­—åŒ–ä¹‹åçš„æ•°å­—&lt;-&gt;å•è¯åŒå‘å¯¹ç…§è¡¨
</span><span class="k">def</span> <span class="nf">tokenize</span><span class="p">(</span><span class="n">lang</span><span class="p">):</span>
    <span class="n">lang_tokenizer</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">preprocessing</span><span class="p">.</span><span class="n">text</span><span class="p">.</span><span class="n">Tokenizer</span><span class="p">(</span>
        <span class="n">filters</span><span class="o">=</span><span class="s">''</span><span class="p">)</span>
    <span class="n">lang_tokenizer</span><span class="p">.</span><span class="n">fit_on_texts</span><span class="p">(</span><span class="n">lang</span><span class="p">)</span>

    <span class="n">tensor</span> <span class="o">=</span> <span class="n">lang_tokenizer</span><span class="p">.</span><span class="n">texts_to_sequences</span><span class="p">(</span><span class="n">lang</span><span class="p">)</span>

    <span class="n">tensor</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">preprocessing</span><span class="p">.</span><span class="n">sequence</span><span class="p">.</span><span class="n">pad_sequences</span><span class="p">(</span>
        <span class="n">tensor</span><span class="p">,</span>
        <span class="n">padding</span><span class="o">=</span><span class="s">'post'</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tensor</span><span class="p">,</span> <span class="n">lang_tokenizer</span>

<span class="k">def</span> <span class="nf">load_dataset</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">num_examples</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="c1"># è½½å…¥æ ·æœ¬ï¼Œä¸¤ç§è¯­è¨€åˆ†åˆ«ä¿å­˜åˆ°ä¸¤ä¸ªæ•°ç»„
</span>    <span class="n">targ_lang</span><span class="p">,</span> <span class="n">inp_lang</span> <span class="o">=</span> <span class="n">create_dataset</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">num_examples</span><span class="p">)</span>
    <span class="c1"># æŠŠå¥å­æ•°å­—åŒ–ï¼Œä¸¤ç§è¯­è¨€æ˜¯ä¸¤å¥—å¯¹ç…§ç¼–ç 
</span>    <span class="n">input_tensor</span><span class="p">,</span> <span class="n">inp_lang_tokenizer</span> <span class="o">=</span> <span class="n">tokenize</span><span class="p">(</span><span class="n">inp_lang</span><span class="p">)</span>
    <span class="n">target_tensor</span><span class="p">,</span> <span class="n">targ_lang_tokenizer</span> <span class="o">=</span> <span class="n">tokenize</span><span class="p">(</span><span class="n">targ_lang</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">input_tensor</span><span class="p">,</span> <span class="n">target_tensor</span><span class="p">,</span> <span class="n">inp_lang_tokenizer</span><span class="p">,</span> <span class="n">targ_lang_tokenizer</span>

<span class="c1"># è®­ç»ƒçš„æ ·æœ¬é›†æ•°é‡ï¼Œè¶Šå¤§ç¿»è¯‘æ•ˆæœè¶Šå¥½ï¼Œä½†è®­ç»ƒè€—æ—¶è¶Šé•¿
</span><span class="n">num_examples</span> <span class="o">=</span> <span class="mi">80000</span>
<span class="n">input_tensor</span><span class="p">,</span> <span class="n">target_tensor</span><span class="p">,</span> <span class="n">inp_lang</span><span class="p">,</span> <span class="n">targ_lang</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="n">path_to_file</span><span class="p">,</span> <span class="n">num_examples</span><span class="p">)</span>
<span class="c1"># è‡³æ­¤ï¼Œinput_tensor/target_tensor æ˜¯æ•°å­—åŒ–ä¹‹åçš„æ ·æœ¬ï¼ˆæ•°å­—æ•°ç»„ï¼‰
# inp_lang/targ_lang æ˜¯æ•°å­—&lt;-&gt;å•è¯ç¼–ç å¯¹ç…§è¡¨
# è®¡ç®—ä¸¤ç§è¯­è¨€ä¸­æœ€é•¿å¥å­çš„é•¿åº¦
</span><span class="n">max_length_targ</span><span class="p">,</span> <span class="n">max_length_inp</span> <span class="o">=</span> <span class="n">max_length</span><span class="p">(</span><span class="n">target_tensor</span><span class="p">),</span> <span class="n">max_length</span><span class="p">(</span><span class="n">input_tensor</span><span class="p">)</span>

<span class="c1"># å°†æ ·æœ¬æŒ‰ç…§8:2åˆ†ä¸ºè®­ç»ƒé›†å’ŒéªŒè¯é›†
</span><span class="n">input_tensor_train</span><span class="p">,</span> <span class="n">input_tensor_val</span><span class="p">,</span> <span class="n">target_tensor_train</span><span class="p">,</span> <span class="n">target_tensor_val</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">input_tensor</span><span class="p">,</span> <span class="n">target_tensor</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

<span class="c1">##############################################
</span>
<span class="n">BUFFER_SIZE</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_tensor_train</span><span class="p">)</span>
<span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">64</span>
<span class="n">steps_per_epoch</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_tensor_train</span><span class="p">)</span><span class="o">//</span><span class="n">BATCH_SIZE</span>
<span class="n">embedding_dim</span> <span class="o">=</span> <span class="mi">256</span>
<span class="n">units</span> <span class="o">=</span> <span class="mi">1024</span>
<span class="n">vocab_inp_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">inp_lang</span><span class="p">.</span><span class="n">word_index</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
<span class="n">vocab_tar_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">targ_lang</span><span class="p">.</span><span class="n">word_index</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>

<span class="n">dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">Dataset</span><span class="p">.</span><span class="n">from_tensor_slices</span><span class="p">((</span><span class="n">input_tensor_train</span><span class="p">,</span> <span class="n">target_tensor_train</span><span class="p">)).</span><span class="n">shuffle</span><span class="p">(</span><span class="n">BUFFER_SIZE</span><span class="p">)</span>
<span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">.</span><span class="n">batch</span><span class="p">(</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="n">drop_remainder</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c1"># ç¼–ç å™¨æ¨¡å‹
</span><span class="k">class</span> <span class="nc">Encoder</span><span class="p">(</span><span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="p">,</span> <span class="n">enc_units</span><span class="p">,</span> <span class="n">batch_sz</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Encoder</span><span class="p">,</span> <span class="bp">self</span><span class="p">).</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">batch_sz</span> <span class="o">=</span> <span class="n">batch_sz</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">enc_units</span> <span class="o">=</span> <span class="n">enc_units</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">embedding</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">vocab_size</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">gru</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">GRU</span><span class="p">(</span>
                                    <span class="bp">self</span><span class="p">.</span><span class="n">enc_units</span><span class="p">,</span> 
                                    <span class="n">return_sequences</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> 
                                    <span class="n">return_state</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> 
                                    <span class="n">recurrent_initializer</span><span class="o">=</span><span class="s">'glorot_uniform'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">hidden</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">embedding</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">output</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">gru</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">initial_state</span><span class="o">=</span><span class="n">hidden</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span><span class="p">,</span> <span class="n">state</span>

    <span class="k">def</span> <span class="nf">initialize_hidden_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">tf</span><span class="p">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="p">.</span><span class="n">batch_sz</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">enc_units</span><span class="p">))</span>

<span class="n">encoder</span> <span class="o">=</span> <span class="n">Encoder</span><span class="p">(</span><span class="n">vocab_inp_size</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">BATCH_SIZE</span><span class="p">)</span>

<span class="c1"># æ³¨æ„åŠ›æ¨¡å‹
</span><span class="k">class</span> <span class="nc">BahdanauAttention</span><span class="p">(</span><span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BahdanauAttention</span><span class="p">,</span> <span class="bp">self</span><span class="p">).</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">W1</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">W2</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">V</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="c1"># queryä¸ºä¸Šæ¬¡çš„GRUéšè—å±‚
</span>        <span class="c1"># valuesä¸ºç¼–ç å™¨çš„ç¼–ç ç»“æœenc_output
</span>        <span class="n">hidden_with_time_axis</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># è®¡ç®—æ³¨æ„åŠ›æƒé‡å€¼
</span>        <span class="n">score</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">V</span><span class="p">(</span><span class="n">tf</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="n">tanh</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">W1</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="p">.</span><span class="n">W2</span><span class="p">(</span><span class="n">hidden_with_time_axis</span><span class="p">)))</span>

        <span class="n">attention_weights</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># ä½¿ç”¨æ³¨æ„åŠ›æƒé‡*ç¼–ç å™¨è¾“å‡ºä½œä¸ºè¿”å›å€¼ï¼Œå°†æ¥ä¼šä½œä¸ºè§£ç å™¨çš„è¾“å…¥
</span>        <span class="n">context_vector</span> <span class="o">=</span> <span class="n">attention_weights</span> <span class="o">*</span> <span class="n">values</span>
        <span class="n">context_vector</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">context_vector</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">context_vector</span><span class="p">,</span> <span class="n">attention_weights</span>

<span class="c1"># è§£ç å™¨æ¨¡å‹
</span><span class="k">class</span> <span class="nc">Decoder</span><span class="p">(</span><span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="p">,</span> <span class="n">dec_units</span><span class="p">,</span> <span class="n">batch_sz</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Decoder</span><span class="p">,</span> <span class="bp">self</span><span class="p">).</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">batch_sz</span> <span class="o">=</span> <span class="n">batch_sz</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">dec_units</span> <span class="o">=</span> <span class="n">dec_units</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">embedding</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">vocab_size</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">gru</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">GRU</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">dec_units</span><span class="p">,</span> 
            <span class="n">return_sequences</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">return_state</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> 
            <span class="n">recurrent_initializer</span><span class="o">=</span><span class="s">'glorot_uniform'</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">fc</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">vocab_size</span><span class="p">)</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">attention</span> <span class="o">=</span> <span class="n">BahdanauAttention</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">dec_units</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">hidden</span><span class="p">,</span> <span class="n">enc_output</span><span class="p">):</span>
        <span class="c1"># ä½¿ç”¨ä¸Šæ¬¡çš„éšè—å±‚ï¼ˆç¬¬ä¸€æ¬¡ä½¿ç”¨ç¼–ç å™¨éšè—å±‚ï¼‰ã€ç¼–ç å™¨è¾“å‡ºè®¡ç®—æ³¨æ„åŠ›æƒé‡
</span>        <span class="n">context_vector</span><span class="p">,</span> <span class="n">attention_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">attention</span><span class="p">(</span><span class="n">hidden</span><span class="p">,</span> <span class="n">enc_output</span><span class="p">)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">embedding</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="c1"># å°†ä¸Šä¸€å¾ªç¯çš„é¢„æµ‹ç»“æœè·Ÿæ³¨æ„åŠ›æƒé‡å€¼ç»“åˆåœ¨ä¸€èµ·ä½œä¸ºæœ¬æ¬¡çš„GRUç½‘ç»œè¾“å…¥
</span>        <span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">concat</span><span class="p">([</span><span class="n">tf</span><span class="p">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">context_vector</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">x</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># stateå®é™…æ˜¯GRUçš„éšè—å±‚
</span>        <span class="n">output</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">gru</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="n">output</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">output</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">fc</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">attention_weights</span>

<span class="n">decoder</span> <span class="o">=</span> <span class="n">Decoder</span><span class="p">(</span><span class="n">vocab_tar_size</span><span class="p">,</span> <span class="n">embedding_dim</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">BATCH_SIZE</span><span class="p">)</span>


<span class="n">optimizer</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">optimizers</span><span class="p">.</span><span class="n">Adam</span><span class="p">()</span>
<span class="n">loss_object</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">losses</span><span class="p">.</span><span class="n">SparseCategoricalCrossentropy</span><span class="p">(</span><span class="n">from_logits</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c1"># æŸå¤±å‡½æ•°
</span><span class="k">def</span> <span class="nf">loss_function</span><span class="p">(</span><span class="n">real</span><span class="p">,</span> <span class="n">pred</span><span class="p">):</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">math</span><span class="p">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">tf</span><span class="p">.</span><span class="n">math</span><span class="p">.</span><span class="n">equal</span><span class="p">(</span><span class="n">real</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">loss_</span> <span class="o">=</span> <span class="n">loss_object</span><span class="p">(</span><span class="n">real</span><span class="p">,</span> <span class="n">pred</span><span class="p">)</span>

    <span class="n">mask</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">cast</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">loss_</span><span class="p">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">loss_</span> <span class="o">*=</span> <span class="n">mask</span>

    <span class="k">return</span> <span class="n">tf</span><span class="p">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">loss_</span><span class="p">)</span>

<span class="c1"># ä¿å­˜ä¸­é—´è®­ç»ƒç»“æœ
</span><span class="n">checkpoint_dir</span> <span class="o">=</span> <span class="s">'./training_checkpoints'</span>
<span class="n">checkpoint_prefix</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">checkpoint_dir</span><span class="p">,</span> <span class="s">"ckpt"</span><span class="p">)</span>
<span class="n">checkpoint</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">train</span><span class="p">.</span><span class="n">Checkpoint</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">optimizer</span><span class="p">,</span>
                                 <span class="n">encoder</span><span class="o">=</span><span class="n">encoder</span><span class="p">,</span>
                                 <span class="n">decoder</span><span class="o">=</span><span class="n">decoder</span><span class="p">)</span>

<span class="c1"># ä¸€æ¬¡è®­ç»ƒ
</span><span class="o">@</span><span class="n">tf</span><span class="p">.</span><span class="n">function</span>
<span class="k">def</span> <span class="nf">train_step</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">targ</span><span class="p">,</span> <span class="n">enc_hidden</span><span class="p">):</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">with</span> <span class="n">tf</span><span class="p">.</span><span class="n">GradientTape</span><span class="p">()</span> <span class="k">as</span> <span class="n">tape</span><span class="p">:</span>
        <span class="c1"># è¾“å…¥æºè¯­è¨€å¥å­è¿›è¡Œç¼–ç 
</span>        <span class="n">enc_output</span><span class="p">,</span> <span class="n">enc_hidden</span> <span class="o">=</span> <span class="n">encoder</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">enc_hidden</span><span class="p">)</span>
        <span class="c1"># ä¿ç•™ç¼–ç å™¨éšè—å±‚ç”¨äºç¬¬ä¸€æ¬¡çš„æ³¨æ„åŠ›æƒé‡è®¡ç®—
</span>        <span class="n">dec_hidden</span> <span class="o">=</span> <span class="n">enc_hidden</span>

        <span class="c1"># è§£ç å™¨ç¬¬ä¸€æ¬¡çš„è¾“å…¥å¿…å®šæ˜¯&lt;start&gt;ï¼Œtarg_lang.word_index['&lt;start&gt;']æ˜¯è½¬æ¢ä¸ºå¯¹åº”çš„æ•°å­—ç¼–ç 
</span>        <span class="n">dec_input</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">expand_dims</span><span class="p">([</span><span class="n">targ_lang</span><span class="p">.</span><span class="n">word_index</span><span class="p">[</span><span class="s">'&lt;start&gt;'</span><span class="p">]]</span> <span class="o">*</span> <span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>       

        <span class="c1"># å¾ªç¯æ•´ä¸ªç›®æ ‡å¥å­ï¼ˆç”¨äºå¯¹æ¯”æ¯ä¸€æ¬¡è§£ç å™¨è¾“å‡ºåŒæ ·æœ¬çš„å¯¹æ¯”ï¼‰
</span>        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">targ</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="c1"># ä½¿ç”¨æœ¬å•è¯ã€éšè—å±‚ã€ç¼–ç å™¨è¾“å‡ºå…±åŒé¢„æµ‹ä¸‹ä¸€ä¸ªå•è¯ï¼ŒåŒäº‹ä¿ç•™æœ¬æ¬¡çš„éšè—å±‚ä½œä¸ºä¸‹ä¸€æ¬¡è¾“å…¥
</span>            <span class="n">predictions</span><span class="p">,</span> <span class="n">dec_hidden</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">decoder</span><span class="p">(</span><span class="n">dec_input</span><span class="p">,</span> <span class="n">dec_hidden</span><span class="p">,</span> <span class="n">enc_output</span><span class="p">)</span>
            <span class="c1"># è®¡ç®—æŸå¤±å€¼ï¼Œæœ€ç»ˆçš„æŸå¤±å€¼æ˜¯æ•´ä¸ªå¥å­æ‰€æœ‰å•è¯æŸå¤±å€¼çš„åˆè®¡
</span>            <span class="n">loss</span> <span class="o">+=</span> <span class="n">loss_function</span><span class="p">(</span><span class="n">targ</span><span class="p">[:,</span> <span class="n">t</span><span class="p">],</span> <span class="n">predictions</span><span class="p">)</span>

            <span class="c1"># åœ¨è®­ç»ƒæ—¶ï¼Œæ¯æ¬¡è§£ç å™¨çš„è¾“å…¥å¹¶ä¸æ˜¯ä¸Šæ¬¡è§£ç å™¨çš„è¾“å‡ºï¼Œè€Œæ˜¯æ ·æœ¬ç›®æ ‡è¯­è¨€å¯¹åº”å•è¯
</span>            <span class="c1"># è¿™ç§°ä¸ºteach forcing
</span>            <span class="n">dec_input</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">targ</span><span class="p">[:,</span> <span class="n">t</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># æ‰€æœ‰å•è¯çš„å¹³å‡æŸå¤±å€¼
</span>    <span class="n">batch_loss</span> <span class="o">=</span> <span class="p">(</span><span class="n">loss</span> <span class="o">/</span> <span class="nb">int</span><span class="p">(</span><span class="n">targ</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="c1"># æœ€ç»ˆçš„è®­ç»ƒå‚é‡æ˜¯ç¼–ç å™¨å’Œè§£ç çš„é›†åˆ
</span>    <span class="n">variables</span> <span class="o">=</span> <span class="n">encoder</span><span class="p">.</span><span class="n">trainable_variables</span> <span class="o">+</span> <span class="n">decoder</span><span class="p">.</span><span class="n">trainable_variables</span>
    <span class="c1"># æ ¹æ®ä»£ä»·å€¼è®¡ç®—ä¸‹ä¸€æ¬¡çš„å‚é‡å€¼
</span>    <span class="n">gradients</span> <span class="o">=</span> <span class="n">tape</span><span class="p">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">variables</span><span class="p">)</span>
    <span class="c1"># å°†æ–°çš„å‚é‡åº”ç”¨åˆ°æ¨¡å‹
</span>    <span class="n">optimizer</span><span class="p">.</span><span class="n">apply_gradients</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">gradients</span><span class="p">,</span> <span class="n">variables</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">batch_loss</span>

<span class="k">def</span> <span class="nf">training</span><span class="p">():</span>
    <span class="n">EPOCHS</span> <span class="o">=</span> <span class="mi">10</span>

    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">EPOCHS</span><span class="p">):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
        <span class="c1"># åˆå§‹åŒ–éšè—å±‚å’ŒæŸå¤±å€¼
</span>        <span class="n">enc_hidden</span> <span class="o">=</span> <span class="n">encoder</span><span class="p">.</span><span class="n">initialize_hidden_state</span><span class="p">()</span>
        <span class="n">total_loss</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># ä¸€ä¸ªæ‰¹æ¬¡çš„è®­ç»ƒ
</span>        <span class="k">for</span> <span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">targ</span><span class="p">))</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dataset</span><span class="p">.</span><span class="n">take</span><span class="p">(</span><span class="n">steps_per_epoch</span><span class="p">)):</span>
            <span class="n">batch_loss</span> <span class="o">=</span> <span class="n">train_step</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">targ</span><span class="p">,</span> <span class="n">enc_hidden</span><span class="p">)</span>
            <span class="n">total_loss</span> <span class="o">+=</span> <span class="n">batch_loss</span>

        <span class="c1"># æ¯100æ¬¡æ˜¾ç¤ºä¸€ä¸‹æ¨¡å‹æŸå¤±å€¼
</span>        <span class="k">if</span> <span class="n">batch</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'Epoch {} Batch {} Loss {:.4f}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span>
                                                        <span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                                                        <span class="n">batch</span><span class="p">,</span>
                                                        <span class="n">batch_loss</span><span class="p">.</span><span class="n">numpy</span><span class="p">()))</span>
        <span class="c1"># æ¯ä¸¤æ¬¡è¿­ä»£ä¿å­˜ä¸€æ¬¡æ•°æ®
</span>        <span class="k">if</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">checkpoint</span><span class="p">.</span><span class="n">save</span><span class="p">(</span><span class="n">file_prefix</span><span class="o">=</span><span class="n">checkpoint_prefix</span><span class="p">)</span>
        <span class="c1"># æ˜¾ç¤ºæ¯æ¬¡è¿­ä»£çš„æŸå¤±å€¼å’Œæ¶ˆè€—æ—¶é—´
</span>        <span class="k">print</span><span class="p">(</span><span class="s">'Epoch {} Loss {:.4f}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                                            <span class="n">total_loss</span> <span class="o">/</span> <span class="n">steps_per_epoch</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'Time taken for 1 epoch {} sec</span><span class="se">\n</span><span class="s">'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>

<span class="c1"># æ ¹æ®å‘½ä»¤è¡Œå‚æ•°é€‰æ‹©æœ¬æ¬¡æ˜¯å¦è¿›è¡Œè®­ç»ƒ
</span><span class="k">if</span> <span class="n">TRAIN</span><span class="p">:</span>
    <span class="n">training</span><span class="p">()</span>
<span class="c1">################################################
</span>
<span class="c1"># è¯„ä¼°ï¼ˆç¿»è¯‘ï¼‰ä¸€è¡Œå¥å­
</span><span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="n">sentence</span><span class="p">):</span>
    <span class="c1"># æ¸…ç©ºæ³¨æ„åŠ›å›¾
</span>    <span class="n">attention_plot</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">max_length_targ</span><span class="p">,</span> <span class="n">max_length_inp</span><span class="p">))</span>
    <span class="c1"># å¥å­é¢„å¤„ç†
</span>    <span class="n">sentence</span> <span class="o">=</span> <span class="n">preprocess_sentence</span><span class="p">(</span><span class="n">sentence</span><span class="p">)</span>
    <span class="c1"># å¥å­æ•°å­—åŒ–
</span>    <span class="n">inputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">inp_lang</span><span class="p">.</span><span class="n">word_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sentence</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">' '</span><span class="p">)]</span>
    <span class="c1"># æŒ‰ç…§æœ€é•¿å¥å­é•¿åº¦è¡¥é½
</span>    <span class="n">inputs</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">preprocessing</span><span class="p">.</span><span class="n">sequence</span><span class="p">.</span><span class="n">pad_sequences</span><span class="p">([</span><span class="n">inputs</span><span class="p">],</span> 
                                                           <span class="n">maxlen</span><span class="o">=</span><span class="n">max_length_inp</span><span class="p">,</span> 
                                                           <span class="n">padding</span><span class="o">=</span><span class="s">'post'</span><span class="p">)</span>
    <span class="n">inputs</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">convert_to_tensor</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="s">''</span>

    <span class="c1"># å¥å­åšç¼–ç 
</span>    <span class="n">hidden</span> <span class="o">=</span> <span class="p">[</span><span class="n">tf</span><span class="p">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">units</span><span class="p">))]</span>
    <span class="n">enc_out</span><span class="p">,</span> <span class="n">enc_hidden</span> <span class="o">=</span> <span class="n">encoder</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">hidden</span><span class="p">)</span>

    <span class="c1"># ç¼–ç å™¨éšè—å±‚ä½œä¸ºç¬¬ä¸€æ¬¡è§£ç å™¨çš„éšè—å±‚å€¼
</span>    <span class="n">dec_hidden</span> <span class="o">=</span> <span class="n">enc_hidden</span>
    <span class="c1"># è§£ç ç¬¬ä¸€ä¸ªå•è¯å¿…ç„¶æ˜¯&lt;start&gt;,è¡¨ç¤ºå¯åŠ¨è§£ç 
</span>    <span class="n">dec_input</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">expand_dims</span><span class="p">([</span><span class="n">targ_lang</span><span class="p">.</span><span class="n">word_index</span><span class="p">[</span><span class="s">'&lt;start&gt;'</span><span class="p">]],</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># å‡è®¾ç¿»è¯‘ç»“æœä¸è¶…è¿‡æœ€é•¿çš„æ ·æœ¬å¥å­
</span>    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_length_targ</span><span class="p">):</span>
        <span class="c1"># é€ä¸ªå•è¯ç¿»è¯‘
</span>        <span class="n">predictions</span><span class="p">,</span> <span class="n">dec_hidden</span><span class="p">,</span> <span class="n">attention_weights</span> <span class="o">=</span> <span class="n">decoder</span><span class="p">(</span><span class="n">dec_input</span><span class="p">,</span>
                                                             <span class="n">dec_hidden</span><span class="p">,</span>
                                                             <span class="n">enc_out</span><span class="p">)</span>

        <span class="c1"># ä¿ç•™æ³¨æ„åŠ›æƒé‡ç”¨äºç»˜åˆ¶æ³¨æ„åŠ›å›¾
</span>        <span class="c1"># æ³¨æ„æ¯æ¬¡å¾ªç¯çš„æ¯ä¸ªå•è¯æ³¨æ„åŠ›æƒé‡æ˜¯ä¸åŒçš„
</span>        <span class="n">attention_weights</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">attention_weights</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">))</span>
        <span class="n">attention_plot</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">attention_weights</span><span class="p">.</span><span class="n">numpy</span><span class="p">()</span>

        <span class="c1"># å¾—åˆ°é¢„æµ‹å€¼
</span>        <span class="n">predicted_id</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">predictions</span><span class="p">[</span><span class="mi">0</span><span class="p">]).</span><span class="n">numpy</span><span class="p">()</span>

        <span class="c1"># ä»æ•°å­—æŸ¥è¡¨è½¬æ¢ä¸ºå¯¹åº”å•è¯ï¼Œç´¯åŠ åˆ°ä¸Šä¸€æ¬¡ç»“æœï¼Œæœ€ç»ˆç»„æˆå¥å­
</span>        <span class="n">result</span> <span class="o">+=</span> <span class="n">targ_lang</span><span class="p">.</span><span class="n">index_word</span><span class="p">[</span><span class="n">predicted_id</span><span class="p">]</span> <span class="o">+</span> <span class="s">' '</span>

        <span class="c1"># å¦‚æœæ˜¯&lt;end&gt;è¡¨ç¤ºç¿»è¯‘ç»“æŸ
</span>        <span class="k">if</span> <span class="n">targ_lang</span><span class="p">.</span><span class="n">index_word</span><span class="p">[</span><span class="n">predicted_id</span><span class="p">]</span> <span class="o">==</span> <span class="s">'&lt;end&gt;'</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">sentence</span><span class="p">,</span> <span class="n">attention_plot</span>

        <span class="c1"># ä¸Šæ¬¡çš„é¢„æµ‹å€¼ï¼Œå°†ä½œä¸ºä¸‹æ¬¡è§£ç å™¨çš„è¾“å…¥
</span>        <span class="n">dec_input</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">expand_dims</span><span class="p">([</span><span class="n">predicted_id</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1"># å¦‚æœè¶…è¿‡æ ·æœ¬ä¸­æœ€é•¿çš„å¥å­ä»ç„¶æ²¡æœ‰ç¿»è¯‘ç»“æŸæ ‡å¿—ï¼Œåˆ™è¿”å›å½“å‰æ‰€æœ‰ç¿»è¯‘ç»“æœ
</span>    <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">sentence</span><span class="p">,</span> <span class="n">attention_plot</span>

<span class="c1"># ç»˜åˆ¶æ³¨æ„åŠ›å›¾
</span><span class="k">def</span> <span class="nf">plot_attention</span><span class="p">(</span><span class="n">attention</span><span class="p">,</span> <span class="n">sentence</span><span class="p">,</span> <span class="n">predicted_sentence</span><span class="p">):</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="p">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">.</span><span class="n">matshow</span><span class="p">(</span><span class="n">attention</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s">'viridis'</span><span class="p">)</span>

    <span class="n">fontdict</span> <span class="o">=</span> <span class="p">{</span><span class="s">'fontsize'</span><span class="p">:</span> <span class="mi">14</span><span class="p">}</span>

    <span class="n">ax</span><span class="p">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s">''</span><span class="p">]</span> <span class="o">+</span> <span class="n">sentence</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">fontdict</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="s">''</span><span class="p">]</span> <span class="o">+</span> <span class="n">predicted_sentence</span><span class="p">,</span> <span class="n">fontdict</span><span class="o">=</span><span class="n">fontdict</span><span class="p">)</span>

    <span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># ç¿»è¯‘ä¸€å¥æ–‡æœ¬
</span><span class="k">def</span> <span class="nf">translate</span><span class="p">(</span><span class="n">sentence</span><span class="p">):</span>
    <span class="n">result</span><span class="p">,</span> <span class="n">sentence</span><span class="p">,</span> <span class="n">attention_plot</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">sentence</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s">'Input: %s'</span> <span class="o">%</span> <span class="p">(</span><span class="n">sentence</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'Predicted translation: {}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>

    <span class="n">attention_plot</span> <span class="o">=</span> <span class="n">attention_plot</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">' '</span><span class="p">)),</span> <span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">sentence</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">' '</span><span class="p">))]</span>
    <span class="n">plot_attention</span><span class="p">(</span><span class="n">attention_plot</span><span class="p">,</span> <span class="n">sentence</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">' '</span><span class="p">),</span> <span class="n">result</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">' '</span><span class="p">))</span>

<span class="c1"># æ¢å¤ä¿å­˜çš„è®­ç»ƒç»“æœ
</span><span class="n">checkpoint</span><span class="p">.</span><span class="n">restore</span><span class="p">(</span><span class="n">tf</span><span class="p">.</span><span class="n">train</span><span class="p">.</span><span class="n">latest_checkpoint</span><span class="p">(</span><span class="n">checkpoint_dir</span><span class="p">))</span>

<span class="c1"># æµ‹è¯•ä»¥ä¸‹ç¿»è¯‘
</span><span class="n">translate</span><span class="p">(</span><span class="sa">u</span><span class="s">'hace mucho frio aqui.'</span><span class="p">)</span>
<span class="n">translate</span><span class="p">(</span><span class="sa">u</span><span class="s">'esta es mi vida.'</span><span class="p">)</span>
<span class="n">translate</span><span class="p">(</span><span class="sa">u</span><span class="s">'Â¿todavia estan en casa?'</span><span class="p">)</span>
<span class="c1"># æ®è¯´è¿™å¥è¯çš„ç¿»è¯‘ç»“æœä¸å¯¹ï¼Œä¸æ‡‚è¥¿ç­ç‰™æ–‡ï¼Œä¸åšè¯„è®º
</span><span class="n">translate</span><span class="p">(</span><span class="sa">u</span><span class="s">'trata de averiguarlo.'</span><span class="p">)</span>
</code></pre></div></div>
<p>ç¬¬ä¸€æ¬¡æ‰§è¡Œçš„æ—¶å€™è¦åŠ å‚æ•°tain:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>./translate_spa2en.py train
Epoch 1 Batch 0 Loss 4.5296
Epoch 1 Batch 100 Loss 2.2811
Epoch 1 Batch 200 Loss 1.7985
Epoch 1 Batch 300 Loss 1.6724
Epoch 1 Loss 2.0235
Time taken <span class="k">for </span>1 epoch 149.3063322815 sec
	...è®­ç»ƒè¿‡ç¨‹ç•¥...
	
Input: &lt;start&gt; hace mucho frio aqui <span class="nb">.</span> &lt;end&gt;
Predicted translation: it s very cold here <span class="nb">.</span> &lt;end&gt; 
Input: &lt;start&gt; esta es mi vida <span class="nb">.</span> &lt;end&gt;
Predicted translation: this is my life <span class="nb">.</span> &lt;end&gt; 
Input: &lt;start&gt; Â¿ todavia estan en casa ? &lt;end&gt;
Predicted translation: are you still at home ? &lt;end&gt; 
Input: &lt;start&gt; trata de averiguarlo <span class="nb">.</span> &lt;end&gt;
Predicted translation: try to figure it out <span class="nb">.</span> &lt;end&gt; 
</code></pre></div></div>
<p>ä»¥åå¦‚æœåªæ˜¯æƒ³æµ‹è¯•ç¿»è¯‘æ•ˆæœï¼Œå¯ä»¥ä¸å¸¦trainå‚æ•°æ‰§è¡Œï¼Œç›´æ¥çœ‹ç¿»è¯‘ç»“æœã€‚<br />
å¯¹äºæ¯ä¸€ä¸ªç¿»è¯‘å¥å­ï¼Œç¨‹åºéƒ½ä¼šç»˜åˆ¶æ³¨æ„åŠ›çŸ©é˜µå›¾ï¼š<br />
<img src="/attachments/201904/tensorFlow2/nmt-attention1.png" alt="" /><br />
é€šå¸¸è¯­æ³•ä¸æ˜¯å¾ˆå¤æ‚çš„å¥å­ï¼ŒåŸºæœ¬æ˜¯é¡ºåºå¯¹åº”å…³ç³»ï¼Œæ‰€ä»¥æ³¨æ„åŠ›äº®ç‚¹åŸºæœ¬è½åœ¨å¯¹è§’çº¿ä¸Šã€‚<br />
å›¾ä¸­Xåæ ‡æ˜¯è¥¿ç­ç‰™æ–‡å•è¯ï¼ŒYåæ ‡æ˜¯è‹±æ–‡å•è¯ã€‚æ¯ä¸ªè‹±æ–‡å•è¯ï¼Œæ²¿Xè½´çœ‹ï¼Œäº®ç‚¹å¯¹åº”çš„Xè½´å•è¯ï¼Œè¡¨ç¤ºå¯¹äºç¿»è¯‘å‡ºè¿™ä¸ªè‹±æ–‡å•è¯ï¼Œæ˜¯å“ªä¸€ä¸ªè¥¿ç­ç‰™æ–‡å•è¯æƒé‡æœ€å¤§ã€‚</p>

<p>ï¼ˆå¾…ç»­â€¦ï¼‰</p>

:ET